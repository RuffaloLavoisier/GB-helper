# Commit: cd1f270ccfcdc2ae51bd446873ced890dd947d60
## Message: Xiaomi: add support for daily details version 4
## Changed files:
 
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/xiaomi/XiaomiSampleProvider.java
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/activity/impl/DailyDetailsParser.java
## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/xiaomi/XiaomiSampleProvider.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/xiaomi/XiaomiSampleProvider.java
index ca9654d44..9e8ae9d66 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/xiaomi/XiaomiSampleProvider.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/xiaomi/XiaomiSampleProvider.java
@@ -182,6 +182,9 @@ public class XiaomiSampleProvider extends AbstractSampleProvider<XiaomiActivityS
 
         if (!stagesMap.isEmpty()) {
             LOG.debug("Found {} sleep samples between {} and {}", stagesMap.size(), timestamp_from, timestamp_to);
+            // FIXME if no samples were retrieved from the database that were generated by other
+            //       activity files, the stages will not get overlayed/inserted and the sleep charts
+            //       will stay empty.
 
             for (final XiaomiActivitySample sample : samples) {
                 final long ts = sample.getTimestamp() * 1000L;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/activity/impl/DailyDetailsParser.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/activity/impl/DailyDetailsParser.java
index 537b4b527..147b82b39 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/activity/impl/DailyDetailsParser.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/activity/impl/DailyDetailsParser.java
@@ -57,6 +57,9 @@ public class DailyDetailsParser extends XiaomiActivityParser {
             case 3:
                 headerSize = 5;
                 break;
+            case 4:
+                headerSize = 6;
+                break;
             default:
                 LOG.warn("Unable to parse daily details version {}", fileId.getVersion());
                 return false;
@@ -155,6 +158,14 @@ public class DailyDetailsParser extends XiaomiActivityParser {
                 }
             }
 
+            if (version >= 4) {
+                // TODO: light value (short)
+                complexParser.nextGroup(16);
+
+                // TODO: body momentum (short)
+                complexParser.nextGroup(16);
+            }
+
             samples.add(sample);
 
             timestamp.add(Calendar.MINUTE, 1);
```
-----------------------------------
