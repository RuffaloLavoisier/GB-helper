# Commit: c168c554fbd98b0bb2f49f2bacb829ae76841b0c
## Message: Huami: Refactor fetching

Remove all dependencies on BLE from the activity fetching logic, so that
it can eventually be reused in btrfcomm devices.
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiFetcher.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/AbstractHuamiOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiFirmwareInfo.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/AbstractFetchOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/AbstractRepeatingFetchOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchActivityOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchDebugLogsOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateManualOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateMaxOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateRestingOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHrvOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchPaiOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSleepRespiratoryRateOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSleepSessionOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSpo2NormalOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSpo2SleepOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSportsDetailsOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSportsSummaryOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStatisticsOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStressAutoOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStressManualOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchTemperatureOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/update/UpdateFirmwareOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsSupport.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java
index fde28839a8..914b7ae02b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java
@@ -495,6 +495,11 @@ public abstract class AbstractDeviceCoordinator implements DeviceCoordinator {
         return false;
     }
 
+    @Override
+    public boolean supportsDebugLogs() {
+        return false;
+    }
+
     @Override
     public boolean supportsActivityDataFetching() {
         return false;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java
index 9e914fd5b3..17fc59cf2f 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java
@@ -200,6 +200,11 @@ public interface DeviceCoordinator {
 
     int getLiveActivityFragmentPulseInterval();
 
+    /**
+     * Whether the device supports fetching debug logs.
+     */
+    boolean supportsDebugLogs();
+
     /**
      * Returns true if activity data fetching is supported by the device
      * (with this coordinator).
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/AbstractHuamiOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/AbstractHuamiOperation.java
deleted file mode 100644
index 33e224fcdc..0000000000
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/AbstractHuamiOperation.java
+++ /dev/null
@@ -1,33 +0,0 @@
-/*  Copyright (C) 2018-2024 Andreas Shimokawa, Jos√© Rebelo
-
-    This file is part of Gadgetbridge.
-
-    Gadgetbridge is free software: you can redistribute it and/or modify
-    it under the terms of the GNU Affero General Public License as published
-    by the Free Software Foundation, either version 3 of the License, or
-    (at your option) any later version.
-
-    Gadgetbridge is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU Affero General Public License for more details.
-
-    You should have received a copy of the GNU Affero General Public License
-    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
-package nodomain.freeyourgadget.gadgetbridge.service.devices.huami;
-
-import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.miband.operations.AbstractMiBandOperation;
-
-public abstract class AbstractHuamiOperation extends AbstractMiBandOperation<HuamiSupport> {
-    protected AbstractHuamiOperation(HuamiSupport support) {
-        super(support);
-    }
-
-    @Override
-    protected void enableOtherNotifications(final TransactionBuilder builder, final boolean enable) {
-        // TODO: check which notifications we should disable and re-enable here
-//        builder.notify(getCharacteristic(MiBandService.UUID_CHARACTERISTIC_REALTIME_STEPS), enable)
-//                .notify(getCharacteristic(MiBandService.UUID_CHARACTERISTIC_SENSOR_DATA), enable);
-    }
-}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiFetcher.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiFetcher.java
new file mode 100644
index 0000000000..b35b45172a
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiFetcher.java
@@ -0,0 +1,211 @@
+package nodomain.freeyourgadget.gadgetbridge.service.devices.huami;
+
+import android.content.Context;
+
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+import java.util.Calendar;
+import java.util.LinkedList;
+import java.util.concurrent.TimeUnit;
+
+import nodomain.freeyourgadget.gadgetbridge.GBApplication;
+import nodomain.freeyourgadget.gadgetbridge.devices.DeviceCoordinator;
+import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
+import nodomain.freeyourgadget.gadgetbridge.model.RecordedDataTypes;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.AbstractFetchOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchActivityOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchDebugLogsOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchHeartRateManualOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchHeartRateMaxOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchHeartRateRestingOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchHrvOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchPaiOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchSleepRespiratoryRateOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchSleepSessionOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchSpo2NormalOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchSportsSummaryOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchStatisticsOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchStressAutoOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchStressManualOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchTemperatureOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsSupport;
+import nodomain.freeyourgadget.gadgetbridge.util.GB;
+import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
+
+public class HuamiFetcher {
+    private static final Logger LOG = LoggerFactory.getLogger(HuamiFetcher.class);
+
+    private final HuamiFetchSupport mSupport;
+
+    private final LinkedList<AbstractFetchOperation> fetchOperationQueue = new LinkedList<>();
+    private AbstractFetchOperation currentOperation;
+
+    public HuamiFetcher(final HuamiFetchSupport mSupport) {
+        this.mSupport = mSupport;
+    }
+
+    public void onFetchRecordedData(final int dataTypes) {
+        final GBDevice gbDevice = mSupport.getDevice();
+        final DeviceCoordinator coordinator = mSupport.getCoordinator();
+
+        if ((dataTypes & RecordedDataTypes.TYPE_ACTIVITY) != 0) {
+            this.fetchOperationQueue.add(new FetchActivityOperation(this));
+        }
+
+        if ((dataTypes & RecordedDataTypes.TYPE_GPS_TRACKS) != 0 && coordinator.supportsActivityTracks()) {
+            this.fetchOperationQueue.add(new FetchSportsSummaryOperation(this, 1));
+        }
+
+        if ((dataTypes & RecordedDataTypes.TYPE_DEBUGLOGS) != 0 && coordinator.supportsDebugLogs()) {
+            this.fetchOperationQueue.add(new FetchDebugLogsOperation(this));
+        }
+
+        if ((dataTypes & RecordedDataTypes.TYPE_STRESS) != 0 && coordinator.supportsStressMeasurement()) {
+            this.fetchOperationQueue.add(new FetchStressAutoOperation(this));
+            this.fetchOperationQueue.add(new FetchStressManualOperation(this));
+        }
+
+        if ((dataTypes & RecordedDataTypes.TYPE_PAI) != 0 && coordinator.supportsPai()) {
+            this.fetchOperationQueue.add(new FetchPaiOperation(this));
+        }
+
+        if ((dataTypes & RecordedDataTypes.TYPE_SPO2) != 0 && coordinator.supportsSpo2(gbDevice)) {
+            this.fetchOperationQueue.add(new FetchSpo2NormalOperation(this));
+        }
+
+        if ((dataTypes & RecordedDataTypes.TYPE_HRV) != 0 && coordinator.supportsHrvMeasurement(gbDevice)) {
+            this.fetchOperationQueue.add(new FetchHrvOperation(this));
+        }
+
+        if ((dataTypes & RecordedDataTypes.TYPE_HEART_RATE) != 0 && coordinator.supportsHeartRateStats()) {
+            this.fetchOperationQueue.add(new FetchHeartRateManualOperation(this));
+            this.fetchOperationQueue.add(new FetchHeartRateMaxOperation(this));
+            this.fetchOperationQueue.add(new FetchHeartRateRestingOperation(this));
+        }
+
+        if ((dataTypes & RecordedDataTypes.TYPE_SLEEP_RESPIRATORY_RATE) != 0 && coordinator.supportsSleepRespiratoryRate()) {
+            this.fetchOperationQueue.add(new FetchSleepRespiratoryRateOperation(this));
+        }
+
+        if ((dataTypes & RecordedDataTypes.TYPE_TEMPERATURE) != 0 && coordinator.supportsTemperatureMeasurement(gbDevice)) {
+            this.fetchOperationQueue.add(new FetchTemperatureOperation(this));
+        }
+
+        if ((dataTypes & RecordedDataTypes.TYPE_SLEEP) != 0 && coordinator.supportsSleepScore(gbDevice)) {
+            this.fetchOperationQueue.add(new FetchSleepSessionOperation(this));
+        }
+
+        if ((dataTypes & RecordedDataTypes.TYPE_HUAMI_STATISTICS) != 0) {
+            this.fetchOperationQueue.add(new FetchStatisticsOperation(this));
+        }
+
+        if (currentOperation == null) {
+            triggerNextOperation();
+        }
+    }
+
+    public void onActivityControl(final byte[] value) {
+        if (currentOperation != null) {
+            currentOperation.handleActivityMetadata(value);
+        } else {
+            LOG.warn("Got activity control, but there is no ongoing operation: {}", GB.hexdump(value));
+        }
+    }
+
+    public void onActivityData(final byte[] value) {
+        if (currentOperation != null) {
+            currentOperation.handleActivityData(value);
+        } else {
+            LOG.warn("Got activity data, but there is no ongoing operation: {}", GB.hexdump(value));
+        }
+    }
+
+    public GBDevice getDevice() {
+        return mSupport.getDevice();
+    }
+
+    public Context getContext() {
+        return mSupport.getContext();
+    }
+
+    public int getActivitySampleSize() {
+        return mSupport.getActivitySampleSize();
+    }
+
+    public byte[] getTimeBytes(final Calendar calendar, final TimeUnit precision) {
+        return mSupport.getTimeBytes(calendar, precision);
+    }
+
+    public void setNotifications(final boolean control, final boolean data) {
+        mSupport.setActivityNotifications(control, data);
+    }
+
+    public TimeUnit getFetchOperationsTimeUnit() {
+        // This is configurable because using seconds was causing issues on Amazfit GTR 3
+        // However, using minutes can cause issues while fetching workouts shorter than 1 minute
+        final Prefs devicePrefs = GBApplication.getDevicePrefs(getDevice());
+        final boolean truncate = devicePrefs.getBoolean("huami_truncate_fetch_operation_timestamps", true);
+        return truncate ? TimeUnit.MINUTES : TimeUnit.SECONDS;
+    }
+
+    public void writeControl(final String name, final byte[] value) {
+        mSupport.writeActivityControl(name, value);
+    }
+
+    public boolean isZeppOs() {
+        return mSupport instanceof ZeppOsSupport;
+    }
+
+    public void triggerNextOperation() {
+        final boolean wasFetching = currentOperation != null;
+        currentOperation = this.fetchOperationQueue.poll();
+
+        if (currentOperation != null) {
+            LOG.debug("Performing next operation {}", currentOperation.getName());
+
+            getDevice().setBusyTask(currentOperation.taskDescription()); // mark as busy quickly to avoid interruptions from the outside
+            getDevice().sendDeviceUpdateIntent(getContext());
+
+            if (!wasFetching) {
+                setNotifications(true, false);
+            }
+
+            currentOperation.doPerform();
+
+            return;
+        }
+
+        if (wasFetching) {
+            LOG.debug("All operations finished");
+
+            GB.updateTransferNotification(null, "", false, 100, getContext());
+            GB.signalActivityDataFinish(getDevice());
+
+            setNotifications(false, false);
+
+            if (getDevice().isBusy()) {
+                getDevice().unsetBusyTask();
+                getDevice().sendDeviceUpdateIntent(getContext());
+            }
+        }
+    }
+
+    public AbstractFetchOperation getNextFetchOperation() {
+        return fetchOperationQueue.poll();
+    }
+
+    public LinkedList<AbstractFetchOperation> getFetchOperationQueue() {
+        return fetchOperationQueue;
+    }
+
+    public interface HuamiFetchSupport {
+        DeviceCoordinator getCoordinator();
+        GBDevice getDevice();
+        Context getContext();
+        int getActivitySampleSize();
+        byte[] getTimeBytes(final Calendar calendar, final TimeUnit precision);
+        void setActivityNotifications(boolean control, boolean data);
+        void writeActivityControl(String name, byte[] value);
+    }
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiFirmwareInfo.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiFirmwareInfo.java
index 7d73fb6a24..33eb2ad4d9 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiFirmwareInfo.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiFirmwareInfo.java
@@ -19,11 +19,6 @@ package nodomain.freeyourgadget.gadgetbridge.service.devices.huami;
 
 import java.nio.ByteBuffer;
 import java.nio.ByteOrder;
-import java.util.Map;
-
-import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
-import nodomain.freeyourgadget.gadgetbridge.util.ArrayUtils;
-import nodomain.freeyourgadget.gadgetbridge.util.CheckSums;
 
 
 public abstract class HuamiFirmwareInfo extends AbstractHuamiFirmwareInfo {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiSupport.java
index aaca74bc28..fc6849af6e 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiSupport.java
@@ -47,24 +47,18 @@ import java.io.IOException;
 import java.nio.ByteBuffer;
 import java.nio.ByteOrder;
 import java.nio.charset.StandardCharsets;
-import java.time.Instant;
 import java.time.LocalDate;
-import java.time.ZoneId;
-import java.time.zone.ZoneOffsetTransition;
-import java.time.zone.ZoneRules;
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.Calendar;
 import java.util.Date;
 import java.util.GregorianCalendar;
 import java.util.HashSet;
-import java.util.LinkedList;
 import java.util.List;
 import java.util.Locale;
 import java.util.Map;
 import java.util.Set;
 import java.util.SimpleTimeZone;
-import java.util.TimeZone;
 import java.util.Timer;
 import java.util.TimerTask;
 import java.util.UUID;
@@ -123,25 +117,9 @@ import nodomain.freeyourgadget.gadgetbridge.model.ActivityKind;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivitySample;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivityUser;
 import nodomain.freeyourgadget.gadgetbridge.model.Alarm;
-import nodomain.freeyourgadget.gadgetbridge.model.RecordedDataTypes;
 import nodomain.freeyourgadget.gadgetbridge.model.SleepState;
 import nodomain.freeyourgadget.gadgetbridge.model.WearingState;
 import nodomain.freeyourgadget.gadgetbridge.service.SleepAsAndroidSender;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.AbstractFetchOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchHrvOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchSleepSessionOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchStatisticsOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchTemperatureOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchHeartRateManualOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchHeartRateMaxOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchHeartRateRestingOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchPaiOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchSleepRespiratoryRateOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchSpo2NormalOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchSportsSummaryOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchStressAutoOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchStressManualOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchDebugLogsOperation;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsCannedMessagesService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsWorldClocksService;
 import nodomain.freeyourgadget.gadgetbridge.util.MediaManager;
@@ -178,7 +156,6 @@ import nodomain.freeyourgadget.gadgetbridge.service.devices.common.SimpleNotific
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.actions.StopNotificationAction;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.miband2.Mi2NotificationStrategy;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.miband2.Mi2TextNotificationStrategy;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch.FetchActivityOperation;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.init.InitOperation;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.init.InitOperation2021;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.update.UpdateFirmwareOperation;
@@ -294,7 +271,8 @@ import static nodomain.freeyourgadget.gadgetbridge.model.ActivityUser.PREF_USER_
 import static nodomain.freeyourgadget.gadgetbridge.model.ActivityUser.PREF_USER_WEIGHT_KG;
 import static nodomain.freeyourgadget.gadgetbridge.service.btle.GattCharacteristic.UUID_CHARACTERISTIC_ALERT_LEVEL;
 
-public abstract class HuamiSupport extends AbstractBTLEDeviceSupport implements Huami2021Handler {
+public abstract class HuamiSupport extends AbstractBTLEDeviceSupport
+        implements Huami2021Handler, HuamiFetcher.HuamiFetchSupport {
 
     // We introduce key press counter for notification purposes
     private static int currentButtonActionId = 0;
@@ -344,7 +322,7 @@ public abstract class HuamiSupport extends AbstractBTLEDeviceSupport implements
     protected Huami2021ChunkedEncoder huami2021ChunkedEncoder;
     protected Huami2021ChunkedDecoder huami2021ChunkedDecoder;
 
-    private final LinkedList<AbstractFetchOperation> fetchOperationQueue = new LinkedList<>();
+    private final HuamiFetcher fetcher = new HuamiFetcher(this);
 
     protected SleepAsAndroidSender sleepAsAndroidSender;
     public HuamiSupport() {
@@ -376,6 +354,21 @@ public abstract class HuamiSupport extends AbstractBTLEDeviceSupport implements
         this.sleepAsAndroidSender = new SleepAsAndroidSender(gbDevice);
     }
 
+    @Override
+    public void setActivityNotifications(final boolean control, final boolean data) {
+        final TransactionBuilder builder = createTransactionBuilder("set activity notifications: " + control + " " + data);
+        builder.notify(getCharacteristic(HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_CONTROL), control);
+        builder.notify(getCharacteristic(HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_DATA), data);
+        builder.queue(getQueue());
+    }
+
+    @Override
+    public void writeActivityControl(final String name, final byte[] value) {
+        final TransactionBuilder builder = createTransactionBuilder(name);
+        builder.write(getCharacteristic(HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_CONTROL), value);
+        builder.queue(getQueue());
+    }
+
     @Override
     protected TransactionBuilder initializeDevice(TransactionBuilder builder) {
         if (getMTU() != MIN_MTU) {
@@ -494,11 +487,6 @@ public abstract class HuamiSupport extends AbstractBTLEDeviceSupport implements
         };
     }
 
-    public Calendar fromTimeBytes(byte[] bytes) {
-        GregorianCalendar timestamp = BLETypeConversions.rawBytesToCalendar(bytes);
-        return timestamp;
-    }
-
     public HuamiSupport setCurrentTimeWithService(TransactionBuilder builder) {
         final Calendar now = createCalendar();
         byte[] bytes = getTimeBytes(now, TimeUnit.SECONDS);
@@ -1567,76 +1555,8 @@ public abstract class HuamiSupport extends AbstractBTLEDeviceSupport implements
     }
 
     @Override
-    public void onFetchRecordedData(int dataTypes) {
-        final HuamiCoordinator coordinator = getCoordinator();
-
-        if ((dataTypes & RecordedDataTypes.TYPE_ACTIVITY) != 0) {
-            this.fetchOperationQueue.add(new FetchActivityOperation(this));
-        }
-
-        if ((dataTypes & RecordedDataTypes.TYPE_GPS_TRACKS) != 0 && coordinator.supportsActivityTracks()) {
-            this.fetchOperationQueue.add(new FetchSportsSummaryOperation(this, 1));
-        }
-
-        if ((dataTypes & RecordedDataTypes.TYPE_DEBUGLOGS) != 0 && coordinator.supportsDebugLogs()) {
-            this.fetchOperationQueue.add(new FetchDebugLogsOperation(this));
-        }
-
-        if ((dataTypes & RecordedDataTypes.TYPE_STRESS) != 0 && coordinator.supportsStressMeasurement()) {
-            this.fetchOperationQueue.add(new FetchStressAutoOperation(this));
-            this.fetchOperationQueue.add(new FetchStressManualOperation(this));
-        }
-
-        if ((dataTypes & RecordedDataTypes.TYPE_PAI) != 0 && coordinator.supportsPai()) {
-            this.fetchOperationQueue.add(new FetchPaiOperation(this));
-        }
-
-        if ((dataTypes & RecordedDataTypes.TYPE_SPO2) != 0 && coordinator.supportsSpo2(gbDevice)) {
-            this.fetchOperationQueue.add(new FetchSpo2NormalOperation(this));
-        }
-
-        if ((dataTypes & RecordedDataTypes.TYPE_HRV) != 0 && coordinator.supportsHrvMeasurement(gbDevice)) {
-            this.fetchOperationQueue.add(new FetchHrvOperation(this));
-        }
-
-        if ((dataTypes & RecordedDataTypes.TYPE_HEART_RATE) != 0 && coordinator.supportsHeartRateStats()) {
-            this.fetchOperationQueue.add(new FetchHeartRateManualOperation(this));
-            this.fetchOperationQueue.add(new FetchHeartRateMaxOperation(this));
-            this.fetchOperationQueue.add(new FetchHeartRateRestingOperation(this));
-        }
-
-        if ((dataTypes & RecordedDataTypes.TYPE_SLEEP_RESPIRATORY_RATE) != 0 && coordinator.supportsSleepRespiratoryRate()) {
-            this.fetchOperationQueue.add(new FetchSleepRespiratoryRateOperation(this));
-        }
-
-        if ((dataTypes & RecordedDataTypes.TYPE_TEMPERATURE) != 0 && coordinator.supportsTemperatureMeasurement(gbDevice)) {
-            this.fetchOperationQueue.add(new FetchTemperatureOperation(this));
-        }
-
-        if ((dataTypes & RecordedDataTypes.TYPE_SLEEP) != 0 && coordinator.supportsSleepScore(gbDevice)) {
-            this.fetchOperationQueue.add(new FetchSleepSessionOperation(this));
-        }
-
-        if ((dataTypes & RecordedDataTypes.TYPE_HUAMI_STATISTICS) != 0) {
-            this.fetchOperationQueue.add(new FetchStatisticsOperation(this));
-        }
-
-        final AbstractFetchOperation nextOperation = this.fetchOperationQueue.poll();
-        if (nextOperation != null) {
-            try {
-                nextOperation.perform();
-            } catch (final IOException e) {
-                LOG.error("Unable to fetch recorded data", e);
-            }
-        }
-    }
-
-    public AbstractFetchOperation getNextFetchOperation() {
-        return fetchOperationQueue.poll();
-    }
-
-    public LinkedList<AbstractFetchOperation> getFetchOperationQueue() {
-        return fetchOperationQueue;
+    public void onFetchRecordedData(final int dataTypes) {
+        fetcher.onFetchRecordedData(dataTypes);
     }
 
     @Override
@@ -2216,8 +2136,14 @@ public abstract class HuamiSupport extends AbstractBTLEDeviceSupport implements
         } else if (HuamiService.UUID_CHARACTERISTIC_RAW_SENSOR_DATA.equals(characteristicUUID)) {
             handleRawSensorData(characteristic.getValue());
             return true;
-        } else {
-            LOG.info("Unhandled characteristic changed: " + characteristicUUID);
+        } else if (HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_DATA.equals(characteristicUUID)) {
+            fetcher.onActivityData(characteristic.getValue());
+            return true;
+        } else if (HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_CONTROL.equals(characteristicUUID)) {
+            fetcher.onActivityControl(characteristic.getValue());
+            return true;
+        }  else {
+            LOG.warn("Unhandled characteristic changed: {}", characteristicUUID);
             logMessageContent(characteristic.getValue());
         }
 
@@ -4131,7 +4057,7 @@ public abstract class HuamiSupport extends AbstractBTLEDeviceSupport implements
         return GBApplication.getDeviceSpecificSharedPrefs(gbDevice.getAddress()).getBoolean("force_new_protocol", false);
     }
 
-    protected HuamiCoordinator getCoordinator() {
+    public HuamiCoordinator getCoordinator() {
         return (HuamiCoordinator) gbDevice.getDeviceCoordinator();
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/AbstractFetchOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/AbstractFetchOperation.java
index 6b77631e5d..80557c7def 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/AbstractFetchOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/AbstractFetchOperation.java
@@ -17,8 +17,7 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.fetch;
 
-import android.bluetooth.BluetoothGatt;
-import android.bluetooth.BluetoothGattCharacteristic;
+import android.content.Context;
 import android.content.SharedPreferences;
 import android.widget.Toast;
 
@@ -33,19 +32,15 @@ import java.text.DateFormat;
 import java.util.Arrays;
 import java.util.Calendar;
 import java.util.GregorianCalendar;
-import java.util.UUID;
 
 import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.Logging;
 import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.devices.huami.HuamiCoordinator;
 import nodomain.freeyourgadget.gadgetbridge.devices.huami.HuamiService;
+import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.actions.SetDeviceBusyAction;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.AbstractHuamiOperation;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.CheckSums;
 import nodomain.freeyourgadget.gadgetbridge.util.DateTimeUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
@@ -53,11 +48,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 /**
  * An operation that fetches activity data.
  */
-public abstract class AbstractFetchOperation extends AbstractHuamiOperation {
+public abstract class AbstractFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(AbstractFetchOperation.class);
 
-    protected BluetoothGattCharacteristic characteristicActivityData;
-    protected BluetoothGattCharacteristic characteristicFetch;
+    protected final HuamiFetcher fetcher;
+    protected final HuamiFetchDataType dataType;
+    protected final String name;
 
     protected Calendar startTimestamp;
 
@@ -68,96 +64,46 @@ public abstract class AbstractFetchOperation extends AbstractHuamiOperation {
 
     protected boolean operationValid = true; // to mark operation failed midway (eg. out of sync)
 
-    public AbstractFetchOperation(final HuamiSupport support) {
-        super(support);
+    public AbstractFetchOperation(final HuamiFetcher fetcher, final HuamiFetchDataType dataType) {
+        this.fetcher = fetcher;
+        this.dataType = dataType;
+        this.name = "fetching " + dataType.name();
     }
 
-    @Override
-    protected void enableNeededNotifications(final TransactionBuilder builder, final boolean enable) {
-        if (!enable) {
-            // dynamically enabled, but always disabled on finish
-            builder.notify(characteristicFetch, false);
-            builder.notify(characteristicActivityData, false);
-        }
+    protected Context getContext() {
+        return fetcher.getContext();
     }
 
-    @Override
-    protected void doPerform() throws IOException {
-        startFetching();
+    public String getName() {
+        return this.name;
     }
 
-    protected void startFetching() throws IOException {
+    protected GBDevice getDevice() {
+        return fetcher.getDevice();
+    }
+
+    public void doPerform() {
         expectedDataLength = 0;
         lastPacketCounter = -1;
-
-        final TransactionBuilder builder = performInitialized(getName());
-        if (fetchCount == 0) {
-            builder.add(new SetDeviceBusyAction(getDevice(), taskDescription(), getContext()));
-        }
         fetchCount++;
 
-        // TODO: this probably returns null when device is not connected/initialized yet!
-        characteristicActivityData = getCharacteristic(HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_DATA);
-        builder.notify(characteristicActivityData, false);
-
-        characteristicFetch = getCharacteristic(HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_CONTROL);
-        builder.notify(characteristicFetch, true);
-
-        startFetching(builder);
-        builder.queue(getQueue());
+        startFetching();
     }
 
     /**
      * A task description, to display in notifications and device card.
      */
-    protected abstract String taskDescription();
+    public abstract String taskDescription();
 
-    protected abstract void startFetching(TransactionBuilder builder);
+    protected abstract void startFetching();
 
     protected abstract String getLastSyncTimeKey();
 
-    @Override
-    public boolean onCharacteristicChanged(final BluetoothGatt gatt,
-                                           final BluetoothGattCharacteristic characteristic) {
-        final UUID characteristicUUID = characteristic.getUuid();
-        if (HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_DATA.equals(characteristicUUID)) {
-            handleActivityData(characteristic.getValue());
-            return true;
-        } else if (HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_CONTROL.equals(characteristicUUID)) {
-            handleActivityMetadata(characteristic.getValue());
-            return true;
-        } else {
-            return super.onCharacteristicChanged(gatt, characteristic);
-        }
-    }
-
     /**
      * Handles the finishing of fetching the activity. This signals the actual end of this operation.
      */
     protected final void onOperationFinished() {
-        final AbstractFetchOperation nextFetchOperation = getSupport().getNextFetchOperation();
-        if (nextFetchOperation != null) {
-            LOG.debug("Performing next operation {}", nextFetchOperation.getName());
-            try {
-                nextFetchOperation.perform();
-                return;
-            } catch (final IOException e) {
-                GB.toast(
-                        getContext(),
-                        "Failed to run next fetch operation",
-                        Toast.LENGTH_SHORT,
-                        GB.ERROR, e
-                );
-                return;
-            }
-        }
-
-        LOG.debug("All operations finished");
-
-        GB.updateTransferNotification(null, "", false, 100, getContext());
-        GB.signalActivityDataFinish(getDevice());
-        operationFinished();
-        unsetBusy();
+        fetcher.triggerNextOperation();
     }
 
     /**
@@ -173,12 +119,11 @@ public abstract class AbstractFetchOperation extends AbstractHuamiOperation {
 
     protected abstract boolean processBufferedData();
 
-    protected void handleActivityData(final byte[] value) {
+    public void handleActivityData(final byte[] value) {
         LOG.debug("{} data: {}", getName(), Logging.formatBytes(value));
 
-        if (!isOperationRunning()) {
-            LOG.error("ignoring {} notification because operation is not running. Data length: {}", getName(), value.length);
-            getSupport().logMessageContent(value);
+        if (!operationValid) {
+            LOG.error("Ignoring {} notification because operation is not valid. Data length: {}", getName(), value.length);
             return;
         }
 
@@ -196,16 +141,15 @@ public abstract class AbstractFetchOperation extends AbstractHuamiOperation {
         buffer.write(value, 1, value.length - 1); // skip the counter
     }
 
-    protected void startFetching(final TransactionBuilder builder, final byte fetchType, final GregorianCalendar sinceWhen) {
-        final HuamiSupport support = getSupport();
-        byte[] fetchBytes = BLETypeConversions.join(new byte[]{
-                        HuamiService.COMMAND_ACTIVITY_DATA_START_DATE,
-                        fetchType},
-                support.getTimeBytes(sinceWhen, support.getFetchOperationsTimeUnit()));
-        builder.write(characteristicFetch, fetchBytes);
+    protected void startFetching(final byte fetchType, final GregorianCalendar sinceWhen) {
+        final byte[] fetchBytes = BLETypeConversions.join(
+                new byte[]{HuamiService.COMMAND_ACTIVITY_DATA_START_DATE, fetchType},
+                fetcher.getTimeBytes(sinceWhen, fetcher.getFetchOperationsTimeUnit())
+        );
+        fetcher.writeControl("fetch", fetchBytes);
     }
 
-    private void handleActivityMetadata(byte[] value) {
+    public void handleActivityMetadata(byte[] value) {
         if (value.length < 3) {
             LOG.warn("Activity metadata too short: {}", Logging.formatBytes(value));
             onOperationFinished();
@@ -254,7 +198,7 @@ public abstract class AbstractFetchOperation extends AbstractHuamiOperation {
         expectedDataLength = BLETypeConversions.toUint32(Arrays.copyOfRange(value, 3, 7));
 
         // last 8 bytes are the start date
-        Calendar startTimestamp = getSupport().fromTimeBytes(Arrays.copyOfRange(value, 7, value.length));
+        Calendar startTimestamp = BLETypeConversions.rawBytesToCalendar(Arrays.copyOfRange(value, 7, value.length));
 
         if (expectedDataLength == 0) {
             LOG.info("No data to fetch since {}", DateTimeUtils.formatIso8601(startTimestamp.getTime()));
@@ -271,15 +215,8 @@ public abstract class AbstractFetchOperation extends AbstractHuamiOperation {
                         DateFormat.getDateTimeInstance().format(startTimestamp.getTime())), true, 0, getContext());
 
         // Trigger the actual data fetch
-        final TransactionBuilder step2builder = createTransactionBuilder(getName() + " Step 2");
-        step2builder.notify(characteristicActivityData, true);
-        step2builder.write(characteristicFetch, new byte[]{HuamiService.COMMAND_FETCH_DATA});
-        try {
-            performImmediately(step2builder);
-        } catch (final IOException e) {
-            GB.toast(getContext(), "Error starting fetch step 2: " + e.getMessage(), Toast.LENGTH_LONG, GB.ERROR, e);
-            onOperationFinished();
-        }
+        fetcher.setNotifications(true, true);
+        fetcher.writeControl(getName() + " step 2", new byte[]{HuamiService.COMMAND_FETCH_DATA});
     }
 
     private void handleFetchDataResponse(final byte[] value) {
@@ -298,7 +235,7 @@ public abstract class AbstractFetchOperation extends AbstractHuamiOperation {
         if (value.length == 7 && !validChecksum(BLETypeConversions.toUint32(value, 3))) {
             LOG.warn("Data checksum invalid");
             // If we're on Zepp OS, ack but keep data on device
-            if (isZeppOs()) {
+            if (fetcher.isZeppOs()) {
                 sendAck(true);
                 // do not finish the operation - do it in the ack response
                 return;
@@ -310,7 +247,7 @@ public abstract class AbstractFetchOperation extends AbstractHuamiOperation {
         final boolean success = operationValid && processBufferedData();
 
         final boolean keepActivityDataOnDevice = !success || HuamiCoordinator.getKeepActivityDataOnDevice(getDevice().getAddress());
-        if (isZeppOs() || !keepActivityDataOnDevice) {
+        if (fetcher.isZeppOs() || !keepActivityDataOnDevice) {
             sendAck(keepActivityDataOnDevice);
             // do not finish the operation - do it in the ack response
             return;
@@ -322,7 +259,7 @@ public abstract class AbstractFetchOperation extends AbstractHuamiOperation {
     protected void sendAck(final boolean keepDataOnDevice) {
         final byte[] ackBytes;
 
-        if (isZeppOs()) {
+        if (fetcher.isZeppOs()) {
             LOG.debug("Sending ack, keepDataOnDevice = {}", keepDataOnDevice);
 
             // 0x01 to ACK, mark as saved on phone (drop from band)
@@ -335,13 +272,7 @@ public abstract class AbstractFetchOperation extends AbstractHuamiOperation {
             ackBytes = new byte[]{HuamiService.COMMAND_ACK_ACTIVITY_DATA};
         }
 
-        try {
-            final TransactionBuilder builder = createTransactionBuilder(getName() + " end");
-            builder.write(characteristicFetch, ackBytes);
-            performImmediately(builder);
-        } catch (final IOException e) {
-            LOG.error("Failed to send ack", e);
-        }
+        fetcher.writeControl(getName() + " end", ackBytes);
     }
 
     private void setStartTimestamp(final Calendar startTimestamp) {
@@ -353,13 +284,13 @@ public abstract class AbstractFetchOperation extends AbstractHuamiOperation {
     }
 
     protected void saveLastSyncTimestamp(@NonNull final GregorianCalendar timestamp) {
-        final SharedPreferences.Editor editor = GBApplication.getDeviceSpecificSharedPrefs(getDevice().getAddress()).edit();
+        final SharedPreferences.Editor editor = GBApplication.getDeviceSpecificSharedPrefs(fetcher.getDevice().getAddress()).edit();
         editor.putLong(getLastSyncTimeKey(), timestamp.getTimeInMillis());
         editor.apply();
     }
 
     protected GregorianCalendar getLastSuccessfulSyncTime() {
-        final long timeStampMillis = GBApplication.getDeviceSpecificSharedPrefs(getDevice().getAddress()).getLong(getLastSyncTimeKey(), 0);
+        final long timeStampMillis = GBApplication.getDeviceSpecificSharedPrefs(fetcher.getDevice().getAddress()).getLong(getLastSyncTimeKey(), 0);
         if (timeStampMillis != 0) {
             GregorianCalendar calendar = BLETypeConversions.createCalendar();
             calendar.setTimeInMillis(timeStampMillis);
@@ -369,8 +300,4 @@ public abstract class AbstractFetchOperation extends AbstractHuamiOperation {
         calendar.add(Calendar.DAY_OF_MONTH, -100);
         return calendar;
     }
-
-    protected boolean isZeppOs() {
-        return getSupport() instanceof ZeppOsSupport;
-    }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/AbstractRepeatingFetchOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/AbstractRepeatingFetchOperation.java
index 47da58663a..f0fe6d6eef 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/AbstractRepeatingFetchOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/AbstractRepeatingFetchOperation.java
@@ -27,8 +27,7 @@ import java.util.Calendar;
 import java.util.GregorianCalendar;
 import java.util.Locale;
 
-import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.DateTimeUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;
 
@@ -40,19 +39,15 @@ import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;
 public abstract class AbstractRepeatingFetchOperation extends AbstractFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(AbstractRepeatingFetchOperation.class);
 
-    protected final HuamiFetchDataType dataType;
-
-    public AbstractRepeatingFetchOperation(final HuamiSupport support, final HuamiFetchDataType dataType) {
-        super(support);
-        this.dataType = dataType;
-        setName("fetching " + dataType.name());
+    public AbstractRepeatingFetchOperation(final HuamiFetcher fetcher, final HuamiFetchDataType dataType) {
+        super(fetcher, dataType);
     }
 
     @Override
-    protected void startFetching(final TransactionBuilder builder) {
+    protected void startFetching() {
         final GregorianCalendar sinceWhen = getLastSuccessfulSyncTime();
         LOG.info("start {} since {}", getName(), DateTimeUtils.formatIso8601(sinceWhen.getTime()));
-        startFetching(builder, dataType.getCode(), sinceWhen);
+        startFetching(dataType.getCode(), sinceWhen);
     }
 
     /**
@@ -91,7 +86,7 @@ public abstract class AbstractRepeatingFetchOperation extends AbstractFetchOpera
         if (needsAnotherFetch(timestamp)) {
             buffer.reset();
 
-            getSupport().getFetchOperationQueue().add(0, this);
+            fetcher.getFetchOperationQueue().add(0, this);
         }
 
         return true;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchActivityOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchActivityOperation.java
index 4c2bc4bccd..6342618564 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchActivityOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchActivityOperation.java
@@ -41,7 +41,7 @@ import nodomain.freeyourgadget.gadgetbridge.entities.Device;
 import nodomain.freeyourgadget.gadgetbridge.entities.HuamiExtendedActivitySample;
 import nodomain.freeyourgadget.gadgetbridge.entities.MiBandActivitySample;
 import nodomain.freeyourgadget.gadgetbridge.entities.User;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.DateTimeUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
@@ -54,13 +54,13 @@ public class FetchActivityOperation extends AbstractRepeatingFetchOperation {
 
     private final int sampleSize;
 
-    public FetchActivityOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.ACTIVITY);
-        this.sampleSize = support.getActivitySampleSize();
+    public FetchActivityOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.ACTIVITY);
+        this.sampleSize = fetcher.getActivitySampleSize();
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_activity_data);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchDebugLogsOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchDebugLogsOperation.java
index 3d13d6fa3a..9c9639fe43 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchDebugLogsOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchDebugLogsOperation.java
@@ -25,13 +25,15 @@ import java.io.File;
 import java.io.FileOutputStream;
 import java.io.IOException;
 import java.text.SimpleDateFormat;
+import java.util.Calendar;
 import java.util.Date;
 import java.util.GregorianCalendar;
 import java.util.Locale;
 
+import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.R;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;
 
 public class FetchDebugLogsOperation extends AbstractFetchOperation {
@@ -39,18 +41,17 @@ public class FetchDebugLogsOperation extends AbstractFetchOperation {
 
     private FileOutputStream logOutputStream;
 
-    public FetchDebugLogsOperation(final HuamiSupport support) {
-        super(support);
-        setName("fetch debug logs");
+    public FetchDebugLogsOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.DEBUG_LOGS);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_debug_logs);
     }
 
     @Override
-    protected void startFetching(final TransactionBuilder builder) {
+    protected void startFetching() {
         File dir;
         try {
             dir = FileUtils.getExternalFilesDir();
@@ -69,7 +70,7 @@ public class FetchDebugLogsOperation extends AbstractFetchOperation {
             return;
         }
         final GregorianCalendar sinceWhen = getLastSuccessfulSyncTime();
-        startFetching(builder, HuamiFetchDataType.DEBUG_LOGS.getCode(), sinceWhen);
+        startFetching(HuamiFetchDataType.DEBUG_LOGS.getCode(), sinceWhen);
     }
 
     @Override
@@ -106,4 +107,21 @@ public class FetchDebugLogsOperation extends AbstractFetchOperation {
             LOG.error("could not write to output stream", e);
         }
     }
+
+    @Override
+    protected GregorianCalendar getLastSuccessfulSyncTime() {
+        // Avoid going too further back - some devices have so many logs that it will take an
+        // incredibly long time to sync
+        final GregorianCalendar lastHour = BLETypeConversions.createCalendar();
+        lastHour.add(Calendar.HOUR, -1);
+
+        final long timeStampMillis = GBApplication.getDeviceSpecificSharedPrefs(fetcher.getDevice().getAddress()).getLong(getLastSyncTimeKey(), 0);
+        if (timeStampMillis != 0 && timeStampMillis > lastHour.getTimeInMillis()) {
+            GregorianCalendar calendar = BLETypeConversions.createCalendar();
+            calendar.setTimeInMillis(timeStampMillis);
+            return calendar;
+        }
+
+        return lastHour;
+    }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateManualOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateManualOperation.java
index d73c024643..558f1fe927 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateManualOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateManualOperation.java
@@ -38,7 +38,7 @@ import nodomain.freeyourgadget.gadgetbridge.entities.Device;
 import nodomain.freeyourgadget.gadgetbridge.entities.HuamiHeartRateManualSample;
 import nodomain.freeyourgadget.gadgetbridge.entities.User;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 /**
@@ -47,12 +47,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 public class FetchHeartRateManualOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchHeartRateManualOperation.class);
 
-    public FetchHeartRateManualOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.MANUAL_HEART_RATE);
+    public FetchHeartRateManualOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.MANUAL_HEART_RATE);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_hr_data);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateMaxOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateMaxOperation.java
index 26189a4bf1..c6c0a7f1dc 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateMaxOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateMaxOperation.java
@@ -38,7 +38,7 @@ import nodomain.freeyourgadget.gadgetbridge.entities.Device;
 import nodomain.freeyourgadget.gadgetbridge.entities.HuamiHeartRateMaxSample;
 import nodomain.freeyourgadget.gadgetbridge.entities.User;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 /**
@@ -47,12 +47,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 public class FetchHeartRateMaxOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchHeartRateMaxOperation.class);
 
-    public FetchHeartRateMaxOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.MAX_HEART_RATE);
+    public FetchHeartRateMaxOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.MAX_HEART_RATE);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_hr_data);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateRestingOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateRestingOperation.java
index 818b00bdf4..b67380c59d 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateRestingOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHeartRateRestingOperation.java
@@ -38,7 +38,7 @@ import nodomain.freeyourgadget.gadgetbridge.entities.Device;
 import nodomain.freeyourgadget.gadgetbridge.entities.HuamiHeartRateRestingSample;
 import nodomain.freeyourgadget.gadgetbridge.entities.User;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 /**
@@ -47,12 +47,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 public class FetchHeartRateRestingOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchHeartRateRestingOperation.class);
 
-    public FetchHeartRateRestingOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.RESTING_HEART_RATE);
+    public FetchHeartRateRestingOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.RESTING_HEART_RATE);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_hr_data);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHrvOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHrvOperation.java
index dbb70377cf..c87c2f2e4f 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHrvOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchHrvOperation.java
@@ -34,7 +34,7 @@ import nodomain.freeyourgadget.gadgetbridge.devices.GenericHrvValueSampleProvide
 import nodomain.freeyourgadget.gadgetbridge.devices.huami.HuamiCoordinator;
 import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession;
 import nodomain.freeyourgadget.gadgetbridge.entities.GenericHrvValueSample;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 /**
@@ -43,12 +43,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 public class FetchHrvOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchHrvOperation.class);
 
-    public FetchHrvOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.HRV);
+    public FetchHrvOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.HRV);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_hrv_data);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchPaiOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchPaiOperation.java
index 667f72b159..83a2b7f4eb 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchPaiOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchPaiOperation.java
@@ -37,7 +37,7 @@ import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession;
 import nodomain.freeyourgadget.gadgetbridge.entities.Device;
 import nodomain.freeyourgadget.gadgetbridge.entities.HuamiPaiSample;
 import nodomain.freeyourgadget.gadgetbridge.entities.User;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 /**
@@ -46,12 +46,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 public class FetchPaiOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchPaiOperation.class);
 
-    public FetchPaiOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.PAI);
+    public FetchPaiOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.PAI);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_pai_data);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSleepRespiratoryRateOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSleepRespiratoryRateOperation.java
index 6c0ff201a2..21c96e00df 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSleepRespiratoryRateOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSleepRespiratoryRateOperation.java
@@ -37,7 +37,7 @@ import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession;
 import nodomain.freeyourgadget.gadgetbridge.entities.Device;
 import nodomain.freeyourgadget.gadgetbridge.entities.HuamiSleepRespiratoryRateSample;
 import nodomain.freeyourgadget.gadgetbridge.entities.User;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 /**
@@ -46,12 +46,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 public class FetchSleepRespiratoryRateOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchSleepRespiratoryRateOperation.class);
 
-    public FetchSleepRespiratoryRateOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.SLEEP_RESPIRATORY_RATE);
+    public FetchSleepRespiratoryRateOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.SLEEP_RESPIRATORY_RATE);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_sleep_respiratory_rate_data);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSleepSessionOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSleepSessionOperation.java
index c0997d4dd4..f502933abb 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSleepSessionOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSleepSessionOperation.java
@@ -34,7 +34,7 @@ import nodomain.freeyourgadget.gadgetbridge.devices.huami.HuamiSleepSessionSampl
 import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession;
 import nodomain.freeyourgadget.gadgetbridge.entities.HuamiSleepSessionSample;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 /**
@@ -43,12 +43,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 public class FetchSleepSessionOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchSleepSessionOperation.class);
 
-    public FetchSleepSessionOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.SLEEP_SESSION);
+    public FetchSleepSessionOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.SLEEP_SESSION);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_sleep_data);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSpo2NormalOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSpo2NormalOperation.java
index 0583fc90ca..6982992a67 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSpo2NormalOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSpo2NormalOperation.java
@@ -38,7 +38,7 @@ import nodomain.freeyourgadget.gadgetbridge.entities.Device;
 import nodomain.freeyourgadget.gadgetbridge.entities.HuamiSpo2Sample;
 import nodomain.freeyourgadget.gadgetbridge.entities.User;
 import nodomain.freeyourgadget.gadgetbridge.model.Spo2Sample;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 /**
@@ -47,12 +47,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 public class FetchSpo2NormalOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchSpo2NormalOperation.class);
 
-    public FetchSpo2NormalOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.SPO2_NORMAL);
+    public FetchSpo2NormalOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.SPO2_NORMAL);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_spo2_data);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSpo2SleepOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSpo2SleepOperation.java
index c013b5218d..5f1db130da 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSpo2SleepOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSpo2SleepOperation.java
@@ -24,7 +24,7 @@ import java.nio.ByteOrder;
 import java.util.GregorianCalendar;
 
 import nodomain.freeyourgadget.gadgetbridge.R;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 
 /**
  * An operation that fetches SPO2 data for sleep measurements (this requires sleep breathing quality enabled).
@@ -32,12 +32,12 @@ import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
 public class FetchSpo2SleepOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchSpo2SleepOperation.class);
 
-    public FetchSpo2SleepOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.SPO2_SLEEP);
+    public FetchSpo2SleepOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.SPO2_SLEEP);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_spo2_data);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSportsDetailsOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSportsDetailsOperation.java
index b8c1d7477b..6148a0218e 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSportsDetailsOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSportsDetailsOperation.java
@@ -39,9 +39,8 @@ import nodomain.freeyourgadget.gadgetbridge.export.GPXExporter;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivityKind;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivityTrack;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.AbstractHuamiActivityDetailsParser;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiActivityDetailsParser;
 import nodomain.freeyourgadget.gadgetbridge.util.DateTimeUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;
@@ -57,13 +56,12 @@ public class FetchSportsDetailsOperation extends AbstractFetchOperation {
     private final BaseActivitySummary summary;
     private final String lastSyncTimeKey;
 
-    FetchSportsDetailsOperation(@NonNull BaseActivitySummary summary,
-                                @NonNull AbstractHuamiActivityDetailsParser detailsParser,
-                                @NonNull HuamiSupport support,
-                                @NonNull String lastSyncTimeKey,
+    FetchSportsDetailsOperation(@NonNull final BaseActivitySummary summary,
+                                @NonNull final AbstractHuamiActivityDetailsParser detailsParser,
+                                @NonNull final HuamiFetcher fetcher,
+                                @NonNull final String lastSyncTimeKey,
                                 int fetchCount) {
-        super(support);
-        setName("fetching sport details");
+        super(fetcher, HuamiFetchDataType.SPORTS_DETAILS);
         this.summary = summary;
         this.detailsParser = detailsParser;
         this.lastSyncTimeKey = lastSyncTimeKey;
@@ -71,15 +69,15 @@ public class FetchSportsDetailsOperation extends AbstractFetchOperation {
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_sports_details);
     }
 
     @Override
-    protected void startFetching(TransactionBuilder builder) {
-        LOG.info("start " + getName());
+    protected void startFetching() {
+        LOG.info("start {}", getName());
         final GregorianCalendar sinceWhen = getLastSuccessfulSyncTime();
-        startFetching(builder, HuamiFetchDataType.SPORTS_DETAILS.getCode(), sinceWhen);
+        startFetching(HuamiFetchDataType.SPORTS_DETAILS.getCode(), sinceWhen);
     }
 
     @Override
@@ -165,8 +163,8 @@ public class FetchSportsDetailsOperation extends AbstractFetchOperation {
         saveLastSyncTimestamp(endTime);
 
         if (needsAnotherFetch(endTime)) {
-            final FetchSportsSummaryOperation nextOperation = new FetchSportsSummaryOperation(getSupport(), fetchCount);
-            getSupport().getFetchOperationQueue().add(0, nextOperation);
+            final FetchSportsSummaryOperation nextOperation = new FetchSportsSummaryOperation(fetcher, fetchCount);
+            fetcher.getFetchOperationQueue().add(0, nextOperation);
         }
 
         return true;
@@ -174,8 +172,8 @@ public class FetchSportsDetailsOperation extends AbstractFetchOperation {
 
     private boolean needsAnotherFetch(GregorianCalendar lastSyncTimestamp) {
         // We have 2 operations per fetch round: summary + details
-        if (fetchCount > 10) {
-            LOG.warn("Already have 5 fetch rounds, not doing another one.");
+        if (fetchCount > 20) {
+            LOG.warn("Already have {} fetch rounds, not doing another one.", fetchCount/ 2);
             return false;
         }
 
@@ -207,14 +205,13 @@ public class FetchSportsDetailsOperation extends AbstractFetchOperation {
 
     private String saveRawBytes() {
         final String fileName = FileUtils.makeValidFileName(String.format("%s.bin", DateTimeUtils.formatIso8601(summary.getStartTime())));
-        FileOutputStream outputStream = null;
 
         try {
             final File targetFolder = new File(FileUtils.getExternalFilesDir(), "rawDetails");
             //noinspection ResultOfMethodCallIgnored
             targetFolder.mkdirs();
             final File targetFile = new File(targetFolder, fileName);
-            outputStream = new FileOutputStream(targetFile);
+            final FileOutputStream outputStream = new FileOutputStream(targetFile);
             outputStream.write(buffer.toByteArray());
             outputStream.close();
             return targetFile.getAbsolutePath();
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSportsSummaryOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSportsSummaryOperation.java
index 4617930fbb..980e8a372f 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSportsSummaryOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchSportsSummaryOperation.java
@@ -35,9 +35,8 @@ import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession;
 import nodomain.freeyourgadget.gadgetbridge.entities.Device;
 import nodomain.freeyourgadget.gadgetbridge.entities.User;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivitySummaryParser;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.AbstractHuamiActivityDetailsParser;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 /**
@@ -47,22 +46,21 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 public class FetchSportsSummaryOperation extends AbstractFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchSportsSummaryOperation.class);
 
-    public FetchSportsSummaryOperation(HuamiSupport support, int fetchCount) {
-        super(support);
-        setName("fetching sport summaries");
+    public FetchSportsSummaryOperation(final HuamiFetcher fetcher, int fetchCount) {
+        super(fetcher, HuamiFetchDataType.SPORTS_SUMMARIES);
         this.fetchCount = fetchCount;
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_sports_summaries);
     }
 
     @Override
-    protected void startFetching(TransactionBuilder builder) {
-        LOG.info("start" + getName());
+    protected void startFetching() {
+        LOG.info("start {}", getName());
         final GregorianCalendar sinceWhen = getLastSuccessfulSyncTime();
-        startFetching(builder, HuamiFetchDataType.SPORTS_SUMMARIES.getCode(), sinceWhen);
+        startFetching(HuamiFetchDataType.SPORTS_SUMMARIES.getCode(), sinceWhen);
     }
 
     @Override
@@ -106,8 +104,8 @@ public class FetchSportsSummaryOperation extends AbstractFetchOperation {
         }
 
         final AbstractHuamiActivityDetailsParser detailsParser = ((HuamiActivitySummaryParser) summaryParser).getDetailsParser(summary);
-        final FetchSportsDetailsOperation nextOperation = new FetchSportsDetailsOperation(summary, detailsParser, getSupport(), getLastSyncTimeKey(), fetchCount);
-        getSupport().getFetchOperationQueue().add(0, nextOperation);
+        final FetchSportsDetailsOperation nextOperation = new FetchSportsDetailsOperation(summary, detailsParser, fetcher, getLastSyncTimeKey(), fetchCount);
+        fetcher.getFetchOperationQueue().add(0, nextOperation);
 
         return true;
     }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStatisticsOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStatisticsOperation.java
index 9c8cfc46eb..62021036ce 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStatisticsOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStatisticsOperation.java
@@ -23,7 +23,7 @@ import java.util.Date;
 import java.util.GregorianCalendar;
 
 import nodomain.freeyourgadget.gadgetbridge.R;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 
 /**
  * An operation that fetches statistics from /storage/statistics/ (hm_statis_data* files). We do not
@@ -32,12 +32,12 @@ import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
 public class FetchStatisticsOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchStatisticsOperation.class);
 
-    public FetchStatisticsOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.STATISTICS);
+    public FetchStatisticsOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.STATISTICS);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_statistics);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStressAutoOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStressAutoOperation.java
index 7f7bd1ed6a..a33a466272 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStressAutoOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStressAutoOperation.java
@@ -37,7 +37,7 @@ import nodomain.freeyourgadget.gadgetbridge.entities.Device;
 import nodomain.freeyourgadget.gadgetbridge.entities.HuamiStressSample;
 import nodomain.freeyourgadget.gadgetbridge.entities.User;
 import nodomain.freeyourgadget.gadgetbridge.model.StressSample;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 /**
@@ -46,12 +46,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 public class FetchStressAutoOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchStressAutoOperation.class);
 
-    public FetchStressAutoOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.STRESS_AUTOMATIC);
+    public FetchStressAutoOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.STRESS_AUTOMATIC);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_stress_data);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStressManualOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStressManualOperation.java
index ba40c9d9ca..e97fb17b13 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStressManualOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchStressManualOperation.java
@@ -39,7 +39,7 @@ import nodomain.freeyourgadget.gadgetbridge.entities.HuamiStressSample;
 import nodomain.freeyourgadget.gadgetbridge.entities.User;
 import nodomain.freeyourgadget.gadgetbridge.model.StressSample;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 /**
@@ -48,12 +48,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 public class FetchStressManualOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchStressManualOperation.class);
 
-    public FetchStressManualOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.STRESS_MANUAL);
+    public FetchStressManualOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.STRESS_MANUAL);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_stress_data);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchTemperatureOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchTemperatureOperation.java
index 1502f2c8a0..ad2cc2d24b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchTemperatureOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/fetch/FetchTemperatureOperation.java
@@ -35,7 +35,7 @@ import nodomain.freeyourgadget.gadgetbridge.devices.GenericTemperatureSampleProv
 import nodomain.freeyourgadget.gadgetbridge.devices.huami.HuamiCoordinator;
 import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession;
 import nodomain.freeyourgadget.gadgetbridge.entities.GenericTemperatureSample;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
 import nodomain.freeyourgadget.gadgetbridge.util.DateTimeUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
@@ -45,12 +45,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 public class FetchTemperatureOperation extends AbstractRepeatingFetchOperation {
     private static final Logger LOG = LoggerFactory.getLogger(FetchTemperatureOperation.class);
 
-    public FetchTemperatureOperation(final HuamiSupport support) {
-        super(support, HuamiFetchDataType.TEMPERATURE);
+    public FetchTemperatureOperation(final HuamiFetcher fetcher) {
+        super(fetcher, HuamiFetchDataType.TEMPERATURE);
     }
 
     @Override
-    protected String taskDescription() {
+    public String taskDescription() {
         return getContext().getString(R.string.busy_task_fetch_temperature);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/update/UpdateFirmwareOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/update/UpdateFirmwareOperation.java
index bad786ac92..1c822ebe37 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/update/UpdateFirmwareOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/update/UpdateFirmwareOperation.java
@@ -39,13 +39,13 @@ import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.actions.SetDeviceBusyAction;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.actions.SetProgressAction;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.AbstractHuamiFirmwareInfo;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.AbstractHuamiOperation;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFirmwareType;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.miband.operations.AbstractMiBandOperation;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
 
-public class UpdateFirmwareOperation extends AbstractHuamiOperation {
+public class UpdateFirmwareOperation extends AbstractMiBandOperation<HuamiSupport> {
     private static final Logger LOG = LoggerFactory.getLogger(UpdateFirmwareOperation.class);
 
     protected final Uri uri;
@@ -66,6 +66,11 @@ public class UpdateFirmwareOperation extends AbstractHuamiOperation {
         builder.notify(fwCControlChar, enable);
     }
 
+    @Override
+    protected void enableOtherNotifications(final TransactionBuilder builder, final boolean enable) {
+        // Nothing to do
+    }
+
     @Override
     protected void doPerform() throws IOException {
         firmwareInfo = createFwInfo(uri, getContext());
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsSupport.java
index 195c251ba9..41d2e4bbbb 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsSupport.java
@@ -1078,7 +1078,7 @@ public class ZeppOsSupport extends HuamiSupport implements ZeppOsFileTransferSer
     }
 
     @Override
-    protected ZeppOsCoordinator getCoordinator() {
+    public ZeppOsCoordinator getCoordinator() {
         return (ZeppOsCoordinator) gbDevice.getDeviceCoordinator();
     }
 
```
-----------------------------------
