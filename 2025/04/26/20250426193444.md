# Commit: 8dabc0a71345ede8dd33c701833d66643c4bb516
## Message: Zepp OS: Btrfcomm support
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/HuamiService.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/AbstractBTLEDeviceSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiUtils.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/update/UpdateFirmwareOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtleTransactionBuilder.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsTransactionBuilder.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/AbstractZeppOsOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/ZeppOsFirmwareUpdateOperation.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsFileTransferService.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferImpl.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferV2.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferV3.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/XiaomiSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/preferences/DevicePrefs.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtbrSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtbrTransactionBuilder.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtleSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsCommunicator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsActivityFetchService.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsDeviceInfoService.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsTimeService.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/HuamiService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/HuamiService.java
index 871da89132..46fd0f4396 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/HuamiService.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/HuamiService.java
@@ -30,7 +30,7 @@ public class HuamiService {
     public static final UUID UUID_SERVICE_HEART_RATE = UUID.fromString(String.format(BASE_UUID, "180D"));
     public static final UUID UUID_SERVICE_FIRMWARE_SERVICE = UUID.fromString("00001530-0000-3512-2118-0009af100700");
 
-    public static final UUID UUID_CHARACTERISTIC_FIRMWARE = UUID.fromString("00001531-0000-3512-2118-0009af100700");
+    public static final UUID UUID_CHARACTERISTIC_FIRMWARE_CONTROL = UUID.fromString("00001531-0000-3512-2118-0009af100700");
     public static final UUID UUID_CHARACTERISTIC_FIRMWARE_DATA = UUID.fromString("00001532-0000-3512-2118-0009af100700");
 
     public static final UUID UUID_UNKNOWN_CHARACTERISTIC0 = UUID.fromString("00000000-0000-3512-2118-0009af100700");
@@ -58,6 +58,8 @@ public class HuamiService {
     public static final UUID UUID_CHARACTERISTIC_CHUNKEDTRANSFER_2021_READ = UUID.fromString("00000017-0000-3512-2118-0009af100700");
     public static final UUID UUID_CHARACTERISTIC_CHUNKEDTRANSFER = UUID.fromString("00000020-0000-3512-2118-0009af100700");
 
+    public static final UUID UUID_BT_SERIAL_SERVICE = UUID.fromString("00000022-0000-3512-2118-0009af100700");
+
     public static final UUID UUID_CHARACTERISTIC_ZEPP_OS_FILE_TRANSFER_V3_SEND = UUID.fromString("00000023-0000-3512-2118-0009af100700");
     public static final UUID UUID_CHARACTERISTIC_ZEPP_OS_FILE_TRANSFER_V3_RECEIVE = UUID.fromString("00000024-0000-3512-2118-0009af100700");
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsCoordinator.java
index ab469d325d..d8b7ea5874 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsCoordinator.java
@@ -22,6 +22,8 @@ import android.net.Uri;
 
 import androidx.annotation.NonNull;
 
+import org.apache.commons.lang3.ArrayUtils;
+
 import java.io.File;
 import java.io.IOException;
 import java.util.ArrayList;
@@ -33,6 +35,7 @@ import java.util.Map;
 import java.util.Set;
 import java.util.regex.Pattern;
 
+import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AppManagerActivity;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsUtils;
@@ -41,6 +44,7 @@ import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSpec
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSpecificSettingsScreen;
 import nodomain.freeyourgadget.gadgetbridge.capabilities.HeartRateCapability;
 import nodomain.freeyourgadget.gadgetbridge.capabilities.password.PasswordCapabilityImpl;
+import nodomain.freeyourgadget.gadgetbridge.devices.DeviceCoordinator;
 import nodomain.freeyourgadget.gadgetbridge.devices.InstallHandler;
 import nodomain.freeyourgadget.gadgetbridge.devices.SampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.devices.SleepAsAndroidFeature;
@@ -57,8 +61,9 @@ import nodomain.freeyourgadget.gadgetbridge.model.Vo2MaxSample;
 import nodomain.freeyourgadget.gadgetbridge.service.DeviceSupport;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiLanguageType;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiVibrationPatternNotificationType;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsBtbrSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsBtleSupport;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsFwInstallHandler;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsSupport;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsAssistantService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsConfigService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsContactsService;
@@ -100,7 +105,20 @@ public abstract class ZeppOsCoordinator extends HuamiCoordinator {
     @NonNull
     @Override
     public final Class<? extends DeviceSupport> getDeviceSupportClass(final GBDevice device) {
-        return ZeppOsSupport.class;
+        // Prioritize user choice
+        DeviceCoordinator.ConnectionType connType = GBApplication.getDevicePrefs(device).getForcedConnectionTypeFromPrefs();
+        if (connType == DeviceCoordinator.ConnectionType.BOTH) {
+            connType = getConnectionType();
+        }
+
+        switch (connType) {
+            case BOTH:
+            case BT_CLASSIC:
+                return ZeppOsBtbrSupport.class;
+            case BLE:
+            default:
+                return ZeppOsBtleSupport.class;
+        }
     }
 
     @Override
@@ -351,6 +369,18 @@ public abstract class ZeppOsCoordinator extends HuamiCoordinator {
         return supportsDisplayItem(device, "voice_memos") && supportsBleFileTransfer(device, "voicememo");
     }
 
+    @Override
+    public int[] getSupportedDeviceSpecificConnectionSettings() {
+        final List<Integer> settings = new ArrayList<>();
+
+        settings.add(R.xml.devicesettings_force_connection_type);
+
+        return ArrayUtils.addAll(
+                ArrayUtils.toPrimitive(settings.toArray(new Integer[0])),
+                super.getSupportedDeviceSpecificConnectionSettings()
+        );
+    }
+
     /**
      * Returns a superset of all settings supported by Zepp OS Devices. Unsupported settings are removed
      * by {@link ZeppOsSettingsCustomizer}.
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/AbstractBTLEDeviceSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/AbstractBTLEDeviceSupport.java
index 86f69a43cd..813fc06960 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/AbstractBTLEDeviceSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/AbstractBTLEDeviceSupport.java
@@ -25,6 +25,8 @@ import android.bluetooth.BluetoothGattDescriptor;
 import android.bluetooth.BluetoothGattService;
 import android.content.Context;
 
+import androidx.annotation.CallSuper;
+
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -112,6 +114,7 @@ public abstract class AbstractBTLEDeviceSupport extends AbstractDeviceSupport im
         }
     }
 
+    @CallSuper
     @Override
     public void setContext(GBDevice gbDevice, BluetoothAdapter btAdapter, Context context) {
         super.setContext(gbDevice, btAdapter, context);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiSupport.java
index 0cef97a59c..d7e99ab099 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiSupport.java
@@ -1442,7 +1442,7 @@ public abstract class HuamiSupport extends AbstractBTLEDeviceSupport
     }
 
     public void sendReboot(TransactionBuilder builder) {
-        builder.write(getCharacteristic(HuamiService.UUID_CHARACTERISTIC_FIRMWARE), new byte[] { HuamiService.COMMAND_FIRMWARE_REBOOT});
+        builder.write(getCharacteristic(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_CONTROL), new byte[] { HuamiService.COMMAND_FIRMWARE_REBOOT});
     }
 
     public void sendFactoryReset(TransactionBuilder builder) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiUtils.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiUtils.java
index b7d45ba04a..d88235a056 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiUtils.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/HuamiUtils.java
@@ -23,13 +23,18 @@ import org.slf4j.LoggerFactory;
 
 import java.nio.ByteBuffer;
 import java.nio.ByteOrder;
+import java.time.Instant;
+import java.time.ZoneId;
+import java.time.zone.ZoneRules;
 import java.util.ArrayList;
+import java.util.Calendar;
 import java.util.Collections;
 import java.util.List;
 
 import nodomain.freeyourgadget.gadgetbridge.devices.huami.HuamiCoordinator;
 import nodomain.freeyourgadget.gadgetbridge.devices.miband.VibrationProfile;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
 
 public class HuamiUtils {
     private static final Logger LOG = LoggerFactory.getLogger(HuamiUtils.class);
@@ -143,4 +148,36 @@ public class HuamiUtils {
 
         return buf.array();
     }
+
+    public static byte[] getCurrentTimeBytes() {
+        // It seems that the format sent to the Current Time characteristic changed in newer devices
+        // to kind-of match the GATT spec, but it doesn't quite respect it?
+        // - 11 bytes get sent instead of 10 (extra byte at the end for the offset in quarter-hours?)
+        // - Day of week starts at 0
+        // Otherwise, the command gets rejected with an "Out of Range" error and init fails.
+
+        final Calendar timestamp = BLETypeConversions.createCalendar();
+
+        final ByteBuffer buf = ByteBuffer.allocate(11).order(ByteOrder.LITTLE_ENDIAN);
+        buf.putShort((short) timestamp.get(Calendar.YEAR));
+        buf.put((byte) (timestamp.get(Calendar.MONTH) + 1));
+        buf.put((byte) timestamp.get(Calendar.DATE));
+        buf.put((byte) timestamp.get(Calendar.HOUR_OF_DAY));
+        buf.put((byte) timestamp.get(Calendar.MINUTE));
+        buf.put((byte) timestamp.get(Calendar.SECOND));
+        buf.put((byte) (timestamp.get(Calendar.DAY_OF_WEEK) - 1));
+        buf.put(BLETypeConversions.fromUint8((int) (timestamp.get(Calendar.MILLISECOND) / 1000. * 256))); // Fractions256
+
+        final ZoneId zoneId = ZoneId.systemDefault();
+        final ZoneRules rules = zoneId.getRules();
+        // reason
+        if (rules.isDaylightSavings(Instant.now())) {
+            buf.put((byte) 0x08);
+        } else {
+            buf.put((byte) 0x00);
+        }
+        buf.put((byte) (rules.getOffset(Instant.now()).getTotalSeconds() / (60 * 15)));
+
+        return buf.array();
+    }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/update/UpdateFirmwareOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/update/UpdateFirmwareOperation.java
index 1c822ebe37..4841683726 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/update/UpdateFirmwareOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/operations/update/UpdateFirmwareOperation.java
@@ -57,7 +57,7 @@ public class UpdateFirmwareOperation extends AbstractMiBandOperation<HuamiSuppor
     public UpdateFirmwareOperation(Uri uri, HuamiSupport support) {
         super(support);
         this.uri = uri;
-        fwCControlChar = getCharacteristic(HuamiService.UUID_CHARACTERISTIC_FIRMWARE);
+        fwCControlChar = getCharacteristic(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_CONTROL);
         fwCDataChar = getCharacteristic(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_DATA);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtbrSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtbrSupport.java
new file mode 100644
index 0000000000..02576ce1c0
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtbrSupport.java
@@ -0,0 +1,499 @@
+/*  Copyright (C) 2025 José Rebelo
+
+    This file is part of Gadgetbridge.
+
+    Gadgetbridge is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published
+    by the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    Gadgetbridge is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
+package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos;
+
+import android.bluetooth.BluetoothAdapter;
+import android.content.Context;
+import android.location.Location;
+import android.net.Uri;
+import android.os.Bundle;
+import android.util.SparseArray;
+
+import org.apache.commons.lang3.RandomUtils;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+import java.nio.ByteBuffer;
+import java.nio.ByteOrder;
+import java.util.ArrayList;
+import java.util.HashMap;
+import java.util.Map;
+import java.util.UUID;
+
+import nodomain.freeyourgadget.gadgetbridge.capabilities.loyaltycards.LoyaltyCard;
+import nodomain.freeyourgadget.gadgetbridge.devices.huami.HuamiService;
+import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
+import nodomain.freeyourgadget.gadgetbridge.model.Alarm;
+import nodomain.freeyourgadget.gadgetbridge.model.CalendarEventSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.CallSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.CannedMessagesSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.Contact;
+import nodomain.freeyourgadget.gadgetbridge.model.MusicSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.MusicStateSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.NotificationSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.Reminder;
+import nodomain.freeyourgadget.gadgetbridge.model.WeatherSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.WorldClock;
+import nodomain.freeyourgadget.gadgetbridge.service.btbr.AbstractBTBRDeviceSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.btbr.TransactionBuilder;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
+import nodomain.freeyourgadget.gadgetbridge.util.CheckSums;
+import nodomain.freeyourgadget.gadgetbridge.util.GB;
+import nodomain.freeyourgadget.gadgetbridge.util.StringUtils;
+
+public class ZeppOsBtbrSupport extends AbstractBTBRDeviceSupport implements ZeppOsCommunicator {
+    private static final Logger LOG = LoggerFactory.getLogger(ZeppOsBtbrSupport.class);
+
+    private static final int MAX_MTU = 32768;
+
+    private static final byte PACKET_PREAMBLE = 0x55;
+    private static final byte PACKET_TRAILER = (byte) 0xaa;
+
+    private static final byte CMD_CHANNELS_GET = 0x01;
+    private static final byte CMD_CHANNELS_RET = 0x02;
+    private static final byte CMD_SESSION_START = 0x03;
+    private static final byte CMD_SESSION_ACK = 0x04;
+    private static final byte CMD_CHANNEL_DATA = 0x07;
+    private static final byte CMD_CHANNEL_ACK = 0x08;
+
+    private byte seqNumTx = 0x00;
+    private byte seqNumRx = 0x5a;
+
+    private byte sessionNumber;
+    private int sessionNonce;
+
+    private final ByteBuffer packetBuffer = ByteBuffer.allocate(MAX_MTU).order(ByteOrder.LITTLE_ENDIAN);
+
+    private final ZeppOsSupport zeppOsSupport = new ZeppOsSupport(this);
+
+    private final SparseArray<UUID> channelToCharacteristic = new SparseArray<>();
+    private final Map<UUID, Short> characteristicToChannel = new HashMap<>();
+
+    public ZeppOsBtbrSupport() {
+        super(LOG);
+        addSupportedService(HuamiService.UUID_BT_SERIAL_SERVICE);
+        setBufferSize(MAX_MTU);
+    }
+
+    @Override
+    public void setContext(final GBDevice gbDevice, final BluetoothAdapter btAdapter, final Context context) {
+        super.setContext(gbDevice, btAdapter, context);
+        zeppOsSupport.setContext(gbDevice, btAdapter, context);
+    }
+
+    @Override
+    public boolean useAutoConnect() {
+        return true;
+    }
+
+    @Override
+    public void dispose() {
+        zeppOsSupport.dispose();
+    }
+
+    @Override
+    protected TransactionBuilder initializeDevice(final TransactionBuilder builder) {
+        write(builder, CMD_CHANNELS_GET, new byte[]{});
+        return builder;
+    }
+
+    @Override
+    public void onSocketRead(final byte[] data) {
+        packetBuffer.put(data);
+        packetBuffer.flip();
+
+        while (packetBuffer.hasRemaining()) {
+            packetBuffer.mark();
+            if (packetBuffer.remaining() < 8) {
+                // not enough bytes for min packet
+                packetBuffer.reset();
+                continue;
+            }
+
+            final byte preamble = packetBuffer.get();
+            if (preamble != PACKET_PREAMBLE) {
+                LOG.warn("Unexpected byte {} is not preamble, skipping 1b", String.format("0x%02x", preamble));
+                continue;
+            }
+
+            final byte cmd = packetBuffer.get();
+            final byte seqNum = packetBuffer.get();
+            // TODO check seqNum
+
+            final int length = packetBuffer.getShort();
+            if (packetBuffer.remaining() < length + 3) {
+                // not enough bytes for payload + crc + trailer
+                packetBuffer.reset();
+                continue;
+            }
+            final byte[] payload = new byte[length];
+            packetBuffer.get(payload);
+
+            final short expectedCrc = packetBuffer.getShort();
+
+            final byte trailer = packetBuffer.get();
+            if (trailer != PACKET_TRAILER) {
+                LOG.warn("Unexpected byte {} is not trailer, skipping 1b", String.format("0x%02x", trailer));
+                // if we made it this far, just rewind 1 byte and continue
+                packetBuffer.position(packetBuffer.position() - 1);
+                continue;
+            }
+
+            final short actualCrc = (short) crc16(cmd, seqNum, payload);
+            if (expectedCrc != actualCrc) {
+                LOG.warn(
+                        "Packet has invalid crc, got {}, expected {}",
+                        String.format("%04x", actualCrc),
+                        String.format("%04x", expectedCrc)
+                );
+                continue;
+            }
+
+            handlePacket(cmd, payload);
+        }
+
+        packetBuffer.compact();
+    }
+
+    public void write(final TransactionBuilder builder, final byte cmd, final byte[] payload) {
+        final ByteBuffer buf = ByteBuffer.allocate(payload.length + 8).order(ByteOrder.LITTLE_ENDIAN);
+
+        final byte seqNum = seqNumTx++;
+        buf.put(PACKET_PREAMBLE);
+        buf.put(cmd);
+        buf.put(seqNum);
+        buf.putShort((short) payload.length);
+        if (payload.length > 0) {
+            buf.put(payload);
+        }
+        buf.putShort((short) crc16(cmd, seqNum, payload));
+        buf.put(PACKET_TRAILER);
+
+        builder.write(buf.array());
+    }
+
+    protected void write(final TransactionBuilder builder, final UUID characteristic, final byte[] value) {
+        final Short channel = characteristicToChannel.get(characteristic);
+        if (channel == null) {
+            LOG.error("Unknown characteristic {}", characteristic);
+            return;
+        }
+        final ByteBuffer buf = ByteBuffer.allocate(value.length + 4).order(ByteOrder.LITTLE_ENDIAN);
+        buf.put(sessionNumber);
+        buf.putShort(channel);
+        buf.put((byte) 0); // TODO request ack?
+        buf.put(value);
+        write(builder, CMD_CHANNEL_DATA, buf.array());
+    }
+
+    private void handlePacket(final byte cmd, final byte[] payload) {
+        final ByteBuffer buf = ByteBuffer.wrap(payload).order(ByteOrder.LITTLE_ENDIAN);
+
+        switch (cmd) {
+            case CMD_CHANNELS_RET: {
+                final int version = buf.get() & 0xff; // ?
+                if (version > 1) {
+                    // TODO warn and disconnect
+                }
+                final int numCharacteristics = buf.getShort();
+                LOG.debug("Got channels version={}, numCharacteristics={}", version, numCharacteristics);
+                channelToCharacteristic.clear();
+                characteristicToChannel.clear();
+                for (int i = 0; i < numCharacteristics; i++) {
+                    final String characteristicUuid = StringUtils.untilNullTerminator(buf);
+                    final short characteristicNumber = buf.getShort();
+
+                    LOG.debug("Got characteristic uuid={} num={}", characteristicUuid, characteristicNumber);
+                    channelToCharacteristic.put(characteristicNumber, UUID.fromString(characteristicUuid));
+                    characteristicToChannel.put(UUID.fromString(characteristicUuid), characteristicNumber);
+                }
+
+                sessionNonce = RandomUtils.insecure().randomInt();
+                final TransactionBuilder builder = createTransactionBuilder("session start");
+                write(builder, CMD_SESSION_START, BLETypeConversions.fromUint32(sessionNonce));
+                builder.queue(getQueue());
+                return;
+            }
+            case CMD_SESSION_ACK: {
+                final int nonce = buf.getInt();
+                if (nonce != sessionNonce) {
+                    LOG.error("Got unexpected session nonce {}, expected {}", nonce, sessionNonce);
+                    // TODO reconnect?
+                    return;
+                }
+                final int status = buf.get() & 0xff;
+                if (status != 1) {
+                    LOG.error("Got unexpected status {}", status);
+                    // TODO reconnect?
+                    return;
+                }
+                sessionNumber = buf.get();
+                final int mtu = buf.getShort() & 0xFFFF;
+                zeppOsSupport.setMtu(mtu);
+
+                if (mtu > MAX_MTU) {
+                    LOG.error("MTU is larger than {}, there may be issues", MAX_MTU);
+                }
+
+                // TODO 3 bytes - 08:07:01?
+
+                LOG.debug("Got session ack, sessionNumber={}, mtu={}", sessionNumber, mtu);
+
+                final ZeppOsTransactionBuilder builder = createZeppOsTransactionBuilder("auth phase 1");
+                zeppOsSupport.initializeDevice(builder);
+                builder.queue(zeppOsSupport);
+
+                return;
+            }
+            case CMD_CHANNEL_DATA: {
+                final byte session = buf.get();
+                if (session != sessionNumber) {
+                    LOG.error("Got data for unknown session {}, expected {}", session, sessionNumber);
+                    return;
+                }
+                final short channel = buf.getShort();
+                final byte mustAck = buf.get();
+                final byte[] dataPayload = new byte[buf.remaining()];
+                buf.get(dataPayload);
+                final UUID uuid = channelToCharacteristic.get(channel);
+                if (uuid == null) {
+                    LOG.error("Channel {} does not match any known characteristic", channel);
+                }
+                zeppOsSupport.onCharacteristicChanged(uuid, dataPayload);
+                if (mustAck != 0) {
+                    // TODO ack
+                    //final TransactionBuilder builder = createTransactionBuilder("ack");
+                    //write(builder, CMD_SESSION_START, BLETypeConversions.fromUint32(sessionNonce));
+                    //builder.queue(getQueue());
+                }
+                return;
+            }
+            case CMD_CHANNEL_ACK: {
+                final byte session = buf.get();
+                final byte seqNum = buf.get();
+                final byte status = buf.get(); // 1 for ack
+                final byte unk = buf.get(); // 0?
+                LOG.debug("Got ack for session={}, seqNum={}, status={}, unk={}", session, seqNum, status, unk);
+                return;
+            }
+        }
+
+        LOG.warn("Unexpected cmd={}, payload={}", String.format("0x%02x", cmd), GB.hexdump(payload));
+    }
+
+    private int crc16(final byte command, final byte seqNum, final byte[] payload) {
+        int crc = CheckSums.getCRC16(new byte[]{command});
+        crc = CheckSums.getCRC16(new byte[]{seqNum}, crc);
+        crc = CheckSums.getCRC16(BLETypeConversions.fromUint16(payload.length), crc);
+        crc = CheckSums.getCRC16(payload, crc);
+        return crc;
+    }
+
+    // =============================================================================================
+    // ZeppOsCommunicator
+    // =============================================================================================
+
+    @Override
+    public ZeppOsTransactionBuilder createZeppOsTransactionBuilder(final String taskName) {
+        return new ZeppOsBtbrTransactionBuilder(this, taskName);
+    }
+
+    @Override
+    public void setCurrentTime(final ZeppOsTransactionBuilder builder) {
+        LOG.error("Set current time not supported on Btbr");
+    }
+
+    @Override
+    public void requestDeviceInfo(final ZeppOsTransactionBuilder builder) {
+        LOG.error("Request device info not supported on Btbr");
+    }
+
+    @Override
+    public void onAuthenticationSuccess(final ZeppOsTransactionBuilder builder) {
+        // Nothing to do
+    }
+
+    // =============================================================================================
+    // Pass-through to zeppOsSupport
+    // =============================================================================================
+
+    @Override
+    public void onSendConfiguration(final String config) {
+        zeppOsSupport.onSendConfiguration(config);
+    }
+
+    @Override
+    public void onTestNewFunction() {
+        zeppOsSupport.onTestNewFunction();
+    }
+
+
+    @Override
+    public void onFindDevice(final boolean start) {
+        zeppOsSupport.onFindDevice(start);
+    }
+
+    @Override
+    public void onFetchRecordedData(final int dataTypes) {
+        zeppOsSupport.onFetchRecordedData(dataTypes);
+    }
+
+    @Override
+    public void onFindPhone(final boolean start) {
+        zeppOsSupport.onFindPhone(start);
+    }
+
+    @Override
+    public void onScreenshotReq() {
+        zeppOsSupport.onScreenshotReq();
+    }
+
+    @Override
+    public void onSetHeartRateMeasurementInterval(final int seconds) {
+        zeppOsSupport.onSetHeartRateMeasurementInterval(seconds);
+    }
+
+    @Override
+    public void onAddCalendarEvent(final CalendarEventSpec calendarEventSpec) {
+        zeppOsSupport.onAddCalendarEvent(calendarEventSpec);
+    }
+
+    @Override
+    public void onDeleteCalendarEvent(final byte type, final long id) {
+        zeppOsSupport.onDeleteCalendarEvent(type, id);
+    }
+
+    @Override
+    public void onHeartRateTest() {
+        zeppOsSupport.onHeartRateTest();
+    }
+
+    @Override
+    public void onEnableRealtimeHeartRateMeasurement(final boolean enable) {
+        zeppOsSupport.onEnableRealtimeHeartRateMeasurement(enable);
+    }
+
+    @Override
+    public void onSetAlarms(final ArrayList<? extends Alarm> alarms) {
+        zeppOsSupport.onSetAlarms(alarms);
+    }
+
+    @Override
+    public void onSetCallState(final CallSpec callSpec) {
+        zeppOsSupport.onSetCallState(callSpec);
+    }
+
+    @Override
+    public void onNotification(final NotificationSpec notificationSpec) {
+        zeppOsSupport.onNotification(notificationSpec);
+    }
+
+    @Override
+    public void onSetReminders(final ArrayList<? extends Reminder> reminders) {
+        zeppOsSupport.onSetReminders(reminders);
+    }
+
+    @Override
+    public void onSetWorldClocks(ArrayList<? extends WorldClock> clocks) {
+        zeppOsSupport.onSetWorldClocks(clocks);
+    }
+
+    @Override
+    public void onSetLoyaltyCards(final ArrayList<LoyaltyCard> cards) {
+        zeppOsSupport.onSetLoyaltyCards(cards);
+    }
+
+    @Override
+    public void onSetContacts(ArrayList<? extends Contact> contacts) {
+        zeppOsSupport.onSetContacts(contacts);
+    }
+
+    @Override
+    public void onDeleteNotification(final int id) {
+        zeppOsSupport.onDeleteNotification(id);
+    }
+
+    @Override
+    public void onSetGpsLocation(final Location location) {
+        zeppOsSupport.onSetGpsLocation(location);
+    }
+
+    @Override
+    public void onSetCannedMessages(final CannedMessagesSpec cannedMessagesSpec) {
+        zeppOsSupport.onSetCannedMessages(cannedMessagesSpec);
+    }
+
+    @Override
+    public void onSetPhoneVolume(final float volume) {
+        zeppOsSupport.onSetPhoneVolume(volume);
+    }
+
+    @Override
+    public void onSetMusicState(final MusicStateSpec stateSpec) {
+        zeppOsSupport.onSetMusicState(stateSpec);
+    }
+
+    @Override
+    public void onSetMusicInfo(final MusicSpec musicSpec) {
+        zeppOsSupport.onSetMusicInfo(musicSpec);
+    }
+
+    @Override
+    public void onEnableRealtimeSteps(final boolean enable) {
+        zeppOsSupport.onEnableRealtimeSteps(enable);
+    }
+
+    @Override
+    public void onInstallApp(final Uri uri) {
+        zeppOsSupport.onInstallApp(uri);
+    }
+
+    @Override
+    public void onAppInfoReq() {
+        zeppOsSupport.onAppInfoReq();
+    }
+
+    @Override
+    public void onAppStart(final UUID uuid, final boolean start) {
+        zeppOsSupport.onAppStart(uuid, start);
+    }
+
+    @Override
+    public void onAppDelete(final UUID uuid) {
+        zeppOsSupport.onAppDelete(uuid);
+    }
+
+    @Override
+    public void onEnableHeartRateSleepSupport(final boolean enable) {
+        zeppOsSupport.onEnableHeartRateSleepSupport(enable);
+    }
+
+    @Override
+    public void onSetTime() {
+        zeppOsSupport.onSetTime();
+    }
+
+    @Override
+    public void onSendWeather(final ArrayList<WeatherSpec> weatherSpecs) {
+        zeppOsSupport.onSendWeather(weatherSpecs);
+    }
+
+    @Override
+    public void onSleepAsAndroidAction(final String action, final Bundle extras) {
+        zeppOsSupport.onSleepAsAndroidAction(action, extras);
+    }
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtbrTransactionBuilder.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtbrTransactionBuilder.java
new file mode 100644
index 0000000000..4129fd6cab
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtbrTransactionBuilder.java
@@ -0,0 +1,72 @@
+/*  Copyright (C) 2025 José Rebelo
+
+    This file is part of Gadgetbridge.
+
+    Gadgetbridge is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published
+    by the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    Gadgetbridge is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
+package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos;
+
+import android.content.Context;
+
+import java.util.UUID;
+
+import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
+import nodomain.freeyourgadget.gadgetbridge.service.btbr.TransactionBuilder;
+import nodomain.freeyourgadget.gadgetbridge.service.btbr.actions.SetDeviceBusyAction;
+import nodomain.freeyourgadget.gadgetbridge.service.btbr.actions.SetDeviceStateAction;
+import nodomain.freeyourgadget.gadgetbridge.service.btbr.actions.SetProgressAction;
+
+public class ZeppOsBtbrTransactionBuilder implements ZeppOsTransactionBuilder {
+    private final ZeppOsBtbrSupport mSupport;
+    private final TransactionBuilder mBuilder;
+
+    public ZeppOsBtbrTransactionBuilder(final ZeppOsBtbrSupport mSupport, final String taskName) {
+        this.mSupport = mSupport;
+        this.mBuilder = new TransactionBuilder(taskName);
+    }
+
+    public ZeppOsBtbrTransactionBuilder(final ZeppOsBtbrSupport mSupport, final TransactionBuilder builder) {
+        this.mSupport = mSupport;
+        this.mBuilder = builder;
+    }
+
+    @Override
+    public void setProgress(final String text, final boolean ongoing, final int percentage, final Context context) {
+        mBuilder.add(new SetProgressAction(text, ongoing, percentage, context));
+    }
+
+    @Override
+    public void setDeviceState(final GBDevice device, final GBDevice.State deviceState, final Context context) {
+        mBuilder.add(new SetDeviceStateAction(device, deviceState, context));
+    }
+
+    @Override
+    public void setBusy(final GBDevice device, final String string, final Context context) {
+        mBuilder.add(new SetDeviceBusyAction(device, string, context));
+    }
+
+    @Override
+    public void notify(final UUID characteristic, final boolean enable) {
+        // Nothing to do
+    }
+
+    @Override
+    public void write(final UUID characteristic, final byte[] arr) {
+        mSupport.write(mBuilder, characteristic, arr);
+    }
+
+    @Override
+    public void queue(final ZeppOsSupport support) {
+        mBuilder.queue(mSupport.getQueue());
+    }
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtleSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtleSupport.java
new file mode 100644
index 0000000000..d136d05ec4
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtleSupport.java
@@ -0,0 +1,375 @@
+/*  Copyright (C) 2025 José Rebelo
+
+    This file is part of Gadgetbridge.
+
+    Gadgetbridge is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published
+    by the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    Gadgetbridge is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
+package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos;
+
+import static nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions.fromUint16;
+import static nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions.fromUint8;
+import static nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions.mapTimeZone;
+
+import android.bluetooth.BluetoothAdapter;
+import android.bluetooth.BluetoothGatt;
+import android.bluetooth.BluetoothGattCharacteristic;
+import android.content.Context;
+import android.location.Location;
+import android.net.Uri;
+import android.os.Bundle;
+
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+import java.util.ArrayList;
+import java.util.Calendar;
+import java.util.UUID;
+
+import nodomain.freeyourgadget.gadgetbridge.capabilities.loyaltycards.LoyaltyCard;
+import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventVersionInfo;
+import nodomain.freeyourgadget.gadgetbridge.devices.huami.HuamiService;
+import nodomain.freeyourgadget.gadgetbridge.devices.miband.MiBandService;
+import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
+import nodomain.freeyourgadget.gadgetbridge.model.Alarm;
+import nodomain.freeyourgadget.gadgetbridge.model.CalendarEventSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.CallSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.CannedMessagesSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.Contact;
+import nodomain.freeyourgadget.gadgetbridge.model.MusicSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.MusicStateSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.NotificationSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.Reminder;
+import nodomain.freeyourgadget.gadgetbridge.model.WeatherSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.WorldClock;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.AbstractBTLEDeviceSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.GattCharacteristic;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.GattService;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.actions.SetDeviceStateAction;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.deviceinfo.DeviceInfo;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.deviceinfo.DeviceInfoProfile;
+
+public class ZeppOsBtleSupport extends AbstractBTLEDeviceSupport implements ZeppOsCommunicator {
+    private static final Logger LOG = LoggerFactory.getLogger(ZeppOsBtleSupport.class);
+
+    private final ZeppOsSupport zeppOsSupport = new ZeppOsSupport(this);
+
+    private final DeviceInfoProfile<ZeppOsBtleSupport> deviceInfoProfile;
+
+    public ZeppOsBtleSupport() {
+        super(LOG);
+
+        addSupportedService(GattService.UUID_SERVICE_HEART_RATE);
+        addSupportedService(GattService.UUID_SERVICE_DEVICE_INFORMATION);
+
+        addSupportedService(MiBandService.UUID_SERVICE_MIBAND_SERVICE);
+        addSupportedService(HuamiService.UUID_SERVICE_FIRMWARE_SERVICE);
+
+        deviceInfoProfile = new DeviceInfoProfile<>(this);
+        deviceInfoProfile.addListener(intent -> {
+            String s = intent.getAction();
+            if (DeviceInfoProfile.ACTION_DEVICE_INFO.equals(s)) {
+                final DeviceInfo info = intent.getParcelableExtra(DeviceInfoProfile.EXTRA_DEVICE_INFO);
+                LOG.debug("Device info: {}", info);
+                if (info == null) {
+                    return;
+                }
+                final GBDeviceEventVersionInfo versionCmd = new GBDeviceEventVersionInfo();
+                versionCmd.hwVersion = info.getHardwareRevision();
+                versionCmd.fwVersion = info.getFirmwareRevision();
+                if (versionCmd.fwVersion == null) {
+                    versionCmd.fwVersion = info.getSoftwareRevision();
+                }
+                if (versionCmd.fwVersion != null && !versionCmd.fwVersion.isEmpty() && versionCmd.fwVersion.charAt(0) == 'V') {
+                    versionCmd.fwVersion = versionCmd.fwVersion.substring(1);
+                }
+                handleGBDeviceEvent(versionCmd);
+            }
+        });
+        addSupportedProfile(deviceInfoProfile);
+    }
+
+    @Override
+    public void setContext(final GBDevice gbDevice, final BluetoothAdapter btAdapter, final Context context) {
+        super.setContext(gbDevice, btAdapter, context);
+        zeppOsSupport.setContext(gbDevice, btAdapter, context);
+    }
+
+    @Override
+    public boolean useAutoConnect() {
+        return true;
+    }
+
+    @Override
+    public void dispose() {
+        zeppOsSupport.dispose();
+    }
+
+    @Override
+    protected TransactionBuilder initializeDevice(final TransactionBuilder builder) {
+        final BluetoothGattCharacteristic characteristicChunked2021Read = getCharacteristic(HuamiService.UUID_CHARACTERISTIC_CHUNKEDTRANSFER_2021_READ);
+        final BluetoothGattCharacteristic characteristicChunked2021Write = getCharacteristic(HuamiService.UUID_CHARACTERISTIC_CHUNKEDTRANSFER_2021_WRITE);
+        if (characteristicChunked2021Write == null || characteristicChunked2021Read == null) {
+            LOG.warn("Chunked 2021 characteristics are null, will attempt to reconnect");
+            builder.add(new SetDeviceStateAction(getDevice(), GBDevice.State.WAITING_FOR_RECONNECT, getContext()));
+            return builder;
+        }
+
+        builder.notify(characteristicChunked2021Read, true);
+
+        final ZeppOsBtleTransactionBuilder zeppOsTransactionBuilder = new ZeppOsBtleTransactionBuilder(this, builder);
+
+        // #3219 - Reset the MTU before re-initializing the device, otherwise initialization will sometimes fail
+        zeppOsSupport.setMtu(23);
+        zeppOsSupport.initializeDevice(zeppOsTransactionBuilder);
+
+        return builder;
+    }
+
+    @Override
+    public boolean onCharacteristicChanged(final BluetoothGatt gatt,
+                                           final BluetoothGattCharacteristic characteristic) {
+        if (super.onCharacteristicChanged(gatt, characteristic)) {
+            // handled upstream
+            return true;
+        }
+
+        return zeppOsSupport.onCharacteristicChanged(characteristic.getUuid(), characteristic.getValue());
+    }
+
+    @Override
+    public void onMtuChanged(final BluetoothGatt gatt, final int mtu, final int status) {
+        super.onMtuChanged(gatt, mtu, status);
+        zeppOsSupport.setMtu(mtu);
+    }
+
+    // =============================================================================================
+    // ZeppOsCommunicator
+    // =============================================================================================
+
+    @Override
+    public ZeppOsTransactionBuilder createZeppOsTransactionBuilder(final String taskName) {
+        return new ZeppOsBtleTransactionBuilder(this, taskName);
+    }
+
+    @Override
+    public void setCurrentTime(final ZeppOsTransactionBuilder builder) {
+        // It seems that the format sent to the Current Time characteristic changed in newer devices
+        // to kind-of match the GATT spec, but it doesn't quite respect it?
+        // - 11 bytes get sent instead of 10 (extra byte at the end for the offset in quarter-hours?)
+        // - Day of week starts at 0
+        // Otherwise, the command gets rejected with an "Out of Range" error and init fails.
+
+        final Calendar timestamp = BLETypeConversions.createCalendar();
+        final byte[] year = fromUint16(timestamp.get(Calendar.YEAR));
+
+        final byte[] cmd = {
+                year[0],
+                year[1],
+                fromUint8(timestamp.get(Calendar.MONTH) + 1),
+                fromUint8(timestamp.get(Calendar.DATE)),
+                fromUint8(timestamp.get(Calendar.HOUR_OF_DAY)),
+                fromUint8(timestamp.get(Calendar.MINUTE)),
+                fromUint8(timestamp.get(Calendar.SECOND)),
+                fromUint8(timestamp.get(Calendar.DAY_OF_WEEK) - 1),
+                0x00, // Fractions256?
+                0x08, // Reason for change?
+                mapTimeZone(timestamp, BLETypeConversions.TZ_FLAG_INCLUDE_DST_IN_TZ), // TODO: Confirm this
+        };
+
+        builder.write(GattCharacteristic.UUID_CHARACTERISTIC_CURRENT_TIME, cmd);
+    }
+
+    @Override
+    public void requestDeviceInfo(final ZeppOsTransactionBuilder builder) {
+        deviceInfoProfile.requestDeviceInfo(((ZeppOsBtleTransactionBuilder) builder).getTransactionBuilder());
+    }
+
+    @Override
+    public void onAuthenticationSuccess(final ZeppOsTransactionBuilder builder) {
+        if (getDevicePrefs().allowHighMtu()) {
+            ((ZeppOsBtleTransactionBuilder) builder).getTransactionBuilder().requestMtu(247);
+        }
+    }
+
+    // =============================================================================================
+    // Pass-through to zeppOsSupport
+    // =============================================================================================
+
+    @Override
+    public void onSendConfiguration(final String config) {
+        zeppOsSupport.onSendConfiguration(config);
+    }
+
+    @Override
+    public void onTestNewFunction() {
+        zeppOsSupport.onTestNewFunction();
+    }
+
+
+    @Override
+    public void onFindDevice(final boolean start) {
+        zeppOsSupport.onFindDevice(start);
+    }
+
+    @Override
+    public void onFetchRecordedData(final int dataTypes) {
+        zeppOsSupport.onFetchRecordedData(dataTypes);
+    }
+
+    @Override
+    public void onFindPhone(final boolean start) {
+        zeppOsSupport.onFindPhone(start);
+    }
+
+    @Override
+    public void onScreenshotReq() {
+        zeppOsSupport.onScreenshotReq();
+    }
+
+    @Override
+    public void onSetHeartRateMeasurementInterval(final int seconds) {
+        zeppOsSupport.onSetHeartRateMeasurementInterval(seconds);
+    }
+
+    @Override
+    public void onAddCalendarEvent(final CalendarEventSpec calendarEventSpec) {
+        zeppOsSupport.onAddCalendarEvent(calendarEventSpec);
+    }
+
+    @Override
+    public void onDeleteCalendarEvent(final byte type, final long id) {
+        zeppOsSupport.onDeleteCalendarEvent(type, id);
+    }
+
+    @Override
+    public void onHeartRateTest() {
+        zeppOsSupport.onHeartRateTest();
+    }
+
+    @Override
+    public void onEnableRealtimeHeartRateMeasurement(final boolean enable) {
+        zeppOsSupport.onEnableRealtimeHeartRateMeasurement(enable);
+    }
+
+    @Override
+    public void onSetAlarms(final ArrayList<? extends Alarm> alarms) {
+        zeppOsSupport.onSetAlarms(alarms);
+    }
+
+    @Override
+    public void onSetCallState(final CallSpec callSpec) {
+        zeppOsSupport.onSetCallState(callSpec);
+    }
+
+    @Override
+    public void onNotification(final NotificationSpec notificationSpec) {
+        zeppOsSupport.onNotification(notificationSpec);
+    }
+
+    @Override
+    public void onSetReminders(final ArrayList<? extends Reminder> reminders) {
+        zeppOsSupport.onSetReminders(reminders);
+    }
+
+    @Override
+    public void onSetWorldClocks(ArrayList<? extends WorldClock> clocks) {
+        zeppOsSupport.onSetWorldClocks(clocks);
+    }
+
+    @Override
+    public void onSetLoyaltyCards(final ArrayList<LoyaltyCard> cards) {
+        zeppOsSupport.onSetLoyaltyCards(cards);
+    }
+
+    @Override
+    public void onSetContacts(ArrayList<? extends Contact> contacts) {
+        zeppOsSupport.onSetContacts(contacts);
+    }
+
+    @Override
+    public void onDeleteNotification(final int id) {
+        zeppOsSupport.onDeleteNotification(id);
+    }
+
+    @Override
+    public void onSetGpsLocation(final Location location) {
+        zeppOsSupport.onSetGpsLocation(location);
+    }
+
+    @Override
+    public void onSetCannedMessages(final CannedMessagesSpec cannedMessagesSpec) {
+        zeppOsSupport.onSetCannedMessages(cannedMessagesSpec);
+    }
+
+    @Override
+    public void onSetPhoneVolume(final float volume) {
+        zeppOsSupport.onSetPhoneVolume(volume);
+    }
+
+    @Override
+    public void onSetMusicState(final MusicStateSpec stateSpec) {
+        zeppOsSupport.onSetMusicState(stateSpec);
+    }
+
+    @Override
+    public void onSetMusicInfo(final MusicSpec musicSpec) {
+        zeppOsSupport.onSetMusicInfo(musicSpec);
+    }
+
+    @Override
+    public void onEnableRealtimeSteps(final boolean enable) {
+        zeppOsSupport.onEnableRealtimeSteps(enable);
+    }
+
+    @Override
+    public void onInstallApp(final Uri uri) {
+        zeppOsSupport.onInstallApp(uri);
+    }
+
+    @Override
+    public void onAppInfoReq() {
+        zeppOsSupport.onAppInfoReq();
+    }
+
+    @Override
+    public void onAppStart(final UUID uuid, final boolean start) {
+        zeppOsSupport.onAppStart(uuid, start);
+    }
+
+    @Override
+    public void onAppDelete(final UUID uuid) {
+        zeppOsSupport.onAppDelete(uuid);
+    }
+
+    @Override
+    public void onEnableHeartRateSleepSupport(final boolean enable) {
+        zeppOsSupport.onEnableHeartRateSleepSupport(enable);
+    }
+
+    @Override
+    public void onSetTime() {
+        zeppOsSupport.onSetTime();
+    }
+
+    @Override
+    public void onSendWeather(final ArrayList<WeatherSpec> weatherSpecs) {
+        zeppOsSupport.onSendWeather(weatherSpecs);
+    }
+
+    @Override
+    public void onSleepAsAndroidAction(final String action, final Bundle extras) {
+        zeppOsSupport.onSleepAsAndroidAction(action, extras);
+    }
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtleTransactionBuilder.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtleTransactionBuilder.java
index 989051f21f..0cff9c1fe4 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtleTransactionBuilder.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBtleTransactionBuilder.java
@@ -21,21 +21,21 @@ import android.content.Context;
 import java.util.UUID;
 
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.AbstractBTLEDeviceSupport;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.actions.SetDeviceBusyAction;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.actions.SetDeviceStateAction;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.actions.SetProgressAction;
 
 public class ZeppOsBtleTransactionBuilder implements ZeppOsTransactionBuilder {
-    private final AbstractBTLEDeviceSupport mSupport;
+    private final ZeppOsBtleSupport mSupport;
     private final TransactionBuilder mBuilder;
 
-    public ZeppOsBtleTransactionBuilder(final AbstractBTLEDeviceSupport mSupport, final String taskName) {
+    public ZeppOsBtleTransactionBuilder(final ZeppOsBtleSupport mSupport, final String taskName) {
         this.mSupport = mSupport;
         this.mBuilder = new TransactionBuilder(taskName);
     }
 
-    public ZeppOsBtleTransactionBuilder(final AbstractBTLEDeviceSupport mSupport, final TransactionBuilder builder) {
+    public ZeppOsBtleTransactionBuilder(final ZeppOsBtleSupport mSupport, final TransactionBuilder builder) {
         this.mSupport = mSupport;
         this.mBuilder = builder;
     }
@@ -50,6 +50,11 @@ public class ZeppOsBtleTransactionBuilder implements ZeppOsTransactionBuilder {
         mBuilder.add(new SetDeviceStateAction(device, deviceState, context));
     }
 
+    @Override
+    public void setBusy(final GBDevice device, final String string, final Context context) {
+        mBuilder.add(new SetDeviceBusyAction(device, string, context));
+    }
+
     @Override
     public void notify(final UUID characteristic, final boolean enable) {
         mBuilder.notify(mSupport.getCharacteristic(characteristic), enable);
@@ -62,6 +67,10 @@ public class ZeppOsBtleTransactionBuilder implements ZeppOsTransactionBuilder {
 
     @Override
     public void queue(final ZeppOsSupport support) {
-        mBuilder.queue(support.getQueue());
+        mBuilder.queue(mSupport.getQueue());
+    }
+
+    public TransactionBuilder getTransactionBuilder() {
+        return mBuilder;
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsCommunicator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsCommunicator.java
new file mode 100644
index 0000000000..f0ab6414cf
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsCommunicator.java
@@ -0,0 +1,24 @@
+/*  Copyright (C) 2025 José Rebelo
+
+    This file is part of Gadgetbridge.
+
+    Gadgetbridge is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published
+    by the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    Gadgetbridge is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
+package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos;
+
+public interface ZeppOsCommunicator {
+    ZeppOsTransactionBuilder createZeppOsTransactionBuilder(final String taskName);
+    void setCurrentTime(final ZeppOsTransactionBuilder builder);
+    void requestDeviceInfo(final ZeppOsTransactionBuilder builder);
+    void onAuthenticationSuccess(final ZeppOsTransactionBuilder builder);
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsSupport.java
index 3e4426b500..7af9819d3b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsSupport.java
@@ -17,15 +17,11 @@
 package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos;
 
 import static java.lang.Thread.sleep;
-import static nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions.fromUint16;
 import static nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions.fromUint8;
-import static nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions.mapTimeZone;
 import static nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsConfigService.ConfigArg.HEART_RATE_ALL_DAY_MONITORING;
 import static nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsConfigService.ConfigArg.SLEEP_HIGH_ACCURACY_MONITORING;
 
 import android.bluetooth.BluetoothAdapter;
-import android.bluetooth.BluetoothGatt;
-import android.bluetooth.BluetoothGattCharacteristic;
 import android.content.Context;
 import android.location.Location;
 import android.net.Uri;
@@ -65,13 +61,12 @@ import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventAppInfo;
 import nodomain.freeyourgadget.gadgetbridge.capabilities.loyaltycards.LoyaltyCard;
 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventDisplayMessage;
 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventScreenshot;
-import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventVersionInfo;
 import nodomain.freeyourgadget.gadgetbridge.devices.huami.zeppos.ZeppOsMapsInstallHandler;
 import nodomain.freeyourgadget.gadgetbridge.devices.huami.zeppos.ZeppOsMusicInstallHandler;
-import nodomain.freeyourgadget.gadgetbridge.devices.miband.MiBandService;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.model.RecordedDataTypes;
 import nodomain.freeyourgadget.gadgetbridge.model.WorldClock;
+import nodomain.freeyourgadget.gadgetbridge.service.AbstractDeviceSupport;
 import nodomain.freeyourgadget.gadgetbridge.service.SleepAsAndroidSender;
 import nodomain.freeyourgadget.gadgetbridge.devices.huami.zeppos.ZeppOsCoordinator;
 import nodomain.freeyourgadget.gadgetbridge.devices.huami.Huami2021Service;
@@ -92,24 +87,18 @@ import nodomain.freeyourgadget.gadgetbridge.model.MusicStateSpec;
 import nodomain.freeyourgadget.gadgetbridge.model.NotificationSpec;
 import nodomain.freeyourgadget.gadgetbridge.model.Reminder;
 import nodomain.freeyourgadget.gadgetbridge.model.WeatherSpec;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.AbstractBTLEDeviceSupport;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.GattCharacteristic;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.GattService;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.actions.SetDeviceStateAction;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.IntentListener;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.deviceinfo.DeviceInfo;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.deviceinfo.DeviceInfoProfile;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.Huami2021ChunkedDecoder;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.Huami2021ChunkedEncoder;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.Huami2021Handler;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiDevicePrefs;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.operations.ZeppOsFirmwareUpdateOperation;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.operations.ZeppOsAgpsUpdateOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.operations.ZeppOsFirmwareUpdateOperation;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.operations.ZeppOsGpxRouteUploadOperation;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.operations.ZeppOsMusicUploadOperation;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsActivityFetchService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsAgpsService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsAlarmsService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsAssistantService;
@@ -119,6 +108,7 @@ import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.service
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsCalendarService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsCannedMessagesService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsConnectionService;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsDeviceInfoService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsDisplayItemsService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsFindDeviceService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsHeartRateService;
@@ -139,6 +129,7 @@ import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.service
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsPhoneService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsSilentModeService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsStepsService;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsTimeService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsUserInfoService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsVibrationPatternsService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsVoiceMemosService;
@@ -153,48 +144,27 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
 import nodomain.freeyourgadget.gadgetbridge.util.RealtimeSamplesAggregator;
 
-public class ZeppOsSupport extends AbstractBTLEDeviceSupport
+public class ZeppOsSupport extends AbstractDeviceSupport
         implements Huami2021Handler, HuamiFetcher.HuamiFetchSupport, ZeppOsFileTransferService.DownloadCallback {
     private static final Logger LOG = LoggerFactory.getLogger(ZeppOsSupport.class);
 
+    private final ZeppOsCommunicator communicator;
+
     // Keep track of whether the rawSensor is enabled
     private boolean rawSensor = false;
     private ScheduledExecutorService rawSensorScheduler;
 
-    private final DeviceInfoProfile<ZeppOsSupport> deviceInfoProfile;
-    private final IntentListener mListener = intent -> {
-        String s = intent.getAction();
-        if (DeviceInfoProfile.ACTION_DEVICE_INFO.equals(s)) {
-            final DeviceInfo info = intent.getParcelableExtra(DeviceInfoProfile.EXTRA_DEVICE_INFO);
-            LOG.debug("Device info: {}", info);
-            if (info == null) {
-                return;
-            }
-            final GBDeviceEventVersionInfo versionCmd = new GBDeviceEventVersionInfo();
-            versionCmd.hwVersion = info.getHardwareRevision();
-            versionCmd.fwVersion = info.getFirmwareRevision();
-            if (versionCmd.fwVersion == null) {
-                versionCmd.fwVersion = info.getSoftwareRevision();
-            }
-            if (versionCmd.fwVersion != null && !versionCmd.fwVersion.isEmpty() && versionCmd.fwVersion.charAt(0) == 'V') {
-                versionCmd.fwVersion = versionCmd.fwVersion.substring(1);
-            }
-            handleGBDeviceEvent(versionCmd);
-        }
-    };
+    private int mMTU = 23;
 
-    protected static final int MIN_MTU = 23;
-    private int mMTU = MIN_MTU;
-    // Keep track of the previous MTU before reconnection, so that we can request it after reconnection
-    private int previousMtu = -1;
-
-    private Huami2021ChunkedEncoder huami2021ChunkedEncoder;
-    private Huami2021ChunkedDecoder huami2021ChunkedDecoder;
+    private final Huami2021ChunkedEncoder huami2021ChunkedEncoder = new Huami2021ChunkedEncoder(getMTU());
+    private final Huami2021ChunkedDecoder huami2021ChunkedDecoder = new Huami2021ChunkedDecoder(this, true);
 
     private final HuamiFetcher fetcher = new HuamiFetcher(this);
 
     private SleepAsAndroidSender sleepAsAndroidSender;
 
+    private ZeppOsFirmwareUpdateOperation firmwareUpdateOperation;
+
     // Services
     private final ZeppOsServicesService servicesService = new ZeppOsServicesService(this);
     private final ZeppOsAuthenticationService authenticationService = new ZeppOsAuthenticationService(this);
@@ -234,6 +204,9 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
     private final ZeppOsWorkoutService workoutService = new ZeppOsWorkoutService(this);
     private final ZeppOsHeartRateService heartRateService = new ZeppOsHeartRateService(this);
     private final ZeppOsStepsService stepsService = new ZeppOsStepsService(this);
+    private final ZeppOsActivityFetchService activityFetchService = new ZeppOsActivityFetchService(this, fetcher);
+    private final ZeppOsTimeService timeService = new ZeppOsTimeService(this);
+    private final ZeppOsDeviceInfoService deviceInfoService = new ZeppOsDeviceInfoService(this);
 
     private final Set<Short> mSupportedServices = new HashSet<>();
     private final Map<Short, AbstractZeppOsService> mServiceMap = new LinkedHashMap<Short, AbstractZeppOsService>() {{
@@ -275,20 +248,17 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
         put(workoutService.getEndpoint(), workoutService);
         put(heartRateService.getEndpoint(), heartRateService);
         put(stepsService.getEndpoint(), stepsService);
+        put(activityFetchService.getEndpoint(), activityFetchService);
+        put(timeService.getEndpoint(), timeService);
+        put(deviceInfoService.getEndpoint(), deviceInfoService);
     }};
 
-    public ZeppOsSupport() {
-        super(LOG);
+    public ZeppOsSupport(final ZeppOsCommunicator communicator) {
+        this.communicator = communicator;
+    }
 
-        addSupportedService(GattService.UUID_SERVICE_HEART_RATE);
-        addSupportedService(GattService.UUID_SERVICE_DEVICE_INFORMATION);
-
-        addSupportedService(MiBandService.UUID_SERVICE_MIBAND_SERVICE);
-        addSupportedService(HuamiService.UUID_SERVICE_FIRMWARE_SERVICE);
-
-        deviceInfoProfile = new DeviceInfoProfile<>(this);
-        deviceInfoProfile.addListener(mListener);
-        addSupportedProfile(deviceInfoProfile);
+    ZeppOsCommunicator getCommunicator() {
+        return communicator;
     }
 
     @Override
@@ -301,13 +271,14 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
     }
 
     @Override
-    public HuamiDevicePrefs getDevicePrefs() {
-        return new HuamiDevicePrefs(GBApplication.getDeviceSpecificSharedPrefs(gbDevice.getAddress()), gbDevice);
+    public boolean connect() {
+        // Nothing to do - connection is done in the communicator
+        return true;
     }
 
     @Override
-    public boolean useAutoConnect() {
-        return true;
+    public HuamiDevicePrefs getDevicePrefs() {
+        return new HuamiDevicePrefs(GBApplication.getDeviceSpecificSharedPrefs(gbDevice.getAddress()), gbDevice);
     }
 
     @Override
@@ -317,39 +288,17 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
                 Objects.requireNonNull(mServiceMap.get(endpoint)).dispose();
             }
         }
-
-        super.dispose();
     }
 
     @Override
-    protected TransactionBuilder initializeDevice(final TransactionBuilder builder) {
-        if (getMTU() != MIN_MTU) {
-            // #3219 - Reset the MTU before re-initializing the device, otherwise initialization will sometimes fail
-            setMtu(MIN_MTU);
-        }
+    public boolean useAutoConnect() {
+        return true;
+    }
 
-        final BluetoothGattCharacteristic characteristicChunked2021Read = getCharacteristic(HuamiService.UUID_CHARACTERISTIC_CHUNKEDTRANSFER_2021_READ);
-        if (characteristicChunked2021Read != null && huami2021ChunkedDecoder == null) {
-            huami2021ChunkedDecoder = new Huami2021ChunkedDecoder(this, true);
-        }
+    protected void initializeDevice(final ZeppOsTransactionBuilder builder) {
+        builder.setDeviceState(getDevice(), GBDevice.State.AUTHENTICATING, getContext());
 
-        final BluetoothGattCharacteristic characteristicChunked2021Write = getCharacteristic(HuamiService.UUID_CHARACTERISTIC_CHUNKEDTRANSFER_2021_WRITE);
-        if (characteristicChunked2021Write != null && huami2021ChunkedEncoder == null) {
-            huami2021ChunkedEncoder = new Huami2021ChunkedEncoder(getMTU());
-        }
-
-        if (characteristicChunked2021Write == null || characteristicChunked2021Read == null) {
-            LOG.warn("Chunked 2021 characteristics are null, will attempt to reconnect");
-            builder.add(new SetDeviceStateAction(getDevice(), GBDevice.State.WAITING_FOR_RECONNECT, getContext()));
-            return builder;
-        }
-
-        builder.notify(characteristicChunked2021Read, true);
-        builder.add(new SetDeviceStateAction(getDevice(), GBDevice.State.AUTHENTICATING, getContext()));
-
-        authenticationService.startAuthentication(new ZeppOsBtleTransactionBuilder(this, builder));
-
-        return builder;
+        authenticationService.startAuthentication(builder);
     }
 
     @Override
@@ -557,10 +506,11 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
                         return;
                     }
 
-                    new ZeppOsFirmwareUpdateOperation(
+                    firmwareUpdateOperation = new ZeppOsFirmwareUpdateOperation(
                             Uri.parse(uihhFile.toURI().toString()),
                             this
-                    ).perform();
+                    );
+                    firmwareUpdateOperation.perform();
                 }
             } catch (final Exception e) {
                 GB.toast(getContext(), "AGPS install error: " + e.getMessage(), Toast.LENGTH_LONG, GB.ERROR, e);
@@ -611,7 +561,8 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
         }
 
         try {
-            new ZeppOsFirmwareUpdateOperation(uri, this).perform();
+            firmwareUpdateOperation = new ZeppOsFirmwareUpdateOperation(uri, this);
+            firmwareUpdateOperation.perform();
         } catch (final IOException ex) {
             GB.toast(getContext(), "Firmware install error: " + ex.getMessage(), Toast.LENGTH_LONG, GB.ERROR, ex);
         }
@@ -699,40 +650,17 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
     public void onSetTime() {
         if (GBApplication.getPrefs().syncTime()) {
             final ZeppOsTransactionBuilder builder = createZeppOsTransactionBuilder("set date and time");
-            setCurrentTime(builder);
+            if (mSupportedServices.contains(timeService.getEndpoint())) {
+                timeService.setTime(builder);
+            } else {
+                communicator.setCurrentTime(builder);
+            }
             builder.queue(this);
         }
 
         CalendarReceiver.forceSync(getDevice());
     }
 
-    private void setCurrentTime(ZeppOsTransactionBuilder builder) {
-        // It seems that the format sent to the Current Time characteristic changed in newer devices
-        // to kind-of match the GATT spec, but it doesn't quite respect it?
-        // - 11 bytes get sent instead of 10 (extra byte at the end for the offset in quarter-hours?)
-        // - Day of week starts at 0
-        // Otherwise, the command gets rejected with an "Out of Range" error and init fails.
-
-        final Calendar timestamp = BLETypeConversions.createCalendar();
-        final byte[] year = fromUint16(timestamp.get(Calendar.YEAR));
-
-        final byte[] cmd = {
-                year[0],
-                year[1],
-                fromUint8(timestamp.get(Calendar.MONTH) + 1),
-                fromUint8(timestamp.get(Calendar.DATE)),
-                fromUint8(timestamp.get(Calendar.HOUR_OF_DAY)),
-                fromUint8(timestamp.get(Calendar.MINUTE)),
-                fromUint8(timestamp.get(Calendar.SECOND)),
-                fromUint8(timestamp.get(Calendar.DAY_OF_WEEK) - 1),
-                0x00, // Fractions256?
-                0x08, // Reason for change?
-                mapTimeZone(timestamp, BLETypeConversions.TZ_FLAG_INCLUDE_DST_IN_TZ), // TODO: Confirm this
-        };
-
-        builder.write(GattCharacteristic.UUID_CHARACTERISTIC_CURRENT_TIME, cmd);
-    }
-
     @Override
     public void onSendWeather(final ArrayList<WeatherSpec> weatherSpecs) {
         weatherService.onSendWeather(weatherSpecs);
@@ -883,20 +811,17 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
         watchfaceService.requestCurrentWatchface(builder);
     }
 
+    public void onFirmwareUpdateFinished() {
+        firmwareUpdateOperation = null;
+    }
+
     public void onAuthenticationSuccess() {
         LOG.info("ZeppOS phase 2 initialize...");
 
-        final TransactionBuilder bleBuilder = new TransactionBuilder("phase 2 initialize");
-        final var builder = new ZeppOsBtleTransactionBuilder(this, bleBuilder);
+        final ZeppOsTransactionBuilder builder = createZeppOsTransactionBuilder("phase 2 initialize");
         builder.setDeviceState(getDevice(), GBDevice.State.INITIALIZING, getContext());
 
-        if (getDevicePrefs().allowHighMtu()) {
-            bleBuilder.requestMtu(247);
-        }
-        if (GBApplication.getPrefs().syncTime()) {
-            setCurrentTime(builder);
-        }
-        deviceInfoProfile.requestDeviceInfo(bleBuilder);
+        communicator.onAuthenticationSuccess(builder);
 
         // Make sure that performInitialized is not called accidentally in here
         // (eg. by creating a new TransactionBuilder).
@@ -918,27 +843,36 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
     public void initializeServices() {
         LOG.info("2021 initializeServices...");
 
-        try {
-            final ZeppOsTransactionBuilder builder = createZeppOsTransactionBuilder("initialize services");
+        final ZeppOsTransactionBuilder builder = createZeppOsTransactionBuilder("initialize services");
 
-            // At this point we got the service list from phase 3, so we know which
-            // services are supported, and whether they are encrypted or not
+        // At this point we got the service list from phase 3, so we know which
+        // services are supported, and whether they are encrypted or not
 
-            final ZeppOsCoordinator coordinator = getCoordinator();
-
-            for (AbstractZeppOsService service : mServiceMap.values()) {
-                if (mSupportedServices.contains(service.getEndpoint())) {
-                    // Only initialize supported services
-                    service.initialize(builder);
-                }
+        if (GBApplication.getPrefs().syncTime()) {
+            if (mSupportedServices.contains(timeService.getEndpoint())) {
+                timeService.setTime(builder);
+            } else {
+                communicator.setCurrentTime(builder);
             }
-
-            builder.setDeviceState(getDevice(), GBDevice.State.INITIALIZED, getContext());
-
-            builder.queue(this);
-        } catch (Exception e) {
-            LOG.error("failed initializing device", e);
         }
+        if (mSupportedServices.contains(deviceInfoService.getEndpoint())) {
+            deviceInfoService.requestDeviceInfo(builder);
+        } else {
+            communicator.requestDeviceInfo(builder);
+        }
+
+        final ZeppOsCoordinator coordinator = getCoordinator();
+
+        for (AbstractZeppOsService service : mServiceMap.values()) {
+            if (mSupportedServices.contains(service.getEndpoint())) {
+                // Only initialize supported services
+                service.initialize(builder);
+            }
+        }
+
+        builder.setDeviceState(getDevice(), GBDevice.State.INITIALIZED, getContext());
+
+        builder.queue(this);
     }
 
     @Override
@@ -951,9 +885,13 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
 
     @Override
     public void writeActivityControl(final String name, final byte[] value) {
-        final ZeppOsTransactionBuilder builder = createZeppOsTransactionBuilder(name);
-        builder.write(HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_CONTROL, value);
-        builder.queue(this);
+        if (mSupportedServices.contains(activityFetchService.getEndpoint())) {
+            activityFetchService.writeActivityControl(name, value);
+        } else {
+            final ZeppOsTransactionBuilder builder = createZeppOsTransactionBuilder(name);
+            builder.write(HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_CONTROL, value);
+            builder.queue(this);
+        }
     }
 
     @Nullable
@@ -975,20 +913,16 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
         LOG.info("Set raw sensor to {}", enable);
         rawSensor = enable;
 
-        try {
-            final TransactionBuilder builder = performInitialized("set raw sensor");
-            if (enable) {
-                builder.write(getCharacteristic(HuamiService.UUID_CHARACTERISTIC_RAW_SENSOR_CONTROL), Huami2021Service.CMD_RAW_SENSOR_START_1);
-                builder.write(getCharacteristic(HuamiService.UUID_CHARACTERISTIC_RAW_SENSOR_CONTROL), Huami2021Service.CMD_RAW_SENSOR_START_2);
-                builder.write(getCharacteristic(HuamiService.UUID_CHARACTERISTIC_RAW_SENSOR_CONTROL), Huami2021Service.CMD_RAW_SENSOR_START_3);
-            } else {
-                builder.write(getCharacteristic(HuamiService.UUID_CHARACTERISTIC_RAW_SENSOR_CONTROL), Huami2021Service.CMD_RAW_SENSOR_STOP);
-            }
-            builder.notify(getCharacteristic(HuamiService.UUID_CHARACTERISTIC_RAW_SENSOR_DATA), enable);
-            builder.queue(getQueue());
-        } catch (final IOException e) {
-            LOG.error("Unable to set raw sensor", e);
+        final ZeppOsTransactionBuilder builder = createZeppOsTransactionBuilder("set raw sensor");
+        if (enable) {
+            builder.write(HuamiService.UUID_CHARACTERISTIC_RAW_SENSOR_CONTROL, Huami2021Service.CMD_RAW_SENSOR_START_1);
+            builder.write(HuamiService.UUID_CHARACTERISTIC_RAW_SENSOR_CONTROL, Huami2021Service.CMD_RAW_SENSOR_START_2);
+            builder.write(HuamiService.UUID_CHARACTERISTIC_RAW_SENSOR_CONTROL, Huami2021Service.CMD_RAW_SENSOR_START_3);
+        } else {
+            builder.write(HuamiService.UUID_CHARACTERISTIC_RAW_SENSOR_CONTROL, Huami2021Service.CMD_RAW_SENSOR_STOP);
         }
+        builder.notify(HuamiService.UUID_CHARACTERISTIC_RAW_SENSOR_DATA, enable);
+        builder.queue(this);
     }
 
     private void handleRawSensorData(final byte[] value) {
@@ -1040,39 +974,41 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
         }
     }
 
-    @Override
-    public boolean onCharacteristicChanged(final BluetoothGatt gatt,
-                                           final BluetoothGattCharacteristic characteristic) {
-        if (super.onCharacteristicChanged(gatt, characteristic)) {
-            // handled upstream
-            return true;
-        }
-
-        final UUID characteristicUUID = characteristic.getUuid();
+    public boolean onCharacteristicChanged(final UUID characteristicUUID,
+                                           final byte[] value) {
         if (HuamiService.UUID_CHARACTERISTIC_CHUNKEDTRANSFER_2021_READ.equals(characteristicUUID)) {
-            handleChunked(characteristic.getValue());
+            handleChunkedRead(value);
+            return true;
+        } if (HuamiService.UUID_CHARACTERISTIC_CHUNKEDTRANSFER_2021_WRITE.equals(characteristicUUID)) {
+            handleChunkedWrite(value);
             return true;
         } else if (HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_DATA.equals(characteristicUUID)) {
-            fetcher.onActivityData(characteristic.getValue());
+            fetcher.onActivityData(value);
             return true;
         } else if (HuamiService.UUID_CHARACTERISTIC_5_ACTIVITY_CONTROL.equals(characteristicUUID)) {
-            fetcher.onActivityControl(characteristic.getValue());
+            fetcher.onActivityControl(value);
             return true;
         } else if (HuamiService.UUID_CHARACTERISTIC_ZEPP_OS_FILE_TRANSFER_V3_SEND.equals(characteristicUUID)) {
-            fileTransferService.onCharacteristicChanged(characteristic);
+            fileTransferService.onCharacteristicChanged(characteristicUUID, value);
             return true;
         } else if (HuamiService.UUID_CHARACTERISTIC_ZEPP_OS_FILE_TRANSFER_V3_RECEIVE.equals(characteristicUUID)) {
-            fileTransferService.onCharacteristicChanged(characteristic);
+            fileTransferService.onCharacteristicChanged(characteristicUUID, value);
             return true;
         } else if (GattCharacteristic.UUID_CHARACTERISTIC_HEART_RATE_MEASUREMENT.equals(characteristicUUID)) {
-            heartRateService.handleHeartRate(characteristic.getValue());
+            heartRateService.handleHeartRate(value);
             return true;
         } else if (HuamiService.UUID_CHARACTERISTIC_RAW_SENSOR_DATA.equals(characteristicUUID)) {
-            handleRawSensorData(characteristic.getValue());
+            handleRawSensorData(value);
             return true;
-        } else {
-            LOG.warn("Unhandled characteristic changed: {}", characteristicUUID);
-            logMessageContent(characteristic.getValue());
+        } else if (HuamiService.UUID_CHARACTERISTIC_FIRMWARE_CONTROL.equals(characteristicUUID)) {
+            if (firmwareUpdateOperation != null) {
+                firmwareUpdateOperation.handleControlNotification(value);
+            } else {
+                LOG.error("Got firmware control, but there is no ongoing operation: {}", GB.hexdump(value));
+            }
+            return true;
+        }  else {
+            LOG.warn("Unhandled characteristic changed: {}, data: {}", characteristicUUID, GB.hexdump(value));
         }
 
         return false;
@@ -1083,34 +1019,39 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
     }
 
     public void setMtu(final int mtu) {
-        if (mtu > MIN_MTU && !getDevicePrefs().allowHighMtu()) {
+        if (mtu > 23 && !getDevicePrefs().allowHighMtu()) {
             LOG.warn("High MTU is not allowed, ignoring");
             return;
         }
 
-        if (mtu < MIN_MTU) {
+        if (mtu < 23) {
             LOG.error("Device announced unreasonable low MTU of {}, ignoring", mtu);
             return;
         }
 
+        LOG.debug("Setting mtu to {}", mtu);
+
         this.mMTU = mtu;
-        if (huami2021ChunkedEncoder != null) {
-            huami2021ChunkedEncoder.setMTU(mtu);
+        this.huami2021ChunkedEncoder.setMTU(mtu);
+    }
+
+    /** @noinspection SwitchStatementWithTooFewBranches*/
+    private void handleChunkedRead(final byte[] value) {
+        switch (value[0]) {
+            case 0x03:
+                final boolean needsAck = huami2021ChunkedDecoder.decode(value);
+                if (needsAck) {
+                    sendChunkedAck();
+                }
+                return;
+            default:
+                LOG.warn("Unhandled chunked read payload of type {}", value[0]);
         }
     }
 
-    private void handleChunked(final byte[] value) {
+    /** @noinspection SwitchStatementWithTooFewBranches*/
+    private void handleChunkedWrite(final byte[] value) {
         switch (value[0]) {
-            case 0x03:
-                if (huami2021ChunkedDecoder != null) {
-                    final boolean needsAck = huami2021ChunkedDecoder.decode(value);
-                    if (needsAck) {
-                        sendChunkedAck();
-                    }
-                } else {
-                    LOG.warn("Got chunked payload, but decoder is null");
-                }
-                return;
             case 0x04:
                 final byte handle = value[2];
                 final byte count = value[4];
@@ -1118,7 +1059,7 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
                 // TODO: We should probably update the handle and count on the encoder
                 return;
             default:
-                LOG.warn("Unhandled chunked payload of type {}", value[0]);
+                LOG.warn("Unhandled chunked write payload of type {}", value[0]);
         }
     }
 
@@ -1213,7 +1154,6 @@ public class ZeppOsSupport extends AbstractBTLEDeviceSupport
     }
 
     public ZeppOsTransactionBuilder createZeppOsTransactionBuilder(final String taskName) {
-        // FIXME this needs to be moved upstream
-        return new ZeppOsBtleTransactionBuilder(this, taskName);
+        return communicator.createZeppOsTransactionBuilder(taskName);
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsTransactionBuilder.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsTransactionBuilder.java
index 2a9909929e..b7a9349e9c 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsTransactionBuilder.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsTransactionBuilder.java
@@ -27,6 +27,8 @@ public interface ZeppOsTransactionBuilder {
 
     void setDeviceState(final GBDevice device, final GBDevice.State deviceState, final Context context);
 
+    void setBusy(final GBDevice device, final String string, final Context context);
+
     void notify(final UUID characteristic, final boolean enable);
 
     void write(final UUID characteristic, final byte[] arr);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/AbstractZeppOsOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/AbstractZeppOsOperation.java
index 3fb7f9d888..f9e9b9f22d 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/AbstractZeppOsOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/AbstractZeppOsOperation.java
@@ -45,7 +45,7 @@ public abstract class AbstractZeppOsOperation<T extends ZeppOsSupport> {
 
     protected abstract void doPerform() throws IOException;
 
-    protected void operationFinished() throws IOException {
+    protected void operationFinished() {
     }
 
     protected Context getContext() {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/ZeppOsFirmwareUpdateOperation.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/ZeppOsFirmwareUpdateOperation.java
index b87d3764b5..227c09462d 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/ZeppOsFirmwareUpdateOperation.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/ZeppOsFirmwareUpdateOperation.java
@@ -16,8 +16,6 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.operations;
 
-import android.bluetooth.BluetoothGatt;
-import android.bluetooth.BluetoothGattCharacteristic;
 import android.net.Uri;
 import android.widget.Toast;
 
@@ -26,7 +24,6 @@ import org.slf4j.LoggerFactory;
 
 import java.io.IOException;
 import java.io.RandomAccessFile;
-import java.util.UUID;
 
 import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventDisplayMessage;
@@ -36,14 +33,10 @@ import nodomain.freeyourgadget.gadgetbridge.devices.huami.zeppos.ZeppOsCoordinat
 import nodomain.freeyourgadget.gadgetbridge.devices.huami.zeppos.ZeppOsFwHelper;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.actions.SetDeviceBusyAction;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.actions.SetProgressAction;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFirmwareType;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.operations.update.UpdateFirmwareOperation2020;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsSupport;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsTransactionBuilder;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.miband.operations.AbstractMiBandOperation;
 import nodomain.freeyourgadget.gadgetbridge.util.ArrayUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
@@ -57,13 +50,13 @@ import nodomain.freeyourgadget.gadgetbridge.util.GB;
  * - buildFirmwareInfoCommand is slightly different
  * - at the end of the update, we request display items / watchfaces depending on what was installed, to refresh the
  * preferences in the UI
+ * <p>
+ * As of btrfcomm support, it also decouples the operation from the abstract ble operation classes.
  */
-public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppOsSupport> {
+public class ZeppOsFirmwareUpdateOperation extends AbstractZeppOsOperation<ZeppOsSupport> {
     private static final Logger LOG = LoggerFactory.getLogger(ZeppOsFirmwareUpdateOperation.class);
 
     private final Uri uri;
-    private final BluetoothGattCharacteristic fwCControlChar;
-    private final BluetoothGattCharacteristic fwCDataChar;
     private ZeppOsFwHelper fwHelper;
     private RandomAccessFile raf;
 
@@ -72,20 +65,16 @@ public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppO
     public ZeppOsFirmwareUpdateOperation(final Uri uri, final ZeppOsSupport support) {
         super(support);
         this.uri = uri;
-        this.fwCControlChar = getCharacteristic(HuamiService.UUID_CHARACTERISTIC_FIRMWARE);
-        this.fwCDataChar = getCharacteristic(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_DATA);
     }
 
-    @Override
-    protected void enableNeededNotifications(TransactionBuilder builder, boolean enable) {
-        builder.notify(fwCControlChar, enable);
+    protected void enableNeededNotifications(ZeppOsTransactionBuilder builder, boolean enable) {
+        builder.notify(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_CONTROL, enable);
     }
 
-    @Override
-    protected void enableOtherNotifications(final TransactionBuilder builder, final boolean enable) {
+    protected void enableOtherNotifications(final ZeppOsTransactionBuilder builder, final boolean enable) {
         // Disable 2021 chunked reads, otherwise firmware upgrades and activity sync get interrupted
         // FIXME is this still needed?
-        builder.notify(getCharacteristic(HuamiService.UUID_CHARACTERISTIC_CHUNKEDTRANSFER_2021_READ), enable);
+        builder.notify(HuamiService.UUID_CHARACTERISTIC_CHUNKEDTRANSFER_2021_READ, enable);
     }
 
     @Override
@@ -96,6 +85,12 @@ public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppO
             throw new IOException("Not a Zepp OS coordinator for " + getDevice().getAddress());
         }
 
+        getDevice().setBusyTask("Operation starting..."); // mark as busy quickly to avoid interruptions from the outside
+        ZeppOsTransactionBuilder builder = getSupport().createZeppOsTransactionBuilder("fw update starting");
+        enableOtherNotifications(builder, false);
+        enableNeededNotifications(builder, true);
+        builder.queue(getSupport());
+
         fwHelper = new ZeppOsFwHelper(
                 uri,
                 getContext(),
@@ -109,10 +104,16 @@ public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppO
 
         raf = new RandomAccessFile(fwHelper.getFile(), "r");
 
-        if (!requestParameters()) {
-            displayErrorMessage("Error requesting parameters, aborting.");
-            done();
-        }
+        requestParameters();
+    }
+
+    @Override
+    protected void operationFinished() {
+        getSupport().onFirmwareUpdateFinished();
+        ZeppOsTransactionBuilder builder = getSupport().createZeppOsTransactionBuilder("fw update finish");
+        enableNeededNotifications(builder, false);
+        enableOtherNotifications(builder, true);
+        builder.queue(getSupport());
     }
 
     protected void done() {
@@ -121,32 +122,11 @@ public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppO
         unsetBusy();
     }
 
-    @Override
-    public boolean onCharacteristicWrite(BluetoothGatt gatt, BluetoothGattCharacteristic characteristic, int status) {
-        if (status != BluetoothGatt.GATT_SUCCESS) {
-            operationFailed();
-        }
-        return super.onCharacteristicWrite(gatt, characteristic, status);
-    }
-
     void operationFailed() {
         GB.updateInstallNotification(getContext().getString(R.string.updatefirmwareoperation_write_failed), false, 0, getContext());
     }
 
-    @Override
-    public boolean onCharacteristicChanged(BluetoothGatt gatt,
-                                           BluetoothGattCharacteristic characteristic) {
-        UUID characteristicUUID = characteristic.getUuid();
-        if (fwCControlChar.getUuid().equals(characteristicUUID)) {
-            handleNotificationNotif(characteristic.getValue());
-            return true; // don't let anyone else handle it
-        } else {
-            super.onCharacteristicChanged(gatt, characteristic);
-        }
-        return false;
-    }
-
-    protected void handleNotificationNotif(byte[] value) {
+    public void handleControlNotification(final byte[] value) {
         boolean success = (value[2] == HuamiService.SUCCESS) || ((value[1] == UpdateFirmwareOperation2020.REPLY_UPDATE_PROGRESS) && value.length >= 6); // ugly
 
         if (value[0] == HuamiService.RESPONSE && success) {
@@ -179,7 +159,7 @@ public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppO
                     case UpdateFirmwareOperation2020.COMMAND_FINALIZE_UPDATE: {
                         if (fwHelper.getFirmwareType() == HuamiFirmwareType.FIRMWARE) {
                             ZeppOsTransactionBuilder builder = getSupport().createZeppOsTransactionBuilder("reboot");
-                            builder.write(HuamiService.UUID_CHARACTERISTIC_FIRMWARE, new byte[]{HuamiService.COMMAND_FIRMWARE_REBOOT});
+                            builder.write(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_CONTROL, new byte[]{HuamiService.COMMAND_FIRMWARE_REBOOT});
                             builder.queue(getSupport());
                         } else {
                             GB.updateInstallNotification(getContext().getString(R.string.updatefirmwareoperation_update_complete), false, 100, getContext());
@@ -194,8 +174,7 @@ public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppO
                         break;
                     }
                     default: {
-                        LOG.error("Unexpected response during firmware update: ");
-                        getSupport().logMessageContent(value);
+                        LOG.error("Unexpected response during firmware update: {}", GB.hexdump(value));
                         operationFailed();
                         displayErrorMessage(getContext().getString(R.string.updatefirmwareoperation_updateproblem_do_not_reboot));
                         done();
@@ -206,9 +185,8 @@ public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppO
                 done();
             }
         } else {
-            LOG.error("Unexpected notification during firmware update: ");
+            LOG.error("Unexpected notification during firmware update: {}", GB.hexdump(value));
             operationFailed();
-            getSupport().logMessageContent(value);
             int errorMessage = R.string.updatefirmwareoperation_metadata_updateproblem;
             // Display a more specific error message for known errors
 
@@ -245,14 +223,10 @@ public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppO
     }
 
     public void sendFwInfo() {
-        try {
-            TransactionBuilder builder = performInitialized("send firmware info");
-            builder.add(new SetDeviceBusyAction(getDevice(), getContext().getString(R.string.updating_firmware), getContext()));
-            builder.write(fwCControlChar, buildFirmwareInfoCommand());
-            builder.queue(getQueue());
-        } catch (IOException e) {
-            LOG.error("Error sending firmware info: " + e.getLocalizedMessage(), e);
-        }
+        ZeppOsTransactionBuilder builder = getSupport().createZeppOsTransactionBuilder("send firmware info");
+        builder.setBusy(getDevice(), getContext().getString(R.string.updating_firmware), getContext());
+        builder.write(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_CONTROL, buildFirmwareInfoCommand());
+        builder.queue(getSupport());
     }
 
     protected byte[] buildFirmwareInfoCommand() {
@@ -281,17 +255,11 @@ public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppO
         };
     }
 
-    public boolean requestParameters() {
-        try {
-            TransactionBuilder builder = performInitialized("get update capabilities");
-            byte[] bytes = new byte[]{UpdateFirmwareOperation2020.COMMAND_REQUEST_PARAMETERS};
-            builder.write(fwCControlChar, bytes);
-            builder.queue(getQueue());
-            return true;
-        } catch (IOException e) {
-            LOG.error("Error sending firmware info: " + e.getLocalizedMessage(), e);
-            return false;
-        }
+    public void requestParameters() {
+        ZeppOsTransactionBuilder builder = getSupport().createZeppOsTransactionBuilder("get update capabilities");
+        byte[] bytes = new byte[]{UpdateFirmwareOperation2020.COMMAND_REQUEST_PARAMETERS};
+        builder.write(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_CONTROL, bytes);
+        builder.queue(getSupport());
     }
 
     private void sendFirmwareDataChunk(int offset) {
@@ -313,14 +281,14 @@ public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppO
                 return;
             }
 
-            TransactionBuilder builder = performInitialized("send firmware packets");
+            ZeppOsTransactionBuilder builder = getSupport().createZeppOsTransactionBuilder("send firmware packets");
 
             for (int i = 0; i < packets; i++) {
                 raf.seek(offset + (long) i * packetLength);
                 byte[] fwChunk = new byte[packetLength];
                 raf.read(fwChunk);
 
-                builder.write(fwCDataChar, fwChunk);
+                builder.write(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_DATA, fwChunk);
                 chunkProgress += packetLength;
             }
 
@@ -328,14 +296,14 @@ public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppO
                 raf.seek(offset + (long) packets * packetLength);
                 byte[] lastChunk = new byte[chunkLength - chunkProgress];
                 raf.read(lastChunk);
-                builder.write(fwCDataChar, lastChunk);
+                builder.write(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_DATA, lastChunk);
             }
 
             int progressPercent = (int) ((((float) (offset + chunkLength)) / len) * 100);
 
-            builder.add(new SetProgressAction(getContext().getString(R.string.updatefirmwareoperation_update_in_progress), true, progressPercent, getContext()));
+            builder.setProgress(getContext().getString(R.string.updatefirmwareoperation_update_in_progress), true, progressPercent, getContext());
 
-            builder.queue(getQueue());
+            builder.queue(getSupport());
 
         } catch (final IOException e) {
             LOG.error("Unable to send fw to device", e);
@@ -343,27 +311,27 @@ public class ZeppOsFirmwareUpdateOperation extends AbstractMiBandOperation<ZeppO
         }
     }
 
-    protected void sendTransferStart() throws IOException {
-        final TransactionBuilder builder = performInitialized("transfer complete");
-        builder.write(fwCControlChar, new byte[]{
+    private void sendTransferStart() {
+        final ZeppOsTransactionBuilder builder = getSupport().createZeppOsTransactionBuilder("transfer complete");
+        builder.write(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_CONTROL, new byte[]{
                 UpdateFirmwareOperation2020.COMMAND_START_TRANSFER, 1,
         });
-        builder.queue(getQueue());
+        builder.queue(getSupport());
     }
 
-    protected void sendTransferComplete() throws IOException {
-        final TransactionBuilder builder = performInitialized("transfer complete");
-        builder.write(fwCControlChar, new byte[]{
+    private void sendTransferComplete() {
+        final ZeppOsTransactionBuilder builder = getSupport().createZeppOsTransactionBuilder("transfer complete");
+        builder.write(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_CONTROL, new byte[]{
                 UpdateFirmwareOperation2020.COMMAND_COMPLETE_TRANSFER,
         });
-        builder.queue(getQueue());
+        builder.queue(getSupport());
     }
 
-    protected void sendFinalize() throws IOException {
-        final TransactionBuilder builder = performInitialized("finalize firmware");
-        builder.write(fwCControlChar, new byte[]{
+    private void sendFinalize() {
+        final ZeppOsTransactionBuilder builder = getSupport().createZeppOsTransactionBuilder("finalize firmware");
+        builder.write(HuamiService.UUID_CHARACTERISTIC_FIRMWARE_CONTROL, new byte[]{
                 UpdateFirmwareOperation2020.COMMAND_FINALIZE_UPDATE,
         });
-        builder.queue(getQueue());
+        builder.queue(getSupport());
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsActivityFetchService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsActivityFetchService.java
new file mode 100644
index 0000000000..cdfd021d8b
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsActivityFetchService.java
@@ -0,0 +1,53 @@
+/*  Copyright (C) 2025 José Rebelo
+
+    This file is part of Gadgetbridge.
+
+    Gadgetbridge is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published
+    by the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    Gadgetbridge is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
+package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services;
+
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiFetcher;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.AbstractZeppOsService;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsSupport;
+import nodomain.freeyourgadget.gadgetbridge.util.GB;
+
+public class ZeppOsActivityFetchService extends AbstractZeppOsService {
+    private static final Logger LOG = LoggerFactory.getLogger(ZeppOsActivityFetchService.class);
+
+    private static final short ENDPOINT = 0x004b;
+
+    private final HuamiFetcher fetcher;
+
+    public ZeppOsActivityFetchService(final ZeppOsSupport support, final HuamiFetcher fetcher) {
+        super(support, true);
+        this.fetcher = fetcher;
+    }
+
+    @Override
+    public short getEndpoint() {
+        return ENDPOINT;
+    }
+
+    @Override
+    public void handlePayload(final byte[] payload) {
+        LOG.trace("Passing to fetcher: {}", GB.hexdump(payload));
+        fetcher.onActivityControl(payload);
+    }
+
+    public void writeActivityControl(final String name, final byte[] value) {
+        write(name, value);
+    }
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsDeviceInfoService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsDeviceInfoService.java
new file mode 100644
index 0000000000..8a69a7062d
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsDeviceInfoService.java
@@ -0,0 +1,88 @@
+/*  Copyright (C) 2025 José Rebelo
+
+    This file is part of Gadgetbridge.
+
+    Gadgetbridge is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published
+    by the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    Gadgetbridge is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
+package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services;
+
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+import java.nio.ByteBuffer;
+import java.nio.ByteOrder;
+
+import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventVersionInfo;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.AbstractZeppOsService;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsTransactionBuilder;
+import nodomain.freeyourgadget.gadgetbridge.util.StringUtils;
+
+public class ZeppOsDeviceInfoService extends AbstractZeppOsService {
+    private static final Logger LOG = LoggerFactory.getLogger(ZeppOsDeviceInfoService.class);
+
+    private static final short ENDPOINT = 0x0043;
+
+    private static final byte CMD_REQUEST = 0x01;
+    private static final byte CMD_REPLY = 0x02;
+
+    public ZeppOsDeviceInfoService(final ZeppOsSupport support) {
+        super(support, false);
+    }
+
+    @Override
+    public short getEndpoint() {
+        return ENDPOINT;
+    }
+
+    @Override
+    public void handlePayload(final byte[] payload) {
+        final ByteBuffer buf = ByteBuffer.wrap(payload).order(ByteOrder.LITTLE_ENDIAN);
+
+        final byte cmd = buf.get();
+        if (cmd != CMD_REPLY) {
+            LOG.warn("Unexpected device info payload byte {}", String.format("0x%02x", cmd));
+            return;
+        }
+
+        final byte one = buf.get();
+        if (one != 1) {
+            LOG.warn("Unexpected device info payload 2nd byte {}", String.format("0x%02x", one));
+            return;
+        }
+
+        final int unk1 = buf.getInt(); // 0x000000ff
+        final int unk2 = buf.getInt(); // 0x00000000
+
+        if (unk1 != 0x000000ff || unk2 != 0x00000000) {
+            LOG.error("Unexpected unk values {}/{}", String.format("0x%08x", unk1), String.format("0x%08x", unk2));
+            return;
+        }
+
+        final int unk3count = buf.get() & 0xff;
+        buf.get(new byte[unk3count]);
+
+        final String serialNumber = StringUtils.untilNullTerminator(buf);
+        final String hwVersion = StringUtils.untilNullTerminator(buf);
+        final String fwVersion = StringUtils.untilNullTerminator(buf);
+
+        final GBDeviceEventVersionInfo versionInfo = new GBDeviceEventVersionInfo();
+        versionInfo.fwVersion = fwVersion;
+        versionInfo.hwVersion = hwVersion;
+        evaluateGBDeviceEvent(versionInfo);
+    }
+
+    public void requestDeviceInfo(final ZeppOsTransactionBuilder builder) {
+        write(builder, CMD_REQUEST);
+    }
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsFileTransferService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsFileTransferService.java
index 05680a99cc..2af65976ee 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsFileTransferService.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsFileTransferService.java
@@ -16,11 +16,11 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services;
 
-import android.bluetooth.BluetoothGattCharacteristic;
-
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
+import java.util.UUID;
+
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsSupport;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.AbstractZeppOsService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsTransactionBuilder;
@@ -91,13 +91,13 @@ public class ZeppOsFileTransferService extends AbstractZeppOsService {
         impl.uploadFile(url, filename, bytes, compress, callback);
     }
 
-    public void onCharacteristicChanged(final BluetoothGattCharacteristic characteristic) {
+    public void onCharacteristicChanged(final UUID characteristicUUID, final byte[] value) {
         if (impl == null) {
-            LOG.error("Service not initialized, ignoring characteristic change for {}", characteristic.getUuid());
+            LOG.error("Service not initialized, ignoring characteristic change for {}", characteristicUUID);
             return;
         }
 
-        impl.onCharacteristicChanged(characteristic);
+        impl.onCharacteristicChanged(characteristicUUID, value);
     }
 
     public interface Callback {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsTimeService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsTimeService.java
new file mode 100644
index 0000000000..277c6bea3a
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsTimeService.java
@@ -0,0 +1,109 @@
+/*  Copyright (C) 2025 José Rebelo
+
+    This file is part of Gadgetbridge.
+
+    Gadgetbridge is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published
+    by the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    Gadgetbridge is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
+package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services;
+
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+import java.nio.ByteBuffer;
+import java.nio.ByteOrder;
+import java.time.Instant;
+import java.time.ZoneId;
+import java.time.zone.ZoneOffsetTransition;
+import java.time.zone.ZoneRules;
+import java.util.Calendar;
+import java.util.GregorianCalendar;
+
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.HuamiUtils;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.AbstractZeppOsService;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsTransactionBuilder;
+
+public class ZeppOsTimeService extends AbstractZeppOsService {
+    private static final Logger LOG = LoggerFactory.getLogger(ZeppOsTimeService.class);
+
+    private static final short ENDPOINT = 0x0047;
+
+    private static final byte CMD_CAPABILITIES_REQUEST = 0x01;
+    private static final byte CMD_CAPABILITIES_RESPONSE = 0x02;
+    private static final byte CMD_SET_TIME = 0x05;
+    private static final byte CMD_SET_TIME_ACK = 0x06;
+    private static final byte CMD_SET_DST = 0x07;
+    private static final byte CMD_SET_DST_ACK = 0x08;
+
+    public ZeppOsTimeService(final ZeppOsSupport support) {
+        super(support, false);
+    }
+
+    @Override
+    public short getEndpoint() {
+        return ENDPOINT;
+    }
+
+    @Override
+    public void handlePayload(final byte[] payload) {
+        switch (payload[0]) {
+            case CMD_CAPABILITIES_RESPONSE:
+                final int version = payload[1] & 0xff;
+                LOG.info("Got time service version {}", version);
+                return;
+            case CMD_SET_TIME_ACK:
+                LOG.debug("Got set time ack, status={}", payload[1]); // 1
+                return;
+            case CMD_SET_DST_ACK:
+                LOG.debug("Got set DST ack, status={}", payload[1]); // 1
+                return;
+        }
+
+        LOG.warn("Unexpected time payload byte {}", String.format("0x%02x", payload[0]));
+    }
+
+    public void setTime(final ZeppOsTransactionBuilder builder) {
+        setCurrentTime(builder);
+        setNextDst(builder);
+    }
+
+    public void setCurrentTime(final ZeppOsTransactionBuilder builder) {
+        final ByteBuffer buf = ByteBuffer.allocate(12).order(ByteOrder.LITTLE_ENDIAN);
+
+        final Calendar now = GregorianCalendar.getInstance();
+
+        buf.put(CMD_SET_TIME);
+        buf.put(HuamiUtils.getCurrentTimeBytes());
+
+        write(builder, buf.array());
+    }
+
+    public void setNextDst(final ZeppOsTransactionBuilder builder) {
+        final ZoneId zoneId = ZoneId.systemDefault();
+        final ZoneRules rules = zoneId.getRules();
+        final ZoneOffsetTransition nextTransition = rules.nextTransition(Instant.now());
+        if (nextTransition == null) {
+            return;
+        }
+
+        final long nextTransitionEpochSeconds = nextTransition.getInstant().getEpochSecond();
+
+        final ByteBuffer buf = ByteBuffer.allocate(7).order(ByteOrder.LITTLE_ENDIAN);
+
+        buf.put(CMD_SET_DST);
+        buf.putInt((int) nextTransitionEpochSeconds);
+        buf.putShort((short) nextTransition.getDuration().getSeconds());
+
+        write(builder, buf.array());
+    }
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferImpl.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferImpl.java
index 46823eacd8..d194473e13 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferImpl.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferImpl.java
@@ -1,7 +1,5 @@
 package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.filetransfer;
 
-import android.bluetooth.BluetoothGattCharacteristic;
-
 import androidx.annotation.Nullable;
 
 import org.slf4j.Logger;
@@ -13,6 +11,7 @@ import java.nio.ByteOrder;
 import java.util.ArrayList;
 import java.util.HashSet;
 import java.util.List;
+import java.util.UUID;
 import java.util.zip.DataFormatException;
 import java.util.zip.Deflater;
 import java.util.zip.Inflater;
@@ -74,7 +73,7 @@ public abstract class ZeppOsFileTransferImpl {
 
     public abstract void handleFileDownloadRequest(final byte session, final FileTransferRequest request);
 
-    public abstract void onCharacteristicChanged(final BluetoothGattCharacteristic characteristic);
+    public abstract void onCharacteristicChanged(final UUID characteristicUUID, final byte[] value);
 
     public void uploadFile(final String url,
                            final String filename,
@@ -105,7 +104,7 @@ public abstract class ZeppOsFileTransferImpl {
         buf.get(); // discard command byte
 
         mVersion = buf.get() & 0xff;
-        mChunkSize = buf.getShort();
+        mChunkSize = buf.getShort() & 0xffff;
         if (mVersion >= 3) {
             mCompressedChunkSize = buf.getInt();
             final int numServices = buf.getShort();
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferV2.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferV2.java
index 4993c4aa64..fadda99656 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferV2.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferV2.java
@@ -16,8 +16,6 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.filetransfer;
 
-import android.bluetooth.BluetoothGattCharacteristic;
-
 import org.apache.commons.lang3.ArrayUtils;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -27,6 +25,7 @@ import java.nio.ByteOrder;
 import java.nio.charset.StandardCharsets;
 import java.util.HashMap;
 import java.util.Map;
+import java.util.UUID;
 
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsSupport;
@@ -134,8 +133,8 @@ public class ZeppOsFileTransferV2 extends ZeppOsFileTransferImpl {
     }
 
     @Override
-    public void onCharacteristicChanged(final BluetoothGattCharacteristic characteristic) {
-        LOG.error("Unknown characteristic changed: {}", characteristic.getUuid());
+    public void onCharacteristicChanged(final UUID characteristicUUID, final byte[] value) {
+        LOG.error("Unknown characteristic changed: {}", characteristicUUID);
     }
 
     private void handleFileTransferData(final byte[] payload) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferV3.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferV3.java
index 792cf38ebb..30b047c0b8 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferV3.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/filetransfer/ZeppOsFileTransferV3.java
@@ -16,8 +16,6 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.filetransfer;
 
-import android.bluetooth.BluetoothGattCharacteristic;
-
 import org.apache.commons.lang3.ArrayUtils;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -31,7 +29,6 @@ import java.util.UUID;
 
 import nodomain.freeyourgadget.gadgetbridge.devices.huami.HuamiService;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsSupport;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.ZeppOsTransactionBuilder;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos.services.ZeppOsFileTransferService;
@@ -184,10 +181,7 @@ public class ZeppOsFileTransferV3 extends ZeppOsFileTransferImpl {
     }
 
     @Override
-    public void onCharacteristicChanged(final BluetoothGattCharacteristic characteristic) {
-        final UUID characteristicUUID = characteristic.getUuid();
-        final byte[] value = characteristic.getValue();
-
+    public void onCharacteristicChanged(final UUID characteristicUUID, final byte[] value) {
         if (HuamiService.UUID_CHARACTERISTIC_ZEPP_OS_FILE_TRANSFER_V3_RECEIVE.equals(characteristicUUID)) {
             handleFileReceiveData(value);
         } else if (HuamiService.UUID_CHARACTERISTIC_ZEPP_OS_FILE_TRANSFER_V3_SEND.equals(characteristicUUID)) {
@@ -348,9 +342,9 @@ public class ZeppOsFileTransferV3 extends ZeppOsFileTransferImpl {
 
             LOG.debug("Got V3 data for session={}, progress={}/{}", currentReceiveSession, currentReceiveRequest.getProgress(), currentReceiveRequest.getSize());
 
-            final TransactionBuilder builder = mSupport.createTransactionBuilder("send ack v3 file data");
+            final ZeppOsTransactionBuilder builder = mSupport.createZeppOsTransactionBuilder("send ack v3 file data");
             builder.write(
-                    mSupport.getCharacteristic(HuamiService.UUID_CHARACTERISTIC_ZEPP_OS_FILE_TRANSFER_V3_RECEIVE),
+                    HuamiService.UUID_CHARACTERISTIC_ZEPP_OS_FILE_TRANSFER_V3_RECEIVE,
                     new byte[]{
                             CMD_DATA_V3_ACK,
                             0x00,
@@ -361,7 +355,7 @@ public class ZeppOsFileTransferV3 extends ZeppOsFileTransferImpl {
                             (byte) 0x00
                     }
             );
-            builder.queue(mSupport.getQueue());
+            builder.queue(mSupport);
 
             if (currentReceiveChunkIsLast) {
                 final byte[] data;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/XiaomiSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/XiaomiSupport.java
index 28ac3e3801..d948158414 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/XiaomiSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/XiaomiSupport.java
@@ -123,25 +123,11 @@ public class XiaomiSupport extends AbstractDeviceSupport {
         }
     }
 
-    private DeviceCoordinator.ConnectionType getForcedConnectionTypeFromPrefs() {
-        final String connTypeAuto = getContext().getString(R.string.pref_force_connection_type_auto_value);
-        String connTypePref = getDevicePrefs().getString(PREF_FORCE_CONNECTION_TYPE, connTypeAuto);
-
-        if (getContext().getString(R.string.pref_force_connection_type_ble_value).equals(connTypePref))
-            return DeviceCoordinator.ConnectionType.BLE;
-
-        if (getContext().getString(R.string.pref_force_connection_type_bt_classic_value).equals(connTypePref))
-            return DeviceCoordinator.ConnectionType.BT_CLASSIC;
-
-        // either set to default, unknown option selected, or has not been set
-        return DeviceCoordinator.ConnectionType.BOTH;
-    }
-
     private XiaomiConnectionSupport createConnectionSpecificSupport() {
         DeviceCoordinator.ConnectionType connType = getCoordinator().getConnectionType();
 
         if (connType == DeviceCoordinator.ConnectionType.BOTH) {
-            connType = getForcedConnectionTypeFromPrefs();
+            connType = getDevicePrefs().getForcedConnectionTypeFromPrefs();
         }
 
         switch (connType) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/preferences/DevicePrefs.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/preferences/DevicePrefs.java
index ac97f6bc8c..95f626c25b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/preferences/DevicePrefs.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/preferences/DevicePrefs.java
@@ -26,6 +26,7 @@ import android.content.SharedPreferences;
 import android.text.format.DateFormat;
 
 import nodomain.freeyourgadget.gadgetbridge.GBApplication;
+import nodomain.freeyourgadget.gadgetbridge.devices.DeviceCoordinator;
 import nodomain.freeyourgadget.gadgetbridge.model.BatteryConfig;
 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
@@ -119,4 +120,16 @@ public class DevicePrefs extends Prefs {
         return getBoolean(PREF_ALLOW_HIGH_MTU, true);
     }
 
+    public DeviceCoordinator.ConnectionType getForcedConnectionTypeFromPrefs() {
+        final String connTypePref = getString(DeviceSettingsPreferenceConst.PREF_FORCE_CONNECTION_TYPE, "BOTH");
+
+        if ("BLE".equals(connTypePref))
+            return DeviceCoordinator.ConnectionType.BLE;
+
+        if ("BT_CLASSIC".equals(connTypePref))
+            return DeviceCoordinator.ConnectionType.BT_CLASSIC;
+
+        // either set to default, unknown option selected, or has not been set
+        return DeviceCoordinator.ConnectionType.BOTH;
+    }
 }
```
-----------------------------------
