# Commit: 8061a1843d10f12fab47455bb609adf912b1ec8b
## Message: Huawei: Force new app version, extend reverse capabilities, fixes
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/DeviceConfig.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/Notifications.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiEphemerisManager.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/DeviceConfig.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/DeviceConfig.java
index 7138c4e625..34d9739153 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/DeviceConfig.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/DeviceConfig.java
@@ -837,7 +837,7 @@ public class DeviceConfig {
                         case 0xf:
                             break;
                         case 0x11:
-                            this.tlv.put(b, 1500106300); // Force AppVersion to 15.1.6.300
+                            this.tlv.put(b, 1600008300); // Force AppVersion to 16.0.8.300
                             break;
                         case 0x15:
                             this.tlv.put(b); // Force buildOSPlatformVersion to ""
@@ -1857,7 +1857,7 @@ public class DeviceConfig {
                 this.commandId = id;
 
                 // Bits like ext capabilities
-                byte[] capabilities = {(byte) 0xFD, (byte) 0xF7, 0x53};
+                byte[] capabilities = {(byte) 0xFD, (byte) 0xF7, (byte)0x73, (byte)0x7A};
                 this.tlv = new HuaweiTLV()
                         .put(0x01, capabilities);
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/Notifications.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/Notifications.java
index 9cabab8a30..2c70715c88 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/Notifications.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/Notifications.java
@@ -124,7 +124,7 @@ public class Notifications {
             }
 
             if (sourceAppId != null)
-                this.tlv.put(0x11, sourceAppId);
+                this.tlv.put(0x11, sourceAppId.length() > 127?sourceAppId.substring(0, 127): sourceAppId);
 
             if(addParams != null) {
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiEphemerisManager.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiEphemerisManager.java
index 140e13be0b..9a8d72b046 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiEphemerisManager.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiEphemerisManager.java
@@ -305,19 +305,20 @@ public class HuaweiEphemerisManager {
                 throw new Exception("Ephemeris no config data");
             }
 
-            JsonObject conf = availableDataConfig.getAsJsonObject(downloadTag);
+            final JsonObject conf = availableDataConfig.getAsJsonObject(downloadTag);
+            if(conf == null) {
+                throw new Exception("Ephemeris no config for tag");
+            }
 
             int version = conf.get("ver").getAsInt();
             if (version != downloadVersion) {
                 throw new Exception("Ephemeris version mismatch");
             }
             String uuid = conf.get("uuid").getAsString();
-
             if (uuid.isEmpty())
                 throw new Exception("Ephemeris uuid is empty");
 
             JsonArray filesJs = conf.get("files").getAsJsonArray();
-
             List<String> files = new ArrayList<>();
             for (int i = 0; i < filesJs.size(); i++) {
                 files.add(filesJs.get(i).getAsString());
@@ -366,14 +367,12 @@ public class HuaweiEphemerisManager {
                 //fileList = "gpslocation.dat";
                 LOG.error("Currently not supported. File type 1. Tag version 0");
             } else if (currentRequest.getTagVersion() == 1 || currentRequest.getTagVersion() == 2 || currentRequest.getTagVersion() == 3) {
-                int i = 0;
-                while (i < currentRequest.getTagFiles().size()) {
-                    fileList.append(currentRequest.getTagFiles().get(i));
-                    if (i == currentRequest.getTagFiles().size() - 1) {
-                        break;
+                List<String> tagFiles = currentRequest.getTagFiles();
+                for (int i = 0; i < tagFiles.size(); i++) {
+                    fileList.append(tagFiles.get(i));
+                    if (i < tagFiles.size() - 1) {
+                        fileList.append(";");
                     }
-                    fileList.append(";");
-                    i++;
                 }
             } else {
                 LOG.error("Unknown version");
```
-----------------------------------
