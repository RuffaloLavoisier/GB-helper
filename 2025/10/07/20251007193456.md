# Commit: b10669d9334011f0f744c5be5b22cfedcba6901d
## Message: Even Realities G1: Handle MTU change as the device expects

The Glasses expect a notification when the MTU chagnes, so forward the
new MTU value to the glasses.
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1Communications.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1Constants.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1DeviceSupport.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1Communications.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1Communications.java
index a4ca5ec87a..1383c7496c 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1Communications.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1Communications.java
@@ -179,24 +179,27 @@ public class G1Communications {
         protected abstract int getHeaderSize();
     }
 
-    public static class CommandSendInit extends CommandHandler {
-        public CommandSendInit() {
+    public static class CommandSendMtu extends CommandHandler {
+        private final byte mtu;
+
+        public CommandSendMtu(byte mtu) {
             super(true, null);
+            this.mtu = mtu;
         }
 
         @Override
         public byte[] serialize() {
-            return new byte[] { G1Constants.CommandId.INIT.id, (byte)0xFB };
+            return new byte[] { G1Constants.CommandId.SET_MTU.id, mtu };
         }
 
         @Override
         public boolean responseMatches(byte[] payload) {
-            return payload[0] == G1Constants.CommandId.INIT.id;
+            return payload[0] == G1Constants.CommandId.SET_MTU.id;
         }
 
         @Override
         public String getName() {
-            return "send_init";
+            return "send_mtu";
         }
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1Constants.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1Constants.java
index d9275bc49f..f7a1c23f70 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1Constants.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1Constants.java
@@ -112,7 +112,7 @@ public class G1Constants {
         SYSTEM((byte) 0x23),
         HEARTBEAT((byte) 0x25),
         BATTERY_LEVEL((byte) 0x2C),
-        INIT((byte) 0x4D),
+        SET_MTU((byte) 0x4D),
         NOTIFICATION((byte) 0x4B),
         FW_INFO_RESPONSE((byte) 0x6E),
         DEBUG_LOG((byte) 0xF4),
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1DeviceSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1DeviceSupport.java
index d5e8a7a6c7..8614d759ea 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1DeviceSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/evenrealities/G1DeviceSupport.java
@@ -282,6 +282,34 @@ public class G1DeviceSupport extends AbstractBTLEMultiDeviceSupport {
     // Below are all the onXXX() handlers overridden from the base class. //
     ////////////////////////////////////////////////////////////////////////
 
+    @Override
+    public void onMtuChanged(BluetoothGatt gatt, int mtu, int status) {
+        super.onMtuChanged(gatt, mtu, status);
+
+        // If the status was not successful, don't forward to the glasses.
+        if (status != BluetoothGatt.GATT_SUCCESS) {
+            return;
+        }
+
+        // The glasses expect to be forwarded the MTU, so when it is changed, also notify the side
+        // that it changed on.
+        String address = gatt.getDevice().getAddress();
+        if (getDevice(G1Constants.Side.LEFT.getDeviceIndex()) != null) {
+            String leftAddress = getDevice(G1Constants.Side.LEFT.getDeviceIndex()).getAddress();
+            if (address.equals(leftAddress) && leftSide != null) {
+                leftSide.send(new G1Communications.CommandSendMtu((byte)mtu));
+            }
+        }
+
+        if (getDevice(G1Constants.Side.RIGHT.getDeviceIndex()) != null) {
+            String rightAddress =
+                    getDevice(G1Constants.Side.RIGHT.getDeviceIndex()).getAddress();
+            if (address.equals(rightAddress) && rightSide != null) {
+                rightSide.send(new G1Communications.CommandSendMtu((byte)mtu));
+            }
+        }
+    }
+
     @Override
     public boolean onCharacteristicChanged(BluetoothGatt gatt,
                                            BluetoothGattCharacteristic characteristic,
```
-----------------------------------
