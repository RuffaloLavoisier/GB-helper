# Commit: a395e8d7e7f5470da0eac7bc60fd8478c9891c03
## Message: Remove redundant checks for sdk 23
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/PendingIntentUtils.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBExceptionHandler.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/SleepAlarmWidget.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/Widget.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/DebugActivity.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/NotificationManagementActivity.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/BodyEnergyFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/CaloriesDailyFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/CaloriesPeriodFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/HRVStatusFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/HeartRatePeriodFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/LoadFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/PaiChartFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateDailyFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRatePeriodFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/SleepPeriodFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StepsDailyFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StepsPeriodFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StressDailyFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StressPeriodFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/TemperatureDailyFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/discovery/DiscoveryActivityV2.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/welcome/WelcomeFragmentPermissions.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEvent.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventFindPhone.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventScreenshot.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/AlarmReceiver.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/CMWeatherReceiver.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/LineageOsWeatherReceiver.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/TimeChangeReceiver.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/gps/GBLocationService.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/DeviceCommunicationService.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/BLEScanService.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/BtLEQueue.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/um25/Support/UM25Support.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/receivers/AutoConnectIntervalReceiver.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/AndroidUtils.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/GB.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/PermissionsUtils.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/maps/MapsManager.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/notifications/GBProgressNotification.kt

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java
index f8fc0fb68a..5af8e3a01e 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java
@@ -101,7 +101,6 @@ import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 import nodomain.freeyourgadget.gadgetbridge.util.GBPrefs;
 import nodomain.freeyourgadget.gadgetbridge.util.LimitedQueue;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
 import nodomain.freeyourgadget.gadgetbridge.util.backup.PeriodicZipExporter;
 import nodomain.freeyourgadget.gadgetbridge.util.preferences.DevicePrefs;
@@ -212,7 +211,12 @@ public class GBApplication extends Application {
         GBApplication.deviceService().quit();
 
         final Intent startActivity = new Intent(context, ControlCenterv2.class);
-        final PendingIntent pendingIntent = PendingIntentUtils.getActivity(context, 1337, startActivity, PendingIntent.FLAG_CANCEL_CURRENT, false);
+        final PendingIntent pendingIntent = PendingIntent.getActivity(
+                context,
+                1337,
+                startActivity,
+                PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_IMMUTABLE
+        );
         final AlarmManager alarmManager = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);
         alarmManager.set(AlarmManager.RTC, System.currentTimeMillis() + 1500, pendingIntent);
 
@@ -229,9 +233,7 @@ public class GBApplication extends Application {
             thread.permitDiskReads(); // log requires disk access
             thread.permitDiskWrites(); // log requires disk access
             thread.detectNetwork();
-            if (VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-                thread.detectResourceMismatches();
-            }
+            thread.detectResourceMismatches();
             if (VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                 thread.detectUnbufferedIo();
             }
@@ -245,9 +247,7 @@ public class GBApplication extends Application {
             vm.detectLeakedClosableObjects();
             vm.detectLeakedRegistrationObjects();
             vm.detectFileUriExposure();
-            if (VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-                vm.detectCleartextNetwork();
-            }
+            vm.detectCleartextNetwork();
             if (VERSION.SDK_INT >= Build.VERSION_CODES.O) {
                 vm.detectContentUriWithoutPermission();
                 vm.detectUntaggedSockets();
@@ -331,18 +331,16 @@ public class GBApplication extends Application {
             PeriodicZipExporter.INSTANCE.scheduleNextExecution(context);
         }
 
-        if (isRunningMarshmallowOrLater()) {
-            notificationManager = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);
-            if (isRunningOreoOrLater()) {
-                bluetoothStateChangeReceiver = new BluetoothStateChangeReceiver();
-                final IntentFilter bif = new IntentFilter();
-                bif.addAction(BluetoothAdapter.ACTION_STATE_CHANGED);
-                if (isRunningPieOrLater())
-                    bif.addAction(BluetoothStateChangeReceiver.ANDROID_BLUETOOTH_DEVICE_ACTION_BATTERY_LEVEL_CHANGED);
-                registerReceiver(bluetoothStateChangeReceiver, bif);
-            }
-            startNotificationCollectorMonitorService();
+        notificationManager = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);
+        if (isRunningOreoOrLater()) {
+            bluetoothStateChangeReceiver = new BluetoothStateChangeReceiver();
+            final IntentFilter bif = new IntentFilter();
+            bif.addAction(BluetoothAdapter.ACTION_STATE_CHANGED);
+            if (isRunningPieOrLater())
+                bif.addAction(BluetoothStateChangeReceiver.ANDROID_BLUETOOTH_DEVICE_ACTION_BATTERY_LEVEL_CHANGED);
+            registerReceiver(bluetoothStateChangeReceiver, bif);
         }
+        startNotificationCollectorMonitorService();
 
         BondingUtil.StartObservingAll(getBaseContext());
     }
@@ -362,7 +360,12 @@ public class GBApplication extends Application {
         } catch (IllegalStateException e) {
             String message = e.toString();
             final Intent instructionsIntent = new Intent(Intent.ACTION_VIEW, Uri.parse("https://gadgetbridge.org/basics/topics/background-service/"));
-            final PendingIntent pi = PendingIntentUtils.getActivity(context, 0, instructionsIntent, PendingIntent.FLAG_ONE_SHOT, false);
+            final PendingIntent pi = PendingIntent.getActivity(
+                    context,
+                    0,
+                    instructionsIntent,
+                    PendingIntent.FLAG_ONE_SHOT | PendingIntent.FLAG_IMMUTABLE
+            );
             GB.notify(NOTIFICATION_ID_ERROR,
                     new NotificationCompat.Builder(this, NOTIFICATION_CHANNEL_HIGH_PRIORITY_ID)
                             .setSmallIcon(R.drawable.ic_notification)
@@ -513,10 +516,6 @@ public class GBApplication extends Application {
         dbLock.unlock();
     }
 
-    public static boolean isRunningMarshmallowOrLater() {
-        return VERSION.SDK_INT >= Build.VERSION_CODES.M;
-    }
-
     public static boolean isRunningNougatOrLater() {
         return VERSION.SDK_INT >= Build.VERSION_CODES.N;
     }
@@ -588,9 +587,8 @@ public class GBApplication extends Application {
         return false;
     }
 
-    @TargetApi(Build.VERSION_CODES.M)
     public static int getGrantedInterruptionFilter() {
-        if (GBApplication.isRunningMarshmallowOrLater() && notificationManager.isNotificationPolicyAccessGranted()) {
+        if (notificationManager.isNotificationPolicyAccessGranted()) {
             return notificationManager.getCurrentInterruptionFilter();
         }
         return NotificationManager.INTERRUPTION_FILTER_ALL;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBExceptionHandler.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBExceptionHandler.java
index 9a589474db..3076a3bce0 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBExceptionHandler.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBExceptionHandler.java
@@ -35,7 +35,6 @@ import org.slf4j.LoggerFactory;
 import java.io.File;
 
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 
 /**
  * Catches otherwise uncaught exceptions, logs them and terminates the app.
@@ -104,12 +103,12 @@ public class GBExceptionHandler implements Thread.UncaughtExceptionHandler {
         shareIntent.putExtra(Intent.EXTRA_TEXT, Log.getStackTraceString(e));
         shareIntent.setType("text/plain");
 
-        final PendingIntent pendingShareIntent = PendingIntentUtils.getActivity(
+        Intent intent = Intent.createChooser(shareIntent, context.getString(R.string.app_crash_share_stacktrace));
+        final PendingIntent pendingShareIntent = PendingIntent.getActivity(
                 context,
                 0,
-                Intent.createChooser(shareIntent, context.getString(R.string.app_crash_share_stacktrace)),
-                PendingIntent.FLAG_UPDATE_CURRENT,
-                false
+                intent,
+                PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
         );
 
         final NotificationCompat.Action shareAction = new NotificationCompat.Action.Builder(android.R.drawable.ic_menu_share, context.getString(R.string.share), pendingShareIntent).build();
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/SleepAlarmWidget.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/SleepAlarmWidget.java
index 32ce58d9d8..a5fd55618d 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/SleepAlarmWidget.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/SleepAlarmWidget.java
@@ -17,14 +17,11 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge;
 
-import android.annotation.TargetApi;
-import android.app.AlarmManager;
 import android.app.PendingIntent;
 import android.appwidget.AppWidgetManager;
 import android.appwidget.AppWidgetProvider;
 import android.content.Context;
 import android.content.Intent;
-import android.os.Build;
 import android.os.Bundle;
 import android.widget.RemoteViews;
 import android.widget.Toast;
@@ -33,13 +30,11 @@ import java.util.ArrayList;
 import java.util.Calendar;
 import java.util.GregorianCalendar;
 
-import nodomain.freeyourgadget.gadgetbridge.activities.ConfigureAlarms;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivityUser;
 import nodomain.freeyourgadget.gadgetbridge.model.Alarm;
 import nodomain.freeyourgadget.gadgetbridge.util.AlarmUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.WidgetPreferenceStorage;
 
 /**
@@ -65,8 +60,12 @@ public class SleepAlarmWidget extends AppWidgetProvider {
         intent.setPackage(BuildConfig.APPLICATION_ID);
         intent.setAction(ACTION_CLICK);
         intent.putExtra(AppWidgetManager.EXTRA_APPWIDGET_ID, appWidgetId);
-        PendingIntent clickPI = PendingIntentUtils.getBroadcast(
-                context, appWidgetId, intent, PendingIntent.FLAG_UPDATE_CURRENT, false);
+        PendingIntent clickPI = PendingIntent.getBroadcast(
+                context,
+                appWidgetId,
+                intent,
+                PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
+        );
         views.setOnClickPendingIntent(R.id.sleepalarmwidget_text, clickPI);
 
         // Instruct the widget manager to update the widget
@@ -133,27 +132,6 @@ public class SleepAlarmWidget extends AppWidgetProvider {
             ArrayList<Alarm> alarms = new ArrayList<>(1);
             alarms.add(alarm);
             GBApplication.deviceService(deviceForWidget).onSetAlarms(alarms);
-
-//          setAlarmViaAlarmManager(context, calendar.getTimeInMillis());
         }
     }
-
-    /**
-     * Use the Android alarm manager to create the alarm icon in the status bar.
-     *
-     * @param packageContext {@code Context}: A Context of the application package implementing this
-     *                       class.
-     * @param triggerTime    {@code long}: time at which the underlying alarm is triggered in wall time
-     *                       milliseconds since the epoch
-     */
-    private void setAlarmViaAlarmManager(Context packageContext, long triggerTime) {
-        AlarmManager am = (AlarmManager) packageContext.getSystemService(Context.ALARM_SERVICE);
-        // TODO: launch the alarm configuration activity when clicking the alarm in the status bar
-        Intent intent = new Intent(packageContext, ConfigureAlarms.class);
-        intent.setPackage(BuildConfig.APPLICATION_ID);
-        PendingIntent pi = PendingIntentUtils.getBroadcast(packageContext, 0, intent,
-                PendingIntent.FLAG_CANCEL_CURRENT, false);
-        am.setAlarmClock(new AlarmManager.AlarmClockInfo(triggerTime, pi), pi);
-    }
 }
-
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/Widget.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/Widget.java
index 6c0e8f16f8..18e7a63aac 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/Widget.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/Widget.java
@@ -50,7 +50,6 @@ import nodomain.freeyourgadget.gadgetbridge.util.AndroidUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.DateTimeUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.FormatUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.WidgetPreferenceStorage;
 
 public class Widget extends AppWidgetProvider {
@@ -91,28 +90,47 @@ public class Widget extends AppWidgetProvider {
         intent.setPackage(BuildConfig.APPLICATION_ID);
         intent.setAction(WIDGET_CLICK);
         intent.putExtra(AppWidgetManager.EXTRA_APPWIDGET_ID, appWidgetId);
-        PendingIntent refreshDataIntent = PendingIntentUtils.getBroadcast(
-                context, appWidgetId, intent, PendingIntent.FLAG_UPDATE_CURRENT, false);
+        PendingIntent refreshDataIntent = PendingIntent.getBroadcast(
+                context,
+                appWidgetId,
+                intent,
+                PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
+        );
         views.setOnClickPendingIntent(R.id.todaywidget_header_container, refreshDataIntent);
 
         //open GB main window
         Intent startMainIntent = new Intent(context, ControlCenterv2.class);
         startMainIntent.setPackage(BuildConfig.APPLICATION_ID);
-        PendingIntent startMainPIntent = PendingIntentUtils.getActivity(context, 0, startMainIntent, 0, false);
+        PendingIntent startMainPIntent = PendingIntent.getActivity(
+                context,
+                0,
+                startMainIntent,
+                PendingIntent.FLAG_IMMUTABLE
+        );
         views.setOnClickPendingIntent(R.id.todaywidget_header_icon, startMainPIntent);
 
         //alarms popup menu
         Intent startAlarmListIntent = new Intent(context, WidgetAlarmsActivity.class);
         startAlarmListIntent.setPackage(BuildConfig.APPLICATION_ID);
         startAlarmListIntent.putExtra(GBDevice.EXTRA_DEVICE, deviceForWidget);
-        PendingIntent startAlarmListPIntent = PendingIntentUtils.getActivity(context, appWidgetId, startAlarmListIntent, PendingIntent.FLAG_UPDATE_CURRENT, false);
+        PendingIntent startAlarmListPIntent = PendingIntent.getActivity(
+                context,
+                appWidgetId,
+                startAlarmListIntent,
+                PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
+        );
         views.setOnClickPendingIntent(R.id.todaywidget_header_alarm_icon, startAlarmListPIntent);
 
         //charts
         Intent startChartsIntent = new Intent(context, ActivityChartsActivity.class);
         startChartsIntent.setPackage(BuildConfig.APPLICATION_ID);
         startChartsIntent.putExtra(GBDevice.EXTRA_DEVICE, deviceForWidget);
-        PendingIntent startChartsPIntent = PendingIntentUtils.getActivity(context, appWidgetId, startChartsIntent, PendingIntent.FLAG_CANCEL_CURRENT, false);
+        PendingIntent startChartsPIntent = PendingIntent.getActivity(
+                context,
+                appWidgetId,
+                startChartsIntent,
+                PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_IMMUTABLE
+        );
         views.setOnClickPendingIntent(R.id.todaywidget_bottom_layout, startChartsPIntent);
 
         DailyTotals dailyTotals = getSteps(deviceForWidget);
@@ -140,21 +158,19 @@ public class Widget extends AppWidgetProvider {
         views.setProgressBar(R.id.todaywidget_sleep_progress, sleepGoalMinutes, sleep, false);
         views.setProgressBar(R.id.todaywidget_distance_progress, distanceGoal, steps * stepLength, false);
         views.setViewVisibility(R.id.todaywidget_battery_icon, View.GONE);
-        if (deviceForWidget != null) {
-            String status = String.format("%1s", deviceForWidget.getStateString(context));
-            if (deviceForWidget.isConnected()) {
-                if (deviceForWidget.getBatteryLevel() > 1) {
-                    views.setViewVisibility(R.id.todaywidget_battery_icon, View.VISIBLE);
+        String status = String.format("%1s", deviceForWidget.getStateString(context));
+        if (deviceForWidget.isConnected()) {
+            if (deviceForWidget.getBatteryLevel() > 1) {
+                views.setViewVisibility(R.id.todaywidget_battery_icon, View.VISIBLE);
 
-                    status = String.format("%1s%%", deviceForWidget.getBatteryLevel());
-                }
+                status = String.format("%1s%%", deviceForWidget.getBatteryLevel());
             }
-
-            String deviceName = deviceForWidget.getAlias() != null ? deviceForWidget.getAlias() : deviceForWidget.getName();
-            views.setTextViewText(R.id.todaywidget_device_status, status);
-            views.setTextViewText(R.id.todaywidget_device_name, deviceName);
         }
 
+        String deviceName = deviceForWidget.getAlias() != null ? deviceForWidget.getAlias() : deviceForWidget.getName();
+        views.setTextViewText(R.id.todaywidget_device_status, status);
+        views.setTextViewText(R.id.todaywidget_device_name, deviceName);
+
         // Instruct the widget manager to update the widget
         appWidgetManager.updateAppWidget(appWidgetId, views);
     }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/DebugActivity.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/DebugActivity.java
index fd563be443..13b2f68c5b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/DebugActivity.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/DebugActivity.java
@@ -127,7 +127,6 @@ import nodomain.freeyourgadget.gadgetbridge.model.weather.WeatherMapper;
 import nodomain.freeyourgadget.gadgetbridge.model.WeatherSpec;
 import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.WidgetPreferenceStorage;
 
 public class DebugActivity extends AbstractGBActivity {
@@ -1037,8 +1036,10 @@ public class DebugActivity extends AbstractGBActivity {
         notificationIntent.setPackage(BuildConfig.APPLICATION_ID);
         notificationIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK
                 | Intent.FLAG_ACTIVITY_CLEAR_TASK);
-        PendingIntent pendingIntent = PendingIntentUtils.getActivity(getApplicationContext(), 0,
-                notificationIntent, 0, false);
+        Context context = getApplicationContext();
+        int flags1 = 0;
+        flags1 |= PendingIntent.FLAG_IMMUTABLE;
+        PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, notificationIntent, flags1);
 
         RemoteInput remoteInput = new RemoteInput.Builder(EXTRA_REPLY)
                 .build();
@@ -1046,7 +1047,7 @@ public class DebugActivity extends AbstractGBActivity {
         Intent replyIntent = new Intent(ACTION_REPLY);
         replyIntent.setPackage(BuildConfig.APPLICATION_ID);
 
-        PendingIntent replyPendingIntent = PendingIntentUtils.getBroadcast(this, 0, replyIntent, 0, true);
+        PendingIntent replyPendingIntent = PendingIntent.getBroadcast(this, 0, replyIntent, PendingIntent.FLAG_MUTABLE);
 
         NotificationCompat.Action action =
                 new NotificationCompat.Action.Builder(android.R.drawable.ic_input_add, "Reply", replyPendingIntent)
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/NotificationManagementActivity.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/NotificationManagementActivity.java
index 0f1dd93827..238a95f9c7 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/NotificationManagementActivity.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/NotificationManagementActivity.java
@@ -108,11 +108,6 @@ public class NotificationManagementActivity extends AbstractSettingsActivityV2 {
 
             final PreferenceCategory notificationsCategory = findPreference("pref_key_notifications");
 
-            if (!GBApplication.isRunningMarshmallowOrLater()) {
-                pref = findPreference("notification_filter");
-                notificationsCategory.removePreference(pref);
-            }
-
             if (GBApplication.isRunningTenOrLater()) {
                 pref = findPreference("minimize_priority");
                 notificationsCategory.removePreference(pref);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/BodyEnergyFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/BodyEnergyFragment.java
index de567eefc5..30f068efac 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/BodyEnergyFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/BodyEnergyFragment.java
@@ -4,7 +4,6 @@ import android.graphics.Bitmap;
 import android.graphics.Canvas;
 import android.graphics.Color;
 import android.graphics.Paint;
-import android.os.Build;
 import android.os.Bundle;
 import android.util.TypedValue;
 import android.view.LayoutInflater;
@@ -70,11 +69,9 @@ public class BodyEnergyFragment extends AbstractChartFragment<BodyEnergyFragment
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View rootView = inflater.inflate(R.layout.fragment_body_energy, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         mDateView = rootView.findViewById(R.id.body_energy_date_view);
         bodyEnergyGauge = rootView.findViewById(R.id.body_energy_gauge);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/CaloriesDailyFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/CaloriesDailyFragment.java
index 7d5bf4dd3b..d4dfb646d6 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/CaloriesDailyFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/CaloriesDailyFragment.java
@@ -16,7 +16,6 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
-import android.os.Build;
 import android.os.Bundle;
 import android.util.TypedValue;
 import android.view.LayoutInflater;
@@ -91,11 +90,9 @@ public class CaloriesDailyFragment extends AbstractChartFragment<CaloriesDailyFr
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View rootView = inflater.inflate(R.layout.fragment_calories, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         caloriesGauge = rootView.findViewById(R.id.calories_gauge);
         dateView = rootView.findViewById(R.id.date_view);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/CaloriesPeriodFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/CaloriesPeriodFragment.java
index 069139f233..238ddd13b9 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/CaloriesPeriodFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/CaloriesPeriodFragment.java
@@ -1,8 +1,6 @@
 package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
 import android.content.Context;
-import android.graphics.Color;
-import android.os.Build;
 import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -78,11 +76,9 @@ public class CaloriesPeriodFragment extends CaloriesFragment<CaloriesPeriodFragm
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View rootView = inflater.inflate(R.layout.fragment_calories_period, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         mDateView = rootView.findViewById(R.id.calories_date_view);
         caloriesChart = rootView.findViewById(R.id.calories_chart);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/HRVStatusFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/HRVStatusFragment.java
index e6e62e84dd..2b126f02a9 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/HRVStatusFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/HRVStatusFragment.java
@@ -16,7 +16,6 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
-import android.os.Build;
 import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -85,11 +84,9 @@ public class HRVStatusFragment extends AbstractChartFragment<HRVStatusFragment.H
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View rootView = inflater.inflate(R.layout.fragment_hrv_status, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         mWeeklyHRVStatusChart = rootView.findViewById(R.id.hrv_weekly_line_chart);
         mHRVStatusLastNight = rootView.findViewById(R.id.hrv_status_last_night);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/HeartRatePeriodFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/HeartRatePeriodFragment.java
index 9d54ffe651..8a9f9358d9 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/HeartRatePeriodFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/HeartRatePeriodFragment.java
@@ -1,7 +1,6 @@
 package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
 import android.graphics.Color;
-import android.os.Build;
 import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -23,6 +22,10 @@ import com.github.mikephil.charting.data.LineDataSet;
 import com.github.mikephil.charting.formatter.ValueFormatter;
 import com.github.mikephil.charting.interfaces.datasets.ILineDataSet;
 
+import org.apache.commons.lang3.tuple.Pair;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
 import java.text.SimpleDateFormat;
 import java.util.ArrayList;
 import java.util.Calendar;
@@ -31,10 +34,6 @@ import java.util.Date;
 import java.util.List;
 import java.util.Locale;
 
-import org.apache.commons.lang3.tuple.Pair;
-import org.slf4j.Logger;
-import org.slf4j.LoggerFactory;
-
 import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.activities.HeartRateUtils;
@@ -97,9 +96,7 @@ public class HeartRatePeriodFragment extends AbstractChartFragment<HeartRatePeri
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View rootView = inflater.inflate(R.layout.fragment_heart_rate, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> getChartsHost().enableSwipeRefresh(scrollY == 0));
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> getChartsHost().enableSwipeRefresh(scrollY == 0));
 
         mDateView = rootView.findViewById(R.id.hr_date_view);
         hrLineChart = rootView.findViewById(R.id.heart_rate_line_chart);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/LoadFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/LoadFragment.java
index c050a5aa80..4475438852 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/LoadFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/LoadFragment.java
@@ -19,7 +19,6 @@ package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 import android.content.Context;
 import android.content.res.Resources;
 import android.graphics.Color;
-import android.os.Build;
 import android.os.Bundle;
 import android.util.TypedValue;
 import android.view.LayoutInflater;
@@ -97,11 +96,9 @@ public class LoadFragment extends AbstractChartFragment<LoadFragment.LoadsData>
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View rootView = inflater.inflate(R.layout.fragment_load, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         dateHeader = rootView.findViewById(R.id.date_view);
         dailyLoadChart = rootView.findViewById(R.id.daily_load_chart);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/PaiChartFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/PaiChartFragment.java
index 4644473320..c6d3b70498 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/PaiChartFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/PaiChartFragment.java
@@ -16,8 +16,6 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
-import android.graphics.Color;
-import android.os.Build;
 import android.os.Bundle;
 import android.util.TypedValue;
 import android.view.LayoutInflater;
@@ -110,11 +108,9 @@ public class PaiChartFragment extends AbstractChartFragment<PaiChartFragment.Pai
 
         final View rootView = inflater.inflate(R.layout.fragment_pai_chart, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         mGoalMinutesGauge = rootView.findViewById(R.id.goal_minutes_gauge);
         mWeekChart = rootView.findViewById(R.id.pai_chart_week);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateDailyFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateDailyFragment.java
index d3a71e4a51..d8d4d60971 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateDailyFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateDailyFragment.java
@@ -1,6 +1,5 @@
 package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
-import android.os.Build;
 import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -49,11 +48,9 @@ public class RespiratoryRateDailyFragment extends RespiratoryRateFragment<Respir
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View rootView = inflater.inflate(R.layout.fragment_respiratory_rate, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         mDateView = rootView.findViewById(R.id.rr_date_view);
         awakeAvg = rootView.findViewById(R.id.awake_avg);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRatePeriodFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRatePeriodFragment.java
index 34a98824f0..f741fe615d 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRatePeriodFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRatePeriodFragment.java
@@ -1,7 +1,5 @@
 package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
-import android.graphics.Color;
-import android.os.Build;
 import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -19,7 +17,6 @@ import com.github.mikephil.charting.data.LineDataSet;
 import com.github.mikephil.charting.formatter.ValueFormatter;
 import com.github.mikephil.charting.interfaces.datasets.ILineDataSet;
 
-import org.apache.commons.lang3.time.DateUtils;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -66,11 +63,9 @@ public class RespiratoryRatePeriodFragment extends RespiratoryRateFragment<Respi
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View rootView = inflater.inflate(R.layout.fragment_respiratory_rate_period, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         mDateView = rootView.findViewById(R.id.rr_date_view);
         sleepAvg = rootView.findViewById(R.id.sleep_avg);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/SleepPeriodFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/SleepPeriodFragment.java
index 6373ce4190..4b73252952 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/SleepPeriodFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/SleepPeriodFragment.java
@@ -19,7 +19,6 @@ package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
 import android.app.Activity;
 import android.graphics.Color;
-import android.os.Build;
 import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -42,9 +41,6 @@ import com.github.mikephil.charting.data.LineDataSet;
 import com.github.mikephil.charting.formatter.ValueFormatter;
 import com.github.mikephil.charting.interfaces.datasets.ILineDataSet;
 
-import nodomain.freeyourgadget.gadgetbridge.database.DBHandler;
-import nodomain.freeyourgadget.gadgetbridge.databinding.FragmentWeeksleepChartBinding;
-import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import org.apache.commons.lang3.ArrayUtils;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -57,6 +53,9 @@ import java.util.concurrent.TimeUnit;
 
 import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.R;
+import nodomain.freeyourgadget.gadgetbridge.database.DBHandler;
+import nodomain.freeyourgadget.gadgetbridge.databinding.FragmentWeeksleepChartBinding;
+import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivityAmount;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivityAmounts;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivityKind;
@@ -99,7 +98,7 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
     private MySleepWeeklyData getMySleepWeeklyData(DBHandler db, Calendar day, GBDevice device) {
         day = (Calendar) day.clone(); // do not modify the caller's argument
         day.add(Calendar.DATE, -TOTAL_DAYS + 1);
-        TOTAL_DAYS_FOR_AVERAGE=0;
+        TOTAL_DAYS_FOR_AVERAGE = 0;
         long awakeWeeklyTotal = 0;
         long remWeeklyTotal = 0;
         long deepWeeklyTotal = 0;
@@ -128,18 +127,16 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
         return new MySleepWeeklyData(awakeWeeklyTotal, remWeeklyTotal, deepWeeklyTotal, lightWeeklyTotal);
     }
 
-        @Override
+    @Override
     public View onCreateView(LayoutInflater inflater, ViewGroup container,
                              Bundle savedInstanceState) {
         mLocale = getResources().getConfiguration().locale;
         binding = FragmentWeeksleepChartBinding.inflate(inflater, container, false);
 
         View rootView = binding.getRoot();
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         final int goal = getGoal();
         if (goal >= 0) {
@@ -282,14 +279,14 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
 
         long balance = 0;
         long daily_balance = 0;
-        TOTAL_DAYS_FOR_AVERAGE=0;
+        TOTAL_DAYS_FOR_AVERAGE = 0;
         List<Entry> sleepScoreEntities = new ArrayList<>();
         final Accumulator sleepScoreAccumulator = new Accumulator();
         final List<ILineDataSet> sleepScoreDataSets = new ArrayList<>();
         for (int counter = 0; counter < TOTAL_DAYS; counter++) {
             // Sleep stages
             ActivityAmounts amounts = getActivityAmountsForDay(db, day, device);
-            daily_balance=calculateBalance(amounts);
+            daily_balance = calculateBalance(amounts);
             if (daily_balance > 0) {
                 TOTAL_DAYS_FOR_AVERAGE++;
             }
@@ -299,8 +296,8 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
             // Sleep score
             if (supportsSleepScore()) {
                 List<? extends SleepScoreSample> sleepScoreSamples = getSleepScoreSamples(db, device, day);
-                if (!sleepScoreSamples.isEmpty() && sleepScoreSamples.get(sleepScoreSamples.size() -1).getSleepScore() > 0) {
-                    int sleepScore = sleepScoreSamples.get(sleepScoreSamples.size() -1).getSleepScore();
+                if (!sleepScoreSamples.isEmpty() && sleepScoreSamples.get(sleepScoreSamples.size() - 1).getSleepScore() > 0) {
+                    int sleepScore = sleepScoreSamples.get(sleepScoreSamples.size() - 1).getSleepScore();
                     sleepScoreAccumulator.add(sleepScore);
                     sleepScoreEntities.add(new Entry(counter, sleepScore));
                 } else {
@@ -349,8 +346,7 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
         if (average > (mTargetValue)) {
             average_line.setLineColor(Color.GREEN);
             average_line.setTextColor(Color.GREEN);
-        }
-        else {
+        } else {
             average_line.setLineColor(Color.RED);
             average_line.setTextColor(Color.RED);
         }
@@ -374,12 +370,11 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
         return new WeekChartsData(barData, new PreformattedXIndexLabelFormatter(labels), getBalanceMessage(balance, mTargetValue));
     }
 
-    protected String getWeeksChartsLabel(Calendar day){
+    protected String getWeeksChartsLabel(Calendar day) {
         if (TOTAL_DAYS > 7) {
             //month, show day date
             return String.valueOf(day.get(Calendar.DAY_OF_MONTH));
-        }
-        else{
+        } else {
             //week, show short day name
             return day.getDisplayName(Calendar.DAY_OF_WEEK, Calendar.SHORT, mLocale);
         }
@@ -405,7 +400,7 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
             }
         });
         return lineDataSet;
-    };
+    }
 
     private void setupSleepScoreChart() {
         final XAxis xAxisBottom = binding.sleepScoreChart.getXAxis();
@@ -416,7 +411,7 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
         xAxisBottom.setDrawLimitLinesBehindData(true);
         xAxisBottom.setTextColor(CHART_TEXT_COLOR);
         xAxisBottom.setAxisMinimum(0f);
-        xAxisBottom.setAxisMaximum(TOTAL_DAYS-1);
+        xAxisBottom.setAxisMaximum(TOTAL_DAYS - 1);
         xAxisBottom.setGranularity(1f);
         xAxisBottom.setGranularityEnabled(true);
 
@@ -453,8 +448,7 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
     public String getTitle() {
         if (GBApplication.getPrefs().getBoolean("charts_range", true)) {
             return getString(R.string.weeksleepchart_sleep_a_month);
-        }
-        else{
+        } else {
             return getString(R.string.weeksleepchart_sleep_a_week);
         }
     }
@@ -487,7 +481,7 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
 
     protected String getBalanceMessage(long balance, int targetValue) {
         if (balance > 0) {
-            final long totalBalance = balance - ((long)targetValue * TOTAL_DAYS_FOR_AVERAGE);
+            final long totalBalance = balance - ((long) targetValue * TOTAL_DAYS_FOR_AVERAGE);
             if (totalBalance > 0)
                 return getString(R.string.overslept, getHM(totalBalance));
             else
@@ -517,7 +511,7 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
         int totalMinutesRemSleep = (int) (totalSecondsRemSleep / 60);
         int totalMinutesAwakeSleep = (int) (totalSecondsAwakeSleep / 60);
 
-        float[] activityAmountsTotals =  {totalMinutesDeepSleep, totalMinutesLightSleep};
+        float[] activityAmountsTotals = {totalMinutesDeepSleep, totalMinutesLightSleep};
         if (supportsRemSleep(getChartsHost().getDevice())) {
             activityAmountsTotals = ArrayUtils.add(activityAmountsTotals, totalMinutesRemSleep);
         }
@@ -538,10 +532,10 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
                 getString(R.string.abstract_chart_fragment_kind_light_sleep)
         };
         if (supportsRemSleep(getChartsHost().getDevice())) {
-            labels = ArrayUtils.add(labels,  getString(R.string.abstract_chart_fragment_kind_rem_sleep));
+            labels = ArrayUtils.add(labels, getString(R.string.abstract_chart_fragment_kind_rem_sleep));
         }
         if (supportsAwakeSleep(getChartsHost().getDevice())) {
-            labels = ArrayUtils.add(labels,  getString(R.string.abstract_chart_fragment_kind_awake_sleep));
+            labels = ArrayUtils.add(labels, getString(R.string.abstract_chart_fragment_kind_awake_sleep));
         }
         return labels;
     }
@@ -599,7 +593,7 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
     }
 
     String getAverage(float value) {
-        return getHM((long)value);
+        return getHM((long) value);
     }
 
     protected static class MyChartsData extends ChartsData {
@@ -653,10 +647,10 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
         return getSamples(db, device, startTs, endTs);
     }
 
-    private int getRangeDays(){
+    private int getRangeDays() {
         if (GBApplication.getPrefs().getBoolean("charts_range", true)) {
-            return 30;}
-        else{
+            return 30;
+        } else {
             return 7;
         }
     }
@@ -698,7 +692,9 @@ public class SleepPeriodFragment extends SleepFragment<SleepPeriodFragment.MyCha
             return balanceMessage;
         }
 
-        public LineData getSleepScoreData() { return sleepScoresLineData; }
+        public LineData getSleepScoreData() {
+            return sleepScoresLineData;
+        }
     }
 
     private static class MySleepWeeklyData {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StepsDailyFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StepsDailyFragment.java
index dfe7b29289..5414cef864 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StepsDailyFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StepsDailyFragment.java
@@ -1,6 +1,5 @@
 package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
-import android.os.Build;
 import android.os.Bundle;
 import android.util.TypedValue;
 import android.view.LayoutInflater;
@@ -60,11 +59,9 @@ public class StepsDailyFragment extends StepsFragment<StepsDailyFragment.StepsDa
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View rootView = inflater.inflate(R.layout.fragment_steps, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         mDateView = rootView.findViewById(R.id.steps_date_view);
         stepsGauge = rootView.findViewById(R.id.steps_gauge);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StepsPeriodFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StepsPeriodFragment.java
index 0a49826ea5..6ce4b96c33 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StepsPeriodFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StepsPeriodFragment.java
@@ -1,8 +1,6 @@
 package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
 import android.content.Context;
-import android.graphics.Color;
-import android.os.Build;
 import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -80,11 +78,9 @@ public class StepsPeriodFragment extends StepsFragment<StepsPeriodFragment.Steps
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View rootView = inflater.inflate(R.layout.fragment_steps_period, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         mDateView = rootView.findViewById(R.id.steps_date_view);
         stepsChart = rootView.findViewById(R.id.steps_chart);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StressDailyFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StressDailyFragment.java
index c848a285b2..15c5cc21e5 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StressDailyFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StressDailyFragment.java
@@ -17,7 +17,6 @@
 package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
 import android.graphics.Color;
-import android.os.Build;
 import android.os.Bundle;
 import android.text.Spannable;
 import android.text.SpannableString;
@@ -29,8 +28,6 @@ import android.view.View;
 import android.view.ViewGroup;
 import android.widget.TextView;
 
-import androidx.core.content.ContextCompat;
-
 import com.github.mikephil.charting.animation.Easing;
 import com.github.mikephil.charting.charts.Chart;
 import com.github.mikephil.charting.charts.LineChart;
@@ -192,9 +189,7 @@ public class StressDailyFragment extends StressFragment<StressDailyFragment.Stre
                              final Bundle savedInstanceState) {
         final View rootView = inflater.inflate(R.layout.fragment_stresschart, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> getChartsHost().enableSwipeRefresh(scrollY == 0));
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> getChartsHost().enableSwipeRefresh(scrollY == 0));
 
         mStressChart = rootView.findViewById(R.id.stress_line_chart);
         mStressLevelsPieChart = rootView.findViewById(R.id.stress_pie_chart);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StressPeriodFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StressPeriodFragment.java
index dd0b7916d8..1f237e5866 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StressPeriodFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/StressPeriodFragment.java
@@ -16,7 +16,6 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
-import android.os.Build;
 import android.os.Bundle;
 import android.text.Spannable;
 import android.text.SpannableString;
@@ -99,11 +98,9 @@ public class StressPeriodFragment extends StressFragment<StressPeriodFragment.My
         mLocale = getResources().getConfiguration().locale;
         View rootView = inflater.inflate(R.layout.fragment_weekstress_chart, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         mWeekChart = rootView.findViewById(R.id.weekstresschart);
         mStressLevelsPieChart = rootView.findViewById(R.id.stress_pie_chart);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/TemperatureDailyFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/TemperatureDailyFragment.java
index 61d8489da7..3749d8f382 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/TemperatureDailyFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/TemperatureDailyFragment.java
@@ -17,7 +17,6 @@
 package nodomain.freeyourgadget.gadgetbridge.activities.charts;
 
 import android.graphics.Color;
-import android.os.Build;
 import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -74,11 +73,9 @@ public class TemperatureDailyFragment extends AbstractChartFragment<TemperatureD
     public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View rootView = inflater.inflate(R.layout.fragment_temperature, container, false);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
-                getChartsHost().enableSwipeRefresh(scrollY == 0);
-            });
-        }
+        rootView.setOnScrollChangeListener((v, scrollX, scrollY, oldScrollX, oldScrollY) -> {
+            getChartsHost().enableSwipeRefresh(scrollY == 0);
+        });
 
         dateView = rootView.findViewById(R.id.temp_date_view);
         tempLineChart = rootView.findViewById(R.id.temp_line_chart);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/discovery/DiscoveryActivityV2.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/discovery/DiscoveryActivityV2.java
index 4ca64ea8ad..a5201b8444 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/discovery/DiscoveryActivityV2.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/discovery/DiscoveryActivityV2.java
@@ -518,11 +518,9 @@ public class DiscoveryActivityV2 extends AbstractGBActivity implements AdapterVi
         final ScanSettings.Builder builder = new ScanSettings.Builder()
                 .setScanMode(ScanSettings.SCAN_MODE_LOW_LATENCY);
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            builder.setCallbackType(ScanSettings.CALLBACK_TYPE_ALL_MATCHES);
-            builder.setMatchMode(ScanSettings.MATCH_MODE_AGGRESSIVE);
-            builder.setNumOfMatches(ScanSettings.MATCH_NUM_ONE_ADVERTISEMENT);
-        }
+        builder.setCallbackType(ScanSettings.CALLBACK_TYPE_ALL_MATCHES);
+        builder.setMatchMode(ScanSettings.MATCH_MODE_AGGRESSIVE);
+        builder.setNumOfMatches(ScanSettings.MATCH_NUM_ONE_ADVERTISEMENT);
 
         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
             builder.setPhy(ScanSettings.PHY_LE_ALL_SUPPORTED);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/welcome/WelcomeFragmentPermissions.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/welcome/WelcomeFragmentPermissions.java
index d259a664c1..2ea0ff878b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/welcome/WelcomeFragmentPermissions.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/welcome/WelcomeFragmentPermissions.java
@@ -84,7 +84,7 @@ public class WelcomeFragmentPermissions extends Fragment {
             List<PermissionsUtils.PermissionDetails> wantedPermissions = PermissionsUtils.getRequiredPermissionsList(requireActivity());
             requestingPermissions = new ArrayList<>();
             for (PermissionsUtils.PermissionDetails wantedPermission : wantedPermissions) {
-                requestingPermissions.add(wantedPermission.getPermission());
+                requestingPermissions.add(wantedPermission.permission());
             }
             requestAllPermissions();
         });
@@ -169,9 +169,9 @@ public class WelcomeFragmentPermissions extends Fragment {
         @Override
         public void onBindViewHolder(@NonNull PermissionHolder holder, int position) {
             PermissionsUtils.PermissionDetails permissionData = permissionList.get(position);
-            holder.titleTextView.setText(permissionData.getTitle());
-            holder.summaryTextView.setText(permissionData.getSummary());
-            if (PermissionsUtils.checkPermission(requireContext(), permissionData.getPermission())) {
+            holder.titleTextView.setText(permissionData.title());
+            holder.summaryTextView.setText(permissionData.summary());
+            if (PermissionsUtils.checkPermission(requireContext(), permissionData.permission())) {
                 holder.requestButton.setVisibility(View.INVISIBLE);
                 holder.requestButton.setEnabled(false);
                 holder.checkmarkImageView.setVisibility(View.VISIBLE);
@@ -180,7 +180,7 @@ public class WelcomeFragmentPermissions extends Fragment {
                 holder.requestButton.setEnabled(true);
                 holder.checkmarkImageView.setVisibility(View.GONE);
                 holder.requestButton.setOnClickListener(view -> {
-                    PermissionsUtils.requestPermission(requireActivity(), permissionData.getPermission());
+                    PermissionsUtils.requestPermission(requireActivity(), permissionData.permission());
                 });
             }
         }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEvent.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEvent.java
index 088136135d..de1c9e9632 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEvent.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEvent.java
@@ -21,7 +21,6 @@ package nodomain.freeyourgadget.gadgetbridge.deviceevents;
 import android.app.NotificationManager;
 import android.content.Context;
 import android.content.Intent;
-import android.os.Build;
 import android.text.TextUtils;
 
 import androidx.annotation.NonNull;
@@ -109,31 +108,29 @@ public abstract class GBDeviceEvent {
             deviceEventMusicControl.evaluate(context, device);
         }
 
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            final NotificationManager notificationManager = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);
+        final NotificationManager notificationManager = (NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE);
 
-            final int interruptionFilter;
-            if (actions.contains(actionDndOff)) {
-                interruptionFilter = NotificationManager.INTERRUPTION_FILTER_ALL;
-            } else if (actions.contains(actionDndpriority)) {
-                interruptionFilter = NotificationManager.INTERRUPTION_FILTER_PRIORITY;
-            } else if (actions.contains(actionDndAlarms)) {
-                interruptionFilter = NotificationManager.INTERRUPTION_FILTER_ALARMS;
-            } else if (actions.contains(actionDndOn)) {
-                interruptionFilter = NotificationManager.INTERRUPTION_FILTER_NONE;
-            } else {
-                interruptionFilter = NotificationManager.INTERRUPTION_FILTER_UNKNOWN;
+        final int interruptionFilter;
+        if (actions.contains(actionDndOff)) {
+            interruptionFilter = NotificationManager.INTERRUPTION_FILTER_ALL;
+        } else if (actions.contains(actionDndpriority)) {
+            interruptionFilter = NotificationManager.INTERRUPTION_FILTER_PRIORITY;
+        } else if (actions.contains(actionDndAlarms)) {
+            interruptionFilter = NotificationManager.INTERRUPTION_FILTER_ALARMS;
+        } else if (actions.contains(actionDndOn)) {
+            interruptionFilter = NotificationManager.INTERRUPTION_FILTER_NONE;
+        } else {
+            interruptionFilter = NotificationManager.INTERRUPTION_FILTER_UNKNOWN;
+        }
+
+        if (interruptionFilter != NotificationManager.INTERRUPTION_FILTER_UNKNOWN) {
+            LOG.debug("Setting do not disturb to {}", interruptionFilter);
+
+            if (!notificationManager.isNotificationPolicyAccessGranted()) {
+                LOG.warn("Do not disturb permissions not granted");
             }
 
-            if (interruptionFilter != NotificationManager.INTERRUPTION_FILTER_UNKNOWN) {
-                LOG.debug("Setting do not disturb to {}", interruptionFilter);
-
-                if (!notificationManager.isNotificationPolicyAccessGranted()) {
-                    LOG.warn("Do not disturb permissions not granted");
-                }
-
-                notificationManager.setInterruptionFilter(interruptionFilter);
-            }
+            notificationManager.setInterruptionFilter(interruptionFilter);
         }
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventFindPhone.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventFindPhone.java
index 223045fe91..7521a85fcd 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventFindPhone.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventFindPhone.java
@@ -39,7 +39,6 @@ import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.activities.FindPhoneActivity;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 
 public class GBDeviceEventFindPhone extends GBDeviceEvent {
     private static final Logger LOG = LoggerFactory.getLogger(GBDeviceEventFindPhone.class);
@@ -101,7 +100,12 @@ public class GBDeviceEventFindPhone extends GBDeviceEvent {
             // On Android Q and above, we need the device to be paired as companion. If it is not, display a notification
             // notifying the user and linking to further instructions
             final Intent instructionsIntent = new Intent(Intent.ACTION_VIEW, Uri.parse("https://gadgetbridge.org/basics/pairing/companion-device/"));
-            final PendingIntent pi = PendingIntentUtils.getActivity(context, 0, instructionsIntent, PendingIntent.FLAG_ONE_SHOT, false);
+            final PendingIntent pi = PendingIntent  .getActivity(
+                    context,
+                    0,
+                    instructionsIntent,
+                    PendingIntent.FLAG_ONE_SHOT | PendingIntent.FLAG_IMMUTABLE
+            );
             final NotificationCompat.Builder notification = new NotificationCompat.Builder(context, NOTIFICATION_CHANNEL_HIGH_PRIORITY_ID)
                     .setSmallIcon(R.drawable.ic_warning)
                     .setOngoing(false)
@@ -121,7 +125,12 @@ public class GBDeviceEventFindPhone extends GBDeviceEvent {
         intent.putExtra(FindPhoneActivity.EXTRA_RING, ring);
         intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);
 
-        final PendingIntent pi = PendingIntentUtils.getActivity(context, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT, false);
+        final PendingIntent pi = PendingIntent.getActivity(
+                context,
+                0,
+                intent,
+                PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
+        );
 
         final NotificationCompat.Builder notification = new NotificationCompat.Builder(context, NOTIFICATION_CHANNEL_HIGH_PRIORITY_ID)
                 .setSmallIcon(R.drawable.ic_notification)
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventScreenshot.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventScreenshot.java
index 1f37b9efcd..1d2f3074d8 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventScreenshot.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventScreenshot.java
@@ -41,7 +41,6 @@ import java.util.Locale;
 import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 
 public class GBDeviceEventScreenshot extends GBDeviceEvent {
     private static final Logger LOG = LoggerFactory.getLogger(GBDeviceEventScreenshot.class);
@@ -77,14 +76,21 @@ public class GBDeviceEventScreenshot extends GBDeviceEvent {
             intent.setDataAndType(screenshotURI, "image/*");
             intent.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);
 
-            final PendingIntent pIntent = PendingIntentUtils.getActivity(context, 0, intent, 0, false);
+            int flags1 = 0;
+            flags1 |= PendingIntent.FLAG_IMMUTABLE;
+            final PendingIntent pIntent = PendingIntent.getActivity(context, 0, intent, flags1);
 
             final Intent shareIntent = new Intent(Intent.ACTION_SEND);
             shareIntent.setType("image/*");
             shareIntent.putExtra(Intent.EXTRA_STREAM, screenshotURI);
 
-            final PendingIntent pendingShareIntent = PendingIntentUtils.getActivity(context, 0, Intent.createChooser(shareIntent, context.getString(R.string.share_screenshot)),
-                    PendingIntent.FLAG_UPDATE_CURRENT, false);
+            Intent intent1 = Intent.createChooser(shareIntent, context.getString(R.string.share_screenshot));
+            final PendingIntent pendingShareIntent = PendingIntent.getActivity(
+                    context,
+                    0,
+                    intent1,
+                    PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
+            );
 
             final NotificationCompat.Action action = new NotificationCompat.Action.Builder(android.R.drawable.ic_menu_share, context.getString(R.string.share), pendingShareIntent).build();
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/AlarmReceiver.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/AlarmReceiver.java
index 985bc8a79f..d63aec6276 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/AlarmReceiver.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/AlarmReceiver.java
@@ -38,7 +38,6 @@ import nodomain.freeyourgadget.gadgetbridge.BuildConfig;
 import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.model.CalendarEventSpec;
 import nodomain.freeyourgadget.gadgetbridge.util.GBPrefs;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 
 public class AlarmReceiver extends BroadcastReceiver {
     private static final Logger LOG = LoggerFactory.getLogger(AlarmReceiver.class);
@@ -47,7 +46,7 @@ public class AlarmReceiver extends BroadcastReceiver {
         Context context = GBApplication.getContext();
         Intent intent = new Intent("DAILY_ALARM");
         intent.setPackage(BuildConfig.APPLICATION_ID);
-        PendingIntent pendingIntent = PendingIntentUtils.getBroadcast(context, 0, intent, 0, false);
+        PendingIntent pendingIntent = PendingIntent.getBroadcast(context, 0, intent, PendingIntent.FLAG_IMMUTABLE);
         AlarmManager am = (AlarmManager) (context.getSystemService(Context.ALARM_SERVICE));
 
         if (am != null) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/CMWeatherReceiver.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/CMWeatherReceiver.java
index 83e81cb896..254f50869d 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/CMWeatherReceiver.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/CMWeatherReceiver.java
@@ -40,7 +40,6 @@ import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.model.weather.Weather;
 import nodomain.freeyourgadget.gadgetbridge.model.weather.WeatherMapper;
 import nodomain.freeyourgadget.gadgetbridge.model.WeatherSpec;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
 
 import static cyanogenmod.providers.WeatherContract.WeatherColumns.TempUnit.FAHRENHEIT;
@@ -106,7 +105,7 @@ public class CMWeatherReceiver extends BroadcastReceiver implements CMWeatherMan
         if (enable) {
             Intent intent = new Intent("GB_UPDATE_WEATHER");
             intent.setPackage(BuildConfig.APPLICATION_ID);
-            mPendingIntent = PendingIntentUtils.getBroadcast(mContext, 0, intent, 0, false);
+            mPendingIntent = PendingIntent.getBroadcast(mContext, 0, intent, PendingIntent.FLAG_IMMUTABLE);
             am.setInexactRepeating(AlarmManager.RTC_WAKEUP, Calendar.getInstance().getTimeInMillis() + 10000, AlarmManager.INTERVAL_HOUR, mPendingIntent);
         } else {
             am.cancel(mPendingIntent);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/LineageOsWeatherReceiver.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/LineageOsWeatherReceiver.java
index cf058cc0b1..17faab7213 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/LineageOsWeatherReceiver.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/LineageOsWeatherReceiver.java
@@ -31,9 +31,6 @@ import android.content.BroadcastReceiver;
 import android.content.Context;
 import android.content.Intent;
 import android.content.SharedPreferences;
-import android.os.Build;
-
-import androidx.annotation.RequiresApi;
 
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -52,16 +49,14 @@ import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.model.weather.Weather;
 import nodomain.freeyourgadget.gadgetbridge.model.weather.WeatherMapper;
 import nodomain.freeyourgadget.gadgetbridge.model.WeatherSpec;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
-import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
+import nodomain.freeyourgadget.gadgetbridge.util.Prevfs;
 
-@RequiresApi(api = Build.VERSION_CODES.M)
 public class LineageOsWeatherReceiver extends BroadcastReceiver implements LineageWeatherManager.WeatherUpdateRequestListener, LineageWeatherManager.LookupCityRequestListener {
 
     private static final Logger LOG = LoggerFactory.getLogger(LineageOsWeatherReceiver.class);
 
     private WeatherLocation weatherLocation = null;
-    private Context mContext;
+    private final Context mContext;
     private PendingIntent mPendingIntent = null;
 
     public LineageOsWeatherReceiver() {
@@ -76,7 +71,7 @@ public class LineageOsWeatherReceiver extends BroadcastReceiver implements Linea
         String city = prefs.getString("weather_city", null);
         String cityId = prefs.getString("weather_cityid", null);
 
-        if ((cityId == null || cityId.equals("")) && city != null && !city.equals("")) {
+        if ((cityId == null || cityId.isEmpty()) && city != null && !city.isEmpty()) {
             lookupCity(city);
         } else if (city != null && cityId != null) {
             weatherLocation = new WeatherLocation.Builder(cityId, city).build();
@@ -90,7 +85,7 @@ public class LineageOsWeatherReceiver extends BroadcastReceiver implements Linea
             return;
         }
 
-        if (city != null && !city.equals("")) {
+        if (city != null && !city.isEmpty()) {
             if (weatherManager.getActiveWeatherServiceProviderLabel() != null) {
                 weatherManager.lookupCity(city, this);
             }
@@ -111,7 +106,7 @@ public class LineageOsWeatherReceiver extends BroadcastReceiver implements Linea
         if (enable) {
             Intent intent = new Intent("GB_UPDATE_WEATHER");
             intent.setPackage(BuildConfig.APPLICATION_ID);
-            mPendingIntent = PendingIntentUtils.getBroadcast(mContext, 0, intent, 0, false);
+            mPendingIntent = PendingIntent.getBroadcast(mContext, 0, intent, PendingIntent.FLAG_IMMUTABLE);
             am.setInexactRepeating(AlarmManager.RTC_WAKEUP, Calendar.getInstance().getTimeInMillis() + 10000, AlarmManager.INTERVAL_HOUR, mPendingIntent);
         } else {
             am.cancel(mPendingIntent);
@@ -126,7 +121,7 @@ public class LineageOsWeatherReceiver extends BroadcastReceiver implements Linea
         String city = prefs.getString("weather_city", null);
         String cityId = prefs.getString("weather_cityid", null);
 
-        if (city != null && !city.equals("") && cityId == null) {
+        if (city != null && !city.isEmpty() && cityId == null) {
             lookupCity(city);
         } else {
             requestWeather();
@@ -163,7 +158,7 @@ public class LineageOsWeatherReceiver extends BroadcastReceiver implements Linea
     @Override
     public void onWeatherRequestCompleted(int status, WeatherInfo weatherInfo) {
         if (weatherInfo != null) {
-            LOG.info("weather: " + weatherInfo.toString());
+            LOG.info("weather: {}", weatherInfo);
             WeatherSpec weatherSpec = new WeatherSpec();
             weatherSpec.setTimestamp((int) (weatherInfo.getTimestamp() / 1000));
             weatherSpec.setLocation(weatherInfo.getCity());
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/TimeChangeReceiver.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/TimeChangeReceiver.java
index 030d7ce3c9..cb3c3735af 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/TimeChangeReceiver.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/TimeChangeReceiver.java
@@ -40,7 +40,6 @@ import nodomain.freeyourgadget.gadgetbridge.util.AndroidUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.DateTimeUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 import nodomain.freeyourgadget.gadgetbridge.util.GBPrefs;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 
 
 public class TimeChangeReceiver extends BroadcastReceiver {
@@ -100,7 +99,7 @@ public class TimeChangeReceiver extends BroadcastReceiver {
 
         final Intent i = new Intent(ACTION_DST_CHANGED_OR_PERIODIC_SYNC);
         i.setPackage(BuildConfig.APPLICATION_ID);
-        final PendingIntent pi = PendingIntentUtils.getBroadcast(context, 0, i, 0, false);
+        final PendingIntent pi = PendingIntent.getBroadcast(context, 0, i, PendingIntent.FLAG_IMMUTABLE);
 
         final AlarmManager am = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);
 
@@ -138,11 +137,7 @@ public class TimeChangeReceiver extends BroadcastReceiver {
         // Fallback to inexact alarm if the exact one failed
         if (!scheduledExact) {
             try {
-                if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-                    am.setAndAllowWhileIdle(AlarmManager.ELAPSED_REALTIME_WAKEUP, SystemClock.elapsedRealtime() + delayMillis, pi);
-                } else {
-                    am.set(AlarmManager.ELAPSED_REALTIME_WAKEUP, SystemClock.elapsedRealtime() + delayMillis, pi);
-                }
+                am.setAndAllowWhileIdle(AlarmManager.ELAPSED_REALTIME_WAKEUP, SystemClock.elapsedRealtime() + delayMillis, pi);
             } catch (final Exception e) {
                 LOG.error("Failed to schedule inexact alarm for next DST change or periodic time sync", e);
             }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/gps/GBLocationService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/gps/GBLocationService.java
index 8dc948aab6..2c1befc137 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/gps/GBLocationService.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/gps/GBLocationService.java
@@ -40,7 +40,6 @@ import nodomain.freeyourgadget.gadgetbridge.BuildConfig;
 import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 
 
 /**
@@ -167,7 +166,7 @@ public class GBLocationService extends BroadcastReceiver {
             final Intent notificationIntent = new Intent(context, GBLocationService.class);
             notificationIntent.setPackage(BuildConfig.APPLICATION_ID);
             notificationIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK);
-            final PendingIntent pendingIntent = PendingIntentUtils.getActivity(context, 0, notificationIntent, 0, false);
+            final PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, notificationIntent, PendingIntent.FLAG_IMMUTABLE);
 
             final NotificationCompat.Builder nb = new NotificationCompat.Builder(context, GB.NOTIFICATION_CHANNEL_ID_GPS)
                     .setTicker(context.getString(R.string.notification_gps_title))
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/DeviceCommunicationService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/DeviceCommunicationService.java
index afb7817fe1..61147b8c2b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/DeviceCommunicationService.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/DeviceCommunicationService.java
@@ -1345,7 +1345,7 @@ public class DeviceCommunicationService extends Service implements SharedPrefere
         if (enable && initialized && features.supportsCalendarEvents()) {
             for (GBDevice deviceWithCalendar : devicesWithCalendar) {
                 if (!deviceHasCalendarReceiverRegistered(deviceWithCalendar)) {
-                    if (!(GBApplication.isRunningMarshmallowOrLater() && ContextCompat.checkSelfPermission(this, Manifest.permission.READ_CALENDAR) == PackageManager.PERMISSION_DENIED)) {
+                    if (ContextCompat.checkSelfPermission(this, Manifest.permission.READ_CALENDAR) == PackageManager.PERMISSION_GRANTED) {
                         CalendarReceiver receiver = new CalendarReceiver(this, deviceWithCalendar);
                         receiver.registerBroadcastReceivers();
                         mCalendarReceiver.add(receiver);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/BLEScanService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/BLEScanService.java
index 9547b777ac..be441ed8ba 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/BLEScanService.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/BLEScanService.java
@@ -399,13 +399,9 @@ public class BLEScanService extends Service {
         }
 
         final ScanSettings.Builder scanSettingsBuilder = new ScanSettings.Builder()
-                .setScanMode(ScanSettings.SCAN_MODE_LOW_POWER); // enforced anyway in background
-
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            scanSettingsBuilder
-                    .setCallbackType(ScanSettings.CALLBACK_TYPE_ALL_MATCHES)
-                    .setMatchMode(ScanSettings.MATCH_MODE_STICKY);
-        }
+                .setScanMode(ScanSettings.SCAN_MODE_LOW_POWER) // enforced anyway in background
+                .setCallbackType(ScanSettings.CALLBACK_TYPE_ALL_MATCHES)
+                .setMatchMode(ScanSettings.MATCH_MODE_STICKY);
 
         if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
             scanSettingsBuilder.setLegacy(false);
@@ -413,7 +409,7 @@ public class BLEScanService extends Service {
 
         scanner.startScan(scanFilters, scanSettingsBuilder.build(), scanCallback);
         if (applyFilters) {
-            LOG.debug("restartScan: started scan for " + scanFilters.size() + " devices");
+            LOG.debug("restartScan: started scan for {} devices", scanFilters.size());
             updateNotification(true, scanFilters.size());
             currentState = ScanningState.SCANNING_WITH_FILTERS;
         } else {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/BtLEQueue.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/BtLEQueue.java
index 16b9ab71ff..d1c576c7f4 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/BtLEQueue.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/BtLEQueue.java
@@ -339,12 +339,9 @@ public final class BtLEQueue implements Thread.UncaughtExceptionHandler {
             mBluetoothGatt = remoteDevice.connectGatt(mContext, false,
                     internalGattCallback, BluetoothDevice.TRANSPORT_LE,
                     BluetoothDevice.PHY_LE_CODED_MASK, mReceiverHandler);
-        }else if (GBApplication.isRunningMarshmallowOrLater()) {
-            mBluetoothGatt = remoteDevice.connectGatt(mContext, false,
-                    internalGattCallback, BluetoothDevice.TRANSPORT_LE);
         } else {
             mBluetoothGatt = remoteDevice.connectGatt(mContext, false,
-                    internalGattCallback);
+                    internalGattCallback, BluetoothDevice.TRANSPORT_LE);
         }
 
         return mBluetoothGatt != null;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/um25/Support/UM25Support.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/um25/Support/UM25Support.java
index bb9564f614..9bb8427800 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/um25/Support/UM25Support.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/um25/Support/UM25Support.java
@@ -49,7 +49,6 @@ import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.um25.Data.CaptureGroup;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.um25.Data.MeasurementData;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.StringUtils;
 
 public class UM25Support extends UM25BaseSupport {
@@ -203,11 +202,17 @@ public class UM25Support extends UM25BaseSupport {
             wasOverNotificationCurrent = false;
             Intent activityIntent = new Intent(getContext(), DataActivity.class);
             activityIntent.setPackage(BuildConfig.APPLICATION_ID);
+            Context context = getContext();
             Notification notification = new NotificationCompat.Builder(getContext(), GB.NOTIFICATION_CHANNEL_HIGH_PRIORITY_ID)
                     .setSmallIcon(R.drawable.ic_notification_low_battery)
                     .setContentTitle("USB current")
                     .setContentText("USB current below threshold")
-                    .setContentIntent(PendingIntentUtils.getActivity(getContext(), 0, activityIntent, PendingIntent.FLAG_CANCEL_CURRENT, false))
+                    .setContentIntent(PendingIntent.getActivity(
+                            context,
+                            0,
+                            activityIntent,
+                            PendingIntent.FLAG_CANCEL_CURRENT | PendingIntent.FLAG_IMMUTABLE
+                    ))
                     .build();
 
             GB.notify(
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/receivers/AutoConnectIntervalReceiver.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/receivers/AutoConnectIntervalReceiver.java
index 4e946f2168..eec0f85f06 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/receivers/AutoConnectIntervalReceiver.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/receivers/AutoConnectIntervalReceiver.java
@@ -23,7 +23,6 @@ import android.content.BroadcastReceiver;
 import android.content.Context;
 import android.content.Intent;
 import android.content.IntentFilter;
-import android.os.Build;
 
 import androidx.localbroadcastmanager.content.LocalBroadcastManager;
 
@@ -37,7 +36,6 @@ import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.devices.DeviceManager;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.service.DeviceCommunicationService;
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
 
 public class AutoConnectIntervalReceiver extends BroadcastReceiver {
 
@@ -65,11 +63,11 @@ public class AutoConnectIntervalReceiver extends BroadcastReceiver {
         }
 
         GBDevice[] devices = service.getGBDevices();
-        if (action.equals(DeviceManager.ACTION_DEVICES_CHANGED)){
+        if (action.equals(DeviceManager.ACTION_DEVICES_CHANGED)) {
             boolean scheduleAutoConnect = false;
             boolean allDevicesInitialized = true;
-            for(GBDevice device : devices){
-                if(!device.isInitialized()) {
+            for (GBDevice device : devices) {
+                if (!device.isInitialized()) {
                     allDevicesInitialized = false;
                     if (device.getState() == GBDevice.State.WAITING_FOR_RECONNECT) {
                         scheduleAutoConnect = true;
@@ -77,18 +75,18 @@ public class AutoConnectIntervalReceiver extends BroadcastReceiver {
                 }
             }
 
-            if(allDevicesInitialized){
+            if (allDevicesInitialized) {
                 LOG.info("will reset connection delay, all devices are initialized!");
                 mDelay = 4;
                 return;
             }
-            if(scheduleAutoConnect && !mScheduled){
+            if (scheduleAutoConnect && !mScheduled) {
                 scheduleReconnect();
             }
-        }else if (action.equals("GB_RECONNECT")){
+        } else if (action.equals("GB_RECONNECT")) {
             mScheduled = false;
-            for(GBDevice device : devices){
-                if(device.getState() == GBDevice.State.WAITING_FOR_RECONNECT) {
+            for (GBDevice device : devices) {
+                if (device.getState() == GBDevice.State.WAITING_FOR_RECONNECT) {
                     LOG.info("time based re-connect to {} ({})", device.getAddress(), device.getName());
                     GBApplication.deviceService(device).connect();
                 }
@@ -97,7 +95,7 @@ public class AutoConnectIntervalReceiver extends BroadcastReceiver {
     }
 
     private void scheduleReconnect() {
-        mDelay*=2;
+        mDelay *= 2;
         if (mDelay > 64) {
             mDelay = 64;
         }
@@ -109,16 +107,14 @@ public class AutoConnectIntervalReceiver extends BroadcastReceiver {
         AlarmManager am = (AlarmManager) (GBApplication.getContext().getSystemService(Context.ALARM_SERVICE));
         Intent intent = new Intent("GB_RECONNECT");
         intent.setPackage(BuildConfig.APPLICATION_ID);
-        PendingIntent pendingIntent = PendingIntentUtils.getBroadcast(GBApplication.getContext(), 0, intent, 0, false);
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            am.setAndAllowWhileIdle(AlarmManager.RTC_WAKEUP, Calendar.getInstance().
-                    getTimeInMillis() + delay * 1000, pendingIntent);
-            mScheduled = true;
-        } else {
-            am.set(AlarmManager.RTC_WAKEUP, Calendar.getInstance().
-                    getTimeInMillis() + delay * 1000, pendingIntent);
-            mScheduled = true;
-        }
+        PendingIntent pendingIntent = PendingIntent.getBroadcast(GBApplication.getContext(), 0, intent, PendingIntent.FLAG_IMMUTABLE);
+        am.setAndAllowWhileIdle(
+                AlarmManager.RTC_WAKEUP,
+                Calendar.getInstance().
+                getTimeInMillis() + delay * 1000,
+                pendingIntent
+        );
+        mScheduled = true;
     }
 
     public void destroy() {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/AndroidUtils.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/AndroidUtils.java
index 2ec9c9837d..76d34d7747 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/AndroidUtils.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/AndroidUtils.java
@@ -40,6 +40,7 @@ import android.widget.Toast;
 
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
+import androidx.core.content.ContextCompat;
 import androidx.core.content.FileProvider;
 import androidx.localbroadcastmanager.content.LocalBroadcastManager;
 
@@ -135,9 +136,9 @@ public class AndroidUtils {
             color = ta.getColor(0, 0);
             ta.recycle();
         } else if (GBApplication.isDarkThemeEnabled()) {
-            color = context.getResources().getColor(R.color.primarytext_dark);
+            color = ContextCompat.getColor(context, R.color.primarytext_dark);
         } else {
-            color = context.getResources().getColor(R.color.primarytext_light);
+            color = ContextCompat.getColor(context, R.color.primarytext_light);
         }
         return colorToHex(color);
     }
@@ -161,9 +162,9 @@ public class AndroidUtils {
             color = ta.getColor(0, 0);
             ta.recycle();
         } else if (GBApplication.isDarkThemeEnabled()) {
-            color = context.getResources().getColor(androidx.cardview.R.color.cardview_dark_background);
+            color = ContextCompat.getColor(context, androidx.cardview.R.color.cardview_dark_background);
         } else {
-            color = context.getResources().getColor(androidx.cardview.R.color.cardview_light_background);
+            color = ContextCompat.getColor(context, androidx.cardview.R.color.cardview_light_background);
         }
         return colorToHex(color);
     }
@@ -171,9 +172,9 @@ public class AndroidUtils {
     public static int getBackgroundColor(Context context) {
         int color;
         if (GBApplication.isDarkThemeEnabled()) {
-            color = context.getResources().getColor(androidx.cardview.R.color.cardview_dark_background);
+            color = ContextCompat.getColor(context, androidx.cardview.R.color.cardview_dark_background);
         } else {
-            color = context.getResources().getColor(androidx.cardview.R.color.cardview_light_background);
+            color = ContextCompat.getColor(context, androidx.cardview.R.color.cardview_light_background);
         }
         return color;
     }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/GB.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/GB.java
index 63f5400924..0c1aca22c6 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/GB.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/GB.java
@@ -43,6 +43,7 @@ import androidx.annotation.StringRes;
 import androidx.core.app.ActivityCompat;
 import androidx.core.app.NotificationCompat;
 import androidx.core.app.NotificationManagerCompat;
+import androidx.core.content.ContextCompat;
 import androidx.localbroadcastmanager.content.LocalBroadcastManager;
 
 import org.slf4j.Logger;
@@ -181,15 +182,13 @@ public class GB {
         notificationIntent.setPackage(BuildConfig.APPLICATION_ID);
         notificationIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK
                 | Intent.FLAG_ACTIVITY_CLEAR_TASK);
-        PendingIntent pendingIntent = PendingIntentUtils.getActivity(context, 0,
-                notificationIntent, 0, false);
 
-        return pendingIntent;
+        return PendingIntent.getActivity(context, 0, notificationIntent, PendingIntent.FLAG_IMMUTABLE);
     }
 
     public static Notification createNotification(List<GBDevice> devices, Context context) {
         NotificationCompat.Builder builder = new NotificationCompat.Builder(context, NOTIFICATION_CHANNEL_ID_CONNECTION_STATUS);
-        if(devices.size() == 0){
+        if (devices.isEmpty()){
             builder.setContentTitle(context.getString(R.string.info_no_devices_connected))
                     .setSmallIcon(R.drawable.ic_notification_disconnected)
                     .setContentIntent(getContentIntent(context))
@@ -197,9 +196,9 @@ public class GB {
                     .setOngoing(true);
 
             if (!GBApplication.isRunningTwelveOrLater()) {
-                builder.setColor(context.getResources().getColor(R.color.accent));
+                builder.setColor(ContextCompat.getColor(context, R.color.accent));
             }
-        }else if(devices.size() == 1) {
+        } else if(devices.size() == 1) {
             GBDevice device = devices.get(0);
             String deviceName = device.getAliasOrName();
             String text = device.getStateString(context);
@@ -216,25 +215,40 @@ public class GB {
                     .setOngoing(true);
 
             if (!GBApplication.isRunningTwelveOrLater()) {
-                builder.setColor(context.getResources().getColor(R.color.accent));
+                builder.setColor(ContextCompat.getColor(context, R.color.accent));
             }
 
             Intent deviceCommunicationServiceIntent = new Intent(context, DeviceCommunicationService.class);
             deviceCommunicationServiceIntent.setPackage(BuildConfig.APPLICATION_ID);
             if (connected) {
                 deviceCommunicationServiceIntent.setAction(DeviceService.ACTION_DISCONNECT);
-                PendingIntent disconnectPendingIntent = PendingIntentUtils.getService(context, 0, deviceCommunicationServiceIntent, PendingIntent.FLAG_ONE_SHOT, false);
+                PendingIntent disconnectPendingIntent = PendingIntent.getService(
+                        context,
+                        0,
+                        deviceCommunicationServiceIntent,
+                        PendingIntent.FLAG_ONE_SHOT | PendingIntent.FLAG_IMMUTABLE
+                );
                 builder.addAction(R.drawable.ic_notification_disconnected, context.getString(R.string.controlcenter_disconnect), disconnectPendingIntent);
                 if (device.getDeviceCoordinator().supportsActivityDataFetching(device)) {
                     deviceCommunicationServiceIntent.setAction(DeviceService.ACTION_FETCH_RECORDED_DATA);
                     deviceCommunicationServiceIntent.putExtra(EXTRA_RECORDED_DATA_TYPES, ActivityKind.ACTIVITY);
-                    PendingIntent fetchPendingIntent = PendingIntentUtils.getService(context, 1, deviceCommunicationServiceIntent, PendingIntent.FLAG_ONE_SHOT, false);
+                    PendingIntent fetchPendingIntent = PendingIntent.getService(
+                            context,
+                            1,
+                            deviceCommunicationServiceIntent,
+                            PendingIntent.FLAG_ONE_SHOT | PendingIntent.FLAG_IMMUTABLE
+                    );
                     builder.addAction(R.drawable.ic_refresh, context.getString(R.string.controlcenter_fetch_activity_data), fetchPendingIntent);
                 }
             } else if (device.getState().equals(GBDevice.State.WAITING_FOR_RECONNECT) || device.getState().equals(GBDevice.State.NOT_CONNECTED)) {
                 deviceCommunicationServiceIntent.setAction(DeviceService.ACTION_CONNECT);
                 deviceCommunicationServiceIntent.putExtra(GBDevice.EXTRA_DEVICE, device);
-                PendingIntent reconnectPendingIntent = PendingIntentUtils.getService(context, 2, deviceCommunicationServiceIntent, PendingIntent.FLAG_UPDATE_CURRENT, false);
+                PendingIntent reconnectPendingIntent = PendingIntent.getService(
+                        context,
+                        2,
+                        deviceCommunicationServiceIntent,
+                        PendingIntent.FLAG_UPDATE_CURRENT | PendingIntent.FLAG_IMMUTABLE
+                );
                 builder.addAction(R.drawable.ic_notification, context.getString(R.string.controlcenter_connect), reconnectPendingIntent);
             }
         }else{
@@ -269,7 +283,7 @@ public class GB {
                     .setOngoing(true);
 
             if (!GBApplication.isRunningTwelveOrLater()) {
-                builder.setColor(context.getResources().getColor(R.color.accent));
+                builder.setColor(ContextCompat.getColor(context, R.color.accent));
             }
 
             if (anyDeviceSupportesActivityDataFetching) {
@@ -277,7 +291,12 @@ public class GB {
                 deviceCommunicationServiceIntent.setPackage(BuildConfig.APPLICATION_ID);
                 deviceCommunicationServiceIntent.setAction(DeviceService.ACTION_FETCH_RECORDED_DATA);
                 deviceCommunicationServiceIntent.putExtra(EXTRA_RECORDED_DATA_TYPES, ActivityKind.ACTIVITY);
-                PendingIntent fetchPendingIntent = PendingIntentUtils.getService(context, 1, deviceCommunicationServiceIntent, PendingIntent.FLAG_ONE_SHOT, false);
+                PendingIntent fetchPendingIntent = PendingIntent.getService(
+                        context,
+                        1,
+                        deviceCommunicationServiceIntent,
+                        PendingIntent.FLAG_ONE_SHOT | PendingIntent.FLAG_IMMUTABLE
+                );
                 builder.addAction(R.drawable.ic_refresh, context.getString(R.string.controlcenter_fetch_activity_data), fetchPendingIntent);
             }
         }
@@ -323,7 +342,7 @@ public class GB {
                 .setOngoing(true);
 
         if (!GBApplication.isRunningTwelveOrLater()) {
-            builder.setColor(context.getResources().getColor(R.color.accent));
+            builder.setColor(ContextCompat.getColor(context, R.color.accent));
         }
 
         // A small bug: When "Reconnect only to connected devices" is disabled, the intent will be added even when there are no devices in GB
@@ -332,7 +351,12 @@ public class GB {
             Intent deviceCommunicationServiceIntent = new Intent(context, DeviceCommunicationService.class);
             deviceCommunicationServiceIntent.setPackage(BuildConfig.APPLICATION_ID);
             deviceCommunicationServiceIntent.setAction(DeviceService.ACTION_CONNECT);
-            PendingIntent reconnectPendingIntent = PendingIntentUtils.getService(context, 2, deviceCommunicationServiceIntent, PendingIntent.FLAG_ONE_SHOT, false);
+            PendingIntent reconnectPendingIntent = PendingIntent.getService(
+                    context,
+                    2,
+                    deviceCommunicationServiceIntent,
+                    PendingIntent.FLAG_ONE_SHOT | PendingIntent.FLAG_IMMUTABLE
+            );
             builder.addAction(R.drawable.ic_notification, context.getString(R.string.controlcenter_connect), reconnectPendingIntent);
         }
 
@@ -487,12 +511,7 @@ public class GB {
         if (Thread.currentThread() == mainLooper.getThread()) {
             Toast.makeText(context, message, displayTime).show();
         } else {
-            Runnable runnable = new Runnable() {
-                @Override
-                public void run() {
-                    Toast.makeText(context, message, displayTime).show();
-                }
-            };
+            Runnable runnable = () -> Toast.makeText(context, message, displayTime).show();
 
             if (context instanceof Activity) {
                 ((Activity) context).runOnUiThread(runnable);
@@ -524,8 +543,7 @@ public class GB {
         notificationIntent.setPackage(BuildConfig.APPLICATION_ID);
         notificationIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK
                 | Intent.FLAG_ACTIVITY_CLEAR_TASK);
-        PendingIntent pendingIntent = PendingIntentUtils.getActivity(context, 0,
-                notificationIntent, 0, false);
+        PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, notificationIntent, PendingIntent.FLAG_IMMUTABLE);
 
         NotificationCompat.Builder nb = new NotificationCompat.Builder(context, NOTIFICATION_CHANNEL_ID_TRANSFER)
                 .setTicker((title == null) ? context.getString(R.string.app_name) : title)
@@ -567,8 +585,7 @@ public class GB {
         notificationIntent.setPackage(BuildConfig.APPLICATION_ID);
         notificationIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK
                 | Intent.FLAG_ACTIVITY_CLEAR_TASK);
-        PendingIntent pendingIntent = PendingIntentUtils.getActivity(context, 0,
-                notificationIntent, 0, false);
+        PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, notificationIntent, PendingIntent.FLAG_IMMUTABLE);
 
         NotificationCompat.Builder nb = new NotificationCompat.Builder(context, NOTIFICATION_CHANNEL_ID)
                 .setContentTitle(context.getString(R.string.app_name))
@@ -598,8 +615,7 @@ public class GB {
         notificationIntent.setPackage(BuildConfig.APPLICATION_ID);
         notificationIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK
                 | Intent.FLAG_ACTIVITY_CLEAR_TASK);
-        PendingIntent pendingIntent = PendingIntentUtils.getActivity(context, 0,
-                notificationIntent, 0, false);
+        PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, notificationIntent, PendingIntent.FLAG_IMMUTABLE);
 
         NotificationCompat.Builder nb = new NotificationCompat.Builder(context, NOTIFICATION_CHANNEL_ID_LOW_BATTERY)
                 .setContentTitle(context.getString(R.string.notif_battery_low_title))
@@ -621,8 +637,7 @@ public class GB {
         notificationIntent.setPackage(BuildConfig.APPLICATION_ID);
         notificationIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK
                 | Intent.FLAG_ACTIVITY_CLEAR_TASK);
-        PendingIntent pendingIntent = PendingIntentUtils.getActivity(context, 0,
-                notificationIntent, 0, false);
+        PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, notificationIntent, PendingIntent.FLAG_IMMUTABLE);
 
         NotificationCompat.Builder nb = new NotificationCompat.Builder(context, NOTIFICATION_CHANNEL_ID_FULL_BATTERY)
                 .setContentTitle(context.getString(R.string.notif_battery_full_title))
@@ -668,8 +683,7 @@ public class GB {
         notificationIntent.setPackage(BuildConfig.APPLICATION_ID);
         notificationIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK
                 | Intent.FLAG_ACTIVITY_CLEAR_TASK);
-        PendingIntent pendingIntent = PendingIntentUtils.getActivity(context, 0,
-                notificationIntent, 0, false);
+        PendingIntent pendingIntent = PendingIntent.getActivity(context, 0, notificationIntent, PendingIntent.FLAG_IMMUTABLE);
 
         NotificationCompat.Builder nb = new NotificationCompat.Builder(context, NOTIFICATION_CHANNEL_ID)
                 .setContentTitle(context.getString(R.string.notif_export_failed_title))
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/PendingIntentUtils.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/PendingIntentUtils.java
deleted file mode 100644
index f6540bf480..0000000000
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/PendingIntentUtils.java
+++ /dev/null
@@ -1,77 +0,0 @@
-/*  Copyright (C) 2022-2024 Ganblejs
-
-    This file is part of Gadgetbridge.
-
-    Gadgetbridge is free software: you can redistribute it and/or modify
-    it under the terms of the GNU Affero General Public License as published
-    by the Free Software Foundation, either version 3 of the License, or
-    (at your option) any later version.
-
-    Gadgetbridge is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU Affero General Public License for more details.
-
-    You should have received a copy of the GNU Affero General Public License
-    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
-package nodomain.freeyourgadget.gadgetbridge.util;
-
-import android.app.PendingIntent;
-import android.content.Context;
-import android.content.Intent;
-import android.os.Build;
-
-public  class PendingIntentUtils {
-    
-    public static PendingIntent getBroadcast(Context context,
-                                             int requestCode,
-                                             Intent intent,
-                                             int flags,
-                                             boolean makeMutable) {
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-          if (makeMutable) {
-            flags |= PendingIntent.FLAG_MUTABLE;
-          } else {
-            flags |= PendingIntent.FLAG_IMMUTABLE;
-          }
-            return PendingIntent.getBroadcast(context, requestCode, intent, flags);
-        }
-
-        return PendingIntent.getBroadcast(context, requestCode, intent, flags);
-    }
-    
-    public static PendingIntent getActivity(Context context,
-                                             int requestCode,
-                                             Intent intent,
-                                             int flags,
-                                             boolean makeMutable) {
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-          if (makeMutable) {
-            flags |= PendingIntent.FLAG_MUTABLE;
-          } else {
-            flags |= PendingIntent.FLAG_IMMUTABLE;
-          }
-            return PendingIntent.getActivity(context, requestCode, intent, flags);
-        }
-
-        return PendingIntent.getActivity(context, requestCode, intent, flags);
-    }
-    
-    public static PendingIntent getService(Context context,
-                                             int requestCode,
-                                             Intent intent,
-                                             int flags,
-                                             boolean makeMutable) {
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-          if (makeMutable) {
-            flags |= PendingIntent.FLAG_MUTABLE;
-          } else {
-            flags |= PendingIntent.FLAG_IMMUTABLE;
-          }
-            return PendingIntent.getService(context, requestCode, intent, flags);
-        }
-
-        return PendingIntent.getService(context, requestCode, intent, flags);
-    }
-    
-}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/PermissionsUtils.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/PermissionsUtils.java
index d1f9b8b927..8ade96664f 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/PermissionsUtils.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/PermissionsUtils.java
@@ -61,10 +61,8 @@ public class PermissionsUtils {
     public static final String CUSTOM_PERM_NOTIFICATION_SERVICE = "custom_perm_notifications_service";
     public static final String CUSTOM_PERM_DISPLAY_OVER = "custom_perm_display_over";
 
-    public static final List<String> specialPermissions = new ArrayList<String>() {{
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            add(CUSTOM_PERM_IGNORE_BATT_OPTIM);
-        }
+    public static final List<String> specialPermissions = new ArrayList<>() {{
+        add(CUSTOM_PERM_IGNORE_BATT_OPTIM);
         add(CUSTOM_PERM_NOTIFICATION_LISTENER);
         add(CUSTOM_PERM_NOTIFICATION_SERVICE);
         add(CUSTOM_PERM_DISPLAY_OVER);
@@ -76,35 +74,32 @@ public class PermissionsUtils {
 
     public static ArrayList<PermissionDetails> getRequiredPermissionsList(Activity activity) {
         ArrayList<PermissionDetails> permissionsList = new ArrayList<>();
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            int companionDevicesCount = 0;
-            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
-                final CompanionDeviceManager manager = (CompanionDeviceManager) GBApplication.getContext().getSystemService(Context.COMPANION_DEVICE_SERVICE);
-                companionDevicesCount = manager.getAssociations().size();
-            }
-            if (companionDevicesCount == 0) {
-                permissionsList.add(new PermissionDetails(
-                        CUSTOM_PERM_IGNORE_BATT_OPTIM,
-                        activity.getString(R.string.permission_disable_doze_title),
-                        activity.getString(R.string.permission_disable_doze_summary)));
-            } else {
-                LOG.info("Not requesting explicit battery optimization exemption due to paired Companion devices");
-            }
+        int companionDevicesCount = 0;
+        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
+            final CompanionDeviceManager manager = (CompanionDeviceManager) GBApplication.getContext().getSystemService(Context.COMPANION_DEVICE_SERVICE);
+            companionDevicesCount = manager.getAssociations().size();
+        }
+        if (companionDevicesCount == 0) {
+            permissionsList.add(new PermissionDetails(
+                    CUSTOM_PERM_IGNORE_BATT_OPTIM,
+                    activity.getString(R.string.permission_disable_doze_title),
+                    activity.getString(R.string.permission_disable_doze_summary)
+            ));
+        } else {
+            LOG.info("Not requesting explicit battery optimization exemption due to paired Companion devices");
         }
         permissionsList.add(new PermissionDetails(
                 CUSTOM_PERM_NOTIFICATION_LISTENER,
                 activity.getString(R.string.menuitem_notifications),
                 activity.getString(R.string.permission_notifications_summary)));
-        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            permissionsList.add(new PermissionDetails(
-                    CUSTOM_PERM_NOTIFICATION_SERVICE,
-                    activity.getString(R.string.permission_manage_dnd_title),
-                    activity.getString(R.string.permission_manage_dnd_summary)));
-            permissionsList.add(new PermissionDetails(
-                    CUSTOM_PERM_DISPLAY_OVER,
-                    activity.getString(R.string.permission_displayover_title),
-                    activity.getString(R.string.permission_displayover_summary)));
-        }
+        permissionsList.add(new PermissionDetails(
+                CUSTOM_PERM_NOTIFICATION_SERVICE,
+                activity.getString(R.string.permission_manage_dnd_title),
+                activity.getString(R.string.permission_manage_dnd_summary)));
+        permissionsList.add(new PermissionDetails(
+                CUSTOM_PERM_DISPLAY_OVER,
+                activity.getString(R.string.permission_displayover_title),
+                activity.getString(R.string.permission_displayover_summary)));
         permissionsList.add(new PermissionDetails(
                 Manifest.permission.ACCESS_FINE_LOCATION,
                 activity.getString(R.string.permission_fine_location_title),
@@ -205,25 +200,31 @@ public class PermissionsUtils {
     }
 
     public static boolean checkPermission(Context context, String permission) {
-        if (permission.equals(CUSTOM_PERM_NOTIFICATION_LISTENER)) {
-            Set<String> set = NotificationManagerCompat.getEnabledListenerPackages(context);
-            return set.contains(context.getPackageName());
-        } else if (permission.equals(CUSTOM_PERM_NOTIFICATION_SERVICE) && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            return ((NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE)).isNotificationPolicyAccessGranted();
-        } else if (permission.equals(CUSTOM_PERM_DISPLAY_OVER) && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            return Settings.canDrawOverlays(context);
-        } else if (permission.equals(CUSTOM_PERM_IGNORE_BATT_OPTIM) && Build.VERSION.SDK_INT >= Build.VERSION_CODES.M) {
-            PowerManager pm = (PowerManager) context.getSystemService(Context.POWER_SERVICE);
-            return pm.isIgnoringBatteryOptimizations(context.getApplicationContext().getPackageName());
-        } else {
-            return ContextCompat.checkSelfPermission(context, permission) != PackageManager.PERMISSION_DENIED;
+        switch (permission) {
+            case CUSTOM_PERM_NOTIFICATION_LISTENER -> {
+                Set<String> set = NotificationManagerCompat.getEnabledListenerPackages(context);
+                return set.contains(context.getPackageName());
+            }
+            case CUSTOM_PERM_NOTIFICATION_SERVICE -> {
+                return ((NotificationManager) context.getSystemService(Context.NOTIFICATION_SERVICE)).isNotificationPolicyAccessGranted();
+            }
+            case CUSTOM_PERM_DISPLAY_OVER -> {
+                return Settings.canDrawOverlays(context);
+            }
+            case CUSTOM_PERM_IGNORE_BATT_OPTIM -> {
+                PowerManager pm = (PowerManager) context.getSystemService(Context.POWER_SERVICE);
+                return pm.isIgnoringBatteryOptimizations(context.getApplicationContext().getPackageName());
+            }
+            default -> {
+                return ContextCompat.checkSelfPermission(context, permission) != PackageManager.PERMISSION_DENIED;
+            }
         }
     }
 
     public static boolean checkAllPermissions(Activity activity) {
         boolean result = true;
         for (PermissionDetails permission : getRequiredPermissionsList(activity)) {
-            if (!checkPermission(activity, permission.getPermission())) {
+            if (!checkPermission(activity, permission.permission())) {
                 result = false;
             }
         }
@@ -235,7 +236,7 @@ public class PermissionsUtils {
             showRequestIgnoreBatteryOptimizationDialog(activity);
         } else if (permission.equals(CUSTOM_PERM_NOTIFICATION_LISTENER)) {
             showNotifyListenerPermissionsDialog(activity);
-        } else if (permission.equals(CUSTOM_PERM_NOTIFICATION_SERVICE) && (Build.VERSION.SDK_INT >= Build.VERSION_CODES.M)) {
+        } else if (permission.equals(CUSTOM_PERM_NOTIFICATION_SERVICE)) {
             showNotifyPolicyPermissionsDialog(activity);
         } else if (permission.equals(CUSTOM_PERM_DISPLAY_OVER)) {
             showDisplayOverOthersPermissionsDialog(activity);
@@ -246,28 +247,9 @@ public class PermissionsUtils {
         }
     }
 
-    public static class PermissionDetails {
-        private String permission;
-        private String title;
-        private String summary;
-
-        public PermissionDetails(String permission, String title, String summary) {
-            this.permission = permission;
-            this.title = title;
-            this.summary = summary;
-        }
-
-        public String getPermission() {
-            return permission;
-        }
-
-        public String getTitle() {
-            return title;
-        }
-
-        public String getSummary() {
-            return summary;
-        }
+    public record PermissionDetails(String permission,
+                                    String title,
+                                    String summary) {
     }
 
     @SuppressLint("BatteryLife")
@@ -313,15 +295,12 @@ public class PermissionsUtils {
                 .setMessage(activity.getString(R.string.permission_notification_policy_access,
                         activity.getString(R.string.app_name),
                         activity.getString(R.string.ok)))
-                .setPositiveButton(R.string.ok, new DialogInterface.OnClickListener() {
-                    @RequiresApi(api = Build.VERSION_CODES.M)
-                    public void onClick(DialogInterface dialog, int id) {
-                        try {
-                            activity.startActivity(new Intent(android.provider.Settings.ACTION_NOTIFICATION_POLICY_ACCESS_SETTINGS));
-                        } catch (ActivityNotFoundException e) {
-                            GB.toast(activity, "'Notification Policy' activity not found", Toast.LENGTH_LONG, GB.ERROR, e);
-                            LOG.error("'Notification Policy' activity not found");
-                        }
+                .setPositiveButton(R.string.ok, (dialog, id) -> {
+                    try {
+                        activity.startActivity(new Intent(Settings.ACTION_NOTIFICATION_POLICY_ACCESS_SETTINGS));
+                    } catch (ActivityNotFoundException e) {
+                        GB.toast(activity, "'Notification Policy' activity not found", Toast.LENGTH_LONG, GB.ERROR, e);
+                        LOG.error("'Notification Policy' activity not found");
                     }
                 })
                 .show();
@@ -332,19 +311,14 @@ public class PermissionsUtils {
                 .setMessage(activity.getString(R.string.permission_display_over_other_apps,
                         activity.getString(R.string.app_name),
                         activity.getString(R.string.ok)))
-                .setPositiveButton(R.string.ok, new DialogInterface.OnClickListener() {
-                    @RequiresApi(api = Build.VERSION_CODES.M)
-                    public void onClick(DialogInterface dialog, int id) {
-                        Intent enableIntent = new Intent(
-                                android.provider.Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
-                                Uri.parse("package:" + BuildConfig.APPLICATION_ID)
-                        );
-                        activity.startActivity(enableIntent);
-                    }
+                .setPositiveButton(R.string.ok, (dialog, id) -> {
+                    Intent enableIntent = new Intent(
+                            Settings.ACTION_MANAGE_OVERLAY_PERMISSION,
+                            Uri.parse("package:" + BuildConfig.APPLICATION_ID)
+                    );
+                    activity.startActivity(enableIntent);
                 })
-                .setNegativeButton(R.string.dismiss, new DialogInterface.OnClickListener() {
-                    public void onClick(DialogInterface dialog, int id) {
-                    }
+                .setNegativeButton(R.string.dismiss, (dialog, id) -> {
                 })
                 .show();
     }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/maps/MapsManager.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/maps/MapsManager.java
index 6c3468f3a8..68ed6a31ec 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/maps/MapsManager.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/maps/MapsManager.java
@@ -19,6 +19,7 @@ package nodomain.freeyourgadget.gadgetbridge.util.maps;
 import android.content.Context;
 import android.net.Uri;
 
+import androidx.core.content.ContextCompat;
 import androidx.documentfile.provider.DocumentFile;
 
 import org.mapsforge.core.graphics.Paint;
@@ -195,7 +196,7 @@ public final class MapsManager {
 
         if (polyline == null) {
             final Paint paint = AndroidGraphicFactory.INSTANCE.createPaint();
-            final int trackColor = GBApplication.getPrefs().getInt(MapsManager.PREF_TRACK_COLOR, mContext.getResources().getColor(R.color.map_track_default));
+            final int trackColor = GBApplication.getPrefs().getInt(MapsManager.PREF_TRACK_COLOR, ContextCompat.getColor(mContext, R.color.map_track_default));
             paint.setColor(trackColor);
             paint.setStrokeWidth(8);
             paint.setStyle(Style.STROKE);
@@ -221,7 +222,7 @@ public final class MapsManager {
 
     public void reload() {
         if (polyline != null) {
-            final int trackColor = GBApplication.getPrefs().getInt(MapsManager.PREF_TRACK_COLOR, mContext.getResources().getColor(R.color.map_track_default));
+            final int trackColor = GBApplication.getPrefs().getInt(MapsManager.PREF_TRACK_COLOR, ContextCompat.getColor(mContext, R.color.map_track_default));
             polyline.getPaintStroke().setColor(trackColor);
             polyline.requestRedraw();
         }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/notifications/GBProgressNotification.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/notifications/GBProgressNotification.kt
index 4b862b33c3..d90134cba5 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/notifications/GBProgressNotification.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/notifications/GBProgressNotification.kt
@@ -17,6 +17,7 @@
 package nodomain.freeyourgadget.gadgetbridge.util.notifications
 
 import android.app.Notification
+import android.app.PendingIntent
 import android.content.Context
 import android.content.Intent
 import androidx.annotation.StringRes
@@ -25,7 +26,6 @@ import nodomain.freeyourgadget.gadgetbridge.BuildConfig
 import nodomain.freeyourgadget.gadgetbridge.R
 import nodomain.freeyourgadget.gadgetbridge.activities.ControlCenterv2
 import nodomain.freeyourgadget.gadgetbridge.util.GB
-import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils
 import org.slf4j.Logger
 import org.slf4j.LoggerFactory
 import java.util.Random
@@ -214,12 +214,11 @@ class GBProgressNotification(
             val notificationIntent = Intent(context, ControlCenterv2::class.java)
             notificationIntent.setPackage(BuildConfig.APPLICATION_ID)
             notificationIntent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_CLEAR_TASK)
-            val pendingIntent = PendingIntentUtils.getActivity(
+            val pendingIntent = PendingIntent.getActivity(
                 context,
                 0,
                 notificationIntent,
-                0,
-                false
+                PendingIntent.FLAG_IMMUTABLE
             )
 
             val nb = NotificationCompat.Builder(context, channelId)
```
-----------------------------------
