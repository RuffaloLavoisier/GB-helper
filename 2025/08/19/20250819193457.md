# Commit: 2aa543fd77dbbc7957fa7e5f180dad600551d073
## Message: Garmin: Allow fetching unknown files with new sync protocol
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitFile.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt
index f3d536dd5c..dbbbe50ecb 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt
@@ -49,6 +49,8 @@ class FileSyncServiceHandler(val deviceSupport: GarminSupport) {
             fileListResponse.nextPageId
         )
 
+        val fetchUnknownFiles = deviceSupport.devicePrefs.fetchUnknownFiles
+
         nextPageId = fileListResponse.nextPageId
 
         // Only the first entry for a type seems to contain the type name, so keep track of them
@@ -67,7 +69,7 @@ class FileSyncServiceHandler(val deviceSupport: GarminSupport) {
                 continue
             }
 
-            if (!FILE_TYPES_TO_PROCESS.contains(typeName)) {
+            if (!FILE_TYPES_TO_PROCESS.contains(typeName) && !fetchUnknownFiles) {
                 LOG.warn("Ignoring file type: {}", typeName)
                 continue
             }
@@ -92,7 +94,12 @@ class FileSyncServiceHandler(val deviceSupport: GarminSupport) {
     }
 
     fun requestFile(fileToRequest: GdiFileSyncService.File): GdiFileSyncService.FileSyncService {
-        LOG.debug("Requesting file: {}/{}", fileToRequest.id.id1, fileToRequest.id.id2)
+        LOG.debug(
+            "Requesting file: {}/{} ({})",
+            fileToRequest.id.id1,
+            fileToRequest.id.id2,
+            fileToRequest.type.name
+        )
         return GdiFileSyncService.FileSyncService.newBuilder().buildWith {
             fileRequest = GdiFileSyncService.FileRequest.newBuilder().buildWith {
                 file = fileToRequest
@@ -104,7 +111,26 @@ class FileSyncServiceHandler(val deviceSupport: GarminSupport) {
         }
     }
 
-    fun markSynced(syncFile: GdiFileSyncService.File): GdiFileSyncService.FileSyncService {
+    fun markSynced(syncFile: GdiFileSyncService.File): GdiFileSyncService.FileSyncService? {
+        val fetchUnknownFiles = deviceSupport.devicePrefs.fetchUnknownFiles
+        if (fetchUnknownFiles) {
+            // Since some of the unknown files are not really supposed to be marked as synced (eg. settings, courses, locations)
+            // let's avoid sending the command if it's not a file that we process
+            if (syncFile.type.name == null) {
+                LOG.warn("Will not mark {}/{} as synced - unknown type", syncFile.id.id1, syncFile.id.id2)
+                return null
+            }
+            if (!FILE_TYPES_TO_PROCESS.contains(syncFile.type.name)) {
+                LOG.warn(
+                    "Will not mark {}/{} ({}) as synced - not a file to process",
+                    syncFile.id.id1,
+                    syncFile.id.id2,
+                    syncFile.type.name
+                )
+                return null
+            }
+        }
+
         return GdiFileSyncService.FileSyncService.newBuilder().buildWith {
             fileSetFlags = GdiFileSyncService.FileSetFlags.newBuilder().buildWith {
                 file = syncFile.id
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
index cbde74cf63..3ceb8cf299 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
@@ -1298,14 +1298,16 @@ public class GarminSupport extends AbstractBTLESingleDeviceSupport implements IC
                 }
 
                 if (!getKeepActivityDataOnDevice()) { // delete file from watch upon successful download
-                    sendOutgoingMessage(
-                            "mark file as synced",
-                            protocolBufferHandler.prepareProtobufRequest(
-                                    GdiSmartProto.Smart.newBuilder().setFileSyncService(
-                                            protocolBufferHandler.getFileSyncServiceHandler().markSynced(currentlyDownloading.getSyncFile())
-                                    ).build()
-                            )
-                    );
+                    final GdiFileSyncService.FileSyncService syncedCommand = protocolBufferHandler.getFileSyncServiceHandler()
+                            .markSynced(currentlyDownloading.getSyncFile());
+                    if (syncedCommand != null) {
+                        sendOutgoingMessage(
+                                "mark file as synced",
+                                protocolBufferHandler.prepareProtobufRequest(
+                                        GdiSmartProto.Smart.newBuilder().setFileSyncService(syncedCommand).build()
+                                )
+                        );
+                    }
                 }
 
                 LOG.debug("New file sync success");
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitFile.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitFile.java
index a43b90b8fe..a33228b84b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitFile.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitFile.java
@@ -202,10 +202,10 @@ public class FitFile {
             this.dataSize = dataSize;
         }
 
-        static Header parseIncomingHeader(GarminByteBufferReader garminByteBufferReader) {
+        static Header parseIncomingHeader(GarminByteBufferReader garminByteBufferReader) throws FitParseException {
             int headerSize = garminByteBufferReader.readByte();
             if (headerSize < 12) {
-                throw new IllegalArgumentException("Too short header in FIT file.");
+                throw new FitParseException("Too short header in FIT file.");
             }
             boolean hasCRC = headerSize == 14;
             int protocolVersion = garminByteBufferReader.readByte();
@@ -213,13 +213,13 @@ public class FitFile {
             int dataSize = garminByteBufferReader.readInt();
             int magic = garminByteBufferReader.readInt();
             if (magic != MAGIC) {
-                throw new IllegalArgumentException("Wrong magic header in FIT file");
+                throw new FitParseException("Wrong magic header in FIT file");
             }
             if (hasCRC) {
                 int incomingCrc = garminByteBufferReader.readShort();
 
                 if (incomingCrc != 0 && incomingCrc != ChecksumCalculator.computeCrc(garminByteBufferReader.asReadOnlyBuffer(), 0, headerSize - 2)) {
-                    throw new IllegalArgumentException("Wrong CRC for header in FIT file");
+                    throw new FitParseException("Wrong CRC for header in FIT file");
                 }
                 //            LOG.info("Fit File Header didn't have CRC, no check performed.");
             }
```
-----------------------------------
