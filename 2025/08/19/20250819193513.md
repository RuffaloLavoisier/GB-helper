# Commit: 98e7aa2c39e3a4903ea5d5d58b19b97cde640966
## Message: Garmin: Improve failure handling in new sync protocol
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java

app/src/main/proto/garmin/gdi_file_sync_service.proto

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt
index 60703d358b..f3d536dd5c 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt
@@ -1,6 +1,7 @@
 package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin
 
 import nodomain.freeyourgadget.gadgetbridge.proto.garmin.GdiFileSyncService
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.deviceevents.FileDownloadedDeviceEvent
 import nodomain.freeyourgadget.gadgetbridge.util.protobuf.buildWith
 import org.slf4j.LoggerFactory
 
@@ -27,7 +28,17 @@ class FileSyncServiceHandler(val deviceSupport: GarminSupport) {
 
     private fun handleFileResponse(fileResponse: GdiFileSyncService.FileResponse): GdiFileSyncService.FileSyncService? {
         LOG.debug("Got file response: {}", fileResponse)
-        deviceSupport.downloadFileFromServiceV2(fileResponse.handle)
+
+        if (fileResponse.status != 0) {
+            LOG.warn("File download failed with status {}", fileResponse.status)
+            // Signal to the support class that the download failed so it can also continue to the next one
+            val fileDownloadedDeviceEvent = FileDownloadedDeviceEvent()
+            fileDownloadedDeviceEvent.success = false
+            deviceSupport.evaluateGBDeviceEvent(fileDownloadedDeviceEvent)
+        } else {
+            deviceSupport.downloadFileFromServiceV2(fileResponse.handle)
+        }
+
         return null
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
index a8f1d9ff5b..cbde74cf63 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
@@ -1320,6 +1320,10 @@ public class GarminSupport extends AbstractBTLESingleDeviceSupport implements IC
                 if (!started) {
                     if (!ArrayUtils.equals(new byte[]{0,0,0}, value, 0)) {
                         LOG.error("Got unexpected first message");
+                        if (currentlyDownloading != null && currentlyDownloading.getSyncFile() != null) {
+                            transferNotification.incrementTotalProgress(currentlyDownloading.getSyncFile().getSize());
+                            currentlyDownloading = null;
+                        }
                         return;
                     }
                     started = true;
diff --git a/app/src/main/proto/garmin/gdi_file_sync_service.proto b/app/src/main/proto/garmin/gdi_file_sync_service.proto
index ac6143b18c..78ec957a70 100644
--- a/app/src/main/proto/garmin/gdi_file_sync_service.proto
+++ b/app/src/main/proto/garmin/gdi_file_sync_service.proto
@@ -42,7 +42,7 @@ message FileRequest {
 }
 
 message FileResponse {
-  optional uint32 unk1 = 1; // 0
+  optional uint32 status = 1; // 0 success 3 failure
   optional uint32 unk2 = 2; // 0
   optional uint32 handle = 3; // varies
   optional uint32 unk7 = 7; // 11
```
-----------------------------------
