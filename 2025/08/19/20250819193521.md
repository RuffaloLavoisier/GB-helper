# Commit: 5f40d3f532faa1905d41ae231284be1a62b5edec
## Message: Huawei: Use single query for P2P timestamp
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
index 737af20ae5..f1af997ca0 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
@@ -2195,30 +2195,23 @@ public class HuaweiSupportProvider {
             Long userId = DBHelper.getUser(db.getDaoSession()).getId();
             Long deviceId = DBHelper.getDevice(gbDevice, db.getDaoSession()).getId();
 
-            List<HuaweiDictData> results;
-
-            QueryBuilder<HuaweiDictData> qbModify = db.getDaoSession().getHuaweiDictDataDao().queryBuilder().where(
+            QueryBuilder<HuaweiDictData> qb = db.getDaoSession().getHuaweiDictDataDao().queryBuilder().where(
                     HuaweiDictDataDao.Properties.UserId.eq(userId),
                     HuaweiDictDataDao.Properties.DeviceId.eq(deviceId),
                     HuaweiDictDataDao.Properties.DictClass.eq(dictClass)
-            ).orderDesc(
-                    HuaweiDictDataDao.Properties.ModifyTimestamp
+            ).orderRaw(
+                    // "max(MODIFY_TIMESTAMP, END_TIMESTAMP) DESC"
+                    String.format(
+                            "max(%s, %s) DESC",
+                            HuaweiDictDataDao.Properties.ModifyTimestamp.columnName,
+                            HuaweiDictDataDao.Properties.EndTimestamp.columnName
+                    )
             ).limit(1);
-            results = qbModify.build().list();
-            if (!results.isEmpty())
+            List<HuaweiDictData> results = qb.build().list();
+            if (!results.isEmpty()) {
                 lastTimestamp = Math.max(lastTimestamp, results.get(0).getModifyTimestamp());
-
-            QueryBuilder<HuaweiDictData> qbEndTimestamp = db.getDaoSession().getHuaweiDictDataDao().queryBuilder().where(
-                    HuaweiDictDataDao.Properties.UserId.eq(userId),
-                    HuaweiDictDataDao.Properties.DeviceId.eq(deviceId),
-                    HuaweiDictDataDao.Properties.DictClass.eq(dictClass)
-            ).orderDesc(
-                    HuaweiDictDataDao.Properties.EndTimestamp
-            ).limit(1);
-            results = qbEndTimestamp.build().list();
-            if (!results.isEmpty())
                 lastTimestamp = Math.max(lastTimestamp, results.get(0).getEndTimestamp());
-
+            }
         } catch (Exception e) {
             LOG.error("Failed to select last timestamp value to database", e);
         }
```
-----------------------------------
