# Commit: 5e7ddd8b9b2bad0752eda17234378352711419b2
## Message: Garmin: Download files from new sync protocol notifications
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/ProtocolBufferHandler.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt
index dbbbe50ecb..0e1b11098b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileSyncServiceHandler.kt
@@ -21,8 +21,19 @@ class FileSyncServiceHandler(val deviceSupport: GarminSupport) {
     }
 
     private fun handleNewFileNotification(newFileNotification: GdiFileSyncService.NewFileNotification): GdiFileSyncService.FileSyncService? {
-        LOG.debug("Got new file notification: {}, ignoring", newFileNotification)
-        //deviceSupport.addFileToDownloadList(newFileNotification.file)
+        LOG.debug("Got new file notification: {}", newFileNotification)
+        if (!newFileNotification.file.hasType() || !newFileNotification.file.type.hasName()) {
+            LOG.warn("New file has no type name")
+            return null
+        }
+        val fetchUnknownFiles = deviceSupport.devicePrefs.fetchUnknownFiles
+        val typeName = newFileNotification.file.type.name
+        if (!FILE_TYPES_TO_PROCESS.contains(typeName) && !fetchUnknownFiles) {
+            LOG.warn("Ignoring file type: {}", typeName)
+            return null
+        }
+
+        deviceSupport.addFileToDownloadList(newFileNotification.file)
         return null
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/ProtocolBufferHandler.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/ProtocolBufferHandler.java
index 85175b1a9c..5105e01c22 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/ProtocolBufferHandler.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/ProtocolBufferHandler.java
@@ -198,7 +198,6 @@ public class ProtocolBufferHandler implements MessageHandler {
                 }
             }
             if (smart.hasFileSyncService()) {
-                processed = true;
                 if (deviceSupport.getDevicePrefs().getBoolean("new_sync_protocol", false)) {
                     processed = true;
                     final GdiFileSyncService.FileSyncService response = fileSyncServiceHandler.handle(smart.getFileSyncService());
@@ -210,7 +209,6 @@ public class ProtocolBufferHandler implements MessageHandler {
                 }
             }
             if (smart.hasEcgService()) {
-                processed = true;
                 if (deviceSupport.getDevicePrefs().getBoolean("new_sync_protocol", false)) {
                     processed = true;
                     final GdiEcgService.EcgService response = ecgServiceHandler.handle(smart.getEcgService());
```
-----------------------------------
