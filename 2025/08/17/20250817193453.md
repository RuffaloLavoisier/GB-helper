# Commit: 711e896c114d29c672cde7a6a7d332de1c1daf11
## Message: Huawei: Batch inserting step data to database
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/GetStepDataRequest.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
index f4f583c334..aeb9c2e308 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
@@ -1788,34 +1788,6 @@ public class HuaweiSupportProvider {
         }
     }
 
-    public void addStepData(int timestamp, short steps, short calories, short distance, byte spo, byte heartrate) {
-        try (DBHandler db = GBApplication.acquireDB()) {
-            Long userId = DBHelper.getUser(db.getDaoSession()).getId();
-            Long deviceId = DBHelper.getDevice(gbDevice, db.getDaoSession()).getId();
-            HuaweiSampleProvider sampleProvider = new HuaweiSampleProvider(gbDevice, db.getDaoSession());
-
-            HuaweiActivitySample activitySample = new HuaweiActivitySample(
-                    timestamp,
-                    deviceId,
-                    userId,
-                    timestamp + 60,
-                    FitnessData.MessageData.stepId,
-                    ActivitySample.NOT_MEASURED,
-                    1,
-                    steps,
-                    calories,
-                    distance,
-                    spo,
-                    heartrate
-            );
-            activitySample.setProvider(sampleProvider);
-
-            sampleProvider.addGBActivitySample(activitySample);
-        } catch (Exception e) {
-            LOG.error("Failed to add step data to database", e);
-        }
-    }
-
     public void addStressData(long startTime, long endTime, byte stress, byte level) {
         try (DBHandler db = GBApplication.acquireDB()) {
             final Device device = DBHelper.getDevice(getDevice(), db.getDaoSession());
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/GetStepDataRequest.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/GetStepDataRequest.java
index 3f59b3c543..06deb35ca5 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/GetStepDataRequest.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/GetStepDataRequest.java
@@ -19,10 +19,17 @@ package nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.requests;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
+import java.util.ArrayList;
 import java.util.List;
 
+import nodomain.freeyourgadget.gadgetbridge.GBApplication;
+import nodomain.freeyourgadget.gadgetbridge.database.DBHandler;
+import nodomain.freeyourgadget.gadgetbridge.database.DBHelper;
 import nodomain.freeyourgadget.gadgetbridge.devices.huawei.HuaweiPacket;
+import nodomain.freeyourgadget.gadgetbridge.devices.huawei.HuaweiSampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.devices.huawei.packets.FitnessData;
+import nodomain.freeyourgadget.gadgetbridge.entities.HuaweiActivitySample;
+import nodomain.freeyourgadget.gadgetbridge.model.ActivitySample;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.HuaweiSupportProvider;
 
 public class GetStepDataRequest extends Request {
@@ -56,35 +63,64 @@ public class GetStepDataRequest extends Request {
         FitnessData.MessageData.StepResponse response = (FitnessData.MessageData.StepResponse) receivedPacket;
 
         if (response.number != this.count) {
-            LOG.warn("Counts do not match! Received: " + response.number + ", expected: " + this.count);
+            LOG.warn("Counts do not match! Received: {}, expected: {}", response.number, this.count);
             this.count = response.number; // This stops it from going into a loop
         }
 
-        for (FitnessData.MessageData.StepResponse.SubContainer subContainer : response.containers) {
-            int dataTimestamp = subContainer.timestamp;
+        try (DBHandler db = GBApplication.acquireDB()) {
+            Long userId = DBHelper.getUser(db.getDaoSession()).getId();
+            Long deviceId = DBHelper.getDevice(supportProvider.getDevice(), db.getDaoSession()).getId();
+            HuaweiSampleProvider sampleProvider = new HuaweiSampleProvider(supportProvider.getDevice(), db.getDaoSession());
 
-            if (subContainer.parsedData != null) {
-                short steps = (short) subContainer.steps;
-                short calories = (short) subContainer.calories;
-                short distance = (short) subContainer.distance;
-                byte heartrate = (byte) subContainer.heartrate;
-                byte spo = (byte) subContainer.spo;
+            List<HuaweiActivitySample> samples = new ArrayList<>(response.containers.size());
 
-                if (steps == -1)
-                    steps = 0;
-                if (calories == -1)
-                    calories = 0;
-                if (distance == -1)
-                    distance = 0;
+            for (FitnessData.MessageData.StepResponse.SubContainer subContainer : response.containers) {
+                int dataTimestamp = subContainer.timestamp;
 
-                for (FitnessData.MessageData.StepResponse.SubContainer.TV tv : subContainer.unknownTVs) {
-                    LOG.warn("Unknown tag in step data: " + tv);
+                if (subContainer.parsedData != null) {
+                    short steps = (short) subContainer.steps;
+                    short calories = (short) subContainer.calories;
+                    short distance = (short) subContainer.distance;
+                    byte heartrate = (byte) subContainer.heartrate;
+                    byte spo = (byte) subContainer.spo;
+
+                    if (steps == -1)
+                        steps = 0;
+                    if (calories == -1)
+                        calories = 0;
+                    if (distance == -1)
+                        distance = 0;
+
+                    for (FitnessData.MessageData.StepResponse.SubContainer.TV tv : subContainer.unknownTVs) {
+                        LOG.warn("Unknown tag in step data: {}", tv);
+                    }
+
+                    // this.supportProvider.addStepData(dataTimestamp, steps, calories, distance, spo, heartrate);
+
+                    HuaweiActivitySample activitySample = new HuaweiActivitySample(
+                            dataTimestamp,
+                            deviceId,
+                            userId,
+                            dataTimestamp + 60,
+                            FitnessData.MessageData.stepId,
+                            ActivitySample.NOT_MEASURED,
+                            1,
+                            steps,
+                            calories,
+                            distance,
+                            spo,
+                            heartrate
+                    );
+                    activitySample.setProvider(sampleProvider);
+                    samples.add(activitySample);
+                } else {
+                    LOG.error(subContainer.parsedDataError);
                 }
-
-                this.supportProvider.addStepData(dataTimestamp, steps, calories, distance, spo, heartrate);
-            } else {
-                LOG.error(subContainer.parsedDataError);
             }
+
+            sampleProvider.addGBActivitySamples(samples.toArray(new HuaweiActivitySample[0]));
+        } catch (Exception e) {
+            LOG.error("Failed to add step data to database", e);
         }
 
         if (count + 1 < maxCount) {
```
-----------------------------------
