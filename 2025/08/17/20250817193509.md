# Commit: 21a272cd742da4839cd49da58647a71742f546b4
## Message: weather: add compressed WeatherGz support to ACTION_GENERIC_WEATHER (#5239)

When receiving the broad cast action `nodomain.freeyourgadget.gadgetbridge.ACTION_GENERIC_WEATHER`

Try to decode bundle extra `WeatherGz` (ByteArray containing GZiped UTF-8 encoded JSON array of weather specifications) first.
If not present fall back to bundle extras `WeatherJson` (String containing one JSON weather specification) and optional `WeatherSecondaryJson` (String containing JSON array of weather specifications).
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/GenericWeatherReceiver.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/CompressionUtils.kt

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/GenericWeatherReceiver.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/GenericWeatherReceiver.java
index e5fee7b9bb..160cd1660d 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/GenericWeatherReceiver.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/GenericWeatherReceiver.java
@@ -1,5 +1,5 @@
-/*  Copyright (C) 2022-2024 Daniele Gobbetti, Enrico Brambilla, José Rebelo,
-    TylerWilliamson
+/*  Copyright (C) 2022-2025 Daniele Gobbetti, Enrico Brambilla, José Rebelo,
+    TylerWilliamson, Thomas Kuehne
 
     This file is part of Gadgetbridge.
 
@@ -36,12 +36,14 @@ import java.util.Objects;
 import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.model.weather.Weather;
 import nodomain.freeyourgadget.gadgetbridge.model.WeatherSpec;
+import nodomain.freeyourgadget.gadgetbridge.util.CompressionUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 public class GenericWeatherReceiver extends BroadcastReceiver {
     private static final Logger LOG = LoggerFactory.getLogger(GenericWeatherReceiver.class);
 
     public final static String ACTION_GENERIC_WEATHER = "nodomain.freeyourgadget.gadgetbridge.ACTION_GENERIC_WEATHER";
+    public final static String EXTRA_WEATHER_GZ = "WeatherGz";
     public final static String EXTRA_WEATHER_JSON = "WeatherJson";
     public final static String EXTRA_WEATHER_SECONDARY_JSON = "WeatherSecondaryJson";
 
@@ -63,23 +65,38 @@ public class GenericWeatherReceiver extends BroadcastReceiver {
             return;
         }
 
-        if (!bundle.containsKey(EXTRA_WEATHER_JSON)) {
-            LOG.warn("Bundle key {} not found", EXTRA_WEATHER_JSON);
-            return;
-        }
-
         try {
-            final JSONObject primaryWeatherJson = new JSONObject(Objects.requireNonNull(bundle.getString(EXTRA_WEATHER_JSON)));
-            final WeatherSpec primaryWeather = weatherFromJson(primaryWeatherJson);
-
             final ArrayList<WeatherSpec> weathers = new ArrayList<>();
-            weathers.add(primaryWeather);
 
-            if (bundle.containsKey(EXTRA_WEATHER_SECONDARY_JSON)) {
-                final JSONArray secondaryWeatherJson = new JSONArray(bundle.getString(EXTRA_WEATHER_SECONDARY_JSON, "[]"));
+            if (bundle.containsKey(EXTRA_WEATHER_GZ)) {
+                LOG.debug("use extra {}", EXTRA_WEATHER_GZ);
+                byte[] compressed = bundle.getByteArray(EXTRA_WEATHER_GZ);
+                String json = CompressionUtils.INSTANCE.gunzipUtf8String(compressed);
 
-                for (int i = 0; i < secondaryWeatherJson.length(); i++) {
-                    weathers.add(weatherFromJson(secondaryWeatherJson.getJSONObject(i)));
+                if (json != null && json.length() > 1){
+                    JSONArray weather = new JSONArray(json);
+                    for (int i = 0; i < weather.length(); i++) {
+                        weathers.add(weatherFromJson(weather.getJSONObject(i)));
+                    }
+                }
+            } else {
+                LOG.debug("use extra {}", EXTRA_WEATHER_JSON);
+                if (!bundle.containsKey(EXTRA_WEATHER_JSON)) {
+                    LOG.warn("Bundle key {} not found", EXTRA_WEATHER_JSON);
+                    return;
+                }
+
+                final JSONObject primaryWeatherJson = new JSONObject(Objects.requireNonNull(bundle.getString(EXTRA_WEATHER_JSON)));
+                final WeatherSpec primaryWeather = weatherFromJson(primaryWeatherJson);
+
+                weathers.add(primaryWeather);
+
+                if (bundle.containsKey(EXTRA_WEATHER_SECONDARY_JSON)) {
+                    final JSONArray secondaryWeatherJson = new JSONArray(bundle.getString(EXTRA_WEATHER_SECONDARY_JSON, "[]"));
+
+                    for (int i = 0; i < secondaryWeatherJson.length(); i++) {
+                        weathers.add(weatherFromJson(secondaryWeatherJson.getJSONObject(i)));
+                    }
                 }
             }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/CompressionUtils.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/CompressionUtils.kt
index a7d65676cc..cfe6474676 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/CompressionUtils.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/CompressionUtils.kt
@@ -1,9 +1,27 @@
+/*  Copyright (C) 2025 José Rebelo, Thomas Kuehne
+
+    This file is part of Gadgetbridge.
+
+    Gadgetbridge is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published
+    by the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    Gadgetbridge is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.util
 
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.GarminSupport
 import org.slf4j.LoggerFactory
+import java.io.ByteArrayInputStream
 import java.io.ByteArrayOutputStream
 import java.util.zip.DataFormatException
+import java.util.zip.GZIPInputStream
 import java.util.zip.Inflater
 
 object CompressionUtils {
@@ -25,4 +43,9 @@ object CompressionUtils {
         }
         return baosInflated.toByteArray()
     }
+
+    fun gunzipUtf8String(compressed: ByteArray?): String {
+        val byteInput = ByteArrayInputStream(compressed)
+        return GZIPInputStream(byteInput).bufferedReader(Charsets.UTF_8).use { it.readText() }
+    }
 }
```
-----------------------------------
