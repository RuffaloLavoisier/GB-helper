# Commit: 32204ce6065d92b6d86c111555fa75789bd66423
## Message: debug: enable sharing an existing log file even if file logging is currently disabled (#4659)
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/DebugActivity.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java
index 91638fcf0f..046b57b434 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java
@@ -417,7 +417,15 @@ public class GBApplication extends Application {
     }
 
     public static String getLogPath() {
-        return logging.getLogPath();
+        String path = logging.getLogPath();
+        if (path == null) {
+            // file logging is currently disabled but there still might be an old logfile
+            try {
+                path = logging.createLogDirectory() + File.separator + "gadgetbridge.log";
+            } catch (Exception ignored) {
+            }
+        }
+        return path;
     }
 
     private void setupExceptionHandler(final boolean notifyOnCrash) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/DebugActivity.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/DebugActivity.java
index 0fe59d7fff..b7d2f15ef9 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/DebugActivity.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/DebugActivity.java
@@ -45,7 +45,6 @@ import android.net.Uri;
 import android.os.Build;
 import android.os.Bundle;
 import android.os.Handler;
-import android.preference.PreferenceManager;
 import android.text.Editable;
 import android.text.InputFilter;
 import android.text.TextUtils;
@@ -129,7 +128,6 @@ import nodomain.freeyourgadget.gadgetbridge.model.WeatherSpec;
 import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 import nodomain.freeyourgadget.gadgetbridge.util.PendingIntentUtils;
-import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
 import nodomain.freeyourgadget.gadgetbridge.util.WidgetPreferenceStorage;
 
 public class DebugActivity extends AbstractGBActivity {
@@ -497,10 +495,19 @@ public class DebugActivity extends AbstractGBActivity {
         shareLogButton.setOnClickListener(new View.OnClickListener() {
             @Override
             public void onClick(View v) {
-                SharedPreferences sharedPrefs = PreferenceManager.getDefaultSharedPreferences(DebugActivity.this);
-                Prefs prefs = new Prefs(sharedPrefs);
-                boolean logging_enabled = prefs.getBoolean("log_to_file", false);
-                if (logging_enabled) {
+                boolean hasLog = false;
+                String filePath = "???";
+                try {
+                    filePath = GBApplication.getLogPath();
+                    if (filePath != null && filePath.length() > 0) {
+                        File log = new File(filePath);
+                        hasLog = log.exists();
+                    }
+                } catch (Exception e) {
+                    LOG.warn("failed to check log existence: {}", filePath, e);
+                }
+
+                if (hasLog) {
                     showLogSharingWarning();
                 } else {
                     showLogSharingNotEnabledAlert();
@@ -998,10 +1005,12 @@ public class DebugActivity extends AbstractGBActivity {
     private void shareLog() {
         String fileName = GBApplication.getLogPath();
         if (fileName != null && fileName.length() > 0) {
-            // Flush the logs, so that we ensure latest lines are also there
-            GBApplication.getLogging().setImmediateFlush(true);
-            LOG.debug("Flushing logs before sharing");
-            GBApplication.getLogging().setImmediateFlush(false);
+            if(GBApplication.isFileLoggingEnabled()) {
+                // Flush the logs, so that we ensure latest lines are also there
+                GBApplication.getLogging().setImmediateFlush(true);
+                LOG.debug("Flushing logs before sharing");
+                GBApplication.getLogging().setImmediateFlush(false);
+            }
 
             File logFile = new File(fileName);
             if (!logFile.exists()) {
```
-----------------------------------
