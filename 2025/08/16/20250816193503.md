# Commit: 2339242c336f186f60dd83deed51eac855bb2e87
## Message: Garmin: Fix activity fetch getting stuck on error

If fetch unknown files was enabled, an INDEX_UNKNOWN might sometimes be
received for some of the files, which would make the activity fetch get
stuck as we do not check the isDownloading() state anymore.
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileTransferHandler.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/deviceevents/FileDownloadedDeviceEvent.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileTransferHandler.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileTransferHandler.java
index fa3926777c..849988a6c3 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileTransferHandler.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/FileTransferHandler.java
@@ -141,8 +141,14 @@ public CreateFileMessage initiateUpload(byte[] fileAsByteArray, FileType.FILETYP
                 throw new IllegalStateException("Received file transfer of unknown file");
             if (downloadRequestStatusMessage.canProceed())
                 currentlyDownloading.setSize(downloadRequestStatusMessage);
-            else
+            else {
+                // Signal to the support class that the download failed so it can also continue to the next one
+                FileDownloadedDeviceEvent fileDownloadedDeviceEvent = new FileDownloadedDeviceEvent();
+                fileDownloadedDeviceEvent.directoryEntry = currentlyDownloading.directoryEntry;
+                fileDownloadedDeviceEvent.success = false;
+                deviceSupport.evaluateGBDeviceEvent(fileDownloadedDeviceEvent);
                 currentlyDownloading = null;
+            }
         }
 
         private void saveFileToExternalStorage() {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
index 93ad629841..d37341ae21 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
@@ -383,6 +383,13 @@ public class GarminSupport extends AbstractBTLESingleDeviceSupport implements IC
             this.supportedFileTypeList.addAll(((SupportedFileTypesDeviceEvent) deviceEvent).getSupportedFileTypes());
         } else if (deviceEvent instanceof FileDownloadedDeviceEvent fileDownloadedDeviceEvent) {
             final FileTransferHandler.DirectoryEntry entry = fileDownloadedDeviceEvent.directoryEntry;
+            if (!fileDownloadedDeviceEvent.success) {
+                LOG.warn("FILE DOWNLOAD FAILED");
+                // Continue to the next one
+                currentlyDownloading = null;
+                return;
+            }
+
             if (entry != null) {
                 final String filename = entry.getFileName();
                 LOG.debug("FILE DOWNLOAD COMPLETE {}", filename);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/deviceevents/FileDownloadedDeviceEvent.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/deviceevents/FileDownloadedDeviceEvent.java
index c481adf2e4..4e75d25750 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/deviceevents/FileDownloadedDeviceEvent.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/deviceevents/FileDownloadedDeviceEvent.java
@@ -7,6 +7,7 @@ import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.FileTransferHandler;
 
 public class FileDownloadedDeviceEvent extends GBDeviceEvent {
+    public boolean success = true;
     public FileTransferHandler.DirectoryEntry directoryEntry;
     public String localPath;
 
```
-----------------------------------
