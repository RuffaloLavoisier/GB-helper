# Commit: a85c895adf7d831dce13cfabbb5456b688874e9b
## Message: Huawei: Some code cleanups and fixes
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiFreebudsCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiFreebudsSettingsCustomizer.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiMusicUtils.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiSequenceDataParser.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiStressSampleProvider.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiTrueSleepSequenceDataParser.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/AsynchronousResponse.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiEphemerisManager.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/ResponseManager.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/datasync/HuaweiDataSyncEmotion.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiFreebudsCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiFreebudsCoordinator.java
index 04f13b86ff..49d6a62c7e 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiFreebudsCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiFreebudsCoordinator.java
@@ -17,7 +17,6 @@
 
 package nodomain.freeyourgadget.gadgetbridge.devices.huawei;
 
-import androidx.annotation.NonNull;
 
 import java.util.Collections;
 import java.util.Set;
@@ -25,13 +24,10 @@ import java.util.stream.Collectors;
 
 import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.R;
-import nodomain.freeyourgadget.gadgetbridge.GBException;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsPreferenceConst;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSpecificSettings;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSpecificSettingsCustomizer;
 import nodomain.freeyourgadget.gadgetbridge.devices.AbstractBLClassicDeviceCoordinator;
-import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession;
-import nodomain.freeyourgadget.gadgetbridge.entities.Device;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.model.BatteryConfig;
 import nodomain.freeyourgadget.gadgetbridge.util.preferences.DevicePrefs;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiFreebudsSettingsCustomizer.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiFreebudsSettingsCustomizer.java
index 12bcc09c22..27045dda7f 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiFreebudsSettingsCustomizer.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiFreebudsSettingsCustomizer.java
@@ -76,7 +76,7 @@ public class HuaweiFreebudsSettingsCustomizer implements DeviceSpecificSettingsC
         return Collections.emptySet();
     }
 
-    public static final Creator<HuaweiFreebudsSettingsCustomizer> CREATOR = new Creator<HuaweiFreebudsSettingsCustomizer>() {
+    public static final Creator<HuaweiFreebudsSettingsCustomizer> CREATOR = new Creator<>() {
         @Override
         public HuaweiFreebudsSettingsCustomizer createFromParcel(final Parcel in) {
             final GBDevice device = in.readParcelable(HuaweiFreebudsSettingsCustomizer.class.getClassLoader());
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiMusicUtils.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiMusicUtils.java
index 09d400f4fc..ac2a8df1c4 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiMusicUtils.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiMusicUtils.java
@@ -16,6 +16,8 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.devices.huawei;
 
+import androidx.annotation.NonNull;
+
 import java.util.ArrayList;
 import java.util.Arrays;
 import java.util.List;
@@ -28,6 +30,7 @@ public class HuaweiMusicUtils {
         public short count = 0;
         public byte[] hashCode = null;
 
+        @NonNull
         @Override
         public String toString() {
             final StringBuffer sb = new StringBuffer("PageStruct{");
@@ -62,6 +65,7 @@ public class HuaweiMusicUtils {
             return (formatIdx >= 0 && formatIdx < formats.length)?formats[formatIdx]:null;
         }
 
+        @NonNull
         @Override
         public String toString() {
             final StringBuffer sb = new StringBuffer("FormatRestrictions{");
@@ -85,6 +89,7 @@ public class HuaweiMusicUtils {
         public int unknown = 0; // TODO: not sure
         public List<FormatRestrictions> formatsRestrictions = null;
 
+        @NonNull
         @Override
         public String toString() {
             final StringBuffer sb = new StringBuffer("MusicCapabilities{");
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiSequenceDataParser.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiSequenceDataParser.java
index f83f87c57a..e66f6b4aec 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiSequenceDataParser.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiSequenceDataParser.java
@@ -1,3 +1,19 @@
+/*  Copyright (C) 2025 Me7c7
+
+    This file is part of Gadgetbridge.
+
+    Gadgetbridge is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published
+    by the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    Gadgetbridge is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.devices.huawei;
 
 import androidx.annotation.NonNull;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiStressSampleProvider.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiStressSampleProvider.java
index aedd21fffd..04b87eb497 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiStressSampleProvider.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiStressSampleProvider.java
@@ -18,9 +18,6 @@ package nodomain.freeyourgadget.gadgetbridge.devices.huawei;
 
 import androidx.annotation.NonNull;
 
-import java.util.ArrayList;
-import java.util.List;
-
 import de.greenrobot.dao.AbstractDao;
 import de.greenrobot.dao.Property;
 import nodomain.freeyourgadget.gadgetbridge.devices.AbstractTimeSampleProvider;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiTrueSleepSequenceDataParser.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiTrueSleepSequenceDataParser.java
index f0ce4e85ed..4c15c0e092 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiTrueSleepSequenceDataParser.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiTrueSleepSequenceDataParser.java
@@ -1,3 +1,19 @@
+/*  Copyright (C) 2025 Me7c7
+
+    This file is part of Gadgetbridge.
+
+    Gadgetbridge is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published
+    by the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    Gadgetbridge is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.devices.huawei;
 
 import androidx.annotation.NonNull;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/AsynchronousResponse.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/AsynchronousResponse.java
index 45ece38954..7f2312f750 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/AsynchronousResponse.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/AsynchronousResponse.java
@@ -261,7 +261,7 @@ public class AsynchronousResponse {
 
                 MusicControl.MusicStatusResponse resp = (MusicControl.MusicStatusResponse) response;
                 if (resp.status != -1 && resp.status != 0x000186A0) {
-                    LOG.warn("Music information error, will stop here: " + Integer.toHexString(resp.status));
+                    LOG.warn("Music information error, will stop here: {}", Integer.toHexString(resp.status));
                     return;
                 }
 
@@ -319,26 +319,22 @@ public class AsynchronousResponse {
                 if (resp.volumePresent) {
                     byte volume = resp.volume;
                     if (volume > audioManager.getStreamMaxVolume(AudioManager.STREAM_MUSIC)) {
-                        LOG.warn("Music - Received volume is too high: 0x"
-                                + Integer.toHexString(volume)
-                                + " > 0x"
-                                + Integer.toHexString(audioManager.getStreamMaxVolume(AudioManager.STREAM_MUSIC))
-                        );
+                        LOG.warn("Music - Received volume is too high: 0x{} > 0x{}",
+                                Integer.toHexString(volume),
+                                Integer.toHexString(audioManager.getStreamMaxVolume(AudioManager.STREAM_MUSIC)));
                         // TODO: probably best to send back an error code, though I wouldn't know which
                         return;
                     }
                     if (Build.VERSION.SDK_INT > Build.VERSION_CODES.P) {
                         if (volume < audioManager.getStreamMinVolume(AudioManager.STREAM_MUSIC)) {
-                            LOG.warn("Music - Received volume is too low: 0x"
-                                    + Integer.toHexString(volume)
-                                    + " < 0x"
-                                    + audioManager.getStreamMinVolume(AudioManager.STREAM_MUSIC)
-                            );
+                            LOG.warn("Music - Received volume is too low: 0x{} < 0x{}",
+                                    Integer.toHexString(volume),
+                                    audioManager.getStreamMinVolume(AudioManager.STREAM_MUSIC));
                             // TODO: probably best to send back an error code, though I wouldn't know which
                             return;
                         }
                     }
-                    LOG.debug("Music - Setting volume to: 0x" + Integer.toHexString(volume));
+                    LOG.debug("Music - Setting volume to: 0x{}", Integer.toHexString(volume));
                     audioManager.setStreamVolume(AudioManager.STREAM_MUSIC, volume, 0);
                 }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiEphemerisManager.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiEphemerisManager.java
index f1da13772f..13b4c4a612 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiEphemerisManager.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiEphemerisManager.java
@@ -185,15 +185,19 @@ public class HuaweiEphemerisManager {
                 if (entry.getName().equals(name)) {
                     InputStream inputStream = zipFile.getInputStream(entry);
                     ret = new byte[inputStream.available()];
-                    inputStream.read(ret);
+                    if(inputStream.read(ret) != ret.length) {
+                        ret = null;
+                    }
                     inputStream.close();
                 }
             }
             zipFile.close();
         } catch (ZipException e) {
             LOG.error("zip exception", e);
+            ret = null;
         } catch (IOException e) {
             LOG.error("zip IO exception", e);
+            ret = null;
         }
         return ret;
     }
@@ -205,6 +209,7 @@ public class HuaweiEphemerisManager {
             while (entries.hasMoreElements()) {
                 ZipEntry entry = entries.nextElement();
                 if (!entry.isDirectory() && entry.getName().equals(name)) {
+                    zipFile.close();
                     return true;
                 }
             }
@@ -218,6 +223,7 @@ public class HuaweiEphemerisManager {
     }
 
     public void handleOperatorRequest(byte operationInfo, int operationTime) {
+        LOG.debug("handleOperatorRequest: operationInfo {} operationTime: {}", operationInfo, operationTime);
         //TODO:
         // 100007 - no network connection
         if (operationInfo == 1) {
@@ -345,7 +351,7 @@ public class HuaweiEphemerisManager {
 
         if(fileType == 0) {
             //TODO: find all files that name contain productId and send
-            LOG.error("Currently not supported. File type: 0");
+            LOG.error("Currently not supported. File type: 0 Product Id: {}", productId);
         } else if(fileType == 1){
             if(currentRequest.getTagVersion() == 0) {
                 //TODO: implement this type
@@ -552,7 +558,7 @@ public class HuaweiEphemerisManager {
     }
 
     void handleFileDoneRequest(byte uploadResult) {
-        LOG.info("handleFileDoneRequest");
+        LOG.info("handleFileDoneRequest uploadResult: {}", uploadResult);
         cleanupUpload(false);
         try {
             SendEphemerisFileUploadDoneResponse sendEphemerisFileUploadDoneResponse = new SendEphemerisFileUploadDoneResponse(this.support, 100000);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
index 8cfc477631..fc6c89e890 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
@@ -1247,7 +1247,7 @@ public class HuaweiSupportProvider {
         if (huaweiDataSyncTreeCircleGoals != null) {
             int stepGoal = GBApplication.getPrefs().getInt(ActivityUser.PREF_USER_STEPS_GOAL, ActivityUser.defaultUserStepsGoal);
             if (!huaweiDataSyncTreeCircleGoals.sendStepsGoal(stepGoal)) {
-                LOG.error("Error to set stand goal");
+                LOG.error("Error to set steps goal");
             }
         } else {
             try {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/ResponseManager.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/ResponseManager.java
index 16c94d5861..201fa16bcc 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/ResponseManager.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/ResponseManager.java
@@ -115,12 +115,12 @@ public class ResponseManager {
                 }
 
                 if (handler == null) {
-                    LOG.debug("Service: " + Integer.toHexString(receivedPacket.serviceId & 0xff) + ", command: " + Integer.toHexString(receivedPacket.commandId & 0xff) + ", asynchronous response.");
+                    LOG.debug("Service: {}, command: {}, asynchronous response.", Integer.toHexString(receivedPacket.serviceId & 0xff), Integer.toHexString(receivedPacket.commandId & 0xff));
 
                     // Asynchronous response
                     asynchronousResponse.handleResponse(receivedPacket);
                 } else {
-                    LOG.debug("Service: " + Integer.toHexString(receivedPacket.serviceId & 0xff) + ", command: " + Integer.toHexString(receivedPacket.commandId & 0xff) + ", handled by: " + handler.getClass());
+                    LOG.debug("Service: {}, command: {}, handled by: {}", Integer.toHexString(receivedPacket.serviceId & 0xff), Integer.toHexString(receivedPacket.commandId & 0xff), handler.getClass());
 
                     if (handler.autoRemoveFromResponseHandler()) {
                         synchronized (handlers) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/datasync/HuaweiDataSyncEmotion.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/datasync/HuaweiDataSyncEmotion.java
index cdb25de00e..9d602900eb 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/datasync/HuaweiDataSyncEmotion.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/datasync/HuaweiDataSyncEmotion.java
@@ -1,6 +1,20 @@
-package nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.datasync;
+/*  Copyright (C) 2025 Me7c7
 
-import android.content.SharedPreferences;
+    This file is part of Gadgetbridge.
+
+    Gadgetbridge is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published
+    by the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    Gadgetbridge is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
+package nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.datasync;
 
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
```
-----------------------------------
