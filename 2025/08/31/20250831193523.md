# Commit: 0c6648ef07aaae2bd152ea11b86976b3c6057e8d
## Message: Amazfit Active: Allow AGPS update with brm files
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/UIHHContainer.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/ZeppOsAgpsFile.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/UIHHContainer.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/UIHHContainer.java
index 978d271765..0acc6c6c27 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/UIHHContainer.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/UIHHContainer.java
@@ -182,6 +182,7 @@ public class UIHHContainer {
         AGPS_EPO_GR_3(-116, "EPO_GR_3.DAT"),
         AGPS_EPO_GAL_7(-115, "EPO_GAL_7.DAT"),
         AGPS_EPO_BDS_3(-114, "EPO_BDS_3.DAT"),
+        AGPS_BRM_LTO_7D(0x8b, "lto7dv5.brm"),
         ;
 
         private final byte value;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/ZeppOsAgpsFile.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/ZeppOsAgpsFile.java
index acdeb18aa9..ea872f466e 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/ZeppOsAgpsFile.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/operations/ZeppOsAgpsFile.java
@@ -39,15 +39,14 @@ public class ZeppOsAgpsFile {
 
     public boolean isValid() {
         if (GBZipFile.isZipFile(fileBytes)) {
-            return isValidAsEpoZip();
+            final GBZipFile zipFile = new GBZipFile(fileBytes);
+            return isValidAsEpoZip(zipFile) || isValidAsBrmZip(zipFile);
         } else {
             return isValidAsUihh();
         }
     }
 
-    private boolean isValidAsEpoZip() {
-        final GBZipFile zipFile = new GBZipFile(fileBytes);
-
+    private boolean isValidAsEpoZip(final GBZipFile zipFile) {
         try {
             final byte[] manifestBin = zipFile.getFileFromZip("META-INF/MANIFEST.MF");
             if (manifestBin == null) {
@@ -70,6 +69,17 @@ public class ZeppOsAgpsFile {
         return false;
     }
 
+    private boolean isValidAsBrmZip(final GBZipFile zipFile) {
+        try {
+            // There's another lto2dv5.brm but we don't what type it gets sent as
+            return zipFile.fileExists("lto7dv5.brm");
+        } catch (final Exception e) {
+            LOG.error("Failed to check brm files", e);
+        }
+
+        return false;
+    }
+
     private boolean isValidAsUihh() {
         final UIHHContainer uihh = UIHHContainer.fromRawBytes(fileBytes);
         if (uihh == null) {
@@ -104,15 +114,21 @@ public class ZeppOsAgpsFile {
 
     public byte[] getUihhBytes() {
         if (GBZipFile.isZipFile(fileBytes)) {
-            // EPO zip - repackage into UIHH
+            // zip - repackage into UIHH
             final UIHHContainer uihh = new UIHHContainer();
 
             final GBZipFile zipFile = new GBZipFile(fileBytes);
 
             try {
-                uihh.addFile(UIHHContainer.FileType.AGPS_EPO_GR_3, zipFile.getFileFromZip("EPO_GR_3.DAT"));
-                uihh.addFile(UIHHContainer.FileType.AGPS_EPO_GAL_7, zipFile.getFileFromZip("EPO_GAL_7.DAT"));
-                uihh.addFile(UIHHContainer.FileType.AGPS_EPO_BDS_3, zipFile.getFileFromZip("EPO_BDS_3.DAT"));
+                if (isValidAsEpoZip(zipFile)) {
+                    uihh.addFile(UIHHContainer.FileType.AGPS_EPO_GR_3, zipFile.getFileFromZip("EPO_GR_3.DAT"));
+                    uihh.addFile(UIHHContainer.FileType.AGPS_EPO_GAL_7, zipFile.getFileFromZip("EPO_GAL_7.DAT"));
+                    uihh.addFile(UIHHContainer.FileType.AGPS_EPO_BDS_3, zipFile.getFileFromZip("EPO_BDS_3.DAT"));
+                } else if (isValidAsBrmZip(zipFile)) {
+                    uihh.addFile(UIHHContainer.FileType.AGPS_BRM_LTO_7D, zipFile.getFileFromZip("lto7dv5.brm"));
+                } else {
+                    throw new IllegalStateException("Unknown agps zip file - this should never happen");
+                }
             } catch (final ZipFileException e) {
                 throw new IllegalStateException("Failed to read file from zip", e);
             }
```
-----------------------------------
