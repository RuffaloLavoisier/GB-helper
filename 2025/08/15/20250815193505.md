# Commit: 78b78de8e662f73545b707abd39644ae7df59fae
## Message: delete export files when deleting a device (#5216)
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/adapter/GBDeviceAdapterv2.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/evenrealities/G1DeviceCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitImporter.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAssistantService.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsVoiceMemosService.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiFileDownloadManager.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/XiaomiSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/activity/XiaomiActivityFileFetcher.java

app/src/main/res/values/strings.xml

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/adapter/GBDeviceAdapterv2.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/adapter/GBDeviceAdapterv2.java
index 4298556045..286651bc4c 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/adapter/GBDeviceAdapterv2.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/adapter/GBDeviceAdapterv2.java
@@ -86,6 +86,7 @@ import com.jaredrummler.android.colorpicker.ColorPickerDialogListener;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
+import java.io.File;
 import java.util.ArrayList;
 import java.util.Collections;
 import java.util.HashMap;
@@ -979,35 +980,63 @@ public class GBDeviceAdapterv2 extends ListAdapter<GBDevice, GBDeviceAdapterv2.V
     }
 
     private void showRemoveDeviceDialog(final GBDevice device) {
-        new MaterialAlertDialogBuilder(context)
+        MaterialAlertDialogBuilder builder = new MaterialAlertDialogBuilder(context)
                 .setCancelable(true)
                 .setTitle(context.getString(R.string.controlcenter_delete_device_name, device.getName()))
                 .setMessage(R.string.controlcenter_delete_device_dialogmessage)
-                .setPositiveButton(R.string.Delete, new DialogInterface.OnClickListener() {
-                    @Override
-                    public void onClick(DialogInterface dialog, int which) {
-                        try {
-                            DeviceCoordinator coordinator = device.getDeviceCoordinator();
-                            coordinator.deleteDevice(device);
-                            BondingUtil.Unpair(context, device.getAddress());
-                            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
-                                removeDynamicShortcut(device);
-                            }
-                        } catch (Exception ex) {
-                            GB.toast(context, context.getString(R.string.error_deleting_device, ex.getLocalizedMessage()), Toast.LENGTH_LONG, GB.ERROR, ex);
-                        } finally {
-                            Intent refreshIntent = new Intent(DeviceManager.ACTION_REFRESH_DEVICELIST);
-                            LocalBroadcastManager.getInstance(context).sendBroadcast(refreshIntent);
-                        }
-                    }
-                })
-                .setNegativeButton(R.string.Cancel, new DialogInterface.OnClickListener() {
-                    @Override
-                    public void onClick(DialogInterface dialog, int which) {
-                        // do nothing
-                    }
-                })
-                .show();
+                .setPositiveButton(R.string.Delete,
+                        (dialog, which) -> removeDevice(device, true))
+                .setNegativeButton(R.string.Cancel, (dialog, which) -> {});
+
+        if (deviceHasFiles(device)) {
+            builder.setNeutralButton(R.string.delete_device_and_retain_files,
+                    (dialog, which) -> removeDevice(device, false));
+        }
+        builder.show();
+    }
+
+    private void removeDevice(GBDevice device, boolean deleteFiles) {
+        try {
+            DeviceCoordinator coordinator = device.getDeviceCoordinator();
+            coordinator.deleteDevice(device, deleteFiles);
+            BondingUtil.Unpair(context, device.getAddress());
+            if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.R) {
+                removeDynamicShortcut(device);
+            }
+        } catch (Exception ex) {
+            GB.toast(context, context.getString(R.string.error_deleting_device, ex.getLocalizedMessage()), Toast.LENGTH_LONG, GB.ERROR, ex);
+        } finally {
+            Intent refreshIntent = new Intent(DeviceManager.ACTION_REFRESH_DEVICELIST);
+            LocalBroadcastManager.getInstance(context).sendBroadcast(refreshIntent);
+        }
+    }
+
+    private boolean deviceHasFiles(final GBDevice device) {
+        DeviceCoordinator coordinator = device.getDeviceCoordinator();
+
+        try {
+            File cache = coordinator.getAppCacheDir();
+            if (cache != null && cache.exists()) {
+                return true;
+            }
+        } catch (Exception e) {
+            LOG.warn("failed to check cache dir", e);
+            // assume device has cache files
+            return true;
+        }
+
+        try {
+            File export = coordinator.getWritableExportDirectory(device, false);
+            if (export != null && export.exists()) {
+                return true;
+            }
+        } catch (Exception e) {
+            LOG.warn("failed to check export dir", e);
+            // assume device has export files
+            return true;
+        }
+
+        return false;
     }
 
     private void showSetParentFolderDialog(final GBDevice device) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java
index 202f2a04d4..761c3dbe96 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java
@@ -27,6 +27,7 @@ import android.bluetooth.BluetoothDevice;
 import android.bluetooth.le.ScanFilter;
 import android.content.Context;
 import android.net.Uri;
+import android.widget.Toast;
 
 import androidx.annotation.DrawableRes;
 import androidx.annotation.NonNull;
@@ -94,6 +95,7 @@ import nodomain.freeyourgadget.gadgetbridge.model.WeightSample;
 import nodomain.freeyourgadget.gadgetbridge.model.WorkoutLoadSample;
 import nodomain.freeyourgadget.gadgetbridge.service.ServiceDeviceSupport;
 import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;
+import nodomain.freeyourgadget.gadgetbridge.util.GB;
 import nodomain.freeyourgadget.gadgetbridge.util.GBPrefs;
 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
 
@@ -179,7 +181,7 @@ public abstract class AbstractDeviceCoordinator implements DeviceCoordinator {
     }
 
     @Override
-    public final void deleteDevice(final GBDevice gbDevice) throws GBException {
+    public final void deleteDevice(final GBDevice gbDevice, boolean deleteFiles) throws GBException {
         LOG.info("will try to delete device: {}", gbDevice.getName());
         if (gbDevice.isConnected() || gbDevice.isConnecting()) {
             GBApplication.deviceService(gbDevice).disconnect();
@@ -214,6 +216,27 @@ public abstract class AbstractDeviceCoordinator implements DeviceCoordinator {
         } catch (Exception e) {
             throw new GBException("Error deleting device: " + e.getMessage(), e);
         }
+
+        if (deleteFiles) {
+            deleteDeviceFiles(gbDevice);
+        }
+    }
+
+
+    private void deleteDeviceFiles(final GBDevice gbDevice) {
+        File export = new File("(export)");
+        try {
+            export = getWritableExportDirectory(gbDevice, false);
+            if (!FileUtils.deleteRecursively(export)) {
+                String message = GBApplication.getContext().getString(R.string.error_deleting_file,
+                        export.getPath());
+                GB.toast(message, Toast.LENGTH_LONG, GB.ERROR);
+            }
+        } catch (Exception e) {
+            String message = GBApplication.getContext().getString(R.string.error_deleting_file_exception,
+                    export.getPath(), e.getLocalizedMessage());
+            GB.toast(message, Toast.LENGTH_LONG, GB.ERROR, e);
+        }
     }
 
     /**
@@ -432,11 +455,10 @@ public abstract class AbstractDeviceCoordinator implements DeviceCoordinator {
     }
 
     @Override
-    public File getWritableExportDirectory(final GBDevice device) throws IOException {
-        File dir;
-        dir = new File(FileUtils.getExternalFilesDir() + File.separator + device.getAddress());
+    public File getWritableExportDirectory(final GBDevice device, boolean createIfRequired) throws IOException {
+        File dir = new File(FileUtils.getExternalFilesDir(), device.getAddress());
         if (!dir.isDirectory()) {
-            if (!dir.mkdir()) {
+            if (createIfRequired && !dir.mkdir()) {
                 throw new IOException("Cannot create device specific directory for " + device.getName());
             }
         }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java
index 6f40be851b..c4738993a2 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java
@@ -188,7 +188,7 @@ public interface DeviceCoordinator {
      * given device.
      * @throws GBException
      */
-    void deleteDevice(GBDevice device) throws GBException;
+    void deleteDevice(GBDevice device, boolean deleteFiles) throws GBException;
 
     /**
      * Returns the Activity class to be started in order to perform a pairing of a
@@ -604,7 +604,7 @@ public interface DeviceCoordinator {
     /**
      * Returns the dedicated writable export directory for this device.
      */
-    File getWritableExportDirectory(GBDevice device) throws IOException;
+    File getWritableExportDirectory(GBDevice device, boolean createIfRequired) throws IOException;
 
     /**
      * Returns a String containing the device app sort order filename.
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/evenrealities/G1DeviceCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/evenrealities/G1DeviceCoordinator.java
index 375285ddd5..e051bba77d 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/evenrealities/G1DeviceCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/evenrealities/G1DeviceCoordinator.java
@@ -147,7 +147,7 @@ public class G1DeviceCoordinator extends AbstractBLEDeviceCoordinator {
             GBDevice rightDevice =
                     new GBDevice(right_address.getDetails(), right_name.getDetails(), null,
                                  gbDevice.getParentFolder(), gbDevice.getType());
-            super.deleteDevice(rightDevice);
+            super.deleteDevice(rightDevice, true);
             BondingUtil.Unpair(GBApplication.getContext(), rightDevice.getAddress());
         }
     }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
index abb8a76807..db2648943f 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
@@ -1078,7 +1078,7 @@ public class GarminSupport extends AbstractBTLESingleDeviceSupport implements IC
     }
 
     public File getWritableExportDirectory() throws IOException {
-        return getDevice().getDeviceCoordinator().getWritableExportDirectory(getDevice());
+        return getDevice().getDeviceCoordinator().getWritableExportDirectory(getDevice(), true);
     }
 
     @Override
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitImporter.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitImporter.java
index 44167e100b..b4cb39c585 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitImporter.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitImporter.java
@@ -376,7 +376,7 @@ public class FitImporter {
         // If the file is not yet on the export directory (eg. we're importing from phone storage), copy it
         File finalExportFile = file;
         try {
-            final File exportDirectory = gbDevice.getDeviceCoordinator().getWritableExportDirectory(gbDevice);
+            final File exportDirectory = gbDevice.getDeviceCoordinator().getWritableExportDirectory(gbDevice, true);
             if (!file.getAbsolutePath().startsWith(exportDirectory.getAbsolutePath())) {
                 final File exportFile = new File(exportDirectory, getFilePath(fileId));
                 if (exportFile.isFile()) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAssistantService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAssistantService.java
index d6f077eb85..66bd8f10e6 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAssistantService.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAssistantService.java
@@ -423,7 +423,7 @@ public class ZeppOsAssistantService extends AbstractZeppOsService {
         if (DUMP_RAW_VOICE) {
             // for decoding debug
             try {
-                final File writableExportDirectory = getCoordinator().getWritableExportDirectory(getSupport().getDevice());
+                final File writableExportDirectory = getCoordinator().getWritableExportDirectory(getSupport().getDevice(), true);
                 final File targetDir = new File(writableExportDirectory, "assistantRawVoice");
                 targetDir.mkdirs();
                 final String filename = DateTimeUtils.formatIso8601(new Date()) + ".opus";
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsVoiceMemosService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsVoiceMemosService.java
index bea24395bd..44c7e9e86b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsVoiceMemosService.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsVoiceMemosService.java
@@ -165,7 +165,7 @@ public class ZeppOsVoiceMemosService extends AbstractZeppOsService {
 
         final File targetFile;
         try {
-            final File exportDirectory = getCoordinator().getWritableExportDirectory(getSupport().getDevice());
+            final File exportDirectory = getCoordinator().getWritableExportDirectory(getSupport().getDevice(), true);
             final File voiceMemosDirectory = new File(exportDirectory, "voicememo");
             //noinspection ResultOfMethodCallIgnored
             voiceMemosDirectory.mkdirs();
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiFileDownloadManager.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiFileDownloadManager.java
index 2ae70281ed..54692c5af4 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiFileDownloadManager.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiFileDownloadManager.java
@@ -813,7 +813,7 @@ public class HuaweiFileDownloadManager {
 
         try {
             String filename = FileUtils.makeValidFileName(System.currentTimeMillis() + "_" + fileRequest.getFileId() + "_" + fileRequest.getFilename());
-            File dir = new File(supportProvider.getDevice().getDeviceCoordinator().getWritableExportDirectory(supportProvider.getDevice()) + File.separator + "raw");
+            File dir = new File(supportProvider.getDevice().getDeviceCoordinator().getWritableExportDirectory(supportProvider.getDevice(), true) + File.separator + "raw");
             if (!dir.isDirectory()) {
                 if (!dir.mkdir()) {
                     LOG.error("Error save raw file");
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
index fd2947c152..175894de8b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
@@ -3080,7 +3080,7 @@ public class HuaweiSupportProvider {
                         File targetFile;
                         try {
                             targetFile = new File(
-                                    getDevice().getDeviceCoordinator().getWritableExportDirectory(getDevice()),
+                                    getDevice().getDeviceCoordinator().getWritableExportDirectory(getDevice(), true),
                                     filename
                             );
                         } catch (IOException e) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/XiaomiSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/XiaomiSupport.java
index 645be78246..1030bfbf04 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/XiaomiSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/XiaomiSupport.java
@@ -465,7 +465,7 @@ public class XiaomiSupport extends AbstractDeviceSupport {
 
         final List<File> activityFiles;
         try {
-            final File externalFilesDir = getCoordinator().getWritableExportDirectory(getDevice());
+            final File externalFilesDir = getCoordinator().getWritableExportDirectory(getDevice(), true);
             final File exportDir = new File(externalFilesDir, "rawFetchOperations");
 
             if (!exportDir.exists() || !exportDir.isDirectory()) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/activity/XiaomiActivityFileFetcher.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/activity/XiaomiActivityFileFetcher.java
index a410afb8b5..11ec4cf8bc 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/activity/XiaomiActivityFileFetcher.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/xiaomi/activity/XiaomiActivityFileFetcher.java
@@ -205,7 +205,7 @@ public class XiaomiActivityFileFetcher {
     public static File getRawFile(final XiaomiSupport support, final XiaomiActivityFileId fileId) {
         try {
             final GBDevice device = support.getDevice();
-            final File exportDirectory = device.getDeviceCoordinator().getWritableExportDirectory(device);
+            final File exportDirectory = device.getDeviceCoordinator().getWritableExportDirectory(device, true);
             final File targetDir = new File(exportDirectory, "rawFetchOperations");
             final File outputFile = fileId.getOutputFile(targetDir);
             if (!outputFile.isFile()) {
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index 55172031cb..9e0484c47f 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -1379,6 +1379,7 @@
     <string name="activity_db_management_empty_db_warning">Warning! By pushing this button you will wipe your database and start from scratch.</string>
     <string name="Cancel">Cancel</string>
     <string name="Delete">Delete</string>
+    <string name="delete_device_and_retain_files">Keep Files</string>
     <string name="ok">OK</string>
     <string name="dismiss">Dismiss</string>
     <string name="notifications_dismiss_all">Dismiss All</string>
@@ -4253,6 +4254,8 @@
     <string name="shokz_controls_long_press_multi_function">Long-press the multi-function button</string>
     <string name="shokz_controls_simultaneous_volume_up_down">Long-press volume up and down simultaneously</string>
     <string name="track_name_required">Track name cannot be empty</string>
+    <string name="error_deleting_file">deleting \"%1$s\" failed</string>
+    <string name="error_deleting_file_exception">deleting \"%1$s\" failed: %2$s</string>
     <string name="bluetooth_multipoint_pairing">Multipoint pairing</string>
     <string name="bluetooth_multipoint">Multipoint</string>
     <string name="bluetooth_multipoint_pair_new">Pair New Device</string>
```
-----------------------------------
