# Commit: e475a42ec5262e02b58baad7e831d9ae1905ede0
## Message: Zepp OS: Parse workout laps
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsActivitySummaryParser.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityDetailsParser.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityTrack.java

app/src/main/res/values/strings.xml

app/src/test/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityDetailsParserTest.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsActivitySummaryParser.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsActivitySummaryParser.java
index ab4af18a03..046e8b2402 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsActivitySummaryParser.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsActivitySummaryParser.java
@@ -256,8 +256,8 @@ public class ZeppOsActivitySummaryParser extends HuamiActivitySummaryParser {
                         "set_" + i,
                         Arrays.asList(
                                 new ActivitySummaryValue(i, UNIT_NONE),
-                                new ActivitySummaryValue(String.valueOf(strengthSet.getReps())),
-                                new ActivitySummaryValue(strengthSet.getWeightKg() >= 0 ? strengthSet.getWeightKg() : null, UNIT_KG)
+                                new ActivitySummaryValue(String.valueOf(strengthSet.reps())),
+                                new ActivitySummaryValue(strengthSet.weightKg() >= 0 ? strengthSet.weightKg() : null, UNIT_KG)
                         )
                 );
 
@@ -266,5 +266,29 @@ public class ZeppOsActivitySummaryParser extends HuamiActivitySummaryParser {
 
             tableBuilder.addToSummaryData(summaryData);
         }
+
+        final List<ZeppOsActivityTrack.Lap> laps = activityTrack.getLaps();
+        if (!laps.isEmpty()) {
+            final ActivitySummaryTableBuilder tableBuilder = new ActivitySummaryTableBuilder(LAPS, "laps_header", Arrays.asList(
+                    "workout_lap",
+                    "distanceMeters",
+                    "Speed",
+                    "lap_time"
+            ));
+
+            for (final ZeppOsActivityTrack.Lap lap : laps) {
+                tableBuilder.addRow(
+                        "lap_" + lap.number(),
+                        Arrays.asList(
+                                new ActivitySummaryValue(lap.number(), UNIT_NONE),
+                                new ActivitySummaryValue(lap.distance(), UNIT_METERS),
+                                new ActivitySummaryValue(1000f / lap.pace(), UNIT_METERS_PER_SECOND),
+                                new ActivitySummaryValue(lap.duration() / 1000, UNIT_SECONDS)
+                        )
+                );
+            }
+
+            tableBuilder.addToSummaryData(summaryData);
+        }
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityDetailsParser.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityDetailsParser.java
index 2390394d34..d4d9bbab16 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityDetailsParser.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityDetailsParser.java
@@ -93,7 +93,7 @@ public class ZeppOsActivityDetailsParser extends AbstractHuamiActivityDetailsPar
 
             final Type type = Type.fromCode(typeCode);
 
-            //trace("Read typeCode={}, type={}, length={}, initialPosition={}", typeCode, type, length, initialPosition);
+            trace("Read typeCode={}, type={}, length={}, initialPosition={}", typeCode, type, length, initialPosition);
 
             if (type == null) {
                 if (!unknownTypeCodes.containsKey(typeCode)) {
@@ -138,6 +138,9 @@ public class ZeppOsActivityDetailsParser extends AbstractHuamiActivityDetailsPar
                 case STRENGTH_SET:
                     consumeStrengthSet(buf);
                     break;
+                case LAP:
+                    consumeLap(buf);
+                    break;
                 default:
                     LOG.warn("No consumer for for type {}", type);
                     // Consume the reported length
@@ -166,7 +169,7 @@ public class ZeppOsActivityDetailsParser extends AbstractHuamiActivityDetailsPar
         this.timestamp = new Date(buf.getLong());
         this.offset = 0;
 
-        //trace("Consumed timestamp");
+        trace("Consumed timestamp");
     }
 
     private void consumeTimestampOffset(final ByteBuffer buf) {
@@ -186,7 +189,7 @@ public class ZeppOsActivityDetailsParser extends AbstractHuamiActivityDetailsPar
         final double longitudeDeg = convertHuamiValueToDecimalDegrees(longitude);
         final double latitudeDeg = convertHuamiValueToDecimalDegrees(latitude);
 
-        //trace("Consumed GPS coords: {} {}", longitudeDeg, latitudeDeg);
+        trace("Consumed GPS coords: {} {}", longitudeDeg, latitudeDeg);
     }
 
     private void consumeGpsDelta(final ByteBuffer buf) {
@@ -206,7 +209,7 @@ public class ZeppOsActivityDetailsParser extends AbstractHuamiActivityDetailsPar
 
         addNewGpsCoordinates();
 
-        //trace("Consumed GPS delta: {} {} {}", longitudeDelta, latitudeDelta, two);
+        trace("Consumed GPS delta: {} {} {}", longitudeDelta, latitudeDelta, two);
     }
 
     private void consumeStatus(final ByteBuffer buf) {
@@ -234,7 +237,7 @@ public class ZeppOsActivityDetailsParser extends AbstractHuamiActivityDetailsPar
                 LOG.warn("Unknown status code {}", String.format("0x%X", statusCode));
         }
 
-        //trace("Consumed Status: {}", status);
+        trace("Consumed Status: {}", status);
     }
 
     private void consumeSpeed(final ByteBuffer buf) {
@@ -252,7 +255,7 @@ public class ZeppOsActivityDetailsParser extends AbstractHuamiActivityDetailsPar
             }
         }
 
-        //trace("Consumed speed: cadence={}, stride={}, pace={}", cadence, stride, pace);
+        trace("Consumed speed: cadence={}, stride={}, pace={}", cadence, stride, pace);
     }
 
     private void consumeAltitude(final ByteBuffer buf) {
@@ -270,7 +273,7 @@ public class ZeppOsActivityDetailsParser extends AbstractHuamiActivityDetailsPar
             ap.setLocation(newCoordinate);
         }
 
-        //trace("Consumed altitude: {}", altitude);
+        trace("Consumed altitude: {}", altitude);
     }
 
     private void consumeHeartRate(final ByteBuffer buf) {
@@ -282,7 +285,7 @@ public class ZeppOsActivityDetailsParser extends AbstractHuamiActivityDetailsPar
             ap.setHeartRate(heartRate);
         }
 
-        //trace("Consumed HeartRate: {}", heartRate);
+        trace("Consumed HeartRate: {}", heartRate);
     }
 
     private void consumeStrengthSet(final ByteBuffer buf) {
@@ -294,7 +297,24 @@ public class ZeppOsActivityDetailsParser extends AbstractHuamiActivityDetailsPar
 
         activityTrack.addStrengthSet(reps, weight != 0xffff ? weight / 10f : -1);
 
-        //trace("Consumed strength set: reps={}, weightKg={}", reps, weightKg);
+        trace("Consumed strength set: reps={}, weightKg={}", reps, weight);
+    }
+
+    private void consumeLap(final ByteBuffer buf) {
+        buf.get(new byte[2]); // ?
+        final int number = buf.getShort() & 0xffff;
+        buf.get(); // 3 ?
+        final int hr = buf.get() & 0xff;
+        final int pace = buf.getShort() & 0xffff; // s/km
+        final int calories = buf.getShort() & 0xffff;
+        final int distance = buf.getShort() & 0xffff; // m
+        buf.get(new byte[4]); // ?
+        final int duration = buf.getInt(); // ms
+        buf.get(new byte[99 - 20]); // ?
+
+        activityTrack.addLap(number, hr, pace, calories, distance, duration);
+
+        trace("Consumed lap: number={}, hr={}, pace={}, calories={}, distance={}, duration={}", number, hr, pace, calories, distance, duration);
     }
 
     @Nullable
@@ -341,8 +361,15 @@ public class ZeppOsActivityDetailsParser extends AbstractHuamiActivityDetailsPar
     }
 
     private void trace(final String format, final Object... args) {
-        final Object[] argsWithDate = ArrayUtils.insert(0, args, SDF.format(new Date(timestamp.getTime() + offset)));
-        LOG.debug("{}: " + format, argsWithDate);
+        final Object[] argsWithDate;
+        if (timestamp != null) {
+            argsWithDate = ArrayUtils.insert(0, args, SDF.format(new Date(timestamp.getTime() + offset)));
+        } else {
+            argsWithDate = ArrayUtils.insert(0, args, "(null)");
+        }
+
+        //noinspection StringConcatenationArgumentToLogCall
+        LOG.trace("{}: " + format, argsWithDate);
     }
 
     private enum Type {
@@ -353,6 +380,7 @@ public class ZeppOsActivityDetailsParser extends AbstractHuamiActivityDetailsPar
         SPEED(5, 8),
         ALTITUDE(7, 6),
         HEARTRATE(8, 3),
+        LAP(11, 99),
         STRENGTH_SET(15, 34),
         ;
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityTrack.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityTrack.java
index 8c1f987366..6b06b05b3a 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityTrack.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityTrack.java
@@ -7,30 +7,37 @@ import nodomain.freeyourgadget.gadgetbridge.model.ActivityTrack;
 
 public class ZeppOsActivityTrack extends ActivityTrack {
     public final List<StrengthSet> strengthSets = new ArrayList<>();
+    public final List<Lap> laps = new ArrayList<>();
 
     public void addStrengthSet(final int reps, final float weightKg) {
         strengthSets.add(new StrengthSet(reps, weightKg));
     }
 
+    public void addLap(final int number,
+                       final int hr,
+                       final int pace,
+                       final int calories,
+                       final int distance,
+                       final int duration) {
+        laps.add(new Lap(number, hr, pace, calories, distance, duration));
+    }
+
     public List<StrengthSet> getStrengthSets() {
         return strengthSets;
     }
 
-    public static class StrengthSet {
-        private final int reps;
-        private final float weightKg;
+    public List<Lap> getLaps() {
+        return laps;
+    }
 
-        public StrengthSet(final int reps, final float weightKg) {
-            this.reps = reps;
-            this.weightKg = weightKg;
-        }
+    public record StrengthSet(int reps, float weightKg) {
+    }
 
-        public int getReps() {
-            return reps;
-        }
-
-        public float getWeightKg() {
-            return weightKg;
-        }
+    public record Lap(int number,
+                      int hr,
+                      int pace,
+                      int calories,
+                      int distance,
+                      int duration) {
     }
 }
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index da254ddd6f..220e76dca4 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -2586,6 +2586,7 @@
     <string name="swimStyle">Swim Style</string>
     <string name="laneLength">Lane Length</string>
     <string name="laps">Laps</string>
+    <string name="workout_lap">Lap</string>
     <string name="ascentSeconds">Ascending</string>
     <string name="descentSeconds">Descending</string>
     <string name="flatSeconds">Flat</string>
@@ -2719,6 +2720,7 @@
     <string name="Elevation">Elevation</string>
     <string name="workout_power">Power</string>
     <string name="Speed">Speed</string>
+    <string name="lap_time">Time</string>
     <string name="Activity">Activity</string>
     <string name="Steps">Steps</string>
     <string name="RunningForm">Running Form</string>
diff --git a/app/src/test/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityDetailsParserTest.java b/app/src/test/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityDetailsParserTest.java
new file mode 100644
index 0000000000..bd971bba9a
--- /dev/null
+++ b/app/src/test/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsActivityDetailsParserTest.java
@@ -0,0 +1,27 @@
+package nodomain.freeyourgadget.gadgetbridge.service.devices.huami.zeppos;
+
+import org.junit.Ignore;
+import org.junit.Test;
+
+import java.nio.file.Files;
+import java.nio.file.Paths;
+
+import nodomain.freeyourgadget.gadgetbridge.entities.BaseActivitySummary;
+import nodomain.freeyourgadget.gadgetbridge.test.TestBase;
+
+public class ZeppOsActivityDetailsParserTest extends TestBase {
+    @Test
+    @Ignore("helper test for development, remove this while debugging")
+    public void localTest() throws Exception {
+        final byte[] bytes = Files.readAllBytes(Paths.get("/storage/downloads/raw_details.bin"));
+
+        final BaseActivitySummary summary = new BaseActivitySummary();
+        summary.setRawSummaryData(bytes);
+        summary.setBaseLatitude(0);
+        summary.setBaseLongitude(0);
+        summary.setBaseAltitude(0);
+
+        final ZeppOsActivityDetailsParser parser = new ZeppOsActivityDetailsParser(summary);
+        final ZeppOsActivityTrack track = parser.parse(bytes);
+    }
+}
```
-----------------------------------
