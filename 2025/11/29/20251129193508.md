# Commit: 4973795abe792ad9746b9e64bb6ee89add431331
## Message: Allow notifications while screen saver is on (#342)
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/NotificationListener.java

app/src/main/res/values/strings.xml

app/src/main/res/xml/notifications_preferences.xml

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/NotificationListener.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/NotificationListener.java
index 2f8c32a6b1..baed07df34 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/NotificationListener.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/externalevents/NotificationListener.java
@@ -55,6 +55,7 @@ import androidx.annotation.Nullable;
 import androidx.annotation.RequiresApi;
 import androidx.core.app.NotificationCompat;
 import androidx.core.app.RemoteInput;
+import androidx.core.content.ContextCompat;
 import androidx.localbroadcastmanager.content.LocalBroadcastManager;
 
 import org.apache.commons.lang3.StringUtils;
@@ -167,8 +168,29 @@ public class NotificationListener extends NotificationListenerService {
     private Runnable mSetMusicInfoRunnable = null;
     private Runnable mSetMusicStateRunnable = null;
 
+    private boolean isDreaming = false;
+
     private final GoogleMapsNotificationHandler googleMapsNotificationHandler = new GoogleMapsNotificationHandler();
 
+    private final BroadcastReceiver mExportedReceiver = new BroadcastReceiver() {
+        @Override
+        public void onReceive(final Context context, final Intent intent) {
+            final String action = intent.getAction();
+            if (action == null) {
+                LOG.warn("Got intent without action");
+                return;
+            }
+
+            LOG.debug("Got action: {}", action);
+
+            switch (action) {
+                case Intent.ACTION_DREAMING_STARTED -> isDreaming = true;
+                case Intent.ACTION_DREAMING_STOPPED -> isDreaming = false;
+                default -> LOG.warn("Unknown action: {}", action);
+            }
+        }
+    };
+
     private final BroadcastReceiver mReceiver = new BroadcastReceiver() {
 
         @Override
@@ -294,6 +316,12 @@ public class NotificationListener extends NotificationListenerService {
         filterLocal.addAction(ACTION_REPLY);
         //noinspection deprecation
         LocalBroadcastManager.getInstance(this).registerReceiver(mReceiver, filterLocal);
+
+        final IntentFilter filter = new IntentFilter();
+        filter.addAction(Intent.ACTION_DREAMING_STARTED);
+        filter.addAction(Intent.ACTION_DREAMING_STOPPED);
+        ContextCompat.registerReceiver(this, mExportedReceiver, filter, ContextCompat.RECEIVER_EXPORTED);
+
         createNotificationPictureCacheDirectory();
         cleanUpNotificationPictureProvider();
     }
@@ -302,6 +330,7 @@ public class NotificationListener extends NotificationListenerService {
     public void onDestroy() {
         //noinspection deprecation
         LocalBroadcastManager.getInstance(this).unregisterReceiver(mReceiver);
+        unregisterReceiver(mExportedReceiver);
         notificationStack.clear();
         notificationsActive.clear();
         cleanUpNotificationPictureProvider();
@@ -1221,10 +1250,15 @@ public class NotificationListener extends NotificationListenerService {
         // has to be on (obviously)
         if (!remove) {
             if (!prefs.getBoolean("notifications_generic_whenscreenon", false)) {
-                PowerManager powermanager = (PowerManager) getSystemService(POWER_SERVICE);
+                final PowerManager powermanager = (PowerManager) getSystemService(POWER_SERVICE);
                 if (powermanager != null && powermanager.isScreenOn()) {
-                    LOG.info("Not forwarding notification, screen seems to be on and settings do not allow this");
-                    return true;
+                    if (!isDreaming) {
+                        LOG.info("Not forwarding notification, screen seems to be on and settings do not allow this");
+                        return true;
+                    } else if (!prefs.getBoolean("notifications_generic_when_screen_saver", true)) {
+                        LOG.info("Not forwarding notification, screen saver seems to be on and settings do not allow this");
+                        return true;
+                    }
                 }
             }
         }
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index fcf9955800..632205911e 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -294,6 +294,7 @@
     <string name="pref_title_notifications_generic">Generic notification support</string>
     <string name="pref_title_notifications_generic_settings">Android notification settings</string>
     <string name="pref_title_whenscreenon">…also when screen is on</string>
+    <string name="pref_title_notifications_when_screen_saver">…also when screen saver is on</string>
     <string name="pref_title_notifications_ignore_low_priority">Ignore low priority notifications</string>
     <string name="pref_summary_notifications_ignore_low_priority">Do not send low and minimum priority notifications to the watch</string>
     <string name="pref_title_notifications_ignore_work_profile">Ignore work profile notifications</string>
diff --git a/app/src/main/res/xml/notifications_preferences.xml b/app/src/main/res/xml/notifications_preferences.xml
index ebc514db06..c56c5e07c8 100644
--- a/app/src/main/res/xml/notifications_preferences.xml
+++ b/app/src/main/res/xml/notifications_preferences.xml
@@ -22,6 +22,13 @@
             android:title="@string/pref_title_whenscreenon"
             app:iconSpaceReserved="false" />
 
+        <SwitchPreferenceCompat
+            android:defaultValue="true"
+            android:key="notifications_generic_when_screen_saver"
+            android:layout="@layout/preference_checkbox"
+            android:title="@string/pref_title_notifications_when_screen_saver"
+            app:iconSpaceReserved="false" />
+
         <SwitchPreferenceCompat
             android:defaultValue="true"
             android:key="notifications_ignore_low_priority"
```
-----------------------------------
