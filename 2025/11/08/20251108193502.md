# Commit: fd2627caeee8178230f93a029208de370bd058f7
## Message: Pebble 2 Duo: Fix getting inital battery level (for the rest still rely on datalog
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/PebbleIoThread.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/ble/PebbleGATTClient.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/ble/PebbleLESupport.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/PebbleIoThread.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/PebbleIoThread.java
index 58bc5977db..0438589fa6 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/PebbleIoThread.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/PebbleIoThread.java
@@ -481,6 +481,9 @@ class PebbleIoThread extends GBDeviceIoThread {
             write(mPebbleProtocol.encodeEnableAppLogs(devicePrefs.getBoolean("pebble_enable_applogs", false)));
             write(mPebbleProtocol.encodeReportDataLogSessions());
             gbDevice.setState(GBDevice.State.INITIALIZED);
+            if (mPebbleLESupport != null) {
+                mPebbleLESupport.readBatteryCharacteristic();
+            }
             return false;
         } else if (deviceEvent instanceof GBDeviceEventAppManagement) {
             GBDeviceEventAppManagement appMgmt = (GBDeviceEventAppManagement) deviceEvent;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/ble/PebbleGATTClient.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/ble/PebbleGATTClient.java
index 835f7f64b3..ab2ee78fc1 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/ble/PebbleGATTClient.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/ble/PebbleGATTClient.java
@@ -245,12 +245,13 @@ class PebbleGATTClient extends BluetoothGattCallback {
         if (status == BluetoothGatt.GATT_SUCCESS) {
             LOG.info("MTU changed to {}", mtu);
             mPebbleLESupport.setMTU(mtu);
+        }
+    }
 
-            // read battery
-            BluetoothGattCharacteristic characteristic = gatt.getService(GattService.UUID_SERVICE_BATTERY_SERVICE).getCharacteristic(GattCharacteristic.UUID_CHARACTERISTIC_BATTERY_LEVEL);
-            if (characteristic != null) {
-                gatt.readCharacteristic(characteristic);
-            }
+    public void readBatteryCharacteristic() {
+        BluetoothGattCharacteristic characteristic = mBluetoothGatt.getService(GattService.UUID_SERVICE_BATTERY_SERVICE).getCharacteristic(GattCharacteristic.UUID_CHARACTERISTIC_BATTERY_LEVEL);
+        if (characteristic != null) {
+            mBluetoothGatt.readCharacteristic(characteristic);
         }
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/ble/PebbleLESupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/ble/PebbleLESupport.java
index 8e5ebc5340..d948ffd117 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/ble/PebbleLESupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/pebble/ble/PebbleLESupport.java
@@ -154,6 +154,10 @@ public class PebbleLESupport {
         mMTU = Math.min(mtu, mMTULimit);
     }
 
+    public void readBatteryCharacteristic() {
+        mPebbleGATTClient.readBatteryCharacteristic();
+    }
+
     public void handlePPoGATTPacket(byte[] value) {
         if (!mIsConnected) {
             mIsConnected = true;
```
-----------------------------------
