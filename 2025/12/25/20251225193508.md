# Commit: 638f9e52fd735f63902fb82bc8bd208cce86f056
## Message: Camera: Allow to switch lens
## Changed files:
app/src/main/res/drawable/ic_cameraswitch.xml

app/src/main/res/menu/menu_camera.xml

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/CameraActivity.java

app/src/main/res/values/strings.xml

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/CameraActivity.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/CameraActivity.java
index 063b5702e6..2087322823 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/CameraActivity.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/CameraActivity.java
@@ -19,12 +19,14 @@ package nodomain.freeyourgadget.gadgetbridge.activities;
 import android.Manifest;
 import android.content.ContentValues;
 import android.content.Intent;
+import android.content.SharedPreferences;
 import android.content.pm.PackageManager;
 import android.os.Bundle;
 import android.provider.MediaStore;
+import android.view.Menu;
+import android.view.MenuItem;
 import android.widget.Toast;
 
-import androidx.activity.result.ActivityResultCallback;
 import androidx.activity.result.ActivityResultLauncher;
 import androidx.activity.result.contract.ActivityResultContracts;
 import androidx.annotation.NonNull;
@@ -54,9 +56,12 @@ public class CameraActivity extends AppCompatActivity {
     private static final Logger LOG = LoggerFactory.getLogger(CameraActivity.class);
 
     public static final String intentExtraEvent = "EVENT";
+    private static final String PREF_CAMERA_LENS = "camera_lens_facing";
 
     private ListenableFuture<ProcessCameraProvider> cameraProviderListenableFuture;
     private ImageCapture imageCapture;
+    private ProcessCameraProvider cameraProvider;
+    private int currentLensFacing;
 
     private boolean reportClosing = true;
 
@@ -86,18 +91,15 @@ public class CameraActivity extends AppCompatActivity {
             LOG.info("Requesting camera permission");
 
             ActivityResultLauncher<String> requestPermissionLauncher =
-                    registerForActivityResult(new ActivityResultContracts.RequestPermission(), new ActivityResultCallback<Boolean>() {
-                        @Override
-                        public void onActivityResult(Boolean isGranted) {
-                            if (isGranted) {
-                                initCamera();
-                            } else {
-                                LOG.error("Did not receive camera permission");
-                                GB.toast(getString(R.string.toast_camera_permission_required), Toast.LENGTH_SHORT, GB.ERROR);
-                                GBApplication.deviceService().onCameraStatusChange(GBDeviceEventCameraRemote.Event.EXCEPTION, null);
-                                reportClosing = false;
-                                finish();
-                            }
+                    registerForActivityResult(new ActivityResultContracts.RequestPermission(), isGranted -> {
+                        if (isGranted) {
+                            initCamera();
+                        } else {
+                            LOG.error("Did not receive camera permission");
+                            GB.toast(getString(R.string.toast_camera_permission_required), Toast.LENGTH_SHORT, GB.ERROR);
+                            GBApplication.deviceService().onCameraStatusChange(GBDeviceEventCameraRemote.Event.EXCEPTION, null);
+                            reportClosing = false;
+                            finish();
                         }
                     });
             requestPermissionLauncher.launch(Manifest.permission.CAMERA);
@@ -108,44 +110,49 @@ public class CameraActivity extends AppCompatActivity {
     }
 
     private void initCamera() {
+        // Load saved camera preference
+        currentLensFacing = GBApplication.getPrefs().getPreferences()
+                .getInt(PREF_CAMERA_LENS, CameraSelector.LENS_FACING_BACK);
+
         cameraProviderListenableFuture = ProcessCameraProvider.getInstance(this);
-        cameraProviderListenableFuture.addListener(new Runnable() {
-            @Override
-            public void run() {
-                try {
-                    ProcessCameraProvider cameraProvider = cameraProviderListenableFuture.get();
-
-                    PreviewView previewView = findViewById(R.id.preview);
-
-                    Preview preview = new Preview.Builder().build();
-
-                    CameraSelector cameraSelector = new CameraSelector.Builder()
-                            .requireLensFacing(CameraSelector.LENS_FACING_BACK) // TODO: make setting
-                            .build();
-
-                    preview.setSurfaceProvider(previewView.getSurfaceProvider());
-
-                    imageCapture = new ImageCapture.Builder()
-                            .setTargetRotation(preview.getTargetRotation())
-                            .build();
-
-                    cameraProvider.bindToLifecycle(
-                            CameraActivity.this,
-                            cameraSelector,
-                            imageCapture,
-                            preview
-                    );
-                } catch (ExecutionException | InterruptedException e) {
-                    throw new RuntimeException(e);
-                }
+        cameraProviderListenableFuture.addListener(() -> {
+            try {
+                cameraProvider = cameraProviderListenableFuture.get();
+                bindCamera();
+            } catch (ExecutionException | InterruptedException e) {
+                throw new RuntimeException(e);
             }
         }, ContextCompat.getMainExecutor(this));
 
         handleIntent(getIntent());
     }
 
+    private void bindCamera() {
+        final PreviewView previewView = findViewById(R.id.preview);
+
+        final Preview preview = new Preview.Builder().build();
+
+        final CameraSelector cameraSelector = new CameraSelector.Builder()
+                .requireLensFacing(currentLensFacing)
+                .build();
+
+        preview.setSurfaceProvider(previewView.getSurfaceProvider());
+
+        imageCapture = new ImageCapture.Builder()
+                .setTargetRotation(preview.getTargetRotation())
+                .build();
+
+        cameraProvider.unbindAll();
+        cameraProvider.bindToLifecycle(
+                CameraActivity.this,
+                cameraSelector,
+                imageCapture,
+                preview
+        );
+    }
+
     @Override
-    protected void onNewIntent(Intent intent) {
+    protected void onNewIntent(@NonNull Intent intent) {
         super.onNewIntent(intent);
         handleIntent(intent);
     }
@@ -212,6 +219,40 @@ public class CameraActivity extends AppCompatActivity {
         }
     }
 
+    @Override
+    public boolean onCreateOptionsMenu(final Menu menu) {
+        getMenuInflater().inflate(R.menu.menu_camera, menu);
+        return true;
+    }
+
+    @Override
+    public boolean onOptionsItemSelected(@NonNull final MenuItem item) {
+        if (item.getItemId() == R.id.menu_camera_switch) {
+            switchCamera();
+            return true;
+        }
+        return super.onOptionsItemSelected(item);
+    }
+
+    private void switchCamera() {
+        // Toggle between front and back camera
+        if (currentLensFacing == CameraSelector.LENS_FACING_BACK) {
+            currentLensFacing = CameraSelector.LENS_FACING_FRONT;
+        } else {
+            currentLensFacing = CameraSelector.LENS_FACING_BACK;
+        }
+
+        // Save preference
+        GBApplication.getPrefs().getPreferences().edit()
+                .putInt(PREF_CAMERA_LENS, currentLensFacing)
+                .apply();
+
+        // Rebind camera
+        if (cameraProvider != null) {
+            bindCamera();
+        }
+    }
+
     @Override
     protected void onStop() {
         super.onStop();
diff --git a/app/src/main/res/drawable/ic_cameraswitch.xml b/app/src/main/res/drawable/ic_cameraswitch.xml
new file mode 100644
index 0000000000..4e43d14812
--- /dev/null
+++ b/app/src/main/res/drawable/ic_cameraswitch.xml
@@ -0,0 +1,10 @@
+<vector xmlns:android="http://schemas.android.com/apk/res/android"
+    android:width="24dp"
+    android:height="24dp"
+    android:tint="?attr/colorControlNormal"
+    android:viewportWidth="960"
+    android:viewportHeight="960">
+    <path
+        android:fillColor="#1f1f1f"
+        android:pathData="M320,680q-33,0 -56.5,-23.5T240,600v-240q0,-33 23.5,-56.5T320,280h40l40,-40h160l40,40h40q33,0 56.5,23.5T720,360v240q0,33 -23.5,56.5T640,680L320,680ZM320,600h320v-240L320,360v240ZM480,560q33,0 56.5,-23.5T560,480q0,-33 -23.5,-56.5T480,400q-33,0 -56.5,23.5T400,480q0,33 23.5,56.5T480,560ZM342,20q34,-11 68.5,-15.5T480,0q94,0 177.5,33.5t148,93Q870,186 911,266.5T960,440h-80q-7,-72 -38,-134.5t-79.5,-110Q714,148 651,118t-135,-36l62,62 -56,56 -180,-180ZM618,940Q584,951 549.5,955.5T480,960q-94,0 -177.5,-33.5t-148,-93Q90,774 49,693.5T0,520h80q8,72 38.5,134.5t79,110Q246,812 309,842t135,36l-62,-62 56,-56L618,940ZM480,480Z" />
+</vector>
diff --git a/app/src/main/res/menu/menu_camera.xml b/app/src/main/res/menu/menu_camera.xml
new file mode 100644
index 0000000000..f6d2bd5502
--- /dev/null
+++ b/app/src/main/res/menu/menu_camera.xml
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="utf-8"?>
+<menu xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto">
+
+    <item
+        android:id="@+id/menu_camera_switch"
+        android:icon="@drawable/ic_cameraswitch"
+        android:title="@string/camera_switch"
+        app:iconTint="?attr/actionmenu_icon_color"
+        app:showAsAction="always" />
+
+</menu>
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index 45b8fe4a4d..2d1572c5b6 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -3930,6 +3930,7 @@
 
     <!-- Camera strings -->
     <string name="open_camera">Open Camera</string>
+    <string name="camera_switch">Switch Camera</string>
     <string name="toast_camera_permission_required">Camera permission is required for this function.</string>
     <string name="toast_camera_support_required">Camera support is required for this function.</string>
     <string name="toast_camera_photo_taken">Photo has been taken and saved at: %s</string>
```
-----------------------------------
