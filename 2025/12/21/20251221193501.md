# Commit: 8a4bc18c03efbeb0df74eb261e9dafe437309112
## Message: Garmin / Zepp OS: Add experimental settings
## Changed files:
app/src/main/res/xml/devicesettings_experimental_warning.xml

app/src/main/res/xml/devicesettings_garmin_experimental.xml

app/src/main/res/xml/devicesettings_root_experimental.xml

app/src/main/res/xml/devicesettings_zeppos_experimental.xml

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsScreen.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAppsService.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAssistantService.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/GBPrefs.java

app/src/main/res/values/strings.xml

app/src/main/res/xml/preferences.xml

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsFragment.java
index 8acf163499..dead06be09 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsFragment.java
@@ -1595,12 +1595,25 @@ public class DeviceSpecificSettingsFragment extends AbstractPreferenceFragment i
                     );
                 }
             }
-            if(BuildConfig.DEBUG) {
+            if (BuildConfig.DEBUG) {
                 deviceSpecificSettings.addRootScreen(
                         DeviceSpecificSettingsScreen.DEVELOPER,
                         R.xml.devicesettings_stress_test
                 );
             }
+            if (GBApplication.getPrefs().experimentalSettings()) {
+                final int[] experimentalSettings = coordinator.getSupportedDeviceSpecificExperimentalSettings(device);
+                if (experimentalSettings != null && experimentalSettings.length > 0) {
+                    deviceSpecificSettings.addRootScreen(
+                            DeviceSpecificSettingsScreen.EXPERIMENTAL,
+                            R.xml.devicesettings_experimental_warning
+                    );
+                    deviceSpecificSettings.addRootScreen(
+                            DeviceSpecificSettingsScreen.EXPERIMENTAL,
+                            experimentalSettings
+                    );
+                }
+            }
         }
 
         final DeviceSpecificSettingsCustomizer deviceSpecificSettingsCustomizer = coordinator.getDeviceSpecificSettingsCustomizer(device);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsScreen.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsScreen.java
index d3d24df346..2916b6d5d4 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsScreen.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsScreen.java
@@ -40,6 +40,7 @@ public enum DeviceSpecificSettingsScreen {
     HEALTH("pref_screen_health", R.xml.devicesettings_root_health),
     TOUCH_OPTIONS("pref_screen_touch_options", R.xml.devicesettings_root_touch_options),
     SOUND("pref_screen_sound", R.xml.devicesettings_root_sound),
+    EXPERIMENTAL("pref_screen_experimental", R.xml.devicesettings_root_experimental),
     ;
 
     private final String key;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java
index 32ee895170..7f6590b819 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java
@@ -957,6 +957,15 @@ public abstract class AbstractDeviceCoordinator implements DeviceCoordinator {
         return new int[0];
     }
 
+    @Override
+    public int[] getSupportedDeviceSpecificExperimentalSettings(final GBDevice device) {
+        return new int[0];
+    }
+
+    public boolean experimentalSettingEnabled(final GBDevice device, final String key) {
+        return GBApplication.getPrefs().experimentalSettings() && GBApplication.getDevicePrefs(device).getBoolean(key, false);
+    }
+
     @Nullable
     @Override
     public DeviceSpecificSettingsCustomizer getDeviceSpecificSettingsCustomizer(GBDevice device) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java
index 7fc5753fae..14807a2d5a 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java
@@ -804,6 +804,12 @@ public interface DeviceCoordinator {
      */
     int[] getSupportedDeviceSpecificAuthenticationSettings();
 
+    /**
+     * Returns device specific experimental settings. This screen is only shown when the global experimental settings
+     * is enabled.
+     */
+    int[] getSupportedDeviceSpecificExperimentalSettings(final GBDevice device);
+
     /**
      * Indicates which device specific settings the device supports (not per device type or family, but unique per device).
      *
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminCoordinator.java
index 8281e8190f..ba002625c5 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminCoordinator.java
@@ -223,6 +223,11 @@ public abstract class GarminCoordinator extends AbstractBLEDeviceCoordinator {
         return new int[]{R.xml.devicesettings_garmin_fake_oauth};
     }
 
+    @Override
+    public int[] getSupportedDeviceSpecificExperimentalSettings(final GBDevice device) {
+        return new int[]{R.xml.devicesettings_garmin_experimental};
+    }
+
     @Override
     public DeviceSpecificSettings getDeviceSpecificSettings(final GBDevice device) {
         final DeviceSpecificSettings deviceSpecificSettings = new DeviceSpecificSettings();
@@ -307,9 +312,8 @@ public abstract class GarminCoordinator extends AbstractBLEDeviceCoordinator {
 
     @Override
     public boolean supportsAppsManagement(@NonNull final GBDevice device) {
-        // FIXME: disabled until better polished
-        //return supports(device, GarminCapability.CONNECTIQ_APP_MANAGEMENT);
-        return false;
+        // FIXME: experimental until better polished
+        return experimentalSettingEnabled(device, "garmin_experimental_app_management");
     }
 
     @Override
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsCoordinator.java
index 37376dd944..ef16212e61 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huami/zeppos/ZeppOsCoordinator.java
@@ -278,7 +278,7 @@ public abstract class ZeppOsCoordinator extends HuamiCoordinator {
 
     @Override
     public boolean supportsAppsManagement(@NonNull final GBDevice device) {
-        return experimentalFeatures(device);
+        return experimentalSettingEnabled(device, "zepp_os_experimental_app_management");
     }
 
     @Override
@@ -388,6 +388,11 @@ public abstract class ZeppOsCoordinator extends HuamiCoordinator {
         );
     }
 
+    @Override
+    public int[] getSupportedDeviceSpecificExperimentalSettings(final GBDevice device) {
+        return new int[]{R.xml.devicesettings_zeppos_experimental};
+    }
+
     /**
      * Returns a superset of all settings supported by Zepp OS Devices. Unsupported settings are removed
      * by {@link ZeppOsSettingsCustomizer}.
@@ -659,7 +664,7 @@ public abstract class ZeppOsCoordinator extends HuamiCoordinator {
     }
 
     public boolean supportsAssistant(final GBDevice device) {
-        return experimentalFeatures(device) && ZeppOsAssistantService.isSupported(getPrefs(device));
+        return experimentalSettingEnabled(device, "zepp_os_experimental_assistant") && ZeppOsAssistantService.isSupported(getPrefs(device));
     }
 
     public boolean supportsMaps(final GBDevice device) {
@@ -687,10 +692,6 @@ public abstract class ZeppOsCoordinator extends HuamiCoordinator {
                 .contains(service);
     }
 
-    public static boolean experimentalFeatures(final GBDevice device) {
-        return getPrefs(device).getBoolean("zepp_os_experimental_features", false);
-    }
-
     @Override
     public boolean validateAuthKey(final String authKey) {
         final byte[] authKeyBytes = authKey.trim().getBytes();
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
index bd2418913c..8d20a400ce 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
@@ -103,8 +103,6 @@ import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.FitWeather;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.ConfigurationMessage;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.DownloadRequestMessage;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.FitDataMessage;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.FitDefinitionMessage;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.GFDIMessage;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.MusicControlEntityUpdateMessage;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.ProtobufMessage;
@@ -516,11 +514,18 @@ public class GarminSupport extends AbstractBTLESingleDeviceSupport implements IC
 
     @Override
     public void onAppStart(final UUID uuid, final boolean start) {
-
+        if (!getCoordinator().experimentalSettingEnabled(getDevice(), "garmin_experimental_app_management")) {
+            LOG.warn("Experimental app management not enabled");
+        }
     }
 
     @Override
     public void onAppDelete(final UUID uuid) {
+        if (!getCoordinator().experimentalSettingEnabled(getDevice(), "garmin_experimental_app_management")) {
+            LOG.warn("Experimental app management not enabled");
+            return;
+        }
+
         final GdiInstalledAppsService.InstalledAppsService.InstalledApp app = installedApps.get(uuid);
 
         if (app == null) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAppsService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAppsService.java
index 597aeef767..e7b2bb08d8 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAppsService.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAppsService.java
@@ -201,6 +201,11 @@ public class ZeppOsAppsService extends AbstractZeppOsService {
     public void deleteApp(final int appId) {
         LOG.info("Delete app {}", String.format("0x%08x", appId));
 
+        if (!getCoordinator().experimentalSettingEnabled(getSupport().getDevice(), "zepp_os_experimental_app_management")) {
+            LOG.warn("Experimental app management not enabled");
+            return;
+        }
+
         final ByteBuffer buf = ByteBuffer.allocate(20).order(ByteOrder.LITTLE_ENDIAN);
 
         buf.put(CMD_APPS);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAssistantService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAssistantService.java
index 66bd8f10e6..d4dc5aa94e 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAssistantService.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsAssistantService.java
@@ -206,7 +206,7 @@ public class ZeppOsAssistantService extends AbstractZeppOsService {
         }
         voiceBuffer.clear();
 
-        if (ZeppOsCoordinator.experimentalFeatures(getSupport().getDevice())) {
+        if (getCoordinator().experimentalSettingEnabled(getSupport().getDevice(), "zepp_os_experimental_assistant")) {
             requestCapabilities(builder);
         }
     }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/GBPrefs.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/GBPrefs.java
index 78abade6e4..1b9b711ebd 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/GBPrefs.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/GBPrefs.java
@@ -187,4 +187,8 @@ public class GBPrefs extends Prefs {
     public boolean refreshOnSwipe() {
         return getBoolean("pref_refresh_on_swipe", true);
     }
+
+    public boolean experimentalSettings() {
+        return getBoolean("experimental_settings", false);
+    }
 }
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index a2a6ab30e9..8584d59b94 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -739,6 +739,8 @@
     <string name="title_activity_sleepmonitor">Sleep monitor</string>
     <string name="pref_write_logfiles">Write log files</string>
     <string name="pref_cache_weather">Cache weather information</string>
+    <string name="pref_experimental_settings_title">Experimental settings</string>
+    <string name="pref_experimental_settings_summary">Experimental settings might be unstable or not work as expected. Proceed at your own risk.</string>
     <string name="pref_cache_weather_summary">Weather information will be cached across application restarts.</string>
     <string name="pref_write_logfiles_not_available">File logging initialization failed, writing log files is currently not available. Restart the application to attempt to initialize the log files again.</string>
     <string name="initializing">Initializing</string>
diff --git a/app/src/main/res/xml/devicesettings_experimental_warning.xml b/app/src/main/res/xml/devicesettings_experimental_warning.xml
new file mode 100644
index 0000000000..c0d1f5d12d
--- /dev/null
+++ b/app/src/main/res/xml/devicesettings_experimental_warning.xml
@@ -0,0 +1,7 @@
+<?xml version="1.0" encoding="utf-8"?>
+<androidx.preference.PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android">
+    <Preference
+        android:icon="@drawable/ic_warning"
+        android:key="pref_experimental_warning"
+        android:summary="@string/pref_experimental_settings_summary" />
+</androidx.preference.PreferenceScreen>
diff --git a/app/src/main/res/xml/devicesettings_garmin_experimental.xml b/app/src/main/res/xml/devicesettings_garmin_experimental.xml
new file mode 100644
index 0000000000..b50715ce5d
--- /dev/null
+++ b/app/src/main/res/xml/devicesettings_garmin_experimental.xml
@@ -0,0 +1,10 @@
+<?xml version="1.0" encoding="utf-8"?>
+<androidx.preference.PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android">
+    <SwitchPreferenceCompat
+        android:defaultValue="false"
+        android:icon="@drawable/ic_settings_applications"
+        android:key="garmin_experimental_app_management"
+        android:layout="@layout/preference_checkbox"
+        android:summary="Allow installed app management from Gadgetbridge. Not heavily tested. Uninstalling system apps might be dangerous."
+        android:title="App management" />
+</androidx.preference.PreferenceScreen>
diff --git a/app/src/main/res/xml/devicesettings_root_experimental.xml b/app/src/main/res/xml/devicesettings_root_experimental.xml
new file mode 100644
index 0000000000..72462ba00e
--- /dev/null
+++ b/app/src/main/res/xml/devicesettings_root_experimental.xml
@@ -0,0 +1,9 @@
+<?xml version="1.0" encoding="utf-8"?>
+<androidx.preference.PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android">
+    <PreferenceScreen
+        android:icon="@drawable/ic_warning_gray"
+        android:key="pref_screen_experimental"
+        android:persistent="false"
+        android:title="@string/pref_experimental_settings_title">
+    </PreferenceScreen>
+</androidx.preference.PreferenceScreen>
diff --git a/app/src/main/res/xml/devicesettings_zeppos_experimental.xml b/app/src/main/res/xml/devicesettings_zeppos_experimental.xml
new file mode 100644
index 0000000000..477984d787
--- /dev/null
+++ b/app/src/main/res/xml/devicesettings_zeppos_experimental.xml
@@ -0,0 +1,18 @@
+<?xml version="1.0" encoding="utf-8"?>
+<androidx.preference.PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android">
+    <SwitchPreferenceCompat
+        android:defaultValue="false"
+        android:icon="@drawable/ic_settings_applications"
+        android:key="zepp_os_experimental_app_management"
+        android:layout="@layout/preference_checkbox"
+        android:summary="Allow installed app management from Gadgetbridge. Not heavily tested. Uninstalling system apps might be dangerous."
+        android:title="App management" />
+
+    <SwitchPreferenceCompat
+        android:defaultValue="false"
+        android:icon="@drawable/ic_voice"
+        android:key="zepp_os_experimental_assistant"
+        android:layout="@layout/preference_checkbox"
+        android:summary="Enable Alexa / Zepp Flow manual debug options and voice receiving. Not yet functional."
+        android:title="Assistant service" />
+</androidx.preference.PreferenceScreen>
diff --git a/app/src/main/res/xml/preferences.xml b/app/src/main/res/xml/preferences.xml
index 401ae0683a..b817949ee6 100644
--- a/app/src/main/res/xml/preferences.xml
+++ b/app/src/main/res/xml/preferences.xml
@@ -463,6 +463,14 @@
                     app:iconSpaceReserved="false" />
             </PreferenceCategory>
         </PreferenceScreen>
+
+        <SwitchPreferenceCompat
+            android:defaultValue="false"
+            android:key="experimental_settings"
+            android:layout="@layout/preference_checkbox"
+            android:summary="@string/pref_experimental_settings_summary"
+            android:title="@string/pref_experimental_settings_title"
+            app:iconSpaceReserved="false" />
     </PreferenceScreen>
 
     <PreferenceScreen
```
-----------------------------------
