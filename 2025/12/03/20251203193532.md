# Commit: 24ec10d525901875fdfb14a1685a24aba21da14d
## Message: Huawei: Notifications picture support.
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSettingsPreferenceConst.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/Notifications.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/SendNotificationRequest.java

app/src/main/res/values/strings.xml

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/datasync/HuaweiDataSyncNotificationPictures.java

app/src/main/res/xml/devicesettings_notifications_pictures.xml

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSettingsPreferenceConst.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSettingsPreferenceConst.java
index 9a19cec7f4..83323f9f87 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSettingsPreferenceConst.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSettingsPreferenceConst.java
@@ -105,6 +105,8 @@ public class DeviceSettingsPreferenceConst {
     public static final String PREF_LOWER_BUTTON_SHORT_PRESS = "pref_button_action_lower_short";
     public static final String PREF_VIBRATION_STRENGH_PERCENTAGE = "vibration_strength";
     public static final String PREF_RELAX_FIRMWARE_CHECKS = "relax_firmware_checks";
+    public static final String PREF_NOTIFICATION_PICTURES_ENABLE = "notification_pictures_enable";
+
 
     public static final String PREF_DEVICE_GPS_UPDATE = "banglejs_gps_update";
     public static final String PREF_DEVICE_GPS_UPDATE_INTERVAL = "banglejs_gps_update_interval";
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiCoordinator.java
index 2403489484..827357538c 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiCoordinator.java
@@ -352,6 +352,9 @@ public class HuaweiCoordinator {
         if (supportsNotificationsRepeatedNotify() || supportsNotificationsRemoveSingle()){
             notifications.add(R.xml.devicesettings_autoremove_notifications);
         }
+        if( supportsP2PService() && supportsNotificationPicture()) {
+            notifications.add(R.xml.devicesettings_notifications_pictures);
+        }
         if (getCannedRepliesSlotCount(device) > 0) {
             notifications.add(R.xml.devicesettings_canned_reply_16);
         }
@@ -842,6 +845,12 @@ public class HuaweiCoordinator {
         return false;
     }
 
+    public boolean supportsNotificationPicture() {
+        if (supportsExpandCapability())
+            return supportsExpandCapability(256);
+        return false;
+    }
+
     public boolean supportsVoipType1() {
         if (supportsExpandCapability())
             return supportsExpandCapability(249);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/Notifications.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/Notifications.java
index 1e44393e29..78290c03b8 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/Notifications.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/packets/Notifications.java
@@ -66,6 +66,7 @@ public class Notifications {
             public String category = "";
             public int voipType = 0;
             public long when = 0;
+            public String pictureName = "";
         }
 
         // TODO: support other types of notifications
@@ -153,6 +154,10 @@ public class Notifications {
                 if(addParams.when != 0) {
                     this.tlv.put(0x32, addParams.when);
                 }
+
+                if(!TextUtils.isEmpty(addParams.pictureName)) {
+                    this.tlv.put(0x34, addParams.pictureName);
+                }
             }
 
             this.complete = true;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
index e616d8a04e..4ac7cb8e8f 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiSupportProvider.java
@@ -145,6 +145,7 @@ import nodomain.freeyourgadget.gadgetbridge.model.RecordedDataTypes;
 import nodomain.freeyourgadget.gadgetbridge.model.TemperatureSample;
 import nodomain.freeyourgadget.gadgetbridge.model.WeatherSpec;
 
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.datasync.HuaweiDataSyncNotificationPictures;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.datasync.HuaweiDataSyncArrhythmia;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.datasync.HuaweiDataSyncEcg;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.datasync.HuaweiDataSyncFeatureManager;
@@ -315,6 +316,8 @@ public class HuaweiSupportProvider {
 
     private HuaweiDataSyncFeatureManager huaweiDataSyncFeatureManager = null;
 
+    private HuaweiDataSyncNotificationPictures huaweiDataSyncNotificationPictures = null;
+
     private HuaweiDataSyncGoals huaweiDataSyncTreeCircleGoals = null;
 
     private HuaweiDataSyncFindDevice huaweiDataSyncFindDevice = null;
@@ -377,6 +380,10 @@ public class HuaweiSupportProvider {
         return huaweiOTAManager;
     }
 
+    public HuaweiDataSyncNotificationPictures getHuaweiDataSyncNotificationPictures() {
+        return huaweiDataSyncNotificationPictures;
+    }
+
     public HuaweiSupportProvider(HuaweiBRSupport support) {
         this.brSupport = support;
     }
@@ -878,6 +885,10 @@ public class HuaweiSupportProvider {
                 huaweiDataSyncFeatureManager = new HuaweiDataSyncFeatureManager(HuaweiSupportProvider.this);
             }
 
+            if (getHuaweiCoordinator().supportsNotificationPicture()) {
+                huaweiDataSyncNotificationPictures = new HuaweiDataSyncNotificationPictures(HuaweiSupportProvider.this);
+            }
+
             if (getHuaweiCoordinator().supportsThreeCircle() || getHuaweiCoordinator().supportsThreeCircleLite()) {
                 huaweiDataSyncTreeCircleGoals = new HuaweiDataSyncGoals(HuaweiSupportProvider.this);
             }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/datasync/HuaweiDataSyncNotificationPictures.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/datasync/HuaweiDataSyncNotificationPictures.java
new file mode 100644
index 0000000000..79b4971610
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/datasync/HuaweiDataSyncNotificationPictures.java
@@ -0,0 +1,262 @@
+package nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.datasync;
+
+import android.content.SharedPreferences;
+import android.graphics.Bitmap;
+import android.graphics.BitmapFactory;
+import android.graphics.Color;
+import android.text.TextUtils;
+
+import org.json.JSONException;
+import org.json.JSONObject;
+import org.slf4j.Logger;
+import org.slf4j.LoggerFactory;
+
+import java.io.IOException;
+import java.nio.ByteBuffer;
+import java.nio.ByteOrder;
+import java.util.Arrays;
+
+
+import nodomain.freeyourgadget.gadgetbridge.GBApplication;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.HuaweiSupportProvider;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.HuaweiUploadManager;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.requests.SendFileUploadInfo;
+import nodomain.freeyourgadget.gadgetbridge.util.GB;
+import nodomain.freeyourgadget.gadgetbridge.util.LimitedQueue;
+
+public class HuaweiDataSyncNotificationPictures implements HuaweiDataSyncCommon.DataCallback {
+    private final Logger LOG = LoggerFactory.getLogger(HuaweiDataSyncNotificationPictures.class);
+
+    private final HuaweiSupportProvider support;
+
+    public static final String SRC_PKG_NAME = "hw.unitedevice.notify.picture";
+    public static final String PKG_NAME = "hw.watch.notify.picture";
+
+    private int picWidth = 0;
+    private int picNum = 0;
+
+    private final LimitedQueue<String, String> pictures = new LimitedQueue<>(16);
+
+    private String getFileName() {
+        //NOTE: persist current index between reconnections and restarts. Watch behaviour.
+        int currNum = GBApplication
+                .getDeviceSpecificSharedPrefs(support.getDevice().getAddress())
+                .getInt("HUAWEI_NOTIFICATION_CURRENT_NOTIFICATION_INDEX", 0);
+        int next = currNum + 1;
+        currNum = (next < Math.max(picNum, 30))?next:0;
+        SharedPreferences deviceSharedPrefs = GBApplication.getDeviceSpecificSharedPrefs(support.getDevice().getAddress());
+        SharedPreferences.Editor deviceSharedPrefsEdit = deviceSharedPrefs.edit();
+        deviceSharedPrefsEdit.putInt("HUAWEI_NOTIFICATION_CURRENT_NOTIFICATION_INDEX", currNum);
+        deviceSharedPrefsEdit.apply();
+        LOG.info("getFileName picNum: {} currNum: {} ", picNum, currNum);
+        return "pic" + currNum + ".bin";
+    }
+
+    public String getNameForPath(String path) {
+        String filename = getFileName();
+        pictures.add(filename, path);
+        return filename;
+    }
+
+    public HuaweiDataSyncNotificationPictures(HuaweiSupportProvider support) {
+        LOG.info("HuaweiDataNotificationPictures");
+        this.support = support;
+        this.support.getHuaweiDataSyncManager().registerCallback(PKG_NAME, this);
+    }
+
+
+    private void sendFeaturesFile(String filename) {
+        LOG.info("HuaweiDataNotificationPictures Send data");
+
+        final String picturePath = pictures.lookup(filename);
+        final byte[] data = prepareImageToSend(picturePath);
+
+        HuaweiUploadManager.FileUploadInfo fileInfo = new HuaweiUploadManager.FileUploadInfo();
+
+        fileInfo.setFileType((byte) 0x07);
+        fileInfo.setFileName(filename);
+        fileInfo.setBytes(data);
+
+        fileInfo.setSrcPackage(SRC_PKG_NAME);
+        fileInfo.setDstPackage(PKG_NAME);
+        fileInfo.setSrcFingerprint("UniteDeviceManagement");
+        fileInfo.setDstFingerprint("SystemApp");
+
+        fileInfo.setFileUploadCallback(new HuaweiUploadManager.FileUploadCallback() {
+            @Override
+            public void onUploadStart() {
+            }
+
+            @Override
+            public void onUploadProgress(int progress) {
+            }
+
+            @Override
+            public void onUploadComplete() {
+                if (support.getDevice().isBusy()) {
+                    support.getDevice().unsetBusyTask();
+                    support.getDevice().sendDeviceUpdateIntent(support.getContext());
+                }
+            }
+
+            @Override
+            public void onError(int code) {
+                if (support.getDevice().isBusy()) {
+                    support.getDevice().unsetBusyTask();
+                    support.getDevice().sendDeviceUpdateIntent(support.getContext());
+                }
+            }
+        });
+
+        HuaweiUploadManager huaweiUploadManager = support.getUploadManager();
+        huaweiUploadManager.setFileUploadInfo(fileInfo);
+
+        try {
+            SendFileUploadInfo sendFileUploadInfo = new SendFileUploadInfo(support, huaweiUploadManager);
+            sendFileUploadInfo.doPerform();
+        } catch (IOException e) {
+            LOG.error("Failed to send file upload info", e);
+        }
+    }
+
+    public Bitmap scaleBitmapToSize(Bitmap bitmap) {
+        int maxSize = picWidth;
+        int width = bitmap.getWidth();
+        int height = bitmap.getHeight();
+        if (maxSize <= 0 || (width <= maxSize && height <= maxSize)) {
+            return bitmap;
+        }
+        if (width > height) {
+            float scaleFactor = (float) maxSize / width;
+            return Bitmap.createScaledBitmap(bitmap, maxSize, (int) (height * scaleFactor), true);
+        } else {
+            float scaleFactor = (float) maxSize / height;
+            return Bitmap.createScaledBitmap(bitmap, (int) (width * scaleFactor), maxSize, true);
+        }
+    }
+
+    private int alphaToColor(int i) {
+        int alpha = Color.alpha(i);
+        if (alpha == 255) {
+            return i;
+        }
+        return ((Color.blue(i) * alpha) / 255) | (((Color.red(i) * alpha) / 255) << 16) | (((Color.green(i) * alpha) / 255) << 8) | 0xFF000000;
+    }
+
+    private void put24BitLE(ByteBuffer data, int i) {
+        data.put((byte) (i & 0xFF));
+        data.put((byte) ((i >> 8) & 0xFF));
+        data.put((byte) ((i >> 16) & 0xFF));
+    }
+
+    private void putColorData(ByteBuffer data, int[] imageData, int count, int idx) {
+        if (count < 4) {
+            for (int i = 0; i < count; i++) {
+                put24BitLE(data, alphaToColor(imageData[idx]));
+            }
+        } else {
+            put24BitLE(data, 0x456789);
+            put24BitLE(data, alphaToColor(imageData[idx]));
+            put24BitLE(data, count);
+        }
+    }
+
+    public byte[] convertImageData(Bitmap bmp) {
+        if (bmp == null) {
+            LOG.error("HuaweiDataNotificationPictures convertImageData bmp is null");
+            return null;
+        }
+
+        int width = bmp.getWidth();
+        int height = bmp.getHeight();
+
+        int imageSize = Math.multiplyExact(width, height);
+
+        ByteBuffer data = ByteBuffer.allocate(imageSize * 3 + 8);
+        data.order(ByteOrder.LITTLE_ENDIAN);
+        data.putShort((short) 0x2345);
+        data.putShort((short) 0x0888);
+        data.putShort((short) width);
+        data.putShort((short) height);
+
+        int[] imageData = new int[imageSize];
+        bmp.getPixels(imageData, 0, width, 0, 0, width, height);
+
+        int i = 1;
+        for (int j = 0; j < imageData.length; j++) {
+            if (j == imageData.length - 1 || alphaToColor(imageData[j]) != alphaToColor(imageData[j + 1])) {
+                putColorData(data, imageData, i, j);
+                i = 1;
+            } else {
+                i++;
+            }
+        }
+        return Arrays.copyOfRange(data.array(), 0, data.position());
+    }
+
+    public byte[] prepareImageToSend(String picturePath) {
+        try {
+            final Bitmap bitmap = BitmapFactory.decodeFile(picturePath);
+            final Bitmap bmp = scaleBitmapToSize(bitmap);
+            return convertImageData(bmp);
+        } catch (Exception e) {
+            LOG.info("prepareImageToSend Exception: ", e);
+        }
+        return null;
+    }
+
+
+    private void handlePicRequest(String filename) {
+        sendFeaturesFile(filename);
+    }
+
+    private void handlePicInfo(int picWidth, int picNum) {
+        this.picWidth = picWidth;
+        this.picNum = picNum;
+    }
+
+    private void handlePicResult(String filename, String result) {
+        LOG.info("HuaweiDataNotificationPictures handlePicResult: {} result: {}", filename, result);
+        if (TextUtils.isEmpty(filename) || !"success".equals(result)) {
+            LOG.info("HuaweiDataNotificationPictures handlePicResult is not success");
+            return;
+        }
+        pictures.remove(filename);
+    }
+
+    @Override
+    public void onConfigCommand(HuaweiDataSyncCommon.ConfigCommandData data) {
+    }
+
+    @Override
+    public void onEventCommand(HuaweiDataSyncCommon.EventCommandData data) {
+        LOG.info("HuaweiDataNotificationPictures config code: {} EventId: {}, EventLevel: {}, Data: {}", data.getCode(), data.getEventId(), data.getEventLevel(), GB.hexdump(data.getData()));
+        if (data.getEventId() != 800100023) {
+            return;
+        }
+
+        try {
+            JSONObject json = new JSONObject(new String(data.getData()));
+            if (!json.has("type")) {
+                LOG.error("no type");
+                return;
+            }
+            switch (json.getString("type")) {
+                case "picInfo" -> handlePicInfo(json.getInt("picWidth"), json.getInt("picNum"));
+                case "picRequest" -> handlePicRequest(json.getString("fileName"));
+                case "picResult" -> handlePicResult(json.getString("fileName"), json.getString("result"));
+            }
+        } catch (JSONException e) {
+            LOG.error("HuaweiDataNotificationPictures Exception: ", e);
+        }
+    }
+
+    @Override
+    public void onDataCommand(HuaweiDataSyncCommon.DataCommandData data) {
+    }
+
+    @Override
+    public void onDictDataCommand(HuaweiDataSyncCommon.DictDataCommandData data) {
+
+    }
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/SendNotificationRequest.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/SendNotificationRequest.java
index 8549b51b03..e3d6f1de9c 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/SendNotificationRequest.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/SendNotificationRequest.java
@@ -19,6 +19,8 @@ package nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.requests;
 import static nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.HuaweiNotificationsManager.getCallSpecKey;
 import static nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.HuaweiNotificationsManager.getNotificationKey;
 
+import android.text.TextUtils;
+
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -26,6 +28,8 @@ import java.util.ArrayList;
 import java.util.List;
 import java.util.Random;
 
+import nodomain.freeyourgadget.gadgetbridge.GBApplication;
+import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsPreferenceConst;
 import nodomain.freeyourgadget.gadgetbridge.devices.huawei.HuaweiPacket;
 import nodomain.freeyourgadget.gadgetbridge.devices.huawei.packets.Notifications;
 import nodomain.freeyourgadget.gadgetbridge.model.CallSpec;
@@ -45,16 +49,12 @@ public class SendNotificationRequest extends Request {
     }
 
     public static byte getNotificationType(NotificationType type) {
-        switch (type.getGenericType()) {
-            case "generic":
-            case "generic_social":
-            case "generic_chat":
-                return Notifications.NotificationType.generic;
-            case "generic_email":
-                return Notifications.NotificationType.email;
-            default:
-                return Notifications.NotificationType.sms;
-        }
+        return switch (type.getGenericType()) {
+            case "generic", "generic_social", "generic_chat" ->
+                    Notifications.NotificationType.generic;
+            case "generic_email" -> Notifications.NotificationType.email;
+            default -> Notifications.NotificationType.sms;
+        };
     }
     
     public void buildNotificationTLVFromNotificationSpec(NotificationSpec notificationSpec) {
@@ -99,6 +99,13 @@ public class SendNotificationRequest extends Request {
         params.address = notificationSpec.phoneNumber;
         params.when = notificationSpec.when;
 
+        boolean pictureEnabled = GBApplication
+                .getDeviceSpecificSharedPrefs(supportProvider.getDevice().getAddress())
+                .getBoolean(DeviceSettingsPreferenceConst.PREF_NOTIFICATION_PICTURES_ENABLE, true);
+        if(supportProvider.getHuaweiCoordinator().supportsNotificationPicture() && !TextUtils.isEmpty(notificationSpec.picturePath) && pictureEnabled) {
+            params.pictureName = supportProvider.getHuaweiDataSyncNotificationPictures().getNameForPath(notificationSpec.picturePath);
+        }
+
         ArrayList<Notifications.NotificationActionRequest.TextElement> content = new ArrayList<>();
         content.add(
                 new Notifications.NotificationActionRequest.TextElement(
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index d2c2bcf929..58e0aa2cea 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -4422,4 +4422,6 @@
     <string name="movementRhythm">Rhythm</string>
     <string name="movementSpeedDecay">Speed decay</string>
     <string name="movement_evaluation">Movement Evaluation</string>
+    <string name="pref_notifications_pictures_enable">Send notification pictures</string>
+    <string name="pref_notifications_pictures_enable_summary">Send notification pictures for current device</string>
 </resources>
diff --git a/app/src/main/res/xml/devicesettings_notifications_pictures.xml b/app/src/main/res/xml/devicesettings_notifications_pictures.xml
new file mode 100644
index 0000000000..34445ed794
--- /dev/null
+++ b/app/src/main/res/xml/devicesettings_notifications_pictures.xml
@@ -0,0 +1,11 @@
+<?xml version="1.0" encoding="utf-8"?>
+<androidx.preference.PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android">
+
+    <SwitchPreferenceCompat
+        android:defaultValue="true"
+        android:icon="@drawable/ic_notifications"
+        android:key="notification_pictures_enable"
+        android:layout="@layout/preference_checkbox"
+        android:summary="@string/pref_notifications_pictures_enable_summary"
+        android:title="@string/pref_notifications_pictures_enable" />
+</androidx.preference.PreferenceScreen>
```
-----------------------------------
