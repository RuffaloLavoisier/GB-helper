# Commit: 763b03bbb1f8877f6ddeb268fd227fc9974b5c50
## Message: Huawei: P2P service related refactoring and fixes
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiP2PManager.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/p2p/HuaweiBaseP2PService.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/p2p/HuaweiP2PDirection.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/SendP2PCommand.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiCoordinator.java
index 827357538c..9b9e3fa4fe 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/huawei/HuaweiCoordinator.java
@@ -352,7 +352,7 @@ public class HuaweiCoordinator {
         if (supportsNotificationsRepeatedNotify() || supportsNotificationsRemoveSingle()){
             notifications.add(R.xml.devicesettings_autoremove_notifications);
         }
-        if( supportsP2PService() && supportsNotificationPicture()) {
+        if (supportsP2PService() && supportsNotificationPicture()) {
             notifications.add(R.xml.devicesettings_notifications_pictures);
         }
         if (getCannedRepliesSlotCount(device) > 0) {
@@ -755,6 +755,12 @@ public class HuaweiCoordinator {
         return supportsCommandForService(0x2d, 0x01);
     }
 
+    public boolean supportsP2PGetAppVersion() {
+        if (supportsExpandCapability())
+            return supportsExpandCapability(14);
+        return false;
+    }
+
     public boolean supportsExternalCalendarService() {
         if (supportsExpandCapability())
             return supportsExpandCapability(184);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiP2PManager.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiP2PManager.java
index 487842a412..17991b5e04 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiP2PManager.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/HuaweiP2PManager.java
@@ -48,10 +48,11 @@ public class HuaweiP2PManager {
 
     private final Map<String, HuaweiWakeApp> supportedWakeApp;
 
-    private Short sequence = 1;
+    private short sequence = 1;
 
-    public synchronized Short getNextSequence() {
-            return sequence++;
+    public synchronized short getNextSequence() {
+        sequence = (short) ((sequence + 1) % (Short.MAX_VALUE - 1));
+        return sequence;
     }
 
     public HuaweiP2PManager(HuaweiSupportProvider support) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/p2p/HuaweiBaseP2PService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/p2p/HuaweiBaseP2PService.java
index debda557ff..5aa1dc422a 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/p2p/HuaweiBaseP2PService.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/p2p/HuaweiBaseP2PService.java
@@ -30,7 +30,6 @@ import nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.requests.Send
 public abstract class HuaweiBaseP2PService {
     private final Logger LOG = LoggerFactory.getLogger(HuaweiBaseP2PService.class);
 
-
     public interface HuaweiP2PCallback {
         void onResponse(int code, byte[] data);
     }
@@ -67,46 +66,41 @@ public abstract class HuaweiBaseP2PService {
 
     private final Map<Short, HuaweiP2PCallback> waitPackets = new ConcurrentHashMap<>();
 
-    private Short getNextSequence() {
+    private short getNextSequence() {
         return manager.getNextSequence();
     }
 
-    public void sendCommand(byte[] sendData, HuaweiP2PCallback callback) {
+    private void sendP2PCommand(byte cmdId,
+                               String srcPackage,
+                               String dstPackage,
+                               String srcFingerprint,
+                               String dstFingerprint,
+                               byte[] sendData,
+                               HuaweiP2PCallback callback) {
         try {
             short seq = this.getNextSequence();
-            SendP2PCommand command2 = new SendP2PCommand(this.manager.getSupportProvider(), (byte) 2, seq, this.getModule(), this.getPackage(), this.getLocalFingerprint(), this.getFingerprint(), sendData, 0);
+            SendP2PCommand cmd = new SendP2PCommand(this.manager.getSupportProvider(), cmdId, seq, srcPackage, dstPackage, srcFingerprint, dstFingerprint, sendData, 0);
             if (callback != null) {
                 this.waitPackets.put(seq, callback);
             }
-            command2.doPerform();
+            cmd.doPerform();
         } catch (IOException e) {
-            LOG.error("Failed to send p2p command 2", e);
-        }
-    }
-
-    public void sendCommand4(byte[] sendData, HuaweiP2PCallback callback) {
-        try {
-            short seq = this.getNextSequence();
-            SendP2PCommand command4 = new SendP2PCommand(this.manager.getSupportProvider(), (byte) 4, seq, this.getModule(), this.getPackage(), null, null, sendData, 0);
-            if (callback != null) {
-                this.waitPackets.put(seq, callback);
-            }
-            command4.doPerform();
-        } catch (IOException e) {
-            LOG.error("Failed to send p2p command 4", e);
+            LOG.error("Failed to send p2p cmdId: {}", cmdId,  e);
         }
     }
 
     public void sendPing(HuaweiP2PCallback callback) {
-        try {
-            short seq = this.getNextSequence();
-            SendP2PCommand commandPing = new SendP2PCommand(this.manager.getSupportProvider(), (byte) 1, seq, this.getPingPackage(), this.getPackage(), null, null, null, 0);
-            if (callback != null) {
-                this.waitPackets.put(seq, callback);
-            }
-            commandPing.doPerform();
-        } catch (IOException e) {
-            LOG.error("Failed to send ping", e);
+        sendP2PCommand((byte) 1, this.getPingPackage(), this.getPackage(), null, null, null, callback);
+    }
+
+    public void sendCommand(byte[] sendData, HuaweiP2PCallback callback) {
+        sendP2PCommand((byte) 2, this.getModule(), this.getPackage(), this.getLocalFingerprint(), this.getFingerprint(), sendData, callback);
+    }
+    public void sendGetVersion(HuaweiP2PCallback callback) {
+        if(manager.getSupportProvider().getHuaweiCoordinator().supportsP2PGetAppVersion()) {
+            sendP2PCommand((byte) 4, this.getModule(), this.getPackage(), null, null, null, callback);
+        } else {
+            LOG.error("P2P Get App Version is not supported");
         }
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/p2p/HuaweiP2PDirection.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/p2p/HuaweiP2PDirection.java
index 4e9daf5944..7c2650a101 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/p2p/HuaweiP2PDirection.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/p2p/HuaweiP2PDirection.java
@@ -24,6 +24,24 @@ public class HuaweiP2PDirection extends HuaweiBaseP2PService {
 
     public static final String MODULE = "com.huawei.maps.app";
 
+    // NOTE: Gadgetbridge and OsmAnd AIDL API does not return events for navigation starts and ends
+    // There are a little workarounds to keep it working with huawei watch
+    // Also the watch wait actions at least every 5 second(according to my tests), but I send it each 3 seconds,
+
+    Handler handler = new Handler(Looper.getMainLooper());
+    private final Runnable updateCallback = this::sendNavigationInfo;
+
+    private final AtomicBoolean isInProgress = new AtomicBoolean(false);
+    private final AtomicBoolean isStarted = new AtomicBoolean(false);
+
+    private final AtomicReference<String> lastInstruction = new AtomicReference<>();
+
+    public final int SEND_DELAY = 3000;
+    public final int SEND_COUNT_BEFORE_END = 10;
+
+    private final AtomicInteger currCount = new AtomicInteger(0);
+
+
     public HuaweiP2PDirection(HuaweiP2PManager manager) {
         super(manager);
         LOG.info("HuaweiP2PDirection");
@@ -66,6 +84,8 @@ public class HuaweiP2PDirection extends HuaweiBaseP2PService {
 
     @Override
     public void unregister() {
+        handler.removeCallbacks(updateCallback);
+        clearNavigationState();
         isRegistered.set(false);
     }
 
@@ -94,7 +114,12 @@ public class HuaweiP2PDirection extends HuaweiBaseP2PService {
     }
 
     private void checkAvailability() {
-        sendCommand4( null, (version, data) -> manager.getSupportProvider().getCoordinator().getHuaweiCoordinator().setNavigationAvailability(version != -1));
+        // NOTE: Get version command may not be supported by some old devices.
+        // app availability can be checked by querying app list from the watch (service 0x2a).
+        sendGetVersion((version, data) -> {
+            LOG.info("HuaweiP2PDirection App version: {}", version);
+            manager.getSupportProvider().getCoordinator().getHuaweiCoordinator().setNavigationAvailability(version != -1);
+        });
     }
 
     public void startNavigation() {
@@ -104,21 +129,13 @@ public class HuaweiP2PDirection extends HuaweiBaseP2PService {
                 isInProgress.set(false);
                 return;
             }
-            sendCommand4(null, (version, data1) -> { // getVersion code - version
-                LOG.error("App version: {}", version);
-                if (version == -1) {
-                    LOG.error("Invalid app version");
+            sendCommand("start navigation".getBytes(), (code3, data3) -> {
+                if (code3 != 0xcf) {
+                    LOG.error("Error start navigation");
                     isInProgress.set(false);
                     return;
                 }
-                sendCommand("start navigation".getBytes(), (code3, data3) -> {
-                    if (code3 != 0xcf) {
-                        LOG.error("Error start navigation");
-                        isInProgress.set(false);
-                        return;
-                    }
-                    isStarted.set(true);
-                });
+                isStarted.set(true);
             });
         });
     }
@@ -139,37 +156,30 @@ public class HuaweiP2PDirection extends HuaweiBaseP2PService {
         });
     }
 
-    // NOTE: Gadgetbridge and OSMAnd AIDL API does not return events for navigation starts and ends
-    // There are a little workarounds to keep it working with huawei watch
-    // Also the watch wait actions at least every 5 second(according to my tests), but I send it each 3 seconds,
-
-    Handler handler = new Handler(Looper.getMainLooper());
-    private final Runnable updateCallback = this::sendNavigationInfo;
-
-    private final AtomicBoolean isInProgress = new AtomicBoolean(false);
-    private final AtomicBoolean isStarted = new AtomicBoolean(false);
-
-    private final AtomicReference<String> lastInstruction = new AtomicReference<>();
-
-    public final int SEND_DELAY = 3000;
-    public final int SEND_COUNT_BEFORE_END = 10;
-
-    private final AtomicInteger currCount = new AtomicInteger(0);
+    private void clearNavigationState() {
+        currCount.set(0);
+        isInProgress.set(false);
+        isStarted.set(false);
+        lastInstruction.set(null);
+    }
 
     private void sendNavigationInfo() {
+        if(!isInProgress.get()) {
+            return;
+        }
         if (currCount.incrementAndGet() < SEND_COUNT_BEFORE_END) {
             handler.postDelayed(updateCallback, SEND_DELAY);
             sendInstruction(lastInstruction.get());
         } else {
             endNavigation();
-            currCount.set(0);
-            isInProgress.set(false);
-            isStarted.set(false);
-            lastInstruction.set(null);
+            clearNavigationState();
         }
     }
 
     public void updateInstruction(String distance, String icon, String name) {
+        if(!isRegistered.get()) {
+            return;
+        }
         currCount.set(0);
         handler.removeCallbacks(updateCallback);
         JsonArray roadName = new JsonArray();
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/SendP2PCommand.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/SendP2PCommand.java
index ee1a868ddf..ccac85e5f4 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/SendP2PCommand.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huawei/requests/SendP2PCommand.java
@@ -26,7 +26,6 @@ import nodomain.freeyourgadget.gadgetbridge.devices.huawei.packets.P2P;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.huawei.HuaweiSupportProvider;
 
 public class SendP2PCommand extends Request {
-    private static final Logger LOG = LoggerFactory.getLogger(SendP2PCommand.class);
 
     private final byte cmdId;
     private final short sequenceId;
```
-----------------------------------
