# Commit: c57f9dc606dae727202fce06ebb0c1a91cf64216
## Message: Test Device: Fix crashes, improve data quality
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateDailyFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/test/samples/TestSampleProvider.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateDailyFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateDailyFragment.java
index d8d4d60971..7181f59e52 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateDailyFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateDailyFragment.java
@@ -6,6 +6,8 @@ import android.view.View;
 import android.view.ViewGroup;
 import android.widget.TextView;
 
+import androidx.core.content.ContextCompat;
+
 import com.github.mikephil.charting.charts.Chart;
 import com.github.mikephil.charting.charts.LineChart;
 import com.github.mikephil.charting.components.LegendEntry;
@@ -26,8 +28,8 @@ import java.util.List;
 
 import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.database.DBHandler;
-import nodomain.freeyourgadget.gadgetbridge.entities.AbstractRespiratoryRateSample;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
+import nodomain.freeyourgadget.gadgetbridge.model.RespiratoryRateSample;
 
 public class RespiratoryRateDailyFragment extends RespiratoryRateFragment<RespiratoryRateFragment.RespiratoryRateDay> {
     protected static final Logger LOG = LoggerFactory.getLogger(RespiratoryRateDailyFragment.class);
@@ -76,15 +78,12 @@ public class RespiratoryRateDailyFragment extends RespiratoryRateFragment<Respir
         String formattedDate = new SimpleDateFormat("E, MMM dd").format(chartsHost.getEndDate());
         mDateView.setText(formattedDate);
         List<RespiratoryRateDay> stepsDayList = getMyRespiratoryRateDaysData(db, day, device);
-        final RespiratoryRateDay RespiratoryRateDay;
         if (stepsDayList.isEmpty()) {
             LOG.error("Failed to get RespiratoryRateDay for {}", day);
-            List<? extends AbstractRespiratoryRateSample> s = new ArrayList<>();
-            RespiratoryRateDay = new RespiratoryRateDay(day, new ArrayList<>(), new ArrayList<>(), true);
+            return new RespiratoryRateDay(day, new ArrayList<>(), new ArrayList<>(), true);
         } else {
-            RespiratoryRateDay = stepsDayList.get(0);
+            return stepsDayList.get(0);
         }
-        return RespiratoryRateDay;
     }
 
     @Override
@@ -99,7 +98,7 @@ public class RespiratoryRateDailyFragment extends RespiratoryRateFragment<Respir
         final List<LegendEntry> legendEntries = new ArrayList<>(1);
         final LegendEntry respiratoryRateEntry = new LegendEntry();
         respiratoryRateEntry.label = getString(R.string.respiratoryrate);
-        respiratoryRateEntry.formColor = getResources().getColor(R.color.respiratory_rate_color);
+        respiratoryRateEntry.formColor = ContextCompat.getColor(requireContext(), R.color.respiratory_rate_color);
         legendEntries.add(respiratoryRateEntry);
         respiratoryRateChart.getLegend().setTextColor(TEXT_COLOR);
         respiratoryRateChart.getLegend().setCustom(legendEntries);
@@ -108,7 +107,7 @@ public class RespiratoryRateDailyFragment extends RespiratoryRateFragment<Respir
         List<Entry> lineEntries = new ArrayList<>();
         final TimestampTranslation tsTranslation = new TimestampTranslation();
         int lastTsShorten = 0;
-        for (final AbstractRespiratoryRateSample sample : respiratoryRateDay.respiratoryRateSamples) {
+        for (final RespiratoryRateSample sample : respiratoryRateDay.respiratoryRateSamples) {
             int ts = (int) (sample.getTimestamp() / 1000L);
             int tsShorten = tsTranslation.shorten(ts);
             if (lastTsShorten == 0 || (tsShorten - lastTsShorten) <= 300) {
@@ -136,12 +135,12 @@ public class RespiratoryRateDailyFragment extends RespiratoryRateFragment<Respir
         }
 
         final LineDataSet lineDataSet = new LineDataSet(lineEntries, getString(R.string.respiratoryrate));
-        lineDataSet.setColor(getResources().getColor(R.color.respiratory_rate_color));
+        lineDataSet.setColor(ContextCompat.getColor(requireContext(), R.color.respiratory_rate_color));
         lineDataSet.setDrawCircles(false);
         lineDataSet.setLineWidth(2f);
         lineDataSet.setFillAlpha(255);
         lineDataSet.setDrawCircles(false);
-        lineDataSet.setCircleColor(getResources().getColor(R.color.respiratory_rate_color));
+        lineDataSet.setCircleColor(ContextCompat.getColor(requireContext(), R.color.respiratory_rate_color));
         lineDataSet.setAxisDependency(YAxis.AxisDependency.LEFT);
         lineDataSet.setDrawValues(false);
         lineDataSet.setMode(LineDataSet.Mode.CUBIC_BEZIER);
@@ -153,12 +152,12 @@ public class RespiratoryRateDailyFragment extends RespiratoryRateFragment<Respir
 
     protected LineDataSet createDataSet(final List<Entry> values) {
         final LineDataSet lineDataSet = new LineDataSet(values, getString(R.string.respiratoryrate));
-        lineDataSet.setColor(getResources().getColor(R.color.respiratory_rate_color));
+        lineDataSet.setColor(ContextCompat.getColor(requireContext(), R.color.respiratory_rate_color));
         lineDataSet.setDrawCircles(false);
         lineDataSet.setLineWidth(2f);
         lineDataSet.setFillAlpha(255);
         lineDataSet.setDrawCircles(false);
-        lineDataSet.setCircleColor(getResources().getColor(R.color.respiratory_rate_color));
+        lineDataSet.setCircleColor(ContextCompat.getColor(requireContext(), R.color.respiratory_rate_color));
         lineDataSet.setAxisDependency(YAxis.AxisDependency.LEFT);
         lineDataSet.setDrawValues(false);
         lineDataSet.setMode(LineDataSet.Mode.CUBIC_BEZIER);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateFragment.java
index 40940f4ba7..979b27a707 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/RespiratoryRateFragment.java
@@ -28,10 +28,9 @@ import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.database.DBHandler;
 import nodomain.freeyourgadget.gadgetbridge.devices.SampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.devices.TimeSampleProvider;
-import nodomain.freeyourgadget.gadgetbridge.entities.AbstractRespiratoryRateSample;
+import nodomain.freeyourgadget.gadgetbridge.model.RespiratoryRateSample;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivitySample;
-import nodomain.freeyourgadget.gadgetbridge.model.RespiratoryRateSample;
 
 abstract class RespiratoryRateFragment<T extends ChartsData> extends AbstractChartFragment<T> {
     protected static final Logger LOG = LoggerFactory.getLogger(RespiratoryRateFragment.class);
@@ -53,9 +52,9 @@ abstract class RespiratoryRateFragment<T extends ChartsData> extends AbstractCha
     protected void init() {
         TEXT_COLOR = GBApplication.getTextColor(requireContext());
         CHART_TEXT_COLOR = GBApplication.getSecondaryTextColor(requireContext());
-        BACKGROUND_COLOR = GBApplication.getBackgroundColor(getContext());
-        LEGEND_TEXT_COLOR = DESCRIPTION_COLOR = GBApplication.getTextColor(getContext());
-        CHART_TEXT_COLOR = GBApplication.getSecondaryTextColor(getContext());
+        BACKGROUND_COLOR = GBApplication.getBackgroundColor(requireContext());
+        LEGEND_TEXT_COLOR = DESCRIPTION_COLOR = GBApplication.getTextColor(requireContext());
+        CHART_TEXT_COLOR = GBApplication.getSecondaryTextColor(requireContext());
     }
 
     protected List<RespiratoryRateFragment.RespiratoryRateDay> getMyRespiratoryRateDaysData(DBHandler db, Calendar day, GBDevice device) {
@@ -64,7 +63,7 @@ abstract class RespiratoryRateFragment<T extends ChartsData> extends AbstractCha
 
         final boolean supportsDayRespiratoryRate = device.getDeviceCoordinator().supportsDayRespiratoryRate(device);
 
-        List<RespiratoryRateDay> daysData = new ArrayList<>();;
+        List<RespiratoryRateDay> daysData = new ArrayList<>();
         for (int counter = 0; counter < TOTAL_DAYS; counter++) {
             int startTs;
             int endTs;
@@ -78,7 +77,7 @@ abstract class RespiratoryRateFragment<T extends ChartsData> extends AbstractCha
             List<? extends ActivitySample> activitySamples = getAllActivitySamples(db, device, startTs, endTs);
             SleepAnalysis sleepAnalysis = new SleepAnalysis();
             List<SleepAnalysis.SleepSession> sleepSessions = sleepAnalysis.calculateSleepSessions(activitySamples);
-            List<? extends AbstractRespiratoryRateSample> samples = getRespiratoryRateSamples(db, device, startTs, endTs);
+            List<? extends RespiratoryRateSample> samples = getRespiratoryRateSamples(db, device, startTs, endTs);
             Calendar d = (Calendar) day.clone();
             daysData.add(new RespiratoryRateDay(d, samples, sleepSessions, supportsDayRespiratoryRate));
             day.add(Calendar.DATE, 1);
@@ -86,13 +85,9 @@ abstract class RespiratoryRateFragment<T extends ChartsData> extends AbstractCha
         return daysData;
     }
 
-    protected List<? extends AbstractRespiratoryRateSample> getSamplesOfDay(DBHandler db, GBDevice device, int startTs, int endTs) {
-        return getRespiratoryRateSamples(db, device, startTs, endTs);
-    }
-
-    protected List<AbstractRespiratoryRateSample> getRespiratoryRateSamples(DBHandler db, GBDevice device, int tsFrom, int tsTo) {
+    protected List<? extends RespiratoryRateSample> getRespiratoryRateSamples(DBHandler db, GBDevice device, int tsFrom, int tsTo) {
         TimeSampleProvider<? extends RespiratoryRateSample> provider = device.getDeviceCoordinator().getRespiratoryRateSampleProvider(device, db.getDaoSession());
-        return (List<AbstractRespiratoryRateSample>) provider.getAllSamples(tsFrom * 1000L, tsTo * 1000L);
+        return provider.getAllSamples(tsFrom * 1000L, tsTo * 1000L);
     }
 
     protected List<? extends ActivitySample> getAllActivitySamples(DBHandler db, GBDevice device, int startTs, int endTs) {
@@ -106,11 +101,11 @@ abstract class RespiratoryRateFragment<T extends ChartsData> extends AbstractCha
         public int rateLowest;
         public int rateHighest;
         public Calendar day;
-        List<? extends AbstractRespiratoryRateSample> respiratoryRateSamples;
+        List<? extends RespiratoryRateSample> respiratoryRateSamples;
         List<SleepAnalysis.SleepSession> sleepSessions;
 
         protected RespiratoryRateDay(Calendar day,
-                                     List<? extends AbstractRespiratoryRateSample> respiratoryRateSamples,
+                                     List<? extends RespiratoryRateSample> respiratoryRateSamples,
                                      List<SleepAnalysis.SleepSession> sleepSessions,
                                      boolean supportsDayRespiratoryRate) {
             this.day = day;
@@ -123,7 +118,7 @@ abstract class RespiratoryRateFragment<T extends ChartsData> extends AbstractCha
             float lowest = 0;
             float highest = 0;
             if (!this.respiratoryRateSamples.isEmpty()) {
-                for (AbstractRespiratoryRateSample sample : this.respiratoryRateSamples) {
+                for (RespiratoryRateSample sample : this.respiratoryRateSamples) {
                     if (isSleepSample(sample, supportsDayRespiratoryRate)) {
                         sleepRateTotal += sample.getRespiratoryRate();
                         sleepCounter++;
@@ -149,7 +144,7 @@ abstract class RespiratoryRateFragment<T extends ChartsData> extends AbstractCha
             this.rateHighest = (int) highest;
         }
 
-        private boolean isSleepSample(AbstractRespiratoryRateSample sample, boolean supportsDayRespiratoryRate) {
+        private boolean isSleepSample(RespiratoryRateSample sample, boolean supportsDayRespiratoryRate) {
             if (!supportsDayRespiratoryRate) {
                 return true;
             }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/test/samples/TestSampleProvider.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/test/samples/TestSampleProvider.java
index 57fa5c9161..7d1cac7f1a 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/test/samples/TestSampleProvider.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/test/samples/TestSampleProvider.java
@@ -28,6 +28,8 @@ import java.util.List;
 
 import de.greenrobot.dao.AbstractDao;
 import de.greenrobot.dao.Property;
+import nodomain.freeyourgadget.gadgetbridge.GBApplication;
+import nodomain.freeyourgadget.gadgetbridge.activities.HeartRateUtils;
 import nodomain.freeyourgadget.gadgetbridge.devices.AbstractSampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.devices.SampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.devices.test.TestDeviceRand;
@@ -35,10 +37,18 @@ import nodomain.freeyourgadget.gadgetbridge.entities.AbstractActivitySample;
 import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivityKind;
+import nodomain.freeyourgadget.gadgetbridge.util.GBPrefs;
+import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
 
 public class TestSampleProvider extends AbstractSampleProvider<TestSampleProvider.TestActivitySample> {
+    private final int maxHeartRateValue;
+    private final int minHeartRateValue;
+
     public TestSampleProvider(final GBDevice device, final DaoSession session) {
         super(device, session);
+        final Prefs prefs = GBApplication.getPrefs();
+        minHeartRateValue = prefs.getInt(GBPrefs.CHART_MIN_HEART_RATE, HeartRateUtils.MIN_HEART_RATE_VALUE);
+        maxHeartRateValue = prefs.getInt(GBPrefs.CHART_MAX_HEART_RATE, HeartRateUtils.MAX_HEART_RATE_VALUE);
     }
 
     @Override
@@ -105,7 +115,7 @@ public class TestSampleProvider extends AbstractSampleProvider<TestSampleProvide
         float dayActivityFactor = TestDeviceRand.randFloat(timestamp_from * 1000L, 0f, 1f);
         int steps = (int) (TestDeviceRand.randInt(timestamp_from * 1000L, 0, 100) * dayActivityFactor);
         int intensity = TestDeviceRand.randInt(timestamp_from * 1000L, 0, 100);
-        int hr = TestDeviceRand.randInt(timestamp_from * 1000L, 90, 153);
+        int hr = TestDeviceRand.randInt(timestamp_from * 1000L, minHeartRateValue, maxHeartRateValue);
 
         final long bedtimeHour = TestDeviceRand.randInt(timestamp_from, 21, 22);
         final long bedtimeMinute = TestDeviceRand.randInt(timestamp_from, 0, 59);
@@ -160,6 +170,7 @@ public class TestSampleProvider extends AbstractSampleProvider<TestSampleProvide
             steps += (int) (TestDeviceRand.randInt(ts, -steps, 100 - steps) * dayActivityFactor);
             intensity += TestDeviceRand.randInt(ts, -1, 1);
             hr += TestDeviceRand.randInt(ts, -2, 2);
+            hr = Math.min(maxHeartRateValue, Math.max(minHeartRateValue, hr));
         }
 
         return samples;
```
-----------------------------------
