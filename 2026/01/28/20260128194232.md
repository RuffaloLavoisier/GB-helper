# Commit: 9dd91c43496471b742406d80f829b5d0a064bc2f
## Message: Garmin: Display sleep restless moments
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminChartsProvider.kt

GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/DefaultChartsProvider.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/DeviceChartsProvider.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/SleepDailyFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitImporter.java

app/src/main/res/values/strings.xml

## Diff:
```
diff --git a/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java b/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java
index ac6d61f88a..613ae8a152 100644
--- a/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java
+++ b/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java
@@ -76,7 +76,7 @@ public class GBDaoGenerator {
             outputDir.mkdirs();
         }
 
-        final Schema schema = new Schema(126, MAIN_PACKAGE + ".entities");
+        final Schema schema = new Schema(127, MAIN_PACKAGE + ".entities");
 
         final List<Entity> sampleProvidersToGenerate = new LinkedList<>();
 
@@ -164,6 +164,7 @@ public class GBDaoGenerator {
         addGarminSleepStatsSample(schema, user, device);
         addGarminIntensityMinutesSample(schema, user, device);
         addGarminNapSample(schema, user, device);
+        sampleProvidersToGenerate.add(addGarminSleepRestlessMomentsSample(schema, user, device));
         addPendingFile(schema, user, device);
         addWena3EnergySample(schema, user, device);
         addWena3BehaviorSample(schema, user, device);
@@ -1105,6 +1106,13 @@ public class GBDaoGenerator {
         return sample;
     }
 
+    private static Entity addGarminSleepRestlessMomentsSample(Schema schema, Entity user, Entity device) {
+        Entity sample = addEntity(schema, "GarminSleepRestlessMomentsSample");
+        addCommonTimeSampleProperties("AbstractTimeSample", sample, user, device);
+        sample.addIntProperty("count").notNull();
+        return sample;
+    }
+
     private static Entity addPendingFile(Schema schema, Entity user, Entity device) {
         Entity pendingFile = addEntity(schema, "PendingFile");
         pendingFile.setJavaDoc(
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/DefaultChartsProvider.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/DefaultChartsProvider.kt
index 08cdf888fe..f23069b4de 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/DefaultChartsProvider.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/DefaultChartsProvider.kt
@@ -6,7 +6,8 @@ import nodomain.freeyourgadget.gadgetbridge.GBApplication
 import nodomain.freeyourgadget.gadgetbridge.R
 import nodomain.freeyourgadget.gadgetbridge.activities.charts.ActivityChartsActivity.UnknownFragment
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsPreferenceConst
-import nodomain.freeyourgadget.gadgetbridge.activities.workouts.entries.ActivitySummaryEntry
+import nodomain.freeyourgadget.gadgetbridge.activities.workouts.entries.ActivitySummarySimpleEntry
+import nodomain.freeyourgadget.gadgetbridge.database.DBHandler
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice
 import java.util.Locale
 
@@ -150,4 +151,14 @@ open class DefaultChartsProvider : DeviceChartsProvider {
             else -> UnknownFragment()
         }
     }
+
+    override fun getDailySleepStats(
+        context: Context,
+        db: DBHandler,
+        device: GBDevice,
+        tsStart: Int,
+        tsEnd: Int
+    ): Map<String, ActivitySummarySimpleEntry> {
+        return emptyMap()
+    }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/DeviceChartsProvider.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/DeviceChartsProvider.kt
index 3eddb76ea8..c56e0c8da6 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/DeviceChartsProvider.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/DeviceChartsProvider.kt
@@ -2,6 +2,8 @@ package nodomain.freeyourgadget.gadgetbridge.activities.charts
 
 import android.content.Context
 import androidx.fragment.app.Fragment
+import nodomain.freeyourgadget.gadgetbridge.activities.workouts.entries.ActivitySummarySimpleEntry
+import nodomain.freeyourgadget.gadgetbridge.database.DBHandler
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice
 
 interface DeviceChartsProvider {
@@ -12,4 +14,12 @@ interface DeviceChartsProvider {
     fun getChartLabel(context: Context, device: GBDevice, chartName: String): String
 
     fun getChartFragment(device: GBDevice, chartName: String, allowSwipe: Boolean): Fragment
+
+    fun getDailySleepStats(
+        context: Context,
+        db: DBHandler,
+        device: GBDevice,
+        tsStart: Int,
+        tsEnd: Int
+    ): Map<String, ActivitySummarySimpleEntry>
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/SleepDailyFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/SleepDailyFragment.java
index 32fe3d5b5b..59d5c3d6ce 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/SleepDailyFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/charts/SleepDailyFragment.java
@@ -53,6 +53,7 @@ import java.util.Arrays;
 import java.util.Date;
 import java.util.Iterator;
 import java.util.List;
+import java.util.Map;
 import java.util.concurrent.TimeUnit;
 
 import nodomain.freeyourgadget.gadgetbridge.GBApplication;
@@ -161,7 +162,23 @@ public class SleepDailyFragment extends SleepFragment<SleepDailyFragment.MyChart
                     Color.RED
             );
         }
-        return new MyChartsData(mySleepChartsData, chartsData, hrData.getLeft(), hrData.getMiddle(), hrData.getRight(), intensityData.getLeft(), intensityData.getMiddle(), intensityData.getRight(), stages, overlay);
+
+        final DeviceChartsProvider chartsProvider = device.getDeviceCoordinator().getChartsProvider();
+        final Map<String, ActivitySummarySimpleEntry> customStats = chartsProvider.getDailySleepStats(requireContext(), db, device, getTSStart(), getTSEnd());
+
+        return new MyChartsData(
+                mySleepChartsData,
+                chartsData,
+                hrData.getLeft(),
+                hrData.getMiddle(),
+                hrData.getRight(),
+                intensityData.getLeft(),
+                intensityData.getMiddle(),
+                intensityData.getRight(),
+                stages,
+                overlay,
+                customStats
+        );
     }
 
     private long getSamplesInterval(List<? extends TimeSample> samples) {
@@ -451,6 +468,10 @@ public class SleepDailyFragment extends SleepFragment<SleepDailyFragment.MyChart
             );
         }
 
+        for (Map.Entry<String, ActivitySummarySimpleEntry> e : mcd.getCustomStats().entrySet()) {
+            statsBuilder.addEntry(e.getKey(), e.getValue());
+        }
+
         binding.sleepStatsContainer.addView(statsBuilder.build());
 
         if (supportsHeartrate(getChartsHost().getDevice()) && SHOW_CHARTS_AVERAGE) {
@@ -748,9 +769,21 @@ public class SleepDailyFragment extends SleepFragment<SleepDailyFragment.MyChart
 
         private final List<SleepDetailsView.SleepDetail> stages;
 
+        private final Map<String, ActivitySummarySimpleEntry> customStats;
+
         private final AbstractOverlayData overlayData;
 
-        public MyChartsData(MySleepChartsData pieData, DefaultChartsData<LineData> chartsData, float heartRateAverage, int heartRateAxisMin, int heartRateAxisMax, float intensityTotal, float intensityAxisMin, float intensityAxisMax, List<SleepDetailsView.SleepDetail> stages, AbstractOverlayData overlayData) {
+        public MyChartsData(MySleepChartsData pieData,
+                            DefaultChartsData<LineData> chartsData,
+                            float heartRateAverage,
+                            int heartRateAxisMin,
+                            int heartRateAxisMax,
+                            float intensityTotal,
+                            float intensityAxisMin,
+                            float intensityAxisMax,
+                            List<SleepDetailsView.SleepDetail> stages,
+                            AbstractOverlayData overlayData,
+                            Map<String, ActivitySummarySimpleEntry> customStats) {
             this.pieData = pieData;
             this.chartsData = chartsData;
             this.heartRateAverage = heartRateAverage;
@@ -761,6 +794,7 @@ public class SleepDailyFragment extends SleepFragment<SleepDailyFragment.MyChart
             this.intensityAxisMax = intensityAxisMax;
             this.stages = stages;
             this.overlayData = overlayData;
+            this.customStats = customStats;
         }
 
         public MySleepChartsData getPieData() {
@@ -802,5 +836,9 @@ public class SleepDailyFragment extends SleepFragment<SleepDailyFragment.MyChart
         public AbstractOverlayData getOverlayData() {
             return overlayData;
         }
+
+        public Map<String, ActivitySummarySimpleEntry> getCustomStats() {
+            return customStats;
+        }
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminChartsProvider.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminChartsProvider.kt
new file mode 100644
index 0000000000..cd3a66d8ec
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminChartsProvider.kt
@@ -0,0 +1,33 @@
+package nodomain.freeyourgadget.gadgetbridge.devices.garmin
+
+import android.content.Context
+import nodomain.freeyourgadget.gadgetbridge.R
+import nodomain.freeyourgadget.gadgetbridge.activities.charts.DefaultChartsProvider
+import nodomain.freeyourgadget.gadgetbridge.activities.workouts.entries.ActivitySummarySimpleEntry
+import nodomain.freeyourgadget.gadgetbridge.database.DBHandler
+import nodomain.freeyourgadget.gadgetbridge.devices.GarminSleepRestlessMomentsSampleProvider
+import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice
+import nodomain.freeyourgadget.gadgetbridge.model.ActivitySummaryEntries.UNIT_NONE
+
+class GarminChartsProvider : DefaultChartsProvider() {
+    override fun getDailySleepStats(
+        context: Context,
+        db: DBHandler,
+        device: GBDevice,
+        tsStart: Int,
+        tsEnd: Int
+    ): Map<String, ActivitySummarySimpleEntry> {
+        val sleepRestlessMomentsSampleProvider = GarminSleepRestlessMomentsSampleProvider(device, db.getDaoSession())
+        val restlessMoments = sleepRestlessMomentsSampleProvider.getAllSamples(tsStart * 1000L, tsEnd * 1000L)
+        if (restlessMoments.isEmpty()) {
+            return emptyMap()
+        }
+        restlessMoments.sumOf { it.count }
+        return mapOf(
+            context.getString(R.string.sleep_restless_moments) to ActivitySummarySimpleEntry(
+                restlessMoments.sumOf { it.count },
+                UNIT_NONE
+            )
+        )
+    }
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminCoordinator.java
index b839d0318e..1aac5e1db6 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminCoordinator.java
@@ -21,6 +21,7 @@ import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AppManagerActivity;
 import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.config.DynamicAppConfigActivity;
+import nodomain.freeyourgadget.gadgetbridge.activities.charts.DeviceChartsProvider;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSpecificSettings;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSpecificSettingsCustomizer;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSpecificSettingsScreen;
@@ -139,6 +140,11 @@ public abstract class GarminCoordinator extends AbstractBLEDeviceCoordinator {
         return GarminSupport.class;
     }
 
+    @Override
+    public DeviceChartsProvider getChartsProvider() {
+        return new GarminChartsProvider();
+    }
+
     @Nullable
     @Override
     public ActivitySummaryParser getActivitySummaryParser(final GBDevice device, final Context context) {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitImporter.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitImporter.java
index c6e0f501b4..4234d20c14 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitImporter.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/FitImporter.java
@@ -39,6 +39,7 @@ import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.database.DBHandler;
 import nodomain.freeyourgadget.gadgetbridge.database.DBHelper;
 import nodomain.freeyourgadget.gadgetbridge.devices.AbstractTimeSampleProvider;
+import nodomain.freeyourgadget.gadgetbridge.devices.GarminSleepRestlessMomentsSampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.devices.GenericTrainingLoadAcuteSampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.devices.GenericTrainingLoadChronicSampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.devices.garmin.GarminActivitySampleProvider;
@@ -71,6 +72,7 @@ import nodomain.freeyourgadget.gadgetbridge.entities.GarminRestingMetabolicRateS
 import nodomain.freeyourgadget.gadgetbridge.entities.GarminHrvSummarySample;
 import nodomain.freeyourgadget.gadgetbridge.entities.GarminHrvValueSample;
 import nodomain.freeyourgadget.gadgetbridge.entities.GarminRespiratoryRateSample;
+import nodomain.freeyourgadget.gadgetbridge.entities.GarminSleepRestlessMomentsSample;
 import nodomain.freeyourgadget.gadgetbridge.entities.GarminSleepStageSample;
 import nodomain.freeyourgadget.gadgetbridge.entities.GarminSleepStatsSample;
 import nodomain.freeyourgadget.gadgetbridge.entities.GarminSpo2Sample;
@@ -102,6 +104,7 @@ import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.FitSession;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.FitSleepDataInfo;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.FitSleepDataRaw;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.FitSleepRestlessMoments;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.FitSleepStage;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.FitSleepStats;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.FitSpo2;
@@ -137,6 +140,7 @@ public class FitImporter {
     private final Map<Integer, Integer> unknownRecords = new HashMap<>();
     private FitSleepDataInfo fitSleepDataInfo = null;
     private final List<FitSleepDataRaw> fitSleepDataRawSamples = new ArrayList<>();
+    private final List<GarminSleepRestlessMomentsSample> sleepRestlessMomentsSamples = new ArrayList<>();
     private final List<BatteryLevel> batterySamples = new ArrayList<>();
     private FitFileId fileId = null;
 
@@ -202,6 +206,14 @@ public class FitImporter {
             } else if (record instanceof FitSleepDataRaw fitSleepDataRaw) {
                 //LOG.debug("Sleep Data Raw: {}", fitSleepDataRaw);
                 fitSleepDataRawSamples.add(fitSleepDataRaw);
+            } else if (record instanceof FitSleepRestlessMoments fitSleepRestlessMoments) {
+                //LOG.debug("Sleep Restless Moments: {}", fitSleepRestlessMoments);
+                if (fitSleepRestlessMoments.getRestlessMomentsCount() != null) {
+                    final GarminSleepRestlessMomentsSample sample = new GarminSleepRestlessMomentsSample();
+                    sample.setTimestamp(ts * 1000L);
+                    sample.setCount(fitSleepRestlessMoments.getRestlessMomentsCount());
+                    sleepRestlessMomentsSamples.add(sample);
+                }
             } else if (record instanceof FitSleepStats) {
                 final Integer score = ((FitSleepStats) record).getOverallSleepScore();
                 if (score == null) {
@@ -452,6 +464,7 @@ public class FitImporter {
                     persistAbstractSamples(events, new GarminEventSampleProvider(gbDevice, session));
                     persistAbstractSamples(sleepStatsSamples, new GarminSleepStatsSampleProvider(gbDevice, session));
                     persistAbstractSamples(napSamples, new GarminNapSampleProvider(gbDevice, session));
+                    persistAbstractSamples(sleepRestlessMomentsSamples, new GarminSleepRestlessMomentsSampleProvider(gbDevice, session));
 
                     // We may have samples, but not sleep samples - #4048
                     // 0 unmeasurable, 1 awake
@@ -551,6 +564,7 @@ public class FitImporter {
         unknownRecords.clear();
         fitSleepDataInfo = null;
         fitSleepDataRawSamples.clear();
+        sleepRestlessMomentsSamples.clear();
         batterySamples.clear();
         fileId = null;
         workoutParser.reset();
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index 80342c98b2..752dc6d4ce 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -2460,6 +2460,7 @@
     <string name="filter_mode">Filter Mode</string>
     <string name="mode_configuration">Mode Configuration</string>
     <string name="save_configuration">Save Configuration</string>
+    <string name="sleep_restless_moments">Restless Moments</string>
     <!-- App Widgets-->
     <string name="appwidget_not_connected">Not connected, alarm not set.</string>
     <string name="widget_settings_select_device_title">Select device</string>
```
-----------------------------------
