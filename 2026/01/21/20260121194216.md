# Commit: ad7ed39a2ad8b461830679ac7ec19adbe17e192f
## Message: HeartRateProfile: Parse and persist RR intervals
## Changed files:
GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/generic_hr/GenericHeartRateCoordinator.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/polar/AbstractPolarDeviceCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/heartrate/HeartRateProfile.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupportHrm.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/generic_hr/GenericHeartRateSupport.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/polar/PolarH10DeviceSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/HeartRrIntervalSampleProvider.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/heartrate/HeartRate.kt

## Diff:
```
diff --git a/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java b/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java
index 9cd7afe5fc..ca8668c19d 100644
--- a/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java
+++ b/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java
@@ -72,7 +72,7 @@ public class GBDaoGenerator {
             outputDir.mkdirs();
         }
 
-        final Schema schema = new Schema(124, MAIN_PACKAGE + ".entities");
+        final Schema schema = new Schema(125, MAIN_PACKAGE + ".entities");
 
         Entity userAttributes = addUserAttributes(schema);
         Entity user = addUserInfo(schema, userAttributes);
@@ -103,6 +103,7 @@ public class GBDaoGenerator {
         addXiaomiActivitySample(schema, user, device);
         addXiaomiSleepTimeSamples(schema, user, device);
         addHeartPulseSamples(schema, user, device);
+        addHeartRrIntervalSamples(schema, user, device);
         addXiaomiSleepStageSamples(schema, user, device);
         addXiaomiManualSamples(schema, user, device);
         addXiaomiDailySummarySamples(schema, user, device);
@@ -566,6 +567,14 @@ public class GBDaoGenerator {
         return sample;
     }
 
+    private static Entity addHeartRrIntervalSamples(Schema schema, Entity user, Entity device) {
+        Entity sample = addEntity(schema, "HeartRrIntervalSample");
+        addCommonTimeSampleProperties("AbstractTimeSample", sample, user, device);
+        sample.addIntProperty("seq").notNull().primaryKey();
+        sample.addIntProperty("rrMillis").notNull();
+        return sample;
+    }
+
     private static Entity addXiaomiSleepStageSamples(Schema schema, Entity user, Entity device) {
         Entity sample = addEntity(schema, "XiaomiSleepStageSample");
         addCommonTimeSampleProperties("AbstractTimeSample", sample, user, device);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/HeartRrIntervalSampleProvider.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/HeartRrIntervalSampleProvider.java
new file mode 100644
index 0000000000..c3730a6f59
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/HeartRrIntervalSampleProvider.java
@@ -0,0 +1,56 @@
+/*  Copyright (C) 2025  Thomas Kuehne
+
+    This file is part of Gadgetbridge.
+
+    Gadgetbridge is free software: you can redistribute it and/or modify
+    it under the terms of the GNU Affero General Public License as published
+    by the Free Software Foundation, either version 3 of the License, or
+    (at your option) any later version.
+
+    Gadgetbridge is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU Affero General Public License for more details.
+
+    You should have received a copy of the GNU Affero General Public License
+    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
+
+package nodomain.freeyourgadget.gadgetbridge.devices;
+
+import androidx.annotation.NonNull;
+
+import de.greenrobot.dao.AbstractDao;
+import de.greenrobot.dao.Property;
+import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession;
+import nodomain.freeyourgadget.gadgetbridge.entities.HeartRrIntervalSample;
+import nodomain.freeyourgadget.gadgetbridge.entities.HeartRrIntervalSampleDao;
+import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
+
+public class HeartRrIntervalSampleProvider extends AbstractTimeSampleProvider<HeartRrIntervalSample> {
+    public HeartRrIntervalSampleProvider(final GBDevice device, final DaoSession session) {
+        super(device, session);
+    }
+
+    @NonNull
+    @Override
+    public AbstractDao<HeartRrIntervalSample, ?> getSampleDao() {
+        return getSession().getHeartRrIntervalSampleDao();
+    }
+
+    @NonNull
+    @Override
+    protected Property getTimestampSampleProperty() {
+        return HeartRrIntervalSampleDao.Properties.Timestamp;
+    }
+
+    @NonNull
+    @Override
+    protected Property getDeviceIdentifierSampleProperty() {
+        return HeartRrIntervalSampleDao.Properties.DeviceId;
+    }
+
+    @Override
+    public HeartRrIntervalSample createSample() {
+        return new HeartRrIntervalSample();
+    }
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/generic_hr/GenericHeartRateCoordinator.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/generic_hr/GenericHeartRateCoordinator.kt
index 3400d7a7fa..909a3e917e 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/generic_hr/GenericHeartRateCoordinator.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/generic_hr/GenericHeartRateCoordinator.kt
@@ -9,6 +9,7 @@ import nodomain.freeyourgadget.gadgetbridge.devices.SampleProvider
 import nodomain.freeyourgadget.gadgetbridge.entities.AbstractActivitySample
 import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession
 import nodomain.freeyourgadget.gadgetbridge.entities.GenericHeartRateSampleDao
+import nodomain.freeyourgadget.gadgetbridge.entities.HeartRrIntervalSampleDao
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDeviceCandidate
 import nodomain.freeyourgadget.gadgetbridge.service.DeviceSupport
@@ -70,6 +71,7 @@ class GenericHeartRateCoordinator : AbstractBLEDeviceCoordinator() {
         return object : HashMap<AbstractDao<*, *>, Property>() {
             init {
                 put(session.genericHeartRateSampleDao, GenericHeartRateSampleDao.Properties.DeviceId)
+                put(session.heartRrIntervalSampleDao, HeartRrIntervalSampleDao.Properties.DeviceId)
             }
         }
     }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/polar/AbstractPolarDeviceCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/polar/AbstractPolarDeviceCoordinator.java
index c1066cde44..24b7664e8a 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/polar/AbstractPolarDeviceCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/polar/AbstractPolarDeviceCoordinator.java
@@ -27,6 +27,7 @@ import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.devices.AbstractBLEDeviceCoordinator;
 import nodomain.freeyourgadget.gadgetbridge.devices.SampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession;
+import nodomain.freeyourgadget.gadgetbridge.entities.HeartRrIntervalSampleDao;
 import nodomain.freeyourgadget.gadgetbridge.entities.PolarH10ActivitySampleDao;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivitySample;
@@ -74,6 +75,7 @@ public abstract class AbstractPolarDeviceCoordinator extends AbstractBLEDeviceCo
     public Map<AbstractDao<?, ?>, Property> getAllDeviceDao(@NonNull final DaoSession session) {
         Map<AbstractDao<?, ?>, Property> map = new HashMap<>(1);
         map.put(session.getPolarH10ActivitySampleDao(), PolarH10ActivitySampleDao.Properties.DeviceId);
+        map.put(session.getHeartRrIntervalSampleDao(), HeartRrIntervalSampleDao.Properties.DeviceId);
         return map;
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/heartrate/HeartRate.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/heartrate/HeartRate.kt
new file mode 100644
index 0000000000..9dfd1c6c44
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/heartrate/HeartRate.kt
@@ -0,0 +1,23 @@
+package nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.heartrate
+
+import android.os.Parcelable
+import kotlinx.parcelize.Parcelize
+
+@Parcelize
+data class HeartRate(
+    val timestamp: Long,
+    val heartRate: Int,
+    val sensorContact: SensorContact,
+    val energyExpended: Int,
+    val rrIntervals: ArrayList<Int>,
+) : Parcelable {
+    fun isValid(): Boolean {
+        return sensorContact != SensorContact.CONTACT_NOT_DETECTED && heartRate > 0
+    }
+}
+
+enum class SensorContact {
+    NOT_SUPPORTED,
+    CONTACT_DETECTED,
+    CONTACT_NOT_DETECTED,
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/heartrate/HeartRateProfile.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/heartrate/HeartRateProfile.java
index 1c6581bfa8..42757a8bee 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/heartrate/HeartRateProfile.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/heartrate/HeartRateProfile.java
@@ -24,15 +24,19 @@ import android.content.Intent;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
+import java.nio.ByteBuffer;
+import java.nio.ByteOrder;
+import java.util.ArrayList;
+
 import nodomain.freeyourgadget.gadgetbridge.service.btle.AbstractBTLESingleDeviceSupport;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.GattCharacteristic;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.GattService;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.AbstractBleProfile;
 
 /**
- * https://www.bluetooth.com/specifications/gatt/viewer?attributeXmlFile=org.bluetooth.service.heart_rate.xml
+ * https://www.bluetooth.com/specifications/specs/html/?src=HRS_v1.0/out/en/index-en.html
+ *
  * @see GattService#UUID_SERVICE_HEART_RATE
  */
 public class HeartRateProfile<T extends AbstractBTLESingleDeviceSupport> extends AbstractBleProfile<T> {
@@ -56,7 +60,7 @@ public class HeartRateProfile<T extends AbstractBTLESingleDeviceSupport> extends
     }
 
     protected void writeToControlPoint(byte value, TransactionBuilder builder) {
-        writeToControlPoint(new byte[] { value }, builder);
+        writeToControlPoint(new byte[]{value}, builder);
     }
 
     protected void writeToControlPoint(byte[] value, TransactionBuilder builder) {
@@ -78,39 +82,76 @@ public class HeartRateProfile<T extends AbstractBTLESingleDeviceSupport> extends
             return false;
         }
 
-        final int flag = value[0];
+        final long timestamp = System.currentTimeMillis();
+
+        final ByteBuffer buf = ByteBuffer.wrap(value).order(ByteOrder.LITTLE_ENDIAN);
+        final int flag = buf.get();
+
         final int heartRate;
         if ((flag & 0x01) != 0) {
-            heartRate = BLETypeConversions.toUint16(value, 1);
+            heartRate = buf.getShort() & 0xffff;
         } else {
-            heartRate = BLETypeConversions.toUnsigned(value, 1);
+            heartRate = buf.get() & 0xff;
         }
 
-        if ((flag & 0x04) != 0){
+        final SensorContact sensorContact;
+        if ((flag & 0x04) != 0) {
             //  Sensor Contact supported
-            if ((flag & 0x02) == 0){
+            if ((flag & 0x02) == 0) {
                 // Sensor Contact NOT detected - no or poor contact with the skin
-                LOG.debug("Got poor contact heartRate: {}", heartRate);
-                return true;
+                sensorContact = SensorContact.CONTACT_NOT_DETECTED;
+            } else {
+                sensorContact = SensorContact.CONTACT_DETECTED;
+            }
+        } else {
+            sensorContact = SensorContact.NOT_SUPPORTED;
+        }
+
+        // Energy Expended (UINT16, unit: kilo Joules since last reset)
+        final int energyExpended;
+        if ((flag & 0x08) != 0) {
+            energyExpended = buf.getShort() & 0xffff;
+        } else {
+            energyExpended = -1;
+        }
+
+        // RR-Interval (UINT16 array, unit: 1/1024 second)
+        final ArrayList<Integer> rrIntervals = new ArrayList<>();
+        if ((flag & 0x10) != 0) {
+            while (buf.hasRemaining()) {
+                rrIntervals.add(((buf.getShort() & 0xffff) * 1000) / 1024);
             }
         }
-        if ((flag & 0x08) != 0){
-            // TODO: Energy Expended present (UINT16, unit: kilo Joules since last reset)
-        }
-        if ((flag & 0x10) != 0){
-            // TODO: RR-Interval present (UINT16 array, unit: 1/1024 second)
-        }
 
-        LOG.debug("Got heartRate: {}", heartRate);
+        LOG.debug(
+                "Got heartRate={}, sensorContact={}, energyExpended={}, rrIntervals={}",
+                heartRate,
+                sensorContact,
+                energyExpended,
+                rrIntervals
+        );
 
-        notify(createIntent(heartRate));
+        notify(createIntent(timestamp, heartRate, sensorContact, energyExpended, rrIntervals));
 
         return true;
     }
 
-    private Intent createIntent(final int heartRate) {
+    private Intent createIntent(final long timestamp,
+                                final int heartRate,
+                                final SensorContact sensorContact,
+                                final int energyExpended,
+                                final ArrayList<Integer> rrIntervals) {
         final Intent intent = new Intent(ACTION_HEART_RATE);
-        intent.putExtra(EXTRA_HEART_RATE, heartRate);
+        intent.putExtra(
+                EXTRA_HEART_RATE,
+                new HeartRate(
+                        timestamp,
+                        heartRate,
+                        sensorContact,
+                        energyExpended,
+                        rrIntervals
+                )
+        );
         return intent;
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupportHrm.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupportHrm.java
index 60ecabbd1e..16d03a5157 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupportHrm.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupportHrm.java
@@ -42,7 +42,9 @@ import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.IntentListener;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.battery.BatteryInfo;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.battery.BatteryInfoProfile;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.heartrate.HeartRate;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.heartrate.HeartRateProfile;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.heartrate.SensorContact;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 public class GarminSupportHrm extends GarminSupport {
@@ -104,8 +106,8 @@ public class GarminSupportHrm extends GarminSupport {
     final class HeartRateListener implements IntentListener {
         @Override
         public void notify(Intent intent) {
-            int hr = intent.getIntExtra(HeartRateProfile.EXTRA_HEART_RATE, -1);
-            if (hr > 0) {
+            final HeartRate heartRate = intent.getParcelableExtra(HeartRateProfile.EXTRA_HEART_RATE);
+            if (heartRate != null && heartRate.isValid()) {
                 final GarminActivitySample sample;
                 try (DBHandler handler = GBApplication.acquireDB()) {
                     final DaoSession session = handler.getDaoSession();
@@ -118,7 +120,7 @@ public class GarminSupportHrm extends GarminSupport {
                     sample.setActiveCalories(ActivitySample.NOT_MEASURED);
                     sample.setDevice(device);
                     sample.setDistanceCm(ActivitySample.NOT_MEASURED);
-                    sample.setHeartRate(hr);
+                    sample.setHeartRate(heartRate.getHeartRate());
                     sample.setRawIntensity(ActivitySample.NOT_MEASURED);
                     sample.setRawKind(ActivityKind.UNKNOWN.getCode());
                     sample.setSteps(ActivitySample.NOT_MEASURED);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/generic_hr/GenericHeartRateSupport.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/generic_hr/GenericHeartRateSupport.kt
index 125c96d19c..f329503236 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/generic_hr/GenericHeartRateSupport.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/generic_hr/GenericHeartRateSupport.kt
@@ -22,7 +22,9 @@ import nodomain.freeyourgadget.gadgetbridge.database.DBHelper
 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventBatteryInfo
 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventVersionInfo
 import nodomain.freeyourgadget.gadgetbridge.devices.GenericHeartRateSampleProvider
+import nodomain.freeyourgadget.gadgetbridge.devices.HeartRrIntervalSampleProvider
 import nodomain.freeyourgadget.gadgetbridge.entities.GenericHeartRateSample
+import nodomain.freeyourgadget.gadgetbridge.entities.HeartRrIntervalSample
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice
 import nodomain.freeyourgadget.gadgetbridge.service.btle.AbstractBTLESingleDeviceSupport
 import nodomain.freeyourgadget.gadgetbridge.service.btle.GattService
@@ -32,10 +34,10 @@ import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.battery.Batter
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.battery.BatteryInfoProfile
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.deviceinfo.DeviceInfo
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.deviceinfo.DeviceInfoProfile
+import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.heartrate.HeartRate
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.heartrate.HeartRateProfile
 import org.slf4j.Logger
 import org.slf4j.LoggerFactory
-import java.util.Calendar
 
 class GenericHeartRateSupport : AbstractBTLESingleDeviceSupport(LOG) {
     private val deviceInfoProfile: DeviceInfoProfile<GenericHeartRateSupport>
@@ -58,7 +60,7 @@ class GenericHeartRateSupport : AbstractBTLESingleDeviceSupport(LOG) {
                     }
 
                     HeartRateProfile.ACTION_HEART_RATE -> {
-                        handleHeartRate(intent.getIntExtra(HeartRateProfile.EXTRA_HEART_RATE, -1))
+                        handleHeartRate(intent.getParcelableExtra(HeartRateProfile.EXTRA_HEART_RATE)!!)
                     }
                 }
             }
@@ -123,21 +125,35 @@ class GenericHeartRateSupport : AbstractBTLESingleDeviceSupport(LOG) {
         handleGBDeviceEvent(batteryCmd)
     }
 
-    private fun handleHeartRate(heartRate: Int) {
+    private fun handleHeartRate(heartRate: HeartRate) {
         LOG.debug("Heart rate: {}", heartRate)
 
-        if (heartRate <= 0) {
+        if (!heartRate.isValid()) {
             return
         }
 
-        val timestamp = Calendar.getInstance().getTimeInMillis()
         try {
             GBApplication.acquireDB().use { db ->
                 val sampleProvider = GenericHeartRateSampleProvider(device, db.getDaoSession())
                 val userId = DBHelper.getUser(db.getDaoSession()).id
                 val deviceId = DBHelper.getDevice(device, db.getDaoSession()).id
-                val sample = GenericHeartRateSample(timestamp, deviceId, userId, heartRate)
+                val sample = GenericHeartRateSample(heartRate.timestamp, deviceId, userId, heartRate.heartRate)
                 sampleProvider.addSample(sample)
+
+                val rrIntervals: ArrayList<Int> = heartRate.rrIntervals
+                if (!rrIntervals.isEmpty()) {
+                    val rrIntervalSampleList: MutableList<HeartRrIntervalSample?> = ArrayList()
+                    for (i in rrIntervals.indices) {
+                        val rrSample = HeartRrIntervalSample()
+                        rrSample.timestamp = heartRate.timestamp
+                        rrSample.seq = i
+                        rrSample.rrMillis = rrIntervals[i]
+                        rrIntervalSampleList.add(rrSample)
+                    }
+
+                    val rrIntervalSampleProvider = HeartRrIntervalSampleProvider(this.device, db.getDaoSession())
+                    rrIntervalSampleProvider.persistForDevice(context, device, rrIntervalSampleList)
+                }
             }
         } catch (e: Exception) {
             LOG.error("Failed to save heartRate sample", e)
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/polar/PolarH10DeviceSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/polar/PolarH10DeviceSupport.java
index f4de1b2532..7b388333f5 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/polar/PolarH10DeviceSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/polar/PolarH10DeviceSupport.java
@@ -3,10 +3,12 @@ package nodomain.freeyourgadget.gadgetbridge.service.devices.polar;
 import android.bluetooth.BluetoothGatt;
 import android.bluetooth.BluetoothGattCharacteristic;
 
+import org.jetbrains.annotations.NotNull;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
-import java.util.Calendar;
+import java.util.ArrayList;
+import java.util.List;
 import java.util.Objects;
 import java.util.UUID;
 
@@ -15,7 +17,9 @@ import nodomain.freeyourgadget.gadgetbridge.database.DBHandler;
 import nodomain.freeyourgadget.gadgetbridge.database.DBHelper;
 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventBatteryInfo;
 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventVersionInfo;
+import nodomain.freeyourgadget.gadgetbridge.devices.HeartRrIntervalSampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.devices.polar.PolarH10ActivitySampleProvider;
+import nodomain.freeyourgadget.gadgetbridge.entities.HeartRrIntervalSample;
 import nodomain.freeyourgadget.gadgetbridge.entities.PolarH10ActivitySample;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.AbstractBTLESingleDeviceSupport;
@@ -25,11 +29,14 @@ import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.IntentListener;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.battery.BatteryInfoProfile;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.deviceinfo.DeviceInfoProfile;
-import nodomain.freeyourgadget.gadgetbridge.util.StringUtils;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.heartrate.HeartRateProfile;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.heartrate.SensorContact;
+import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
 public class PolarH10DeviceSupport extends AbstractBTLESingleDeviceSupport {
     private final DeviceInfoProfile<PolarH10DeviceSupport> deviceInfoProfile;
     private final BatteryInfoProfile<PolarH10DeviceSupport> batteryInfoProfile;
+    private final HeartRateProfile<PolarH10DeviceSupport> heartRateProfile;
     private static final Logger LOG = LoggerFactory.getLogger(PolarH10DeviceSupport.class);
     private final GBDeviceEventVersionInfo versionCmd = new GBDeviceEventVersionInfo();
     private final GBDeviceEventBatteryInfo batteryCmd = new GBDeviceEventBatteryInfo();
@@ -56,6 +63,9 @@ public class PolarH10DeviceSupport extends AbstractBTLESingleDeviceSupport {
                 handleBatteryInfo(Objects.requireNonNull(intent.getParcelableExtra(BatteryInfoProfile.EXTRA_BATTERY_INFO)));
             }
 
+            if (HeartRateProfile.ACTION_HEART_RATE.equals(action)) {
+                handleHeartRate(Objects.requireNonNull(intent.getParcelableExtra(HeartRateProfile.EXTRA_HEART_RATE)));
+            }
         };
 
         deviceInfoProfile = new DeviceInfoProfile<>(this);
@@ -66,6 +76,9 @@ public class PolarH10DeviceSupport extends AbstractBTLESingleDeviceSupport {
         batteryInfoProfile.addListener(mListener);
         addSupportedProfile(batteryInfoProfile);
 
+        heartRateProfile = new HeartRateProfile<>(this);
+        heartRateProfile.addListener(mListener);
+        addSupportedProfile(heartRateProfile);
     }
 
     @Override
@@ -82,7 +95,7 @@ public class PolarH10DeviceSupport extends AbstractBTLESingleDeviceSupport {
         batteryInfoProfile.requestBatteryInfo(builder);
         batteryInfoProfile.enableNotify(builder, true);
 
-        builder.notify(UUID_CHARACTERISTIC_HEART_RATE_MEASUREMENT, true);
+        heartRateProfile.enableNotify(builder, true);
 
         // Set defaults
         getDevice().setFirmwareVersion("N/A");
@@ -99,34 +112,11 @@ public class PolarH10DeviceSupport extends AbstractBTLESingleDeviceSupport {
             return true;
         }
 
-        UUID characteristicUUID = characteristic.getUuid();
-
-        if (characteristicUUID.equals(UUID_CHARACTERISTIC_HEART_RATE_MEASUREMENT)) {
-            int heartrate = Byte.toUnsignedInt(value[1]);
-            LOG.debug("onCharacteristicChanged: HeartRateMeasurement:HeartRate={}", heartrate);
-            this.processSamples(heartrate);
-            return true;
-        }
-
-        LOG.info("Characteristic changed UUID: {}", characteristicUUID);
-        LOG.info("Characteristic changed value: {}", StringUtils.bytesToHex(value));
+        LOG.warn("Unhandled characteristic change: {} = {}", characteristic.getUuid(), GB.hexdump(value));
 
         return false;
     }
 
-    private void processSamples(int hr) {
-        int timestamp = (int) (Calendar.getInstance().getTimeInMillis() / 1000L);
-        try (DBHandler db = GBApplication.acquireDB()) {
-            PolarH10ActivitySampleProvider sampleProvider = new PolarH10ActivitySampleProvider(this.getDevice(), db.getDaoSession());
-            Long userId = DBHelper.getUser(db.getDaoSession()).getId();
-            Long deviceId = DBHelper.getDevice(getDevice(), db.getDaoSession()).getId();
-            PolarH10ActivitySample sample = new PolarH10ActivitySample(timestamp, deviceId, userId, hr);
-            sampleProvider.addGBActivitySamples(new PolarH10ActivitySample[]{sample});
-        } catch (Exception e) {
-            LOG.error("Error acquiring database", e);
-        }
-    }
-
     private void handleDeviceInfo(nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.deviceinfo.DeviceInfo info) {
         LOG.warn("Device info: {}", info);
 
@@ -143,5 +133,36 @@ public class PolarH10DeviceSupport extends AbstractBTLESingleDeviceSupport {
         handleGBDeviceEvent(batteryCmd);
     }
 
+    private void handleHeartRate(nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.heartrate.HeartRate info) {
+        LOG.debug("Heart Rate: {}", info);
 
+        if (info == null || info.getSensorContact() == SensorContact.CONTACT_NOT_DETECTED || info.getHeartRate() <= 0) {
+            return;
+        }
+
+        try (DBHandler db = GBApplication.acquireDB()) {
+            final PolarH10ActivitySampleProvider polarSampleProvider = new PolarH10ActivitySampleProvider(this.getDevice(), db.getDaoSession());
+            final Long userId = DBHelper.getUser(db.getDaoSession()).getId();
+            final Long deviceId = DBHelper.getDevice(getDevice(), db.getDaoSession()).getId();
+            final PolarH10ActivitySample sample = new PolarH10ActivitySample((int) (info.getTimestamp() / 1000), deviceId, userId, info.getHeartRate());
+            polarSampleProvider.addGBActivitySamples(new PolarH10ActivitySample[]{sample});
+
+            final ArrayList<@NotNull Integer> rrIntervals = info.getRrIntervals();
+            if (!rrIntervals.isEmpty()) {
+                final List<HeartRrIntervalSample> rrIntervalSampleList = new ArrayList<>();
+                for (int i = 0; i < rrIntervals.size(); i++) {
+                    final HeartRrIntervalSample rrSample = new HeartRrIntervalSample();
+                    rrSample.setTimestamp(info.getTimestamp());
+                    rrSample.setSeq(i);
+                    rrSample.setRrMillis(rrIntervals.get(i));
+                    rrIntervalSampleList.add(rrSample);
+                }
+
+                final HeartRrIntervalSampleProvider rrIntervalSampleProvider = new HeartRrIntervalSampleProvider(this.getDevice(), db.getDaoSession());
+                rrIntervalSampleProvider.persistForDevice(getContext(), getDevice(), rrIntervalSampleList);
+            }
+        } catch (Exception e) {
+            LOG.error("Error acquiring database", e);
+        }
+    }
 }
```
-----------------------------------
