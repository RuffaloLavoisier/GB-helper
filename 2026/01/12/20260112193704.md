# Commit: 1976dc698c498c583e2220d70a213d2eed9f8cef
## Message: Debug: Add function to drop database table
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseDebugFragment.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseTableDebugFragment.kt

app/src/main/res/xml/debug_preferences_database_table.xml

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseDebugFragment.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseDebugFragment.kt
index 25bd5793df..2e9858d9e2 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseDebugFragment.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseDebugFragment.kt
@@ -23,6 +23,11 @@ class DatabaseDebugFragment : AbstractDebugFragment() {
         addTables()
     }
 
+    override fun onResume() {
+        super.onResume()
+        addTables()
+    }
+
     private fun addTables() {
         val tablesHeader: PreferenceCategory = findPreference(PREF_HEADER_DATABASE_TABLES)!!
         removeDynamicPrefs(tablesHeader)
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseTableDebugFragment.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseTableDebugFragment.kt
index 7b2a98838b..003d870c1b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseTableDebugFragment.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseTableDebugFragment.kt
@@ -5,20 +5,42 @@ import android.content.ClipboardManager
 import android.content.Context
 import android.os.Bundle
 import android.widget.TextView
+import android.widget.Toast
 import androidx.preference.Preference
 import androidx.preference.PreferenceViewHolder
+import com.google.android.material.dialog.MaterialAlertDialogBuilder
 import nodomain.freeyourgadget.gadgetbridge.GBApplication
 import nodomain.freeyourgadget.gadgetbridge.R
+import nodomain.freeyourgadget.gadgetbridge.util.GB
+import kotlin.io.use
 import kotlin.use
 
 class DatabaseTableDebugFragment : AbstractDebugFragment() {
     override fun onCreatePreferences(savedInstanceState: Bundle?, rootKey: String?) {
-        setPreferencesFromResource(R.xml.debug_preferences_empty, rootKey)
+        setPreferencesFromResource(R.xml.debug_preferences_database_table, rootKey)
 
         val tableName = arguments?.getString("tableName")!!
 
         preferenceScreen?.title = tableName
 
+        try {
+            GBApplication.acquireDB().use { db ->
+                val cursor = db.database.rawQuery(
+                    "SELECT COUNT(*) as \"count\" FROM $tableName;",
+                    null
+                )
+
+                cursor.use {
+                    it.moveToNext()
+                    findPreference<Preference>(PREF_DEBUG_DATABASE_COUNT)?.summary = it.getInt(it.getColumnIndexOrThrow("count")).toString()
+                }
+            }
+        } catch (e: Exception) {
+            GB.log("Error accessing database", GB.ERROR, e)
+        }
+
+        onClick(PREF_DEBUG_DROP_TABLE) { dropTable(tableName) }
+
         val ddl = getTableDdl(tableName)
 
         val pref = object : Preference(requireContext()) {
@@ -106,4 +128,30 @@ class DatabaseTableDebugFragment : AbstractDebugFragment() {
 
         return sb.toString().trim()
     }
+
+    private fun dropTable(tableName: String) {
+        MaterialAlertDialogBuilder(requireContext())
+            .setCancelable(true)
+            .setIcon(R.drawable.ic_warning)
+            .setTitle("Drop $tableName")
+            .setMessage("Drop $tableName? All data in this table will be lost, and the table must be re-created manually.")
+            .setPositiveButton(R.string.Delete) { _, _ ->
+                try {
+                    GBApplication.acquireDB().use { db ->
+                        db.database.execSQL("DROP TABLE IF EXISTS $tableName;")
+                    }
+                    parentFragmentManager.popBackStack()
+                } catch (e: Exception) {
+                    GB.toast("Failed to drop table", Toast.LENGTH_LONG, GB.ERROR, e)
+                }
+            }
+            .setNegativeButton(R.string.Cancel) { _, _ -> }
+            .show()
+
+    }
+
+    companion object {
+        private const val PREF_DEBUG_DATABASE_COUNT = "pref_debug_database_count"
+        private const val PREF_DEBUG_DROP_TABLE = "pref_debug_drop_table"
+    }
 }
diff --git a/app/src/main/res/xml/debug_preferences_database_table.xml b/app/src/main/res/xml/debug_preferences_database_table.xml
new file mode 100644
index 0000000000..ccbdad6ea0
--- /dev/null
+++ b/app/src/main/res/xml/debug_preferences_database_table.xml
@@ -0,0 +1,29 @@
+<?xml version="1.0" encoding="utf-8"?>
+<androidx.preference.PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto"
+    android:title="@string/database">
+
+    <Preference
+        android:icon="@drawable/ic_database"
+        android:key="pref_debug_database_count"
+        android:persistent="false"
+        android:selectable="false"
+        android:title="Number of records" />
+
+    <SwitchPreferenceCompat
+        android:defaultValue="false"
+        android:icon="@drawable/ic_warning_gray"
+        android:key="dangerous_actions"
+        android:layout="@layout/preference_checkbox"
+        android:persistent="false"
+        android:title="@string/dangerous_actions" />
+
+    <Preference
+        android:dependency="dangerous_actions"
+        android:icon="@drawable/ic_delete_forever"
+        android:key="pref_debug_drop_table"
+        android:persistent="false"
+        android:summary="Warning! By pushing this button the table will be dropped to the database and must be re-created."
+        android:title="Drop table" />
+
+</androidx.preference.PreferenceScreen>
```
-----------------------------------
