# Commit: 9a84a2f5af944f9922103e19aa77974e9fe46f2e
## Message: Zepp OS: Fix image encoding
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBitmapFormat.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsNotificationService.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBitmapFormat.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBitmapFormat.java
index 5432fd4b55..c1985e122e 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBitmapFormat.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/ZeppOsBitmapFormat.java
@@ -9,18 +9,19 @@ import com.android.nQuant.PnnLABQuantizer;
 
 import java.nio.ByteBuffer;
 
+import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
 import nodomain.freeyourgadget.gadgetbridge.util.BitmapUtil;
 
 public enum ZeppOsBitmapFormat {
-    TGA_RGB565_GCNANOLITE(0x04, "SOMHP".getBytes()) {
+    TGA_RGB565_GCNANOLITE(0x04) {
         @Override
         public byte[] encode(final Bitmap bmp, final int width, final int height) {
-            return BitmapUtil.convertToTgaRGB565(bmp, width, height, getTgaIdBytes());
+            return BitmapUtil.convertToTgaRGB565(bmp, width, height, getTgaIdBytes(width));
         }
     },
 
     // Zepp OS 4
-    TGA_L8_ARGB8888_GCNANOLITE(0x05, new byte[]{'S', 'O', 'M', 'H', (byte) 0x80}) {
+    TGA_L8_ARGB8888_GCNANOLITE(0x05) {
         @Override
         public byte[] encode(final Bitmap bmp, final int width, final int height) {
             final Bitmap resizedBmp = BitmapUtil.convert(bmp, Bitmap.Config.ARGB_8888, width, height);
@@ -61,37 +62,36 @@ public enum ZeppOsBitmapFormat {
                 }
             }
 
-            return BitmapUtil.buildTga(imageDataBuf.array(), 8, paletteBytes, width, height, getTgaIdBytes());
+            return BitmapUtil.buildTga(imageDataBuf.array(), 8, paletteBytes, width, height, getTgaIdBytes(width));
         }
     },
 
-    TGA_RGB565_DAVE2D(0x08, "SOMH6".getBytes()) {
+    TGA_RGB565_DAVE2D(0x08) {
         @Override
         public byte[] encode(final Bitmap bmp, final int width, final int height) {
-            return BitmapUtil.convertToTgaRGB565(bmp, width, height, getTgaIdBytes());
+            return BitmapUtil.convertToTgaRGB565(bmp, width, height, getTgaIdBytes(width));
         }
     },
 
     ;
 
     private final byte code;
-    private final byte[] tgaId;
 
-    ZeppOsBitmapFormat(final int code, final byte[] tgaId) {
+    ZeppOsBitmapFormat(final int code) {
         this.code = (byte) code;
-        this.tgaId = tgaId;
     }
 
     public byte getCode() {
         return code;
     }
 
-    public byte[] getTgaIdBytes() {
-        // Without the expected tga id and format string they seem to get corrupted,
-        // but the encoding seems to actually be the same...?
-        // The TGA needs to have this ID, or the band does not accept it
+    public byte[] getTgaIdBytes(final int width) {
         final byte[] tgaIdBytes = new byte[46];
-        System.arraycopy(tgaId, 0, tgaIdBytes, 0, tgaId.length);
+        tgaIdBytes[0] = 'S';
+        tgaIdBytes[1] = 'O';
+        tgaIdBytes[2] = 'M';
+        tgaIdBytes[3] = 'H';
+        BLETypeConversions.writeUint32(tgaIdBytes, 4, width);
         return tgaIdBytes;
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsNotificationService.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsNotificationService.java
index 448dade6cf..df3bd8fef6 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsNotificationService.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/huami/zeppos/services/ZeppOsNotificationService.java
@@ -497,7 +497,7 @@ public class ZeppOsNotificationService extends AbstractZeppOsService {
         //    LOG.error("Failed to dump bytes to storage", e);
         //}
 
-        sendFile(url, filename, tga, false, success -> ackNotificationAfterIconSent(packageName, success));
+        sendFile(url, filename, tga, success -> ackNotificationAfterIconSent(packageName, success));
     }
 
     private void sendNotificationPicture(final String packageName, final int notificationId, final byte pictureFormat, final int width) {
@@ -527,6 +527,11 @@ public class ZeppOsNotificationService extends AbstractZeppOsService {
         final int targetWidth = width + 10;
         final int targetHeight = (int) Math.round(bmp.getHeight() * ((double) targetWidth / bmp.getWidth()));
         final byte[] tga = format.encode(bmp, targetWidth, targetHeight);
+        if (tga == null) {
+            LOG.warn("Failed to encode tga from {}", picturePath);
+            ackNotificationAfterPictureSent(packageName, notificationId, false);
+            return;
+        }
 
         final String url = String.format(
                 Locale.ROOT,
@@ -539,13 +544,12 @@ public class ZeppOsNotificationService extends AbstractZeppOsService {
         );
         final String filename = String.format(Locale.ROOT, "picture_%d.tga", notificationId);
 
-        sendFile(url, filename, tga, true, success -> ackNotificationAfterPictureSent(packageName, notificationId, success));
+        sendFile(url, filename, tga, success -> ackNotificationAfterPictureSent(packageName, notificationId, success));
     }
 
     private void sendFile(final String url,
                           final String filename,
                           final byte[] bytes,
-                          final boolean compress,
                           final Consumer<Boolean> uploadFinishCallback) {
         if (getSupport().getMTU() < 247) {
             LOG.warn("Sending files requires high MTU, current MTU is {}", getSupport().getMTU());
```
-----------------------------------
