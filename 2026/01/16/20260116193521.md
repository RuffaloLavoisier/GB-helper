# Commit: 915c2a554604dbbd468afc290b3dfdeee45f23da
## Message: Garmin: Map some missing fit fields

Taken from a fit file of a Garmin Edge 1040
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/workouts/charts/DefaultWorkoutCharts.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/workouts/entries/ActivitySummaryGroup.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminWorkoutParser.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/model/ActivitySummaryEntries.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/GlobalFITMessage.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/messages/FitSession.java

app/src/main/res/values/strings.xml

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/workouts/charts/DefaultWorkoutCharts.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/workouts/charts/DefaultWorkoutCharts.java
index 224f4e3cb9..93ffcec69b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/workouts/charts/DefaultWorkoutCharts.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/workouts/charts/DefaultWorkoutCharts.java
@@ -322,7 +322,7 @@ public class DefaultWorkoutCharts {
         return new WorkoutChart(
                 "temperature",
                 context.getString(R.string.menuitem_temperature),
-                ActivitySummaryEntries.GROUP_OTHER,
+                ActivitySummaryEntries.GROUP_TEMPERATURE,
                 new LineData(dataset),
                 integerFormatter,
                 getUnitString(context, UNIT_CELSIUS),
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/workouts/entries/ActivitySummaryGroup.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/workouts/entries/ActivitySummaryGroup.kt
index 604c3b9d11..265a9b2974 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/workouts/entries/ActivitySummaryGroup.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/workouts/entries/ActivitySummaryGroup.kt
@@ -25,6 +25,13 @@ object ActivitySummaryGroup {
                 }
             }
 
+        // Ensure "other" is at the end
+        val other = activeGroups[ActivitySummaryEntries.GROUP_OTHER]
+        if (other != null) {
+            activeGroups.remove(ActivitySummaryEntries.GROUP_OTHER)
+            activeGroups[ActivitySummaryEntries.GROUP_OTHER] = other
+        }
+
         // activeGroups is already ordered
         return activeGroups
     }
@@ -298,6 +305,15 @@ object ActivitySummaryGroup {
                 )
             )
 
+            // Temperature
+            put(
+                ActivitySummaryEntries.GROUP_TEMPERATURE, listOf<String>(
+                    ActivitySummaryEntries.TEMPERATURE_MIN,
+                    ActivitySummaryEntries.TEMPERATURE_MAX,
+                    ActivitySummaryEntries.TEMPERATURE_AVG,
+                )
+            )
+
             // Other
             put(
                 ActivitySummaryEntries.GROUP_OTHER, listOf<String>(
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminWorkoutParser.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminWorkoutParser.java
index c123f29c38..388b009bb5 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminWorkoutParser.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/garmin/GarminWorkoutParser.java
@@ -255,12 +255,16 @@ public class GarminWorkoutParser implements ActivitySummaryParser {
         }
         summaryData.add(STEP_LENGTH_AVG, session.getAvgStepLength(), UNIT_MM);
         if (session.getTotalCalories() != null) {
+            summaryData.add(CALORIES_CONSUMED, session.getCaloriesConsumed(), UNIT_KCAL);
             summaryData.add(CALORIES_BURNT, session.getTotalCalories(), UNIT_KCAL);
             if (session.getRestingCalories() != null) {
                 summaryData.add(CALORIES_ACTIVE, session.getTotalCalories() - session.getRestingCalories(), UNIT_KCAL);
                 summaryData.add(CALORIES_RESTING, session.getRestingCalories(), UNIT_KCAL);
             }
         }
+        if (session.getFluidConsumed() != null) {
+            summaryData.add(FLUID_CONSUMED, session.getFluidConsumed(), UNIT_ML);
+        }
         if (session.getEstimatedSweatLoss() != null) {
             summaryData.add(ESTIMATED_SWEAT_LOSS, session.getEstimatedSweatLoss(), UNIT_ML);
         }
@@ -579,11 +583,23 @@ public class GarminWorkoutParser implements ActivitySummaryParser {
                 summaryData.add(BOTTOM_TIME, diveSummary.getBottomTime(), UNIT_SECONDS);
             }
         }
+        summaryData.add(TEMPERATURE_MIN, session.getMinTemperature(), UNIT_CELSIUS);
+        summaryData.add(TEMPERATURE_MAX, session.getMaxTemperature(), UNIT_CELSIUS);
+        summaryData.add(TEMPERATURE_AVG, session.getAvgTemperature(), UNIT_CELSIUS);
+
+        // MTB-specific metrics
+        summaryData.add("activity_type_mountain_bike", MOUNTAIN_BIKE_GRIT_SCORE, session.getTotalGrit(), UNIT_NONE);
+        summaryData.add("activity_type_mountain_bike", MOUNTAIN_BIKE_FLOW_SCORE, session.getAvgFlow(), UNIT_NONE);
 
         summaryData.add(TRAINING_LOAD, safeRound(session.getTrainingLoadPeak()), UNIT_NONE);
         summaryData.add(INTENSITY_FACTOR, session.getIntensityFactor(), UNIT_NONE);
         summaryData.add(TRAINING_STRESS_SCORE, session.getTrainingStressScore(), UNIT_NONE);
 
+        summaryData.add(SOLAR_INTENSITY, safeRound(session.getSolarIntensity()), UNIT_PERCENTAGE);
+        if (session.getBatteryGain() != null) {
+            summaryData.add(BATTERY_GAIN, session.getBatteryGain() * 60, UNIT_SECONDS);
+        }
+
         if (!diveGases.isEmpty()) {
             final ActivitySummaryTableBuilder tableBuilder = new ActivitySummaryTableBuilder(GAS, "gases_header", Arrays.asList(
                     "diving_gas",
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/model/ActivitySummaryEntries.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/model/ActivitySummaryEntries.java
index 306e6143e0..504d2120df 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/model/ActivitySummaryEntries.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/model/ActivitySummaryEntries.java
@@ -98,6 +98,10 @@ public class ActivitySummaryEntries {
     public static final String FRONT_GEAR_SHIFTS = "front_gear_shifts";
     public static final String REAR_GEAR_SHIFTS = "rear_gear_shifts";
     public static final String ACTIVE_SCORE = "workout_active_score";
+    public static final String SOLAR_INTENSITY = "solar_intensity";
+    public static final String BATTERY_GAIN = "battery_gain";
+    public static final String MOUNTAIN_BIKE_GRIT_SCORE = "mountain_bike_grit_score";
+    public static final String MOUNTAIN_BIKE_FLOW_SCORE = "mountain_bike_flow_score";
 
     public static final String AVG_VERTICAL_OSCILLATION = "vertical_oscillation";
     public static final String AVG_GROUND_CONTACT_TIME = "ground_contact_time";
@@ -124,6 +128,9 @@ public class ActivitySummaryEntries {
     public static final String HR_ZONE_EXTREME = "hrZoneExtreme";
     public static final String HR_ZONE_MAXIMUM = "hrZoneMaximum";
 
+    public static final String TEMPERATURE_AVG = "avg_temperature";
+    public static final String TEMPERATURE_MIN = "min_temperature";
+    public static final String TEMPERATURE_MAX = "max_temperature";
     public static final String RESPIRATION_AVG = "average_respiration_rate";
     public static final String RESPIRATION_MAX = "max_respiration_rate";
     public static final String RESPIRATION_MIN = "min_respiration_rate";
@@ -164,6 +171,7 @@ public class ActivitySummaryEntries {
     public static final String SWOLF_MIN = "swolfMin";
     public static final String SWIM_AVG_CADENCE = "swim_avg_cadence";
 
+    public static final String CALORIES_CONSUMED = "calories_consumed";
     public static final String CALORIES_BURNT = "caloriesBurnt";
     public static final String CALORIES_ACTIVE = "active_calories";
     public static final String CALORIES_RESTING = "restingCalories";
@@ -172,6 +180,7 @@ public class ActivitySummaryEntries {
     public static final String WORKOUT_LOAD = "currentWorkoutLoad";
     public static final String MAXIMUM_OXYGEN_UPTAKE = "maximumOxygenUptake";
     public static final String RECOVERY_TIME = "recoveryTime";
+    public static final String FLUID_CONSUMED = "fluid_consumed";
     public static final String ESTIMATED_SWEAT_LOSS = "estimatedSweatLoss";
     public static final String LACTATE_THRESHOLD_HR = "lactateThresholdHeartRate";
 
@@ -247,6 +256,7 @@ public class ActivitySummaryEntries {
     public static final String GROUP_POWER = "workout_power";
     public static final String GROUP_HEART_RATE = "heart_rate";
     public static final String GROUP_RESPIRATORY_RATE = "respiratoryrate";
+    public static final String GROUP_TEMPERATURE = "menuitem_temperature";
     public static final String GROUP_OTHER = "Other";
     public static final String GROUP_HEART_RATE_ZONES = "HeartRateZones";
     public static final String GROUP_STROKES = "Strokes";
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/GlobalFITMessage.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/GlobalFITMessage.java
index 0b4e7b6d8d..fa85a2d73f 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/GlobalFITMessage.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/GlobalFITMessage.java
@@ -352,7 +352,9 @@ public class GlobalFITMessage {
             new FieldDefinitionPrimitive(168, BaseType.SINT32, "training_load_peak", 65536, 0),
             new FieldDefinitionPrimitive(169, BaseType.UINT16, "enhanced_avg_respiration_rate", 100, 0), // breaths/min
             new FieldDefinitionPrimitive(170, BaseType.UINT16, "enhanced_max_respiration_rate", 100, 0), // breaths/min
+            new FieldDefinitionPrimitive(177, BaseType.UINT16, "calories_consumed"), // kcal
             new FieldDefinitionPrimitive(178, BaseType.UINT16, "estimated_sweat_loss"), // ml
+            new FieldDefinitionPrimitive(179, BaseType.UINT16, "fluid_consumed"), // ml
             new FieldDefinitionPrimitive(180, BaseType.UINT16, "enhanced_min_respiration_rate", 100, 0), // breaths/min
             new FieldDefinitionPrimitive(181, BaseType.FLOAT32, "total_grit"),
             new FieldDefinitionPrimitive(182, BaseType.FLOAT32, "total_flow"),
@@ -369,6 +371,8 @@ public class GlobalFITMessage {
             new FieldDefinitionPrimitive(198, BaseType.UINT8, "hrv_rmssd"), // ms
             new FieldDefinitionPrimitive(199, BaseType.UINT8, "total_fractional_ascent", 100, 0), // m
             new FieldDefinitionPrimitive(200, BaseType.UINT8, "total_fractional_descent", 100, 0), // m
+            new FieldDefinitionPrimitive(203, BaseType.UINT32, "battery_gain"), // minutes
+            new FieldDefinitionPrimitive(204, BaseType.UINT16, "solar_intensity", 100, 0), // %
             new FieldDefinitionPrimitive(205, BaseType.UINT8, "beginning_potential"),
             new FieldDefinitionPrimitive(206, BaseType.UINT8, "ending_potential"),
             new FieldDefinitionPrimitive(207, BaseType.UINT8, "min_stamina"),
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/messages/FitSession.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/messages/FitSession.java
index 3228e67550..caa8b7f5bc 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/messages/FitSession.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/fit/messages/FitSession.java
@@ -970,11 +970,21 @@ public class FitSession extends RecordData {
         return (Float) getFieldByNumber(170);
     }
 
+    @Nullable
+    public Integer getCaloriesConsumed() {
+        return (Integer) getFieldByNumber(177);
+    }
+
     @Nullable
     public Integer getEstimatedSweatLoss() {
         return (Integer) getFieldByNumber(178);
     }
 
+    @Nullable
+    public Integer getFluidConsumed() {
+        return (Integer) getFieldByNumber(179);
+    }
+
     @Nullable
     public Float getEnhancedMinRespirationRate() {
         return (Float) getFieldByNumber(180);
@@ -1055,6 +1065,16 @@ public class FitSession extends RecordData {
         return (Float) getFieldByNumber(200);
     }
 
+    @Nullable
+    public Long getBatteryGain() {
+        return (Long) getFieldByNumber(203);
+    }
+
+    @Nullable
+    public Float getSolarIntensity() {
+        return (Float) getFieldByNumber(204);
+    }
+
     @Nullable
     public Integer getBeginningPotential() {
         return (Integer) getFieldByNumber(205);
@@ -1818,11 +1838,21 @@ public class FitSession extends RecordData {
             return this;
         }
 
+        public Builder setCaloriesConsumed(final Integer value) {
+            setFieldByNumber(177, value);
+            return this;
+        }
+
         public Builder setEstimatedSweatLoss(final Integer value) {
             setFieldByNumber(178, value);
             return this;
         }
 
+        public Builder setFluidConsumed(final Integer value) {
+            setFieldByNumber(179, value);
+            return this;
+        }
+
         public Builder setEnhancedMinRespirationRate(final Float value) {
             setFieldByNumber(180, value);
             return this;
@@ -1903,6 +1933,16 @@ public class FitSession extends RecordData {
             return this;
         }
 
+        public Builder setBatteryGain(final Long value) {
+            setFieldByNumber(203, value);
+            return this;
+        }
+
+        public Builder setSolarIntensity(final Float value) {
+            setFieldByNumber(204, value);
+            return this;
+        }
+
         public Builder setBeginningPotential(final Integer value) {
             setFieldByNumber(205, value);
             return this;
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index 3abef9f981..fe2e87c952 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -2594,6 +2594,9 @@
     <string name="distance_avg">Distance AVG</string>
     <string name="distance_total">Distance Total</string>
     <string name="activeSeconds">Active</string>
+    <string name="calories_consumed">Calories consumed</string>
+    <string name="mountain_bike_grit_score">Grit score</string>
+    <string name="mountain_bike_flow_score">Flow score</string>
     <string name="caloriesBurnt">Calories</string>
     <string name="restingCalories">Resting Calories</string>
     <string name="metabolic_rate">Metabolic Rate</string>
@@ -2610,6 +2613,9 @@
     <string name="averageHR">Avg Heart Rate</string>
     <string name="maxHR">Max Heart Rate</string>
     <string name="minHR">Min Heart Rate</string>
+    <string name="avg_temperature">Avg Temperature</string>
+    <string name="min_temperature">Min Temperature</string>
+    <string name="max_temperature">Max Temperature</string>
     <string name="averageKMPaceSeconds">Avg Pace</string>
     <string name="HeartRateZones">Heart Rate Zones</string>
     <string name="hrZoneNa">N/A</string>
@@ -2633,6 +2639,7 @@
     <string name="anaerobicTrainingEffect">Anaerobic Effect</string>
     <string name="currentWorkoutLoad">Workout Load</string>
     <string name="maximumOxygenUptake">Maximum Oxygen Uptake</string>
+    <string name="fluid_consumed">Fluid consumed</string>
     <string name="estimatedSweatLoss">Estimated Sweat Loss</string>
     <string name="lactateThresholdHeartRate">Lactate Threshold Heart Rate</string>
     <string name="recoveryTime">Recovery Time</string>
@@ -2760,6 +2767,8 @@
     <string name="front_gear_shifts">Front shifts</string>
     <string name="rear_gear_shifts">Rear shifts</string>
     <string name="workout_active_score">Active Score</string>
+    <string name="solar_intensity">Solar intensity</string>
+    <string name="battery_gain">Battery gain</string>
     <string name="vertical_oscillation">Vertical Oscillation</string>
     <string name="ground_contact_time">Ground Contact Time</string>
     <string name="vertical_ratio">Vertical Ratio</string>
```
-----------------------------------
