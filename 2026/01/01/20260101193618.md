# Commit: b2c3f9376ebc691b58cdc634e4b276c9e170684c
## Message: Zendure SolarFlow: Support battery bypass modes

Not sure how exactly this works yet
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSettingsPreferenceConst.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/zendure/SolarFlowDeviceCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/zendure/SolarFlowDeviceSupport.java

app/src/main/res/values/arrays.xml

app/src/main/res/values/strings.xml

app/src/main/res/xml/devicesettings_battery_allow_bypass.xml

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSettingsPreferenceConst.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSettingsPreferenceConst.java
index 2414e36b8a..ede3f7f9af 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSettingsPreferenceConst.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSettingsPreferenceConst.java
@@ -680,6 +680,7 @@ public class DeviceSettingsPreferenceConst {
     public static final String PREF_BATTERY_MINIMUM_CHARGE = "battery_minimum_charge";
     public static final String PREF_BATTERY_MAXIMUM_CHARGE = "battery_maximum_charge";
     public static final String PREF_BATTERY_ALLOW_PASS_THROUGH = "battery_allow_pass_through";
+    public static final String PREF_BATTERY_ALLOW_BYPASS = "battery_allow_bypass";
     public static final String PREF_OUTPUT_POWER_GRID = "output_power_grid";
     public static final String PREF_OFFGRID_MODE = "offgrid_mode";
     public static final String PREF_SOLAR_PANEL1_PEAK_W = "solar_panel1_peak_w";
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsFragment.java
index 76e999a9b7..89fc87f340 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/devicesettings/DeviceSpecificSettingsFragment.java
@@ -1004,6 +1004,7 @@ public class DeviceSpecificSettingsFragment extends AbstractPreferenceFragment i
         addPreferenceHandlerFor(PREF_BATTERY_MINIMUM_CHARGE);
         addPreferenceHandlerFor(PREF_BATTERY_MAXIMUM_CHARGE);
         addPreferenceHandlerFor(PREF_BATTERY_ALLOW_PASS_THROUGH);
+        addPreferenceHandlerFor(PREF_BATTERY_ALLOW_BYPASS);
         addPreferenceHandlerFor(PREF_OUTPUT_POWER_GRID);
         addPreferenceHandlerFor(PREF_OFFGRID_MODE);
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/zendure/SolarFlowDeviceCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/zendure/SolarFlowDeviceCoordinator.java
index d87054123f..3df0d43467 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/zendure/SolarFlowDeviceCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/zendure/SolarFlowDeviceCoordinator.java
@@ -96,6 +96,7 @@ public class SolarFlowDeviceCoordinator extends AbstractBLEDeviceCoordinator {
                 R.xml.devicesettings_solar_panel4_peak_w,
                 R.xml.devicesettings_battery_minimum_charge,
                 R.xml.devicesettings_battery_maximum_charge,
+                R.xml.devicesettings_battery_allow_bypass,
                 R.xml.devicesettings_output_power_grid,
                 R.xml.devicesettings_offgrid_mode_on_off_eco,
                 R.xml.devicesettings_always_on_display,
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/zendure/SolarFlowDeviceSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/zendure/SolarFlowDeviceSupport.java
index c344501d30..40d50ead7b 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/zendure/SolarFlowDeviceSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/zendure/SolarFlowDeviceSupport.java
@@ -17,6 +17,7 @@
 package nodomain.freeyourgadget.gadgetbridge.service.devices.zendure;
 
 import static nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsPreferenceConst.PREF_ALWAYS_ON_DISPLAY;
+import static nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsPreferenceConst.PREF_BATTERY_ALLOW_BYPASS;
 import static nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsPreferenceConst.PREF_BATTERY_MAXIMUM_CHARGE;
 import static nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsPreferenceConst.PREF_BATTERY_MINIMUM_CHARGE;
 import static nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsPreferenceConst.PREF_OFFGRID_MODE;
@@ -62,6 +63,7 @@ public class SolarFlowDeviceSupport extends AbstractBTLESingleDeviceSupport {
     private int gridOffPower = -1;
     private int gridOffMode = -1;
     private int outputHomePower = -1;
+    private int gridReverse = -1;
     private int minSoc = -1;
     private int socSet = -1;
     private int outputLimit = -1;
@@ -177,6 +179,15 @@ public class SolarFlowDeviceSupport extends AbstractBTLESingleDeviceSupport {
                 if (socSet > 100) socSet = 100;
                 sendWriteProperty("socSet", socSet * 10);
             }
+            case PREF_BATTERY_ALLOW_BYPASS -> {
+                String batteryAllowBypass = devicePrefs.getString(PREF_BATTERY_ALLOW_BYPASS, "never");
+                int gridReverse = switch (batteryAllowBypass) {
+                    case "auto" -> 0;
+                    case "always" -> 1;
+                    default -> 2;
+                };
+                sendWriteProperty("gridReverse", gridReverse);
+            }
             case PREF_OUTPUT_POWER_GRID -> {
                 int outputLimit = devicePrefs.getInt(PREF_OUTPUT_POWER_GRID, 800);
                 if (outputLimit < 0) outputLimit = 0;
@@ -255,7 +266,10 @@ public class SolarFlowDeviceSupport extends AbstractBTLESingleDeviceSupport {
                 socSet = properties.getInt("socSet");
             }
             if (properties.has("hyperTmp")) {
-                hyperTmp = (properties.getInt("hyperTmp") - 2731) / 10;
+                hyperTmp = properties.getInt("hyperTmp");
+            }
+            if (properties.has("gridReverse")) {
+                gridReverse = properties.getInt("gridReverse");
             }
             if (properties.has("electricLevel")) {
                 int electricLevel = properties.getInt("electricLevel");
@@ -273,9 +287,7 @@ public class SolarFlowDeviceSupport extends AbstractBTLESingleDeviceSupport {
                     getDevice().sendDeviceUpdateIntent(getContext());
                 }
             }
-            if (properties.has("lampSwitch")) {
-                lampSwitch = properties.getInt("lampSwitch");
-            }
+
 
         } catch (JSONException e) {
             LOG.error("JSON error while parsing report: {}", e.getMessage());
@@ -310,7 +322,7 @@ public class SolarFlowDeviceSupport extends AbstractBTLESingleDeviceSupport {
     private void reportToStatusActivity() {
         Intent intent = new Intent(SolarEquipmentStatusActivity.ACTION_SEND_SOLAR_EQUIPMENT_STATUS)
                 .putExtra(SolarEquipmentStatusActivity.EXTRA_BATTERY_PCT, electricLevel)
-                .putExtra(SolarEquipmentStatusActivity.EXTRA_TEMP1, hyperTmp)
+                .putExtra(SolarEquipmentStatusActivity.EXTRA_TEMP1, (hyperTmp - 2731) / 10)
                 .putExtra(SolarEquipmentStatusActivity.EXTRA_TEMP2, batteryTemp)
                 .putExtra(SolarEquipmentStatusActivity.EXTRA_OUTPUT1_WATT, outputHomePower)
                 .putExtra(SolarEquipmentStatusActivity.EXTRA_OUTPUT2_WATT, gridOffPower)
@@ -326,16 +338,26 @@ public class SolarFlowDeviceSupport extends AbstractBTLESingleDeviceSupport {
     private void syncSettingsToPrefs() {
         Prefs devicePrefs = new Prefs(GBApplication.getDeviceSpecificSharedPrefs(getDevice().getAddress()));
         SharedPreferences.Editor devicePrefsEdit = devicePrefs.getPreferences().edit();
+
         devicePrefsEdit.putString(PREF_BATTERY_MINIMUM_CHARGE, String.valueOf(minSoc/10));
         devicePrefsEdit.putString(PREF_BATTERY_MAXIMUM_CHARGE, String.valueOf(socSet/10));
         devicePrefsEdit.putString(PREF_OUTPUT_POWER_GRID, String.valueOf(outputLimit));
         devicePrefsEdit.putBoolean(PREF_ALWAYS_ON_DISPLAY, lampSwitch != 0);
+
         String offGridMode = switch (gridOffMode) {
             case 0 -> "on";
             case 1 -> "eco";
             default -> "off";
         };
         devicePrefsEdit.putString(PREF_OFFGRID_MODE, offGridMode);
+
+        String batteryAllowBypass = switch (gridReverse) {
+            case 0 -> "auto";
+            case 1 -> "always";
+            default -> "never";
+        };
+        devicePrefsEdit.putString(PREF_BATTERY_ALLOW_BYPASS, batteryAllowBypass);
+
         devicePrefsEdit.apply();
         devicePrefsEdit.commit();
     }
diff --git a/app/src/main/res/values/arrays.xml b/app/src/main/res/values/arrays.xml
index 2294601b6f..f6689309e3 100644
--- a/app/src/main/res/values/arrays.xml
+++ b/app/src/main/res/values/arrays.xml
@@ -5322,9 +5322,23 @@
         <item>@string/off</item>
         <item>@string/eco</item>
     </string-array>
+
     <string-array name="offgrid_mode_on_off_eco_values">
         <item>on</item>
         <item>off</item>
         <item>eco</item>
     </string-array>
+
+    <string-array name="battery_allow_bypass">
+        <item>@string/automatic</item>
+        <item>@string/always</item>
+        <item>@string/never</item>
+    </string-array>
+
+    <string-array name="battery_allow_bypass_values">
+        <item>auto</item>
+        <item>always</item>
+        <item>never</item>
+    </string-array>
+
 </resources>
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index e25a819c2d..0d0dfa4b3e 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -4497,4 +4497,5 @@
     <string name="are_you_sure">Are you sure?</string>
     <string name="dangerous_actions">Dangerous actions</string>
     <string name="debug_other_actions">Other actions</string>
+    <string name="prefs_title_battery_allow_bypass_mode">Allow battery bypass</string>
 </resources>
diff --git a/app/src/main/res/xml/devicesettings_battery_allow_bypass.xml b/app/src/main/res/xml/devicesettings_battery_allow_bypass.xml
new file mode 100644
index 0000000000..d7f29fe3da
--- /dev/null
+++ b/app/src/main/res/xml/devicesettings_battery_allow_bypass.xml
@@ -0,0 +1,11 @@
+<?xml version="1.0" encoding="utf-8"?>
+<androidx.preference.PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:app="http://schemas.android.com/apk/res-auto">
+    <ListPreference
+        android:defaultValue="never"
+        android:entries="@array/battery_allow_bypass"
+        android:entryValues="@array/battery_allow_bypass_values"
+        android:key="battery_allow_bypass"
+        app:useSimpleSummaryProvider="true"
+        android:title="@string/prefs_title_battery_allow_bypass_mode" />
+</androidx.preference.PreferenceScreen>
\ No newline at end of file
```
-----------------------------------
