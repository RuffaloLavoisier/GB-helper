# Commit: 9330d8f96ccee6628537e1d0d4aa417c118b5934
## Message: Ear Fun: Switch to BTBR support class
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/EarFunIOThread.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/EarFunDeviceSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/airpro4/EarFunAirPro4DeviceSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/airs/EarFunAirSDeviceSupport.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/EarFunDeviceSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/EarFunDeviceSupport.java
index e775bde1c2..362fc84bab 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/EarFunDeviceSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/EarFunDeviceSupport.java
@@ -1,38 +1,29 @@
 package nodomain.freeyourgadget.gadgetbridge.service.devices.earfun;
 
-import nodomain.freeyourgadget.gadgetbridge.service.AbstractHeadphoneSerialDeviceSupport;
-import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceIoThread;
-import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;
+import java.util.UUID;
 
-public class EarFunDeviceSupport extends AbstractHeadphoneSerialDeviceSupport {
-    @Override
-    public void onSendConfiguration(String config) {
-        super.onSendConfiguration(config);
+import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
+import nodomain.freeyourgadget.gadgetbridge.service.btbr.TransactionBuilder;
+import nodomain.freeyourgadget.gadgetbridge.service.serial.AbstractHeadphoneSerialDeviceSupportV2;
+
+public class EarFunDeviceSupport extends AbstractHeadphoneSerialDeviceSupportV2<EarFunProtocol> {
+    public static final UUID GAIA_SPP_UUID = UUID.fromString("00001101-0000-1000-8000-00805F9B34FB");
+    private static final UUID GAIA_UUID = UUID.fromString("00001107-D102-11E1-9B23-00025B00A5A5");
+
+    public EarFunDeviceSupport() {
+        addSupportedService(GAIA_SPP_UUID);
     }
 
     @Override
-    public void onTestNewFunction() {
-        super.onTestNewFunction();
-    }
-
-    @Override
-    public synchronized EarFunIOThread getDeviceIOThread() {
-        return (EarFunIOThread) super.getDeviceIOThread();
-    }
-
-    @Override
-    public boolean useAutoConnect() {
-        return false;
-    }
-
-    @Override
-    protected GBDeviceProtocol createDeviceProtocol() {
+    protected EarFunProtocol createDeviceProtocol() {
         return new EarFunProtocol(getDevice());
     }
 
     @Override
-    protected GBDeviceIoThread createDeviceIOThread() {
-        return new EarFunIOThread(getDevice(), getContext(), (EarFunProtocol) getDeviceProtocol(),
-                EarFunDeviceSupport.this, getBluetoothAdapter());
+    protected TransactionBuilder initializeDevice(final TransactionBuilder builder) {
+        builder.setDeviceState(GBDevice.State.INITIALIZED);
+        builder.write(mDeviceProtocol.encodeFirmwareVersionReq());
+        builder.write(mDeviceProtocol.encodeSettingsReq());
+        return builder;
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/EarFunIOThread.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/EarFunIOThread.java
deleted file mode 100644
index 8dc4b78635..0000000000
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/EarFunIOThread.java
+++ /dev/null
@@ -1,54 +0,0 @@
-package nodomain.freeyourgadget.gadgetbridge.service.devices.earfun;
-
-import static nodomain.freeyourgadget.gadgetbridge.util.GB.hexdump;
-
-import android.bluetooth.BluetoothAdapter;
-import android.content.Context;
-import android.os.ParcelUuid;
-
-import androidx.annotation.NonNull;
-
-import org.slf4j.Logger;
-import org.slf4j.LoggerFactory;
-
-import java.io.IOException;
-import java.io.InputStream;
-import java.util.Arrays;
-import java.util.UUID;
-
-import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
-import nodomain.freeyourgadget.gadgetbridge.service.btclassic.BtClassicIoThread;
-
-public class EarFunIOThread extends BtClassicIoThread {
-    private static final Logger LOG = LoggerFactory.getLogger(EarFunIOThread.class);
-    private final EarFunProtocol earFunProtocol;
-    public static final UUID GAIA_SPP_UUID = UUID.fromString("00001101-0000-1000-8000-00805F9B34FB");
-    private static final UUID GAIA_UUID = UUID.fromString("00001107-D102-11E1-9B23-00025B00A5A5");
-
-    @Override
-    @NonNull
-    protected UUID getUuidToConnect(@NonNull ParcelUuid[] uuids) {
-        return GAIA_SPP_UUID;
-    }
-
-    public EarFunIOThread(GBDevice device, Context context, EarFunProtocol deviceProtocol,
-                          EarFunDeviceSupport earFunDeviceSupport, BluetoothAdapter bluetoothAdapter) {
-        super(device, context, deviceProtocol, earFunDeviceSupport, bluetoothAdapter);
-        earFunProtocol = deviceProtocol;
-    }
-
-    @Override
-    protected void initialize() {
-        super.initialize();
-        write(earFunProtocol.encodeFirmwareVersionReq());
-        write(earFunProtocol.encodeSettingsReq());
-    }
-
-    @Override
-    protected byte[] parseIncoming(InputStream inStream) throws IOException {
-        byte[] buffer = new byte[1048576]; //HUGE read
-        int bytes = inStream.read(buffer);
-        LOG.debug("read " + bytes + " bytes. " + hexdump(buffer, 0, bytes));
-        return Arrays.copyOf(buffer, bytes);
-    }
-}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/airpro4/EarFunAirPro4DeviceSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/airpro4/EarFunAirPro4DeviceSupport.java
index 93e007d6c2..cece2494e3 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/airpro4/EarFunAirPro4DeviceSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/airpro4/EarFunAirPro4DeviceSupport.java
@@ -1,12 +1,11 @@
 package nodomain.freeyourgadget.gadgetbridge.service.devices.earfun.airpro4;
 
 import nodomain.freeyourgadget.gadgetbridge.service.devices.earfun.EarFunDeviceSupport;
-import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;
 
 public class EarFunAirPro4DeviceSupport extends EarFunDeviceSupport {
 
     @Override
-    protected GBDeviceProtocol createDeviceProtocol() {
+    protected EarFunAirPro4Protocol createDeviceProtocol() {
         return new EarFunAirPro4Protocol(getDevice());
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/airs/EarFunAirSDeviceSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/airs/EarFunAirSDeviceSupport.java
index eb16b14580..335b6fd8c0 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/airs/EarFunAirSDeviceSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/earfun/airs/EarFunAirSDeviceSupport.java
@@ -1,12 +1,11 @@
 package nodomain.freeyourgadget.gadgetbridge.service.devices.earfun.airs;
 
 import nodomain.freeyourgadget.gadgetbridge.service.devices.earfun.EarFunDeviceSupport;
-import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;
 
 public class EarFunAirSDeviceSupport extends EarFunDeviceSupport {
 
     @Override
-    protected GBDeviceProtocol createDeviceProtocol() {
+    protected EarFunAirSProtocol createDeviceProtocol() {
         return new EarFunAirSProtocol(getDevice());
     }
 }
```
-----------------------------------
