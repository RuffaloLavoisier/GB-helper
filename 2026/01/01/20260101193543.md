# Commit: 8b18830e9a5de067edc522c115f86f3de4874989
## Message: Soundcore Motion 300: Switch to BTBR support class
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/motion300/SoundcoreMotion300DeviceSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/motion300/SoundcoreMotion300IOThread.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/motion300/SoundcoreMotion300DeviceSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/motion300/SoundcoreMotion300DeviceSupport.java
index 7c7ed5267f..cf1ff9e90c 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/motion300/SoundcoreMotion300DeviceSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/motion300/SoundcoreMotion300DeviceSupport.java
@@ -16,28 +16,44 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.service.devices.soundcore.motion300;
 
-import nodomain.freeyourgadget.gadgetbridge.service.AbstractHeadphoneSerialDeviceSupport;
-import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceIoThread;
-import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;
+import android.os.Handler;
 
-public class SoundcoreMotion300DeviceSupport extends AbstractHeadphoneSerialDeviceSupport {
-    @Override
-    public boolean useAutoConnect() {
-        return false;
+import java.util.UUID;
+
+import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
+import nodomain.freeyourgadget.gadgetbridge.service.btbr.TransactionBuilder;
+import nodomain.freeyourgadget.gadgetbridge.service.serial.AbstractHeadphoneSerialDeviceSupportV2;
+
+public class SoundcoreMotion300DeviceSupport extends AbstractHeadphoneSerialDeviceSupportV2<SoundcoreMotion300Protocol> {
+    private final Handler handler = new Handler();
+
+    public SoundcoreMotion300DeviceSupport() {
+        addSupportedService(UUID.fromString("0cf12d31-fac3-4553-bd80-d6832e7b3135"));
     }
 
     @Override
-    protected GBDeviceProtocol createDeviceProtocol() {
+    protected SoundcoreMotion300Protocol createDeviceProtocol() {
         return new SoundcoreMotion300Protocol(getDevice());
     }
 
     @Override
-    protected GBDeviceIoThread createDeviceIOThread() {
-        return new SoundcoreMotion300IOThread(
-                getDevice(),
-                getContext(),
-                (SoundcoreMotion300Protocol)getDeviceProtocol(),
-                SoundcoreMotion300DeviceSupport.this,
-                getBluetoothAdapter());
+    protected TransactionBuilder initializeDevice(final TransactionBuilder builder) {
+        // Device requires a little delay to respond to commands
+        handler.postDelayed(() -> {
+            final TransactionBuilder builderDelayed = createTransactionBuilder("initialize delayed");
+            builderDelayed.write(mDeviceProtocol.encodeGetDeviceInfo());
+            builderDelayed.queue();
+        }, 500);
+
+        builder.setDeviceState(GBDevice.State.INITIALIZING);
+        return builder;
+    }
+
+    @Override
+    public void dispose() {
+        synchronized (ConnectionMonitor) {
+            handler.removeCallbacksAndMessages(null);
+            super.dispose();
+        }
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/motion300/SoundcoreMotion300IOThread.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/motion300/SoundcoreMotion300IOThread.java
deleted file mode 100644
index 8adc3ae62a..0000000000
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/motion300/SoundcoreMotion300IOThread.java
+++ /dev/null
@@ -1,76 +0,0 @@
-/*  Copyright (C) 2024 Severin von Wnuck-Lipinski
-
-    This file is part of Gadgetbridge.
-
-    Gadgetbridge is free software: you can redistribute it and/or modify
-    it under the terms of the GNU Affero General Public License as published
-    by the Free Software Foundation, either version 3 of the License, or
-    (at your option) any later version.
-
-    Gadgetbridge is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU Affero General Public License for more details.
-
-    You should have received a copy of the GNU Affero General Public License
-    along with this program.  If not, see <https://www.gnu.org/licenses/>. */
-package nodomain.freeyourgadget.gadgetbridge.service.devices.soundcore.motion300;
-
-import android.bluetooth.BluetoothAdapter;
-import android.content.Context;
-import android.os.Handler;
-import android.os.ParcelUuid;
-import androidx.annotation.NonNull;
-
-import org.slf4j.Logger;
-import org.slf4j.LoggerFactory;
-
-import java.io.IOException;
-import java.io.InputStream;
-import java.util.Arrays;
-import java.util.UUID;
-
-import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
-import nodomain.freeyourgadget.gadgetbridge.service.btclassic.BtClassicIoThread;
-
-import static nodomain.freeyourgadget.gadgetbridge.util.GB.hexdump;
-
-public class SoundcoreMotion300IOThread extends BtClassicIoThread {
-    private static final Logger LOG = LoggerFactory.getLogger(SoundcoreMotion300IOThread.class);
-
-    private final SoundcoreMotion300Protocol protocol;
-    private final Handler handler = new Handler();
-
-    public SoundcoreMotion300IOThread(
-            GBDevice device,
-            Context context,
-            SoundcoreMotion300Protocol protocol,
-            SoundcoreMotion300DeviceSupport support,
-            BluetoothAdapter adapter) {
-        super(device, context, protocol, support, adapter);
-        this.protocol = protocol;
-    }
-
-    @Override
-    protected void initialize() {
-        setUpdateState(GBDevice.State.INITIALIZING);
-
-        // Device requires a little delay to respond to commands
-        handler.postDelayed(() -> write(protocol.encodeGetDeviceInfo()), 500);
-    }
-
-    @Override
-    @NonNull
-    protected UUID getUuidToConnect(@NonNull ParcelUuid[] uuids) {
-        return UUID.fromString("0cf12d31-fac3-4553-bd80-d6832e7b3135");
-    }
-
-    @Override
-    protected byte[] parseIncoming(InputStream stream) throws IOException {
-        byte[] buffer = new byte[1048576];
-        int bytes = stream.read(buffer);
-        LOG.debug("read " + bytes + " bytes. " + hexdump(buffer, 0, bytes));
-
-        return Arrays.copyOf(buffer, bytes);
-    }
-}
```
-----------------------------------
