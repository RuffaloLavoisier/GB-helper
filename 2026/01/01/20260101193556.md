# Commit: 4443b947309bfdbac7d833711d877b0a7c18859d
## Message: Improve Gadgetbridge restart

- Close the database
- Ensure we go back to the start activity
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/BackupRestoreProgressActivity.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseDebugFragment.kt

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java
index fa5662221f..8d73cf4a27 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java
@@ -212,6 +212,14 @@ public class GBApplication extends Application {
         LocalBroadcastManager.getInstance(context).sendBroadcast(quitIntent);
         GBApplication.deviceService().quit();
 
+        if (lockHandler != null) {
+            try {
+                lockHandler.closeDb();
+            } catch (final Exception e) {
+                GB.log("Failed to close DB before restart", GB.ERROR, e);
+            }
+        }
+
         final Intent startActivity = new Intent(context, ControlCenterv2.class);
         final PendingIntent pendingIntent = PendingIntent.getActivity(
                 context,
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/BackupRestoreProgressActivity.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/BackupRestoreProgressActivity.java
index 29cb1e4fe9..a0f23f3bc2 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/BackupRestoreProgressActivity.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/BackupRestoreProgressActivity.java
@@ -125,11 +125,11 @@ public class BackupRestoreProgressActivity extends AbstractGBActivity {
                                     .setTitle(R.string.backup_restore_restart_title)
                                     .setMessage(message.toString())
                                     .setOnCancelListener((dialog -> {
-                                        finish();
+                                        finishAffinity();
                                         GBApplication.restart();
                                     }))
                                     .setPositiveButton(R.string.ok, (dialog, which) -> {
-                                        finish();
+                                        finishAffinity();
                                         GBApplication.restart();
                                     }).show();
                             break;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseDebugFragment.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseDebugFragment.kt
index 50d559ef3d..25bd5793df 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseDebugFragment.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/DatabaseDebugFragment.kt
@@ -85,6 +85,7 @@ class DatabaseDebugFragment : AbstractDebugFragment() {
                         Toast.LENGTH_SHORT,
                         GB.INFO
                     )
+                    requireActivity().finishAffinity()
                     GBApplication.restart()
                 } else {
                     GB.toast(
```
-----------------------------------
