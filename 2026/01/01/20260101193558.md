# Commit: e9c101ade880846c1c4e1fcd98395321cfad0300
## Message: Garmin: Refactor HTTP interceptors
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/HttpHandler.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/AgpsInterceptor.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/ContactsInterceptor.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/HttpInterceptor.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/ImageServiceInterceptor.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/OauthInterceptor.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/WeatherInterceptor.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/agps/AgpsHandler.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/ContactsHandler.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/ImageServiceHandler.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/OauthHandler.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/WeatherHandler.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/HttpHandler.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/HttpHandler.java
index d8cc4fad14..95d0f89f7a 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/HttpHandler.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/HttpHandler.java
@@ -1,5 +1,7 @@
 package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http;
 
+import androidx.annotation.Nullable;
+
 import com.google.protobuf.ByteString;
 
 import org.slf4j.Logger;
@@ -7,27 +9,34 @@ import org.slf4j.LoggerFactory;
 
 import java.io.ByteArrayOutputStream;
 import java.util.ArrayList;
+import java.util.Arrays;
 import java.util.List;
 import java.util.Map;
+import java.util.Optional;
 import java.util.zip.GZIPOutputStream;
 
 import nodomain.freeyourgadget.gadgetbridge.proto.garmin.GdiHttpService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.GarminSupport;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.agps.AgpsHandler;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.interceptors.AgpsInterceptor;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.interceptors.ContactsInterceptor;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.interceptors.HttpInterceptor;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.interceptors.ImageServiceInterceptor;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.interceptors.OauthInterceptor;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.interceptors.WeatherInterceptor;
 
 public class HttpHandler {
     private static final Logger LOG = LoggerFactory.getLogger(HttpHandler.class);
 
-    private final AgpsHandler agpsHandler;
-    private final ContactsHandler contactsHandler;
-    private final OauthHandler oauthHandler;
-    private final ImageServiceHandler imageServiceHandler;
+    private final List<HttpInterceptor> interceptors;
 
     public HttpHandler(GarminSupport deviceSupport) {
-        agpsHandler = new AgpsHandler(deviceSupport);
-        contactsHandler = new ContactsHandler(deviceSupport);
-        oauthHandler = new OauthHandler(deviceSupport);
-        imageServiceHandler = new ImageServiceHandler(deviceSupport);
+        interceptors = Arrays.asList(
+                new WeatherInterceptor(),
+                new AgpsInterceptor(deviceSupport),
+                new ImageServiceInterceptor(deviceSupport),
+                new ContactsInterceptor(deviceSupport),
+                new OauthInterceptor(deviceSupport)
+        );
     }
 
     public GdiHttpService.HttpService handle(final GdiHttpService.HttpService httpService) {
@@ -59,26 +68,7 @@ public class HttpHandler {
 
         final GarminHttpRequest request = new GarminHttpRequest(rawRequest);
 
-        final GarminHttpResponse response;
-        if (request.getPath().startsWith("/weather/")) {
-            LOG.info("Got weather request for {}", request.getPath());
-            response = WeatherHandler.handleWeatherRequest(request);
-        } else if (request.getPath().startsWith("/ephemeris/")) {
-            LOG.info("Got AGPS request for {}", request.getPath());
-            response = agpsHandler.handleAgpsRequest(request);
-        } else if (request.getPath().startsWith("/device-gateway/usercontact/")) {
-            LOG.info("Got contacts request for {}", request.getPath());
-            response = contactsHandler.handleRequest(request);
-        } else if (request.getPath().startsWith("/api/oauth") || request.getPath().startsWith("/oauthTokenExchangeService")) {
-            LOG.info("Got OAuth request for {}", request.getPath());
-            response = oauthHandler.handleRequest(request);
-        } else if (request.getPath().startsWith("/image-service/")) {
-            LOG.info("Got image service request for {}", request.getPath());
-            response = imageServiceHandler.handleRequest(request);
-        } else {
-            LOG.warn("Unhandled path {}", request.getPath());
-            response = null;
-        }
+        final GarminHttpResponse response = handleRequest(request);
 
         if (response == null) {
             return GdiHttpService.HttpService.RawResponse.newBuilder()
@@ -91,6 +81,22 @@ public class HttpHandler {
         return createRawResponse(request, response);
     }
 
+    @Nullable
+    private GarminHttpResponse handleRequest(final GarminHttpRequest request) {
+        final Optional<HttpInterceptor> interceptorOpt = interceptors.stream()
+                .filter(it -> it.supports(request))
+                .findFirst();
+
+        if (interceptorOpt.isEmpty()) {
+            LOG.warn("No interceptor for {}", request.getPath());
+            return null;
+        }
+
+        final HttpInterceptor interceptor = interceptorOpt.get();
+        LOG.debug("Handling request to {}", interceptor.getClass().getSimpleName());
+        return interceptor.handle(request);
+    }
+
     private static GdiHttpService.HttpService.RawResponse createRawResponse(
             final GarminHttpRequest request,
             final GarminHttpResponse response
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/agps/AgpsHandler.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/AgpsInterceptor.java
similarity index 89%
rename from app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/agps/AgpsHandler.java
rename to app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/AgpsInterceptor.java
index ef86c64e8a..7e07aec237 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/agps/AgpsHandler.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/AgpsInterceptor.java
@@ -1,7 +1,11 @@
-package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.agps;
+package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.interceptors;
+
+import android.net.Uri;
 
 import androidx.documentfile.provider.DocumentFile;
 
+import org.jetbrains.annotations.NotNull;
+import org.jetbrains.annotations.Nullable;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -18,6 +22,8 @@ import java.util.concurrent.Callable;
 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventUpdatePreferences;
 import nodomain.freeyourgadget.gadgetbridge.devices.garmin.GarminPreferences;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.GarminSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.agps.GarminAgpsFile;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.agps.GarminAgpsStatus;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.GarminHttpRequest;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.GarminHttpResponse;
 import nodomain.freeyourgadget.gadgetbridge.util.CheckSums;
@@ -25,16 +31,23 @@ import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
 
-public class AgpsHandler {
-    private static final Logger LOG = LoggerFactory.getLogger(AgpsHandler.class);
+public class AgpsInterceptor implements HttpInterceptor {
+    private static final Logger LOG = LoggerFactory.getLogger(AgpsInterceptor.class);
     private static final String QUERY_CONSTELLATIONS = "constellations";
     private final GarminSupport deviceSupport;
 
-    public AgpsHandler(GarminSupport deviceSupport) {
+    public AgpsInterceptor(final GarminSupport deviceSupport) {
         this.deviceSupport = deviceSupport;
     }
 
-    public GarminHttpResponse handleAgpsRequest(final GarminHttpRequest request) {
+    @Override
+    public boolean supports(@NotNull final GarminHttpRequest request) {
+        return request.getPath().startsWith("/ephemeris/");
+    }
+
+    @Override
+    @Nullable
+    public GarminHttpResponse handle(@NotNull final GarminHttpRequest request) {
         saveKnownUrl(request.getUrl());
 
         try {
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/ContactsHandler.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/ContactsInterceptor.java
similarity index 86%
rename from app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/ContactsHandler.java
rename to app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/ContactsInterceptor.java
index 4255718942..2aea8018ff 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/ContactsHandler.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/ContactsInterceptor.java
@@ -1,5 +1,7 @@
-package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http;
+package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.interceptors;
 
+import org.jetbrains.annotations.NotNull;
+import org.jetbrains.annotations.Nullable;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -14,18 +16,27 @@ import nodomain.freeyourgadget.gadgetbridge.entities.Contact;
 import nodomain.freeyourgadget.gadgetbridge.model.ActivityUser;
 import nodomain.freeyourgadget.gadgetbridge.proto.garmin.GarminContacts;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.GarminSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.GarminHttpRequest;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.GarminHttpResponse;
 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
 
-public class ContactsHandler {
-    private static final Logger LOG = LoggerFactory.getLogger(ContactsHandler.class);
+public class ContactsInterceptor implements HttpInterceptor {
+    private static final Logger LOG = LoggerFactory.getLogger(ContactsInterceptor.class);
 
     private final GarminSupport deviceSupport;
 
-    public ContactsHandler(final GarminSupport deviceSupport) {
+    public ContactsInterceptor(final GarminSupport deviceSupport) {
         this.deviceSupport = deviceSupport;
     }
 
-    public GarminHttpResponse handleRequest(final GarminHttpRequest request) {
+    @Override
+    public boolean supports(@NotNull final GarminHttpRequest request) {
+        return request.getPath().startsWith("/device-gateway/usercontact/");
+    }
+
+    @Override
+    @Nullable
+    public GarminHttpResponse handle(@NotNull final GarminHttpRequest request) {
         if (!request.getPath().equals("/device-gateway/usercontact/contacts")) {
             LOG.warn("Unknown contacts path {}", request.getPath());
             return null;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/HttpInterceptor.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/HttpInterceptor.kt
new file mode 100644
index 0000000000..d624b474e4
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/HttpInterceptor.kt
@@ -0,0 +1,10 @@
+package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.interceptors
+
+import android.net.Uri
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.GarminHttpRequest
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.GarminHttpResponse
+
+interface HttpInterceptor {
+    fun supports(request: GarminHttpRequest): Boolean
+    fun handle(request: GarminHttpRequest): GarminHttpResponse?
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/ImageServiceHandler.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/ImageServiceInterceptor.java
similarity index 88%
rename from app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/ImageServiceHandler.java
rename to app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/ImageServiceInterceptor.java
index fcf0d15037..4805aa5cab 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/ImageServiceHandler.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/ImageServiceInterceptor.java
@@ -1,4 +1,4 @@
-package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http;
+package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.interceptors;
 
 import android.graphics.Bitmap;
 import android.graphics.Canvas;
@@ -9,6 +9,8 @@ import androidx.annotation.NonNull;
 import com.google.gson.Gson;
 import com.google.gson.GsonBuilder;
 
+import org.jetbrains.annotations.NotNull;
+import org.jetbrains.annotations.Nullable;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -23,10 +25,12 @@ import java.util.UUID;
 import nodomain.freeyourgadget.gadgetbridge.proto.garmin.GdiHttpService;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.GarminSupport;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.GarminHttpRequest;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.GarminHttpResponse;
 import nodomain.freeyourgadget.gadgetbridge.util.NotificationUtils;
 
-public class ImageServiceHandler {
-    private static final Logger LOG = LoggerFactory.getLogger(ImageServiceHandler.class);
+public class ImageServiceInterceptor implements HttpInterceptor {
+    private static final Logger LOG = LoggerFactory.getLogger(ImageServiceInterceptor.class);
 
     private static final Gson GSON = new GsonBuilder()
             //.serializeNulls()
@@ -34,11 +38,18 @@ public class ImageServiceHandler {
 
     private final GarminSupport deviceSupport;
 
-    public ImageServiceHandler(final GarminSupport deviceSupport) {
+    public ImageServiceInterceptor(final GarminSupport deviceSupport) {
         this.deviceSupport = deviceSupport;
     }
 
-    public GarminHttpResponse handleRequest(final GarminHttpRequest request) {
+    @Override
+    public boolean supports(@NotNull final GarminHttpRequest request) {
+        return request.getPath().startsWith("/image-service/");
+    }
+
+    @Override
+    @Nullable
+    public GarminHttpResponse handle(@NotNull final GarminHttpRequest request) {
         if (request.getRawRequest().getMethod() != GdiHttpService.HttpService.Method.GET) {
             LOG.warn("Known image service requests should be GET");
             return null;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/OauthHandler.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/OauthInterceptor.java
similarity index 87%
rename from app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/OauthHandler.java
rename to app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/OauthInterceptor.java
index 6b50362094..5268ffefd7 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/OauthHandler.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/OauthInterceptor.java
@@ -1,8 +1,10 @@
-package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http;
+package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.interceptors;
 
 import com.google.gson.Gson;
 import com.google.gson.GsonBuilder;
 
+import org.jetbrains.annotations.NotNull;
+import org.jetbrains.annotations.Nullable;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -16,10 +18,11 @@ import java.util.stream.Collectors;
 import nodomain.freeyourgadget.gadgetbridge.proto.garmin.GdiHttpService;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.GarminPrefs;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.GarminSupport;
-import nodomain.freeyourgadget.gadgetbridge.util.preferences.DevicePrefs;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.GarminHttpRequest;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.GarminHttpResponse;
 
-public class OauthHandler {
-    private static final Logger LOG = LoggerFactory.getLogger(OauthHandler.class);
+public class OauthInterceptor implements HttpInterceptor {
+    private static final Logger LOG = LoggerFactory.getLogger(OauthInterceptor.class);
 
     private static final Gson GSON = new GsonBuilder()
             //.serializeNulls()
@@ -27,11 +30,18 @@ public class OauthHandler {
 
     private final GarminSupport deviceSupport;
 
-    public OauthHandler(final GarminSupport deviceSupport) {
+    public OauthInterceptor(final GarminSupport deviceSupport) {
         this.deviceSupport = deviceSupport;
     }
 
-    public GarminHttpResponse handleRequest(final GarminHttpRequest request) {
+    @Override
+    public boolean supports(@NotNull final GarminHttpRequest request) {
+        return request.getPath().startsWith("/api/oauth") || request.getPath().startsWith("/oauthTokenExchangeService");
+    }
+
+    @Override
+    @Nullable
+    public GarminHttpResponse handle(@NotNull final GarminHttpRequest request) {
         if (request.getRawRequest().getMethod() != GdiHttpService.HttpService.Method.POST) {
             LOG.warn("Known OAuth requests should be POST");
             return null;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/WeatherHandler.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/WeatherInterceptor.java
similarity index 96%
rename from app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/WeatherHandler.java
rename to app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/WeatherInterceptor.java
index 7ab1270b6d..5d650b853f 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/WeatherHandler.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/http/interceptors/WeatherInterceptor.java
@@ -1,4 +1,4 @@
-package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http;
+package nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.interceptors;
 
 import android.location.Location;
 
@@ -9,6 +9,8 @@ import net.e175.klaus.solarpositioning.DeltaT;
 import net.e175.klaus.solarpositioning.SPA;
 import net.e175.klaus.solarpositioning.SunriseTransitSet;
 
+import org.jetbrains.annotations.NotNull;
+import org.jetbrains.annotations.Nullable;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -27,18 +29,27 @@ import nodomain.freeyourgadget.gadgetbridge.model.weather.Weather;
 import nodomain.freeyourgadget.gadgetbridge.model.weather.WeatherMapper;
 import nodomain.freeyourgadget.gadgetbridge.model.WeatherSpec;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.BLETypeConversions;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.GarminHttpRequest;
+import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.http.GarminHttpResponse;
 import nodomain.freeyourgadget.gadgetbridge.webview.CurrentPosition;
 
 @SuppressWarnings("unused")
-public class WeatherHandler {
-    private static final Logger LOG = LoggerFactory.getLogger(WeatherHandler.class);
+public class WeatherInterceptor implements HttpInterceptor {
+    private static final Logger LOG = LoggerFactory.getLogger(WeatherInterceptor.class);
 
     private static final Gson GSON = new GsonBuilder()
             //.serializeNulls()
             .create();
 
-    // These get requested on connection at most every 5 minutes
-    public static GarminHttpResponse handleWeatherRequest(final GarminHttpRequest request) {
+    @Override
+    public boolean supports(@NotNull final GarminHttpRequest request) {
+        return request.getPath().startsWith("/weather/");
+    }
+
+    /// These get requested on connection at most every 5 minutes
+    @Override
+    @Nullable
+    public GarminHttpResponse handle(@NotNull final GarminHttpRequest request) {
         final String path = request.getPath();
         final Map<String, String> query = request.getQuery();
 
```
-----------------------------------
