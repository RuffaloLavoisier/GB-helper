# Commit: c5d9e450062624e96a5d4c3ddb3e6ed011aac88c
## Message: Make app manager device-agnostic (pt1)
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/ExternalPebbleJSActivity.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AbstractAppManagerFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AppManagerFragmentInstalledApps.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventAppInfo.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/pebble/PebbleCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/impl/GBDeviceApp.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/qhybrid/adapter/fossil_hr/FossilHRWatchAdapter.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/ExternalPebbleJSActivity.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/ExternalPebbleJSActivity.java
index 19fe885148..6211e15657 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/ExternalPebbleJSActivity.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/ExternalPebbleJSActivity.java
@@ -109,6 +109,9 @@ public class ExternalPebbleJSActivity extends AbstractGBActivity {
 
         Objects.requireNonNull(currentDevice, "Must provide a device when invoking this activity");
         Objects.requireNonNull(currentUUID, "Must provide a uuid when invoking this activity");
+
+        GBApplication.deviceService(currentDevice).onAppStart(currentUUID, true);
+
         setupWebView(currentDevice, currentUUID);
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AbstractAppManagerFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AbstractAppManagerFragment.java
index 86e28ab7ba..2e63debcd6 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AbstractAppManagerFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AbstractAppManagerFragment.java
@@ -33,6 +33,7 @@ import android.net.Uri;
 import android.os.Bundle;
 import android.os.Handler;
 import android.os.Looper;
+import android.os.Parcelable;
 import android.view.LayoutInflater;
 import android.view.Menu;
 import android.view.MenuItem;
@@ -92,12 +93,12 @@ import nodomain.freeyourgadget.gadgetbridge.util.InternetHelperSingleton;
 import nodomain.freeyourgadget.gadgetbridge.util.InternetUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.PebbleUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.Version;
-import nodomain.freeyourgadget.gadgetbridge.util.preferences.DevicePrefs;
 
 
 public abstract class AbstractAppManagerFragment extends Fragment {
     public static final String ACTION_REFRESH_APPLIST
             = "nodomain.freeyourgadget.gadgetbridge.appmanager.action.refresh_applist";
+    public static final String EXTRA_APP_LIST = "app_list";
     private static final Logger LOG = LoggerFactory.getLogger(AbstractAppManagerFragment.class);
     private static final int CHILD_ACTIVITY_WATCHFACE_EDITOR = 0;
 
@@ -197,13 +198,23 @@ public abstract class AbstractAppManagerFragment extends Fragment {
         final Map<UUID, GBDeviceApp> cachedAppsMap = getCachedAppsMap(null);
 
         appList.clear();
-        int appCount = intent.getIntExtra("app_count", 0);
-        for (int i = 0; i < appCount; i++) {
-            String appName = intent.getStringExtra("app_name" + i);
-            String appCreator = intent.getStringExtra("app_creator" + i);
-            String appVersion = intent.getStringExtra("app_version" + i);
-            UUID uuid = UUID.fromString(intent.getStringExtra("app_uuid" + i));
-            GBDeviceApp.Type appType = GBDeviceApp.Type.values()[intent.getIntExtra("app_type" + i, 0)];
+        final Parcelable[] parcelables = intent.getParcelableArrayExtra(EXTRA_APP_LIST);
+        if (parcelables == null) {
+            LOG.error("App list is null - this should never happen");
+            return;
+        }
+        final GBDeviceApp[] apps = new GBDeviceApp[parcelables.length];
+
+        for (int i = 0; i < parcelables.length; i++) {
+            apps[i] = (GBDeviceApp) parcelables[i];
+        }
+
+        for (final GBDeviceApp appFromIntent : apps) {
+            String appName = appFromIntent.getName();
+            String appCreator = appFromIntent.getCreator();
+            String appVersion = appFromIntent.getVersion();
+            UUID uuid = appFromIntent.getUUID();
+            GBDeviceApp.Type appType = appFromIntent.getType();
             Bitmap previewImage = getAppPreviewImage(uuid.toString());
 
             // Fill out information from the cached app if missing
@@ -223,31 +234,14 @@ public abstract class AbstractAppManagerFragment extends Fragment {
             }
 
             GBDeviceApp app = new GBDeviceApp(uuid, appName, appCreator, appVersion, appType, previewImage);
+            app.setConfigurable(appFromIntent.isConfigurable());
+            app.setUpToDate(appFromIntent.isUpToDate());
             app.setOnDevice(true);
-            if (mGBDevice.getType() == DeviceType.FOSSILQHYBRID) {
-                if ((app.getType() == GBDeviceApp.Type.WATCHFACE) && (!QHybridConstants.HYBRIDHR_WATCHFACE_VERSION.equals(appVersion))) {
-                    app.setUpToDate(false);
-                }
-                try {
-                    if ((app.getType() == GBDeviceApp.Type.APP_GENERIC) && ((new Version(app.getVersion())).smallerThan(new Version(QHybridConstants.KNOWN_WAPP_VERSIONS.get(app.getName()))))) {
-                        app.setUpToDate(false);
-                    }
-                } catch (IllegalArgumentException e) {
-                    LOG.warn("App JSON: " + app.getJSON().toString());
-                    LOG.warn("Couldn't read app version", e);
-                }
-            }
 
             if (filterApp(app)) {
                 appList.add(app);
             }
         }
-        if (mGBDevice.getType() == DeviceType.FOSSILQHYBRID) {
-            List<GBDeviceApp> systemApps = getSystemAppsInCategory();
-            for (GBDeviceApp systemApp : systemApps) {
-                appList.add(systemApp);
-            }
-        }
     }
 
     private Bitmap getAppPreviewImage(String name) {
@@ -273,7 +267,7 @@ public abstract class AbstractAppManagerFragment extends Fragment {
             }
             switch (action) {
                 case ACTION_REFRESH_APPLIST: {
-                    if (intent.hasExtra("app_count")) {
+                    if (intent.hasExtra(EXTRA_APP_LIST)) {
                         LOG.info("got app info from device");
                         if (!isCacheManager()) {
                             LOG.info("will refresh list based on data from device");
@@ -715,9 +709,9 @@ public abstract class AbstractAppManagerFragment extends Fragment {
             GBApplication.deviceService(mGBDevice).onAppDelete(selectedApp.getUUID());
             return true;
         } else if (itemId == R.id.appmanager_app_configure) {
-            GBApplication.deviceService(mGBDevice).onAppStart(selectedApp.getUUID(), true);
+            final Class<? extends Activity> appConfigurationActivity = mGBDevice.getDeviceCoordinator().getAppConfigurationActivity(mGBDevice);
 
-            final Intent startIntent = new Intent(getContext().getApplicationContext(), ExternalPebbleJSActivity.class);
+            final Intent startIntent = new Intent(requireContext().getApplicationContext(), appConfigurationActivity);
             startIntent.putExtra(DeviceService.EXTRA_APP_UUID, selectedApp.getUUID());
             startIntent.putExtra(GBDevice.EXTRA_DEVICE, mGBDevice);
             startActivity(startIntent);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AppManagerFragmentInstalledApps.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AppManagerFragmentInstalledApps.java
index 2f07bf9536..a0c4b24349 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AppManagerFragmentInstalledApps.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AppManagerFragmentInstalledApps.java
@@ -53,8 +53,6 @@ public class AppManagerFragmentInstalledApps extends AbstractAppManagerFragment
                     systemApps.add(new GBDeviceApp(PebbleProtocol.UUID_WEATHER, "Weather (System)", "Pebble Inc.", "", GBDeviceApp.Type.APP_SYSTEM));
                 }
             }
-        } else if (mGBDevice.getType() == DeviceType.FOSSILQHYBRID) {
-            systemApps.add(new GBDeviceApp(UUID.nameUUIDFromBytes("workoutApp".getBytes(StandardCharsets.UTF_8)), "workoutApp", "", "", GBDeviceApp.Type.APP_ACTIVITYTRACKER));
         }
 
         return systemApps;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventAppInfo.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventAppInfo.java
index cae0e60ecf..98ccef0c8f 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventAppInfo.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/deviceevents/GBDeviceEventAppInfo.java
@@ -36,18 +36,10 @@ public class GBDeviceEventAppInfo extends GBDeviceEvent {
 
     @Override
     public void evaluate(final Context context, final GBDevice device) {
-        LOG.info("Got event for APP_INFO");
+        LOG.info("Got event for APP_INFO with {} apps", apps.length);
 
-        Intent appInfoIntent = new Intent(AbstractAppManagerFragment.ACTION_REFRESH_APPLIST);
-        int appCount = apps.length;
-        appInfoIntent.putExtra("app_count", appCount);
-        for (int i = 0; i < appCount; i++) {
-            appInfoIntent.putExtra("app_name" + i, apps[i].getName());
-            appInfoIntent.putExtra("app_creator" + i, apps[i].getCreator());
-            appInfoIntent.putExtra("app_version" + i, apps[i].getVersion());
-            appInfoIntent.putExtra("app_uuid" + i, apps[i].getUUID().toString());
-            appInfoIntent.putExtra("app_type" + i, apps[i].getType().ordinal());
-        }
+        final Intent appInfoIntent = new Intent(AbstractAppManagerFragment.ACTION_REFRESH_APPLIST);
+        appInfoIntent.putExtra(AbstractAppManagerFragment.EXTRA_APP_LIST, apps);
         LocalBroadcastManager.getInstance(context).sendBroadcast(appInfoIntent);
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java
index ff1190c4da..686d507094 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinator.java
@@ -57,6 +57,7 @@ import de.greenrobot.dao.query.QueryBuilder;
 import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.GBException;
 import nodomain.freeyourgadget.gadgetbridge.R;
+import nodomain.freeyourgadget.gadgetbridge.activities.ExternalPebbleJSActivity;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsPreferenceConst;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSpecificSettings;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSpecificSettingsCustomizer;
@@ -587,6 +588,12 @@ public abstract class AbstractDeviceCoordinator implements DeviceCoordinator {
         return null;
     }
 
+    @Nullable
+    @Override
+    public Class<? extends Activity> getAppConfigurationActivity(final GBDevice device) {
+        return null;
+    }
+
     @Override
     public int getBondingStyle() {
         return BONDING_STYLE_ASK;
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java
index 32a3dc4aeb..494e3ea2e2 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/DeviceCoordinator.java
@@ -620,11 +620,16 @@ public interface DeviceCoordinator {
 
     /**
      * Returns the Activity class that will be used to download apps/watchfaces.
-     *
-     * @return
      */
+    @Nullable
     Class<? extends Activity> getAppStoreActivity(GBDevice device);
 
+    /**
+     * Returns the Activity class that will be used to configure apps.
+     */
+    @Nullable
+    Class<? extends Activity> getAppConfigurationActivity(GBDevice device);
+
     /**
      * Returns the device app cache directory.
      */
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/pebble/PebbleCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/pebble/PebbleCoordinator.java
index c225f5d4ba..8e33ad2a25 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/pebble/PebbleCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/pebble/PebbleCoordinator.java
@@ -37,6 +37,7 @@ import de.greenrobot.dao.AbstractDao;
 import de.greenrobot.dao.Property;
 import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.R;
+import nodomain.freeyourgadget.gadgetbridge.activities.ExternalPebbleJSActivity;
 import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.AppManagerActivity;
 import nodomain.freeyourgadget.gadgetbridge.activities.appmanager.RebbleAppStoreActivity;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSpecificSettings;
@@ -146,6 +147,11 @@ public class PebbleCoordinator extends AbstractBLClassicDeviceCoordinator {
         return RebbleAppStoreActivity.class;
     }
 
+    @Override
+    public Class<? extends Activity> getAppConfigurationActivity(final GBDevice device) {
+        return ExternalPebbleJSActivity.class;
+    }
+
     @Override
     public File getAppCacheDir() throws IOException {
         return PebbleUtils.getPbwCacheDir();
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/impl/GBDeviceApp.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/impl/GBDeviceApp.java
index 45d66d7dd7..f43ea41e8c 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/impl/GBDeviceApp.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/impl/GBDeviceApp.java
@@ -18,13 +18,17 @@
 package nodomain.freeyourgadget.gadgetbridge.impl;
 
 import android.graphics.Bitmap;
+import android.os.Parcel;
+import android.os.Parcelable;
+
+import androidx.annotation.NonNull;
 
 import org.json.JSONException;
 import org.json.JSONObject;
 
 import java.util.UUID;
 
-public class GBDeviceApp {
+public class GBDeviceApp implements Parcelable {
     private final String name;
     private final String creator;
     private final String version;
@@ -32,7 +36,7 @@ public class GBDeviceApp {
     private final Type type;
     private final boolean inCache;
     private boolean isOnDevice;
-    private final boolean configurable;
+    private boolean configurable;
     private final Bitmap previewImage;
     private boolean isUpToDate = true;
 
@@ -90,6 +94,25 @@ public class GBDeviceApp {
         this.configurable = configurable;
     }
 
+    private GBDeviceApp(final Parcel in) {
+        this.name = in.readString();
+        this.creator = in.readString();
+        this.version = in.readString();
+        final String uuidString = in.readString();
+        this.uuid = uuidString != null ? UUID.fromString(uuidString) : null;
+        final String typeString = in.readString();
+        this.type = typeString != null ? Type.valueOf(typeString) : null;
+        this.inCache = in.readInt() != 0;
+        this.isOnDevice = in.readInt() != 0;
+        this.configurable = in.readInt() != 0;
+        this.previewImage = in.readParcelable(GBDeviceApp.class.getClassLoader());
+        this.isUpToDate = in.readInt() != 0;
+    }
+
+    public void setConfigurable(boolean configurable) {
+        this.configurable = configurable;
+    }
+
     public void setOnDevice(boolean isOnDevice) {
         this.isOnDevice = isOnDevice;
     }
@@ -160,4 +183,35 @@ public class GBDeviceApp {
     public boolean isUpToDate() {
         return isUpToDate;
     }
+
+    @Override
+    public int describeContents() {
+        return 0;
+    }
+
+    @Override
+    public void writeToParcel(@NonNull final Parcel dest, final int flags) {
+        dest.writeString(name);
+        dest.writeString(creator);
+        dest.writeString(version);
+        dest.writeString(uuid != null ? uuid.toString() : null);
+        dest.writeString(type != null ? type.name() : null);
+        dest.writeInt(inCache ? 1 : 0);
+        dest.writeInt(isOnDevice ? 1 : 0);
+        dest.writeInt(configurable ? 1 : 0);
+        dest.writeParcelable(previewImage, 0);
+        dest.writeInt(isUpToDate ? 1 : 0);
+    }
+
+    public static final Creator<GBDeviceApp> CREATOR = new Creator<>() {
+        @Override
+        public GBDeviceApp createFromParcel(Parcel in) {
+            return new GBDeviceApp(in);
+        }
+
+        @Override
+        public GBDeviceApp[] newArray(int size) {
+            return new GBDeviceApp[size];
+        }
+    };
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/qhybrid/adapter/fossil_hr/FossilHRWatchAdapter.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/qhybrid/adapter/fossil_hr/FossilHRWatchAdapter.java
index ff0f1b6e3e..9c926ca1f5 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/qhybrid/adapter/fossil_hr/FossilHRWatchAdapter.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/qhybrid/adapter/fossil_hr/FossilHRWatchAdapter.java
@@ -111,6 +111,7 @@ import nodomain.freeyourgadget.gadgetbridge.devices.qhybrid.FossilHRInstallHandl
 import nodomain.freeyourgadget.gadgetbridge.devices.qhybrid.HybridHRActivitySampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.devices.qhybrid.HybridHRSpo2SampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.devices.qhybrid.NotificationHRConfiguration;
+import nodomain.freeyourgadget.gadgetbridge.devices.qhybrid.QHybridConstants;
 import nodomain.freeyourgadget.gadgetbridge.entities.BaseActivitySummary;
 import nodomain.freeyourgadget.gadgetbridge.entities.BaseActivitySummaryDao;
 import nodomain.freeyourgadget.gadgetbridge.entities.Device;
@@ -121,6 +122,7 @@ import nodomain.freeyourgadget.gadgetbridge.externalevents.NotificationListener;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDeviceApp;
 import nodomain.freeyourgadget.gadgetbridge.model.CallSpec;
+import nodomain.freeyourgadget.gadgetbridge.model.DeviceType;
 import nodomain.freeyourgadget.gadgetbridge.model.GenericItem;
 import nodomain.freeyourgadget.gadgetbridge.model.ItemWithDetails;
 import nodomain.freeyourgadget.gadgetbridge.model.MusicSpec;
@@ -794,9 +796,19 @@ public class FossilHRWatchAdapter extends FossilWatchAdapter {
     }
 
     public void setInstalledApplications(List<ApplicationInformation> installedApplications) {
+        final List<GBDeviceApp> systemApps = Collections.singletonList(
+                new GBDeviceApp(
+                        UUID.nameUUIDFromBytes("workoutApp".getBytes(StandardCharsets.UTF_8)),
+                        "workoutApp",
+                        "",
+                        "",
+                        GBDeviceApp.Type.APP_ACTIVITYTRACKER
+                )
+        );
+
         this.installedApplications = installedApplications;
         GBDeviceEventAppInfo appInfoEvent = new GBDeviceEventAppInfo();
-        appInfoEvent.apps = new GBDeviceApp[installedApplications.size()];
+        appInfoEvent.apps = new GBDeviceApp[installedApplications.size() + systemApps.size()];
         for (int i = 0; i < installedApplications.size(); i++) {
             String appName = installedApplications.get(i).getAppName();
             String appVersion = installedApplications.get(i).getAppVersion();
@@ -807,8 +819,28 @@ public class FossilHRWatchAdapter extends FossilWatchAdapter {
             } else {
                 appType = GBDeviceApp.Type.WATCHFACE;
             }
-            appInfoEvent.apps[i] = new GBDeviceApp(appUUID, appName, "(unknown)", appVersion, appType);
+
+            final GBDeviceApp app = new GBDeviceApp(appUUID, appName, "(unknown)", appVersion, appType);
+            if (getDeviceSupport().getDevice().getType() == DeviceType.FOSSILQHYBRID) {
+                if ((app.getType() == GBDeviceApp.Type.WATCHFACE) && (!QHybridConstants.HYBRIDHR_WATCHFACE_VERSION.equals(appVersion))) {
+                    app.setUpToDate(false);
+                }
+                try {
+                    if ((app.getType() == GBDeviceApp.Type.APP_GENERIC) && ((new Version(app.getVersion())).smallerThan(new Version(QHybridConstants.KNOWN_WAPP_VERSIONS.get(app.getName()))))) {
+                        app.setUpToDate(false);
+                    }
+                } catch (final IllegalArgumentException e) {
+                    LOG.warn("Couldn't read app version", e);
+                }
+            }
+
+            appInfoEvent.apps[i] = app;
         }
+
+        for (int i = installedApplications.size(), j = 0; i < appInfoEvent.apps.length && j < systemApps.size(); i++, j++) {
+            appInfoEvent.apps[i] = systemApps.get(j);
+        }
+
         getDeviceSupport().evaluateGBDeviceEvent(appInfoEvent);
     }
 
```
-----------------------------------
