# Commit: 90fd47c2d6a69764561bd3fe1580147327c4088e
## Message: Health Connect: Add debug fragment
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/AbstractDebugFragment.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/OtherDebugFragment.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/WeatherSpecDebugFragment.kt

app/src/main/res/xml/debug_preferences_main.xml

app/src/main/res/xml/debug_preferences_other_actions.xml

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/HealthConnectDebugFragment.kt

app/src/main/res/xml/debug_preferences_health_connect.xml

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/AbstractDebugFragment.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/AbstractDebugFragment.kt
index fb014f3f05..ff3713a995 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/AbstractDebugFragment.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/AbstractDebugFragment.kt
@@ -5,6 +5,7 @@ import android.widget.Toast
 import androidx.preference.EditTextPreference
 import androidx.preference.ListPreference
 import androidx.preference.Preference
+import androidx.preference.PreferenceCategory
 import androidx.preference.PreferenceGroup
 import com.google.android.material.dialog.MaterialAlertDialogBuilder
 import nodomain.freeyourgadget.gadgetbridge.GBApplication
@@ -106,6 +107,15 @@ abstract class AbstractDebugFragment : AbstractPreferenceFragment() {
         return pref
     }
 
+    protected fun addDynamicCategory(title: String) {
+        val pref = PreferenceCategory(requireContext())
+        pref.key = "${PREF_DYNAMIC_PREFIX}_category_${UUID.randomUUID()})"
+        pref.title = title
+        pref.isPersistent = false
+        pref.isIconSpaceReserved = false
+        preferenceScreen?.addPreference(pref)
+    }
+
     protected fun goTo(fragment: AbstractDebugFragment) {
         requireActivity().supportFragmentManager.beginTransaction()
             .replace(R.id.settings_container, fragment)
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/HealthConnectDebugFragment.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/HealthConnectDebugFragment.kt
new file mode 100644
index 0000000000..125d0c4736
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/HealthConnectDebugFragment.kt
@@ -0,0 +1,113 @@
+package nodomain.freeyourgadget.gadgetbridge.activities.debug
+
+import android.app.DatePickerDialog
+import android.os.Bundle
+import android.widget.DatePicker
+import android.widget.Toast
+import com.google.android.material.dialog.MaterialAlertDialogBuilder
+import nodomain.freeyourgadget.gadgetbridge.GBApplication
+import nodomain.freeyourgadget.gadgetbridge.R
+import nodomain.freeyourgadget.gadgetbridge.database.DBHelper
+import nodomain.freeyourgadget.gadgetbridge.entities.HealthConnectSyncStateDao
+import nodomain.freeyourgadget.gadgetbridge.util.DateTimeUtils
+import nodomain.freeyourgadget.gadgetbridge.util.GB
+import org.slf4j.Logger
+import org.slf4j.LoggerFactory
+import java.time.Instant
+import java.time.ZoneId
+import java.time.format.DateTimeFormatter
+
+class HealthConnectDebugFragment : AbstractDebugFragment() {
+    override fun onCreatePreferences(savedInstanceState: Bundle?, rootKey: String?) {
+        setupPreferences()
+    }
+
+    private fun setupPreferences() {
+        setPreferencesFromResource(R.xml.debug_preferences_health_connect, null)
+
+        onClick(PREF_DEBUG_RESET_HC_SYNC_STATE) {
+            MaterialAlertDialogBuilder(requireActivity())
+                .setCancelable(true)
+                .setTitle("Reset HC sync state")
+                .setMessage("Reset Health Connect sync state? This will allow all data to be re-synced.")
+                .setPositiveButton(R.string.ok) { _, _ ->
+                    try {
+                        GBApplication.acquireDB().use { db ->
+                            db.daoSession.healthConnectSyncStateDao.deleteAll()
+                            GB.toast("Health Connect sync state reset successfully", Toast.LENGTH_SHORT, GB.INFO)
+                        }
+                    } catch (e: Exception) {
+                        GB.toast("Failed to reset Health Connect sync state", Toast.LENGTH_LONG, GB.ERROR, e)
+                    }
+                    reloadSyncStates()
+                }
+                .setNegativeButton(R.string.Cancel) { _, _ -> }
+                .show()
+        }
+
+        reloadSyncStates()
+    }
+
+    private fun reloadSyncStates() {
+        removeDynamicPrefs(preferenceScreen)
+
+        GBApplication.app().deviceManager.devices
+            .sortedBy { it.aliasOrName }
+            .forEach { gbDevice ->
+                val syncStates = GBApplication.acquireDB().use { db ->
+                    val deviceFromDb = DBHelper.getDevice(gbDevice, db.daoSession)
+                    return@use db.daoSession.healthConnectSyncStateDao.queryBuilder()
+                        .where(HealthConnectSyncStateDao.Properties.DeviceId.eq(deviceFromDb.id))
+                        .orderAsc(HealthConnectSyncStateDao.Properties.DataType)
+                        .list()
+                }
+
+                if (syncStates.isEmpty()) {
+                    return@forEach
+                }
+
+                addDynamicCategory(gbDevice.aliasOrName)
+                val formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")
+                for (state in syncStates) {
+                    val zonedDateTime = Instant.ofEpochMilli(state.lastSyncTimestamp * 1000L)
+                        .atZone(ZoneId.systemDefault())
+
+                    addDynamicPref(
+                        preferenceScreen,
+                        state.dataType,
+                        zonedDateTime.format(formatter)
+                    ) {
+                        DatePickerDialog(
+                            requireActivity(),
+                            { _: DatePicker?, year: Int, monthOfYear: Int, dayOfMonth: Int ->
+                                val date = DateTimeUtils.dayStart(year, monthOfYear, dayOfMonth)
+
+                                GBApplication.acquireDB().use { db ->
+                                    val syncStateDao = db.daoSession.healthConnectSyncStateDao
+                                    state.lastSyncTimestamp = date.time / 1000
+
+                                    LOG.info(
+                                        "Updating Health Connect sync state for device {}, data type {} to timestamp: {}",
+                                        gbDevice.aliasOrName,
+                                        state.dataType,
+                                        date
+                                    )
+                                    syncStateDao.insertOrReplace(state)
+                                }
+
+                                reloadSyncStates()
+                            },
+                            zonedDateTime.year,
+                            zonedDateTime.monthValue - 1,
+                            zonedDateTime.dayOfMonth
+                        ).show()
+                    }
+                }
+            }
+    }
+
+    companion object {
+        private val LOG: Logger = LoggerFactory.getLogger(HealthConnectDebugFragment::class.java)
+        private const val PREF_DEBUG_RESET_HC_SYNC_STATE = "pref_debug_reset_hc_sync_state"
+    }
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/OtherDebugFragment.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/OtherDebugFragment.kt
index d380af5709..fad6c87b04 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/OtherDebugFragment.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/OtherDebugFragment.kt
@@ -96,28 +96,6 @@ class OtherDebugFragment : AbstractDebugFragment() {
             }
         }
 
-        onClick(PREF_DEBUG_RESET_HC_SYNC_STATE) {
-            MaterialAlertDialogBuilder(requireActivity())
-                .setCancelable(true)
-                .setTitle("Reset HC sync state")
-                .setMessage("Reset Health Connect sync state? This will allow all data to be re-synced.")
-                .setPositiveButton(R.string.ok) { _, _ ->
-                    try {
-                        val db = GBApplication.acquireDB()
-                        try {
-                            db.daoSession.healthConnectSyncStateDao.deleteAll()
-                            GB.toast("Health Connect sync state reset successfully", Toast.LENGTH_SHORT, GB.INFO)
-                        } finally {
-                            GBApplication.releaseDB()
-                        }
-                    } catch (e: Exception) {
-                        GB.toast("Failed to reset Health Connect sync state", Toast.LENGTH_LONG, GB.ERROR, e)
-                    }
-                }
-                .setNegativeButton(R.string.Cancel) { _, _ -> }
-                .show()
-        }
-
         onClick(PREF_DEBUG_FACTORY_RESET) {
             MaterialAlertDialogBuilder(requireActivity())
                 .setCancelable(true)
@@ -141,7 +119,6 @@ class OtherDebugFragment : AbstractDebugFragment() {
         private const val PREF_DEBUG_FETCH_DEBUG_LOGS = "pref_debug_fetch_debug_logs"
         private const val PREF_DEBUG_HEADER_RESET = "pref_debug_header_reset"
         private const val PREF_DEBUG_REBOOT = "pref_debug_reboot"
-        private const val PREF_DEBUG_RESET_HC_SYNC_STATE = "pref_debug_reset_hc_sync_state"
         private const val PREF_DEBUG_FACTORY_RESET = "pref_debug_factory_reset"
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/WeatherSpecDebugFragment.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/WeatherSpecDebugFragment.kt
index 636308cf3a..e6550bcd24 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/WeatherSpecDebugFragment.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/debug/WeatherSpecDebugFragment.kt
@@ -1,14 +1,12 @@
 package nodomain.freeyourgadget.gadgetbridge.activities.debug
 
 import android.os.Bundle
-import androidx.preference.PreferenceCategory
 import nodomain.freeyourgadget.gadgetbridge.R
 import nodomain.freeyourgadget.gadgetbridge.model.WeatherSpec
 import nodomain.freeyourgadget.gadgetbridge.util.DateTimeUtils
 import java.text.SimpleDateFormat
 import java.util.Date
 import java.util.Locale
-import java.util.UUID
 import java.util.concurrent.TimeUnit
 
 class WeatherSpecDebugFragment : AbstractDebugFragment() {
@@ -41,15 +39,6 @@ class WeatherSpecDebugFragment : AbstractDebugFragment() {
         }
     }
 
-    private fun addCategory(title: String) {
-        val pref = PreferenceCategory(requireContext())
-        pref.key = "${PREF_DYNAMIC_PREFIX}_category_${UUID.randomUUID()})"
-        pref.title = title
-        pref.isPersistent = false
-        pref.isIconSpaceReserved = false
-        preferenceScreen?.addPreference(pref)
-    }
-
     private fun showMainWeather(weatherSpec: WeatherSpec) {
         val sdf = SimpleDateFormat("yyyy-MM-dd HH:mm:ss Z", Locale.ROOT)
 
@@ -132,7 +121,7 @@ class WeatherSpecDebugFragment : AbstractDebugFragment() {
         val sdf = SimpleDateFormat("yyyy-MM-dd HH:mm:ss Z", Locale.ROOT)
 
         for ((i, daily) in weatherSpec.forecasts.withIndex()) {
-            addCategory("Day $i")
+            addDynamicCategory("Day $i")
             addPreference("Max Temp", "${daily.maxTemp} K (${daily.maxTemp - 273} °C)")
             addPreference("Min Temp", "${daily.minTemp} K (${daily.minTemp - 273} °C)")
             addPreference("Condition Code", daily.conditionCode)
@@ -170,7 +159,7 @@ class WeatherSpecDebugFragment : AbstractDebugFragment() {
     private fun showHours(weatherSpec: WeatherSpec) {
         val sdf = SimpleDateFormat("yyyy-MM-dd HH:mm:ss Z", Locale.ROOT)
         for ((i, hourly) in weatherSpec.hourly.withIndex()) {
-            addCategory("Hour $i - ${sdf.format(Date(hourly.timestamp * 1000L))}")
+            addDynamicCategory("Hour $i - ${sdf.format(Date(hourly.timestamp * 1000L))}")
             addPreference("Max Temp", "${hourly.temp} K (${hourly.temp - 273} °C)")
             addPreference("Condition Code", hourly.conditionCode)
             addPreference("Humidity", hourly.humidity)
diff --git a/app/src/main/res/xml/debug_preferences_health_connect.xml b/app/src/main/res/xml/debug_preferences_health_connect.xml
new file mode 100644
index 0000000000..0621b8bcdc
--- /dev/null
+++ b/app/src/main/res/xml/debug_preferences_health_connect.xml
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="utf-8"?>
+<androidx.preference.PreferenceScreen xmlns:android="http://schemas.android.com/apk/res/android"
+    android:title="@string/healthconnect_settings">
+
+    <Preference
+        android:icon="@drawable/ic_refresh"
+        android:key="pref_debug_reset_hc_sync_state"
+        android:persistent="false"
+        android:summary="Reset Health Connect sync state and allow re-syncing all data"
+        android:title="Reset HC sync state" />
+
+</androidx.preference.PreferenceScreen>
diff --git a/app/src/main/res/xml/debug_preferences_main.xml b/app/src/main/res/xml/debug_preferences_main.xml
index 2dfb40ef3d..746419c5b8 100644
--- a/app/src/main/res/xml/debug_preferences_main.xml
+++ b/app/src/main/res/xml/debug_preferences_main.xml
@@ -96,6 +96,13 @@
             android:persistent="false"
             android:title="@string/pref_header_location" />
 
+        <Preference
+            android:fragment="nodomain.freeyourgadget.gadgetbridge.activities.debug.HealthConnectDebugFragment"
+            android:icon="@drawable/ic_heart"
+            android:key="pref_debug_health_connect"
+            android:persistent="false"
+            android:title="@string/healthconnect_settings" />
+
         <Preference
             android:fragment="nodomain.freeyourgadget.gadgetbridge.activities.debug.OtherDebugFragment"
             android:icon="@drawable/ic_developer_mode"
diff --git a/app/src/main/res/xml/debug_preferences_other_actions.xml b/app/src/main/res/xml/debug_preferences_other_actions.xml
index 99d3b40add..e8f616987e 100644
--- a/app/src/main/res/xml/debug_preferences_other_actions.xml
+++ b/app/src/main/res/xml/debug_preferences_other_actions.xml
@@ -46,13 +46,6 @@
             android:persistent="false"
             android:title="Reboot" />
 
-        <Preference
-            android:icon="@drawable/ic_refresh"
-            android:key="pref_debug_reset_hc_sync_state"
-            android:persistent="false"
-            android:summary="Reset Health Connect sync state and allow re-syncing all data"
-            android:title="Reset HC sync state" />
-
         <SwitchPreferenceCompat
             android:defaultValue="false"
             android:icon="@drawable/ic_warning_gray"
```
-----------------------------------
