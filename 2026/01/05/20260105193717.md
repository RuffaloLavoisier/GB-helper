# Commit: 11ca07451a50eef23b9f8c66dbb40a1f3969023b
## Message: Add Lifecycle observer to GBApplication

Support classes can now react to application being in foreground/background.

Also adds support for sending app status to garmin devices.
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/AppLifecycleObserver.kt

app/build.gradle

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java

## Diff:
```
diff --git a/app/build.gradle b/app/build.gradle
index 7784bdd8da..aa2bda7319 100644
--- a/app/build.gradle
+++ b/app/build.gradle
@@ -244,6 +244,7 @@ dependencies {
     implementation "androidx.fragment:fragment-ktx:1.8.9"
     implementation "androidx.viewpager2:viewpager2:1.1.0"
     implementation "androidx.work:work-runtime-ktx:2.11.0"
+    implementation 'androidx.lifecycle:lifecycle-process:2.10.0'
 
     // Not latest version because of https://github.com/material-components/material-components-android/issues/3924
     implementation "com.google.android.material:material:1.13.0"
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/AppLifecycleObserver.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/AppLifecycleObserver.kt
new file mode 100644
index 0000000000..ea67ed26f5
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/AppLifecycleObserver.kt
@@ -0,0 +1,21 @@
+package nodomain.freeyourgadget.gadgetbridge
+
+import android.content.Intent
+import androidx.lifecycle.DefaultLifecycleObserver
+import androidx.lifecycle.LifecycleOwner
+import androidx.localbroadcastmanager.content.LocalBroadcastManager
+
+
+class AppLifecycleObserver : DefaultLifecycleObserver {
+
+    override fun onStart(owner: LifecycleOwner) {
+        super.onStart(owner)
+        LocalBroadcastManager.getInstance(GBApplication.getContext()).sendBroadcast( Intent(GBApplication.ACTION_APP_IS_IN_FOREGROUND))
+    }
+
+    override fun onStop(owner: LifecycleOwner) {
+        super.onStop(owner)
+        LocalBroadcastManager.getInstance(GBApplication.getContext()).sendBroadcast( Intent(GBApplication.ACTION_APP_IS_IN_BACKGROUND))
+    }
+
+}
\ No newline at end of file
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java
index 8d73cf4a27..f6e9e6852f 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/GBApplication.java
@@ -77,6 +77,7 @@ import androidx.localbroadcastmanager.content.LocalBroadcastManager;
 import org.apache.commons.lang3.StringUtils;
 import org.json.JSONObject;
 import org.slf4j.LoggerFactory;
+import androidx.lifecycle.ProcessLifecycleOwner;
 
 import java.io.File;
 import java.io.IOException;
@@ -158,6 +159,8 @@ public class GBApplication extends Application {
     public static final String ACTION_LANGUAGE_CHANGE = "nodomain.freeyourgadget.gadgetbridge.gbapplication.action.language_change";
     public static final String ACTION_THEME_CHANGE = "nodomain.freeyourgadget.gadgetbridge.gbapplication.action.theme_change";
     public static final String ACTION_NEW_DATA = "nodomain.freeyourgadget.gadgetbridge.action.new_data";
+    public static final String ACTION_APP_IS_IN_FOREGROUND = "nodomain.freeyourgadget.gadgetbridge.action.app_foreground";
+    public static final String ACTION_APP_IS_IN_BACKGROUND = "nodomain.freeyourgadget.gadgetbridge.action.app_background";
 
     private static GBApplication app;
 
@@ -294,6 +297,7 @@ public class GBApplication extends Application {
     public void onCreate() {
         app = this;
         super.onCreate();
+        ProcessLifecycleOwner.get().getLifecycle().addObserver(new AppLifecycleObserver());
 
         if (lockHandler != null) {
             // guard against multiple invocations (robolectric)
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
index c4ba0ab4fd..eba5e53e8a 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/garmin/GarminSupport.java
@@ -4,7 +4,10 @@ import android.annotation.SuppressLint;
 import android.bluetooth.BluetoothAdapter;
 import android.bluetooth.BluetoothGatt;
 import android.bluetooth.BluetoothGattCharacteristic;
+import android.content.BroadcastReceiver;
 import android.content.Context;
+import android.content.Intent;
+import android.content.IntentFilter;
 import android.graphics.Bitmap;
 import android.graphics.BitmapFactory;
 import android.location.Location;
@@ -15,6 +18,7 @@ import android.widget.Toast;
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
 import androidx.documentfile.provider.DocumentFile;
+import androidx.localbroadcastmanager.content.LocalBroadcastManager;
 
 import org.apache.commons.lang3.StringUtils;
 import org.slf4j.Logger;
@@ -101,7 +105,6 @@ import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.FitDeviceSettings;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.FitFileId;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.fit.messages.FitWeather;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.ConfigurationMessage;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.DownloadRequestMessage;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.GFDIMessage;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.MusicControlEntityUpdateMessage;
@@ -110,7 +113,6 @@ import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.SetD
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.SetFileFlagsMessage;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.SupportedFileTypesMessage;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.SystemEventMessage;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.status.GenericStatusMessage;
 import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.messages.status.NotificationSubscriptionStatusMessage;
 import nodomain.freeyourgadget.gadgetbridge.util.ArrayUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.CompressionUtils;
@@ -120,6 +122,8 @@ import nodomain.freeyourgadget.gadgetbridge.util.MediaManager;
 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
 import nodomain.freeyourgadget.gadgetbridge.util.notifications.GBProgressNotification;
 
+import static nodomain.freeyourgadget.gadgetbridge.GBApplication.ACTION_APP_IS_IN_BACKGROUND;
+import static nodomain.freeyourgadget.gadgetbridge.GBApplication.ACTION_APP_IS_IN_FOREGROUND;
 import static nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsPreferenceConst.PREF_ALLOW_HIGH_MTU;
 import static nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsPreferenceConst.PREF_SEND_APP_NOTIFICATIONS;
 
@@ -142,6 +146,24 @@ public class GarminSupport extends AbstractBTLESingleDeviceSupport implements IC
 
     final Map<UUID, GdiInstalledAppsService.InstalledAppsService.InstalledApp> installedApps = new HashMap<>();
 
+    private final BroadcastReceiver broadcastReceiver = new BroadcastReceiver() {
+        @Override
+        public void onReceive(Context context, Intent intent) {
+            String action = intent.getAction();
+            if (action == null) {
+                return;
+            }
+            switch (action) {
+                case ACTION_APP_IS_IN_FOREGROUND:
+                    sendOutgoingMessage("set foreground", new SystemEventMessage(SystemEventMessage.GarminSystemEventType.HOST_DID_ENTER_FOREGROUND, 0));
+                    break;
+                case ACTION_APP_IS_IN_BACKGROUND:
+                    sendOutgoingMessage("set background", new SystemEventMessage(SystemEventMessage.GarminSystemEventType.HOST_DID_ENTER_BACKGROUND, 0));
+                    break;
+            }
+        }
+    };
+
     public GarminSupport() {
         super(LOG);
         addSupportedService(CommunicatorV1.UUID_SERVICE_GARMIN_GFDI_V0);
@@ -155,6 +177,11 @@ public class GarminSupport extends AbstractBTLESingleDeviceSupport implements IC
         messageHandlers.add(fileTransferHandler);
         messageHandlers.add(protocolBufferHandler);
         messageHandlers.add(notificationsHandler);
+
+        IntentFilter filterLocal = new IntentFilter();
+        filterLocal.addAction(ACTION_APP_IS_IN_FOREGROUND);
+        filterLocal.addAction(ACTION_APP_IS_IN_BACKGROUND);
+        LocalBroadcastManager.getInstance(GBApplication.getContext()).registerReceiver(broadcastReceiver, filterLocal);
     }
 
     @Override
@@ -735,8 +762,6 @@ public class GarminSupport extends AbstractBTLESingleDeviceSupport implements IC
 
         enableBatteryLevelUpdate();
 
-        sendOutgoingMessage("set foreground", new SystemEventMessage(SystemEventMessage.GarminSystemEventType.HOST_DID_ENTER_FOREGROUND, 0));
-
 
         gbDevice.setUpdateState(GBDevice.State.INITIALIZED, getContext());
 
@@ -854,7 +879,6 @@ public class GarminSupport extends AbstractBTLESingleDeviceSupport implements IC
                 isBusyFetching = false;
 
                 sendOutgoingMessage("set sync complete", new SystemEventMessage(SystemEventMessage.GarminSystemEventType.SYNC_COMPLETE, 0));
-                sendOutgoingMessage("set background", new SystemEventMessage(SystemEventMessage.GarminSystemEventType.HOST_DID_ENTER_BACKGROUND, 0));
 
                 return;
             }
```
-----------------------------------
