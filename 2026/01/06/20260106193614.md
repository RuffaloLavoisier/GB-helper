# Commit: 731c1717e83c3e85e87c1675d74bef70ac36b67a
## Message: Anker Soundcore Liberty 3 Pro / 4 NC: Switch to BTBR support class, add headphones features
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/soundcore/liberty3_pro/SoundcoreLiberty3ProCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/soundcore/liberty4_nc/SoundcoreLiberty4NCCoordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLiberty3ProDeviceSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLiberty4NCDeviceSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLibertyIOThread.java

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/soundcore/liberty3_pro/SoundcoreLiberty3ProCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/soundcore/liberty3_pro/SoundcoreLiberty3ProCoordinator.java
index c74fdd4729..5f39d060cc 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/soundcore/liberty3_pro/SoundcoreLiberty3ProCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/soundcore/liberty3_pro/SoundcoreLiberty3ProCoordinator.java
@@ -61,6 +61,8 @@ public class SoundcoreLiberty3ProCoordinator extends AbstractBLClassicDeviceCoor
         deviceSpecificSettings.addSubScreen(DeviceSpecificSettingsScreen.TOUCH_OPTIONS, R.xml.devicesettings_sony_headphones_ambient_sound_control_button_modes);
         deviceSpecificSettings.addSubScreen(DeviceSpecificSettingsScreen.TOUCH_OPTIONS, R.xml.devicesettings_soundcore_liberty_touch_options);
         deviceSpecificSettings.addRootScreen(R.xml.devicesettings_soundcore_liberty);
+        deviceSpecificSettings.addRootScreen(DeviceSpecificSettingsScreen.CALLS_AND_NOTIFICATIONS);
+        deviceSpecificSettings.addSubScreen(DeviceSpecificSettingsScreen.CALLS_AND_NOTIFICATIONS, R.xml.devicesettings_headphones);
         return deviceSpecificSettings;
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/soundcore/liberty4_nc/SoundcoreLiberty4NCCoordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/soundcore/liberty4_nc/SoundcoreLiberty4NCCoordinator.java
index 0837888020..e5d4e53cbc 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/soundcore/liberty4_nc/SoundcoreLiberty4NCCoordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/soundcore/liberty4_nc/SoundcoreLiberty4NCCoordinator.java
@@ -61,6 +61,8 @@ public class SoundcoreLiberty4NCCoordinator extends AbstractBLClassicDeviceCoord
         deviceSpecificSettings.addSubScreen(DeviceSpecificSettingsScreen.TOUCH_OPTIONS, R.xml.devicesettings_sony_headphones_ambient_sound_control_button_modes);
         deviceSpecificSettings.addSubScreen(DeviceSpecificSettingsScreen.TOUCH_OPTIONS, R.xml.devicesettings_soundcore_liberty_touch_options);
         deviceSpecificSettings.addRootScreen(R.xml.devicesettings_soundcore_liberty);
+        deviceSpecificSettings.addRootScreen(DeviceSpecificSettingsScreen.CALLS_AND_NOTIFICATIONS);
+        deviceSpecificSettings.addSubScreen(DeviceSpecificSettingsScreen.CALLS_AND_NOTIFICATIONS, R.xml.devicesettings_headphones);
         return deviceSpecificSettings;
     }
 
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLiberty3ProDeviceSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLiberty3ProDeviceSupport.java
index 89b5304741..7832e2365f 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLiberty3ProDeviceSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLiberty3ProDeviceSupport.java
@@ -2,32 +2,25 @@ package nodomain.freeyourgadget.gadgetbridge.service.devices.soundcore.liberty;
 
 import java.util.UUID;
 
-import nodomain.freeyourgadget.gadgetbridge.service.serial.AbstractSerialDeviceSupport;
-import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceIoThread;
-import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;
+import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
+import nodomain.freeyourgadget.gadgetbridge.service.btbr.TransactionBuilder;
+import nodomain.freeyourgadget.gadgetbridge.service.serial.AbstractHeadphoneSerialDeviceSupportV2;
 
-public class SoundcoreLiberty3ProDeviceSupport extends AbstractSerialDeviceSupport {
+public class SoundcoreLiberty3ProDeviceSupport extends AbstractHeadphoneSerialDeviceSupportV2<SoundcoreLibertyProtocol> {
     public static final UUID UUID_DEVICE_CTRL = UUID.fromString("0cf12d31-fac3-4553-bd80-d6832e7b3952");
 
-    @Override
-    public boolean useAutoConnect() {
-        return false;
+    public SoundcoreLiberty3ProDeviceSupport() {
+        addSupportedService(UUID_DEVICE_CTRL);
     }
 
     @Override
-    protected GBDeviceProtocol createDeviceProtocol() {
+    protected SoundcoreLibertyProtocol createDeviceProtocol() {
         return new SoundcoreLibertyProtocol(getDevice());
     }
 
-    @Override
-    protected synchronized GBDeviceIoThread createDeviceIOThread() {
-        return new SoundcoreLibertyIOThread(
-                getDevice(),
-                getContext(),
-                (SoundcoreLibertyProtocol) getDeviceProtocol(),
-                UUID_DEVICE_CTRL,
-                this,
-                getBluetoothAdapter()
-        );
+    protected TransactionBuilder initializeDevice(final TransactionBuilder builder) {
+        builder.write(mDeviceProtocol.encodeDeviceInfoRequest());
+        builder.setDeviceState(GBDevice.State.INITIALIZED);
+        return builder;
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLiberty4NCDeviceSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLiberty4NCDeviceSupport.java
index ab490bb758..75f716b4e4 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLiberty4NCDeviceSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLiberty4NCDeviceSupport.java
@@ -2,32 +2,26 @@ package nodomain.freeyourgadget.gadgetbridge.service.devices.soundcore.liberty;
 
 import java.util.UUID;
 
-import nodomain.freeyourgadget.gadgetbridge.service.serial.AbstractSerialDeviceSupport;
-import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceIoThread;
-import nodomain.freeyourgadget.gadgetbridge.service.serial.GBDeviceProtocol;
+import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
+import nodomain.freeyourgadget.gadgetbridge.service.btbr.TransactionBuilder;
+import nodomain.freeyourgadget.gadgetbridge.service.serial.AbstractHeadphoneSerialDeviceSupportV2;
 
-public class SoundcoreLiberty4NCDeviceSupport extends AbstractSerialDeviceSupport {
+public class SoundcoreLiberty4NCDeviceSupport extends AbstractHeadphoneSerialDeviceSupportV2<SoundcoreLibertyProtocol> {
     public static final UUID UUID_DEVICE_CTRL = UUID.fromString("0cf12d31-fac3-4553-bd80-d6832e7b3947");
 
-    @Override
-    public boolean useAutoConnect() {
-        return false;
+    public SoundcoreLiberty4NCDeviceSupport() {
+        addSupportedService(UUID_DEVICE_CTRL);
     }
 
     @Override
-    protected GBDeviceProtocol createDeviceProtocol() {
+    protected SoundcoreLibertyProtocol createDeviceProtocol() {
         return new SoundcoreLibertyProtocol(getDevice());
     }
 
     @Override
-    protected synchronized GBDeviceIoThread createDeviceIOThread() {
-        return new SoundcoreLibertyIOThread(
-                getDevice(),
-                getContext(),
-                (SoundcoreLibertyProtocol) getDeviceProtocol(),
-                UUID_DEVICE_CTRL,
-                this,
-                getBluetoothAdapter()
-        );
+    protected TransactionBuilder initializeDevice(final TransactionBuilder builder) {
+        builder.write(mDeviceProtocol.encodeDeviceInfoRequest());
+        builder.setDeviceState(GBDevice.State.INITIALIZED);
+        return builder;
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLibertyIOThread.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLibertyIOThread.java
deleted file mode 100644
index 022e988af1..0000000000
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/soundcore/liberty/SoundcoreLibertyIOThread.java
+++ /dev/null
@@ -1,58 +0,0 @@
-package nodomain.freeyourgadget.gadgetbridge.service.devices.soundcore.liberty;
-
-import static nodomain.freeyourgadget.gadgetbridge.util.GB.hexdump;
-
-import android.bluetooth.BluetoothAdapter;
-import android.content.Context;
-import android.os.ParcelUuid;
-
-import androidx.annotation.NonNull;
-
-import org.slf4j.Logger;
-import org.slf4j.LoggerFactory;
-
-import java.io.IOException;
-import java.io.InputStream;
-import java.util.Arrays;
-import java.util.UUID;
-
-import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
-import nodomain.freeyourgadget.gadgetbridge.service.btclassic.BtClassicIoThread;
-import nodomain.freeyourgadget.gadgetbridge.service.serial.AbstractSerialDeviceSupport;
-
-public class SoundcoreLibertyIOThread extends BtClassicIoThread {
-    private static final Logger LOG = LoggerFactory.getLogger(SoundcoreLibertyIOThread.class);
-    private final SoundcoreLibertyProtocol mSoundcoreProtocol;
-    private final UUID mUuidToConnect;
-
-    public SoundcoreLibertyIOThread(final GBDevice gbDevice,
-                                    final Context context,
-                                    final SoundcoreLibertyProtocol deviceProtocol,
-                                    final UUID uuidToConnect,
-                                    final AbstractSerialDeviceSupport deviceSupport,
-                                    final BluetoothAdapter btAdapter) {
-        super(gbDevice, context, deviceProtocol, deviceSupport, btAdapter);
-        mSoundcoreProtocol = deviceProtocol;
-        mUuidToConnect = uuidToConnect;
-    }
-
-    @Override
-    protected void initialize() {
-        write(mSoundcoreProtocol.encodeDeviceInfoRequest());
-        setUpdateState(GBDevice.State.INITIALIZED);
-    }
-
-    @Override
-    @NonNull
-    protected UUID getUuidToConnect(@NonNull ParcelUuid[] uuids) {
-        return mUuidToConnect;
-    }
-
-    @Override
-    protected byte[] parseIncoming(InputStream inStream) throws IOException {
-        byte[] buffer = new byte[1048576]; //HUGE read
-        int bytes = inStream.read(buffer);
-        LOG.debug("read {} bytes. {}", bytes, hexdump(buffer, 0, bytes));
-        return Arrays.copyOf(buffer, bytes);
-    }
-}
```
-----------------------------------
