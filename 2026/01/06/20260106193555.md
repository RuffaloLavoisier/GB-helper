# Commit: 2e582f48c60917f06a277315c87707a1c429aebf
## Message: Health Connect: Refactor HrvSyncer, Vo2MaxSyncer, and WeightSyncer to use AbstractTimeSampleSyncer
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/HrvSyncer.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/Vo2MaxSyncer.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/WeightSyncer.kt

## Diff:
```
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/HrvSyncer.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/HrvSyncer.kt
index 885f091009..5696dcf660 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/HrvSyncer.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/HrvSyncer.kt
@@ -16,129 +16,49 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.util.healthconnect.syncers
 
-import androidx.health.connect.client.HealthConnectClient
-import androidx.health.connect.client.permission.HealthPermission
 import androidx.health.connect.client.records.HeartRateVariabilityRmssdRecord
-import androidx.health.connect.client.records.Record
 import androidx.health.connect.client.records.metadata.Metadata
-import nodomain.freeyourgadget.gadgetbridge.GBApplication
+import nodomain.freeyourgadget.gadgetbridge.devices.TimeSampleProvider
+import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice
 import nodomain.freeyourgadget.gadgetbridge.model.HrvValueSample
-import nodomain.freeyourgadget.gadgetbridge.util.healthconnect.HealthConnectUtils
-import nodomain.freeyourgadget.gadgetbridge.util.healthconnect.SyncException
+import org.slf4j.Logger
 import org.slf4j.LoggerFactory
 import java.time.Instant
 import java.time.ZoneOffset
+import kotlin.reflect.KClass
 
-private val LOG = LoggerFactory.getLogger("HrvSyncer")
+internal object HrvSyncer : AbstractTimeSampleSyncer<HrvValueSample, HeartRateVariabilityRmssdRecord>() {
+    override val logger: Logger = LoggerFactory.getLogger(HrvSyncer::class.java)
+    override val recordClass: KClass<HeartRateVariabilityRmssdRecord> = HeartRateVariabilityRmssdRecord::class
 
-internal object HrvSyncer : HealthConnectSyncer {
+    override fun getSampleProvider(
+        gbDevice: GBDevice,
+        daoSession: DaoSession
+    ): TimeSampleProvider<out HrvValueSample>? {
+        return gbDevice.deviceCoordinator.getHrvValueSampleProvider(gbDevice, daoSession)
+    }
 
-    private fun createHrvRecordsFromSamples(
-        valueSamples: List<HrvValueSample>,
-        sliceStartBoundary: Instant,
-        sliceEndBoundary: Instant,
+    override fun convertSample(
+        sample: HrvValueSample,
         offset: ZoneOffset,
         metadata: Metadata,
         deviceName: String
-    ): List<Record> {
-        if (valueSamples.isEmpty()) {
-            LOG.info("No HRV value samples provided to create records for device '$deviceName'.")
-            return emptyList()
-        }
-
-        LOG.info("Processing ${valueSamples.size} HRV value samples for device '$deviceName'.")
-        val records = mutableListOf<Record>()
-        for (sample in valueSamples) {
-            val timestamp = Instant.ofEpochMilli(sample.timestamp)
-
-            if (sample.value <= 0) {
-                LOG.debug(
-                    "Skipping HRV value sample for device '{}' at {} due to non-positive value: {}.",
-                    deviceName,
-                    timestamp,
-                    sample.value
-                )
-                continue
-            }
-
-            if (timestamp.isBefore(sliceStartBoundary) || !timestamp.isBefore(sliceEndBoundary)) {
-                LOG.debug(
-                    "Skipping HRV value sample for device '{}' at {} (value: {}) as it's outside the slice {} - {}.",
-                    deviceName,
-                    timestamp,
-                    sample.value,
-                    sliceStartBoundary,
-                    sliceEndBoundary
-                )
-                continue
-            }
-
-            records.add(
-                HeartRateVariabilityRmssdRecord(
-                    time = timestamp,
-                    zoneOffset = offset,
-                    heartRateVariabilityMillis = sample.value.toDouble(),
-                    metadata = metadata
-                )
+    ): HeartRateVariabilityRmssdRecord? {
+        if (sample.value <= 0) {
+            logger.debug(
+                "Skipping HRV value sample for device '{}' due to non-positive value: {}.",
+                deviceName,
+                sample.value
             )
-        }
-        return records
-    }
-
-    override suspend fun sync(
-        healthConnectClient: HealthConnectClient,
-        gbDevice: GBDevice,
-        metadata: Metadata,
-        offset: ZoneOffset,
-        sliceStartBoundary: Instant,
-        sliceEndBoundary: Instant,
-        grantedPermissions: Set<String>
-    ): SyncerStatistics {
-        val deviceName = gbDevice.aliasOrName
-
-        if (HealthPermission.getWritePermission(HeartRateVariabilityRmssdRecord::class) !in grantedPermissions) {
-            LOG.info("Skipping HRV sync for device '$deviceName'; HeartRateVariabilityRmssdRecord permission not granted.")
-            return SyncerStatistics(recordType = "HRV")
+            return null
         }
 
-        val coordinator = gbDevice.deviceCoordinator
-        val valueSamples: List<HrvValueSample> = try {
-            GBApplication.acquireDB().use { dbInstance ->
-                val valueProvider = coordinator.getHrvValueSampleProvider(gbDevice, dbInstance.daoSession)
-                if (valueProvider == null) {
-                    LOG.info("HRV Value Provider not available for device '$deviceName'.")
-                    return SyncerStatistics(recordType = "HRV")
-                }
-                valueProvider.getAllSamples(sliceStartBoundary.toEpochMilli(), sliceEndBoundary.toEpochMilli())
-            }
-        } catch (e: Exception) {
-            throw SyncException("Error fetching HRV value samples for device '$deviceName' for slice $sliceStartBoundary to $sliceEndBoundary.", e)
-        }
-
-        if (valueSamples.isEmpty()) {
-            LOG.info("No HRV value samples found by provider for device '$deviceName' in slice $sliceStartBoundary to $sliceEndBoundary.")
-            return SyncerStatistics(recordType = "HRV")
-        }
-
-        val recordsToInsert = createHrvRecordsFromSamples(
-            valueSamples,
-            sliceStartBoundary,
-            sliceEndBoundary,
-            offset,
-            metadata,
-            deviceName
+        return HeartRateVariabilityRmssdRecord(
+            time = Instant.ofEpochMilli(sample.timestamp),
+            zoneOffset = offset,
+            heartRateVariabilityMillis = sample.value.toDouble(),
+            metadata = metadata
         )
-
-        if (recordsToInsert.isEmpty()) {
-            LOG.info("No valid HRV records to insert for device '$deviceName' in slice $sliceStartBoundary to $sliceEndBoundary after processing samples.")
-            return SyncerStatistics(recordType = "HRV")
-        }
-
-        LOG.info("Attempting to insert ${recordsToInsert.size} HeartRateVariabilityRmssdRecord(s) for device '$deviceName' for slice $sliceStartBoundary to $sliceEndBoundary.")
-        HealthConnectUtils.insertRecords(recordsToInsert, healthConnectClient)
-
-        LOG.info("Successfully inserted ${recordsToInsert.size} HeartRateVariabilityRmssdRecord(s) for device '$deviceName' for slice $sliceStartBoundary to $sliceEndBoundary.")
-        return SyncerStatistics(recordsSynced = recordsToInsert.size, recordType = "HRV")
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/Vo2MaxSyncer.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/Vo2MaxSyncer.kt
index 3797ea0533..dc7ac14b13 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/Vo2MaxSyncer.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/Vo2MaxSyncer.kt
@@ -16,102 +16,46 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.util.healthconnect.syncers
 
-import androidx.health.connect.client.HealthConnectClient
-import androidx.health.connect.client.permission.HealthPermission
-import androidx.health.connect.client.records.Record
 import androidx.health.connect.client.records.Vo2MaxRecord
 import androidx.health.connect.client.records.metadata.Metadata
-import nodomain.freeyourgadget.gadgetbridge.GBApplication
+import nodomain.freeyourgadget.gadgetbridge.devices.TimeSampleProvider
+import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice
 import nodomain.freeyourgadget.gadgetbridge.model.Vo2MaxSample
-import nodomain.freeyourgadget.gadgetbridge.util.healthconnect.HealthConnectUtils
-import nodomain.freeyourgadget.gadgetbridge.util.healthconnect.SyncException
+import org.slf4j.Logger
 import org.slf4j.LoggerFactory
 import java.time.Instant
 import java.time.ZoneOffset
+import kotlin.reflect.KClass
 
-private val LOG = LoggerFactory.getLogger("Vo2MaxSyncer")
+internal object Vo2MaxSyncer : AbstractTimeSampleSyncer<Vo2MaxSample, Vo2MaxRecord>() {
+    override val logger: Logger = LoggerFactory.getLogger(Vo2MaxSyncer::class.java)
+    override val recordClass: KClass<Vo2MaxRecord> = Vo2MaxRecord::class
 
-internal object Vo2MaxSyncer : HealthConnectSyncer {
-    override suspend fun sync(
-        healthConnectClient: HealthConnectClient,
+    override fun getSampleProvider(
         gbDevice: GBDevice,
-        metadata: Metadata,
+        daoSession: DaoSession
+    ): TimeSampleProvider<out Vo2MaxSample>? {
+        return gbDevice.deviceCoordinator.getVo2MaxSampleProvider(gbDevice, daoSession)
+    }
+
+    override fun convertSample(
+        sample: Vo2MaxSample,
         offset: ZoneOffset,
-        sliceStartBoundary: Instant,
-        sliceEndBoundary: Instant,
-        grantedPermissions: Set<String>
-    ): SyncerStatistics {
-        val deviceName = gbDevice.aliasOrName
-
-        if (HealthPermission.getWritePermission(Vo2MaxRecord::class) !in grantedPermissions) {
-            LOG.info("Skipping VO2Max sync for device '$deviceName'; Vo2MaxRecord permission not granted.")
-            return SyncerStatistics(recordType = "VO2Max")
+        metadata: Metadata,
+        deviceName: String
+    ): Vo2MaxRecord? {
+        if (sample.value <= 0) {
+            logger.debug("Skipping VO2Max sample for device '$deviceName' due to invalid value: ${sample.value}.")
+            return null
         }
 
-        val samples = try {
-            GBApplication.acquireDB().use { dbInstance ->
-                val provider = gbDevice.deviceCoordinator.getVo2MaxSampleProvider(gbDevice, dbInstance.daoSession)
-
-                if (provider == null) {
-                    LOG.warn("Vo2MaxSampleProvider not found for device '$deviceName'. Skipping VO2Max sync for slice $sliceStartBoundary to $sliceEndBoundary.")
-                    return@use emptyList<Vo2MaxSample>()
-                }
-                provider.getAllSamples(sliceStartBoundary.toEpochMilli(), sliceEndBoundary.toEpochMilli())
-            }
-        } catch (e: Exception) {
-            throw SyncException("Error fetching VO2Max samples for device '$deviceName' for slice $sliceStartBoundary to $sliceEndBoundary.", e)
-        }
-
-        if (samples.isEmpty()) {
-            LOG.info("No VO2Max samples found for device '$deviceName' in slice $sliceStartBoundary to $sliceEndBoundary.")
-            return SyncerStatistics(recordType = "VO2Max")
-        }
-
-        LOG.info("Found ${samples.size} VO2Max samples for device '$deviceName' in slice $sliceStartBoundary to $sliceEndBoundary.")
-
-        val recordsToInsert = mutableListOf<Record>()
-        var skippedCount = 0
-        for (sample in samples) {
-            val timestamp = Instant.ofEpochMilli(sample.timestamp)
-
-            if (sample.value <= 0) {
-                LOG.warn("Skipping VO2Max sample for device '$deviceName' at $timestamp due to invalid value: ${sample.value}.")
-                skippedCount++
-                continue
-            }
-
-            if (!timestamp.isBefore(sliceStartBoundary) && timestamp.isBefore(sliceEndBoundary)) {
-                recordsToInsert.add(
-                    Vo2MaxRecord(
-                        time = timestamp,
-                        zoneOffset = offset,
-                        vo2MillilitersPerMinuteKilogram = sample.value.toDouble(),
-                        measurementMethod = Vo2MaxRecord.MEASUREMENT_METHOD_OTHER,
-                        metadata = metadata
-                    )
-                )
-            } else {
-                LOG.debug(
-                    "Skipping VO2Max sample for device '{}' at {} as it's outside the slice {} - {}",
-                    deviceName,
-                    timestamp,
-                    sliceStartBoundary,
-                    sliceEndBoundary
-                )
-                skippedCount++
-            }
-        }
-
-        if (recordsToInsert.isEmpty()) {
-            LOG.info("No valid VO2Max records to insert for device '$deviceName' in slice $sliceStartBoundary to $sliceEndBoundary after filtering.")
-            return SyncerStatistics(recordsSkipped = skippedCount, recordType = "VO2Max")
-        }
-
-        LOG.info("Attempting to insert ${recordsToInsert.size} Vo2MaxRecord(s) for device '$deviceName' for slice $sliceStartBoundary to $sliceEndBoundary.")
-        HealthConnectUtils.insertRecords(recordsToInsert, healthConnectClient)
-
-        LOG.info("Successfully inserted ${recordsToInsert.size} Vo2MaxRecord(s) for device '$deviceName' for slice $sliceStartBoundary to $sliceEndBoundary.")
-        return SyncerStatistics(recordsSynced = recordsToInsert.size, recordsSkipped = skippedCount, recordType = "VO2Max")
+        return Vo2MaxRecord(
+            time = Instant.ofEpochMilli(sample.timestamp),
+            zoneOffset = offset,
+            vo2MillilitersPerMinuteKilogram = sample.value.toDouble(),
+            measurementMethod = Vo2MaxRecord.MEASUREMENT_METHOD_OTHER,
+            metadata = metadata
+        )
     }
 }
\ No newline at end of file
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/WeightSyncer.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/WeightSyncer.kt
index 722c1aeb58..376627287e 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/WeightSyncer.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/healthconnect/syncers/WeightSyncer.kt
@@ -16,112 +16,52 @@
     along with this program.  If not, see <https://www.gnu.org/licenses/>. */
 package nodomain.freeyourgadget.gadgetbridge.util.healthconnect.syncers
 
-import androidx.health.connect.client.HealthConnectClient
-import androidx.health.connect.client.permission.HealthPermission
-import androidx.health.connect.client.records.Record
 import androidx.health.connect.client.records.WeightRecord
 import androidx.health.connect.client.records.metadata.Metadata
 import androidx.health.connect.client.units.Mass
-import nodomain.freeyourgadget.gadgetbridge.GBApplication
+import nodomain.freeyourgadget.gadgetbridge.devices.TimeSampleProvider
+import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice
 import nodomain.freeyourgadget.gadgetbridge.model.WeightSample
-import nodomain.freeyourgadget.gadgetbridge.util.healthconnect.HealthConnectUtils
-import nodomain.freeyourgadget.gadgetbridge.util.healthconnect.SyncException
+import org.slf4j.Logger
 import org.slf4j.LoggerFactory
 import java.time.Instant
 import java.time.ZoneOffset
+import kotlin.reflect.KClass
 
-private val LOG = LoggerFactory.getLogger("WeightSyncer")
+internal object WeightSyncer : AbstractTimeSampleSyncer<WeightSample, WeightRecord>() {
+    override val logger: Logger = LoggerFactory.getLogger(WeightSyncer::class.java)
+    override val recordClass: KClass<WeightRecord> = WeightRecord::class
 
-internal object WeightSyncer : HealthConnectSyncer {
-    override suspend fun sync(
-        healthConnectClient: HealthConnectClient,
+    override fun getSampleProvider(
         gbDevice: GBDevice,
-        metadata: Metadata,
+        daoSession: DaoSession
+    ): TimeSampleProvider<out WeightSample>? {
+        return gbDevice.deviceCoordinator.getWeightSampleProvider(gbDevice, daoSession)
+    }
+
+    override fun convertSample(
+        sample: WeightSample,
         offset: ZoneOffset,
-        sliceStartBoundary: Instant,
-        sliceEndBoundary: Instant,
-        grantedPermissions: Set<String>
-    ): SyncerStatistics {
-        val deviceName = gbDevice.aliasOrName
+        metadata: Metadata,
+        deviceName: String
+    ): WeightRecord? {
+        val weightInKg = sample.getWeightKg()
 
-        if (HealthPermission.getWritePermission(WeightRecord::class) !in grantedPermissions) {
-            LOG.info("Skipping Weight sync for device '$deviceName'; WeightRecord permission not granted.")
-            return SyncerStatistics(recordType = "Weight")
-        }
-
-        val samples = try {
-            GBApplication.acquireDB().use { dbInstance ->
-                val provider = gbDevice.deviceCoordinator.getWeightSampleProvider(gbDevice, dbInstance.daoSession)
-
-                if (provider == null) {
-                    LOG.warn("WeightSampleProvider not found for device '$deviceName'. Skipping Weight sync for slice $sliceStartBoundary to $sliceEndBoundary.")
-                    return@use emptyList<WeightSample>()
-                }
-                provider.getAllSamples(sliceStartBoundary.toEpochMilli(), sliceEndBoundary.toEpochMilli())
-            }
-        } catch (e: Exception) {
-            throw SyncException("Error fetching Weight samples for device '$deviceName' for slice $sliceStartBoundary to $sliceEndBoundary.", e)
-        }
-
-        LOG.info("Found ${samples.size} Weight samples for device '$deviceName' in slice $sliceStartBoundary to $sliceEndBoundary.")
-
-        if (samples.isEmpty()) {
-            LOG.info("No Weight samples to process for device '$deviceName' in slice $sliceStartBoundary to $sliceEndBoundary.")
-            return SyncerStatistics(recordType = "Weight")
-        }
-
-        val recordsToInsert = mutableListOf<Record>()
-        var skippedCount = 0
-        for (sample in samples) {
-            val timestampValue = sample.timestamp
-            val weightInKgValue = sample.getWeightKg()
-
-            val timestamp = Instant.ofEpochMilli(timestampValue)
-
-            if (timestamp.isBefore(sliceStartBoundary) || !timestamp.isBefore(sliceEndBoundary)) {
-                LOG.debug(
-                    "Skipping Weight sample for device '{}' at {} (weight: {}kg) as it's outside the slice {} - {}.",
-                    deviceName,
-                    timestamp,
-                    weightInKgValue,
-                    sliceStartBoundary,
-                    sliceEndBoundary
-                )
-                skippedCount++
-                continue
-            }
-
-            if (weightInKgValue <= 0) {
-                LOG.debug(
-                    "Skipping Weight sample for device '{}' at {} due to invalid weight: {}kg (must be > 0).",
-                    deviceName,
-                    timestamp,
-                    weightInKgValue
-                )
-                skippedCount++
-                continue
-            }
-
-            recordsToInsert.add(
-                WeightRecord(
-                    time = timestamp,
-                    zoneOffset = offset,
-                    weight = Mass.kilograms(weightInKgValue.toDouble()),
-                    metadata = metadata
-                )
+        if (weightInKg <= 0) {
+            logger.debug(
+                "Skipping Weight sample for device '{}' due to invalid weight: {}kg (must be > 0).",
+                deviceName,
+                weightInKg
             )
+            return null
         }
 
-        if (recordsToInsert.isEmpty()) {
-            LOG.info("No valid Weight records to insert for device '$deviceName' in slice $sliceStartBoundary to $sliceEndBoundary after filtering.")
-            return SyncerStatistics(recordsSkipped = skippedCount, recordType = "Weight")
-        }
-
-        LOG.info("Attempting to insert ${recordsToInsert.size} WeightRecord(s) for device '$deviceName' for slice $sliceStartBoundary to $sliceEndBoundary.")
-        HealthConnectUtils.insertRecords(recordsToInsert, healthConnectClient)
-
-        LOG.info("Successfully inserted ${recordsToInsert.size} WeightRecord(s) for device '$deviceName' for slice $sliceStartBoundary to $sliceEndBoundary.")
-        return SyncerStatistics(recordsSynced = recordsToInsert.size, recordsSkipped = skippedCount, recordType = "Weight")
+        return WeightRecord(
+            time = Instant.ofEpochMilli(sample.timestamp),
+            zoneOffset = offset,
+            weight = Mass.kilograms(weightInKg.toDouble()),
+            metadata = metadata
+        )
     }
 }
\ No newline at end of file
```
-----------------------------------
