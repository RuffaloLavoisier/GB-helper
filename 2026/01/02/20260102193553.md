# Commit: 19147e1e36ec6390f327c1b8896eaceb729873fc
## Message: Pebble: Check for watchapp updates if internet is available
## Changed files:
GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AbstractAppManagerFragment.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/RebbleAppStoreActivity.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/database/DBHelper.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/pebble/PebbleSettingsCustomizer.java

app/src/main/res/values/strings.xml

app/src/main/res/xml/devicesettings_pebble_generic.xml

## Diff:
```
diff --git a/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java b/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java
index 72a08e8c8e..c158354683 100644
--- a/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java
+++ b/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java
@@ -67,7 +67,7 @@ public class GBDaoGenerator {
     private static final String TIMESTAMP_TO = "timestampTo";
 
     public static void main(String[] args) throws Exception {
-        final Schema schema = new Schema(122, MAIN_PACKAGE + ".entities");
+        final Schema schema = new Schema(123, MAIN_PACKAGE + ".entities");
 
         Entity userAttributes = addUserAttributes(schema);
         Entity user = addUserInfo(schema, userAttributes);
@@ -213,6 +213,7 @@ public class GBDaoGenerator {
         addAppSpecificNotificationSettings(schema, device);
         addCyclingSample(schema, user, device);
         addAudioRecordings(schema, device);
+        addPebbleAppstoreIdEntry(schema);
 
         Entity notificationFilter = addNotificationFilters(schema);
 
@@ -1461,6 +1462,19 @@ public class GBDaoGenerator {
         return notificatonFilter;
     }
 
+    private static void addPebbleAppstoreIdEntry(Schema schema) {
+        Entity pebbleAppstoreIdEntry = addEntity(schema, "PebbleAppstoreIdEntry");
+        Property uuidProperty = pebbleAppstoreIdEntry.addStringProperty("uuid").notNull().getProperty();
+        pebbleAppstoreIdEntry.addStringProperty("appstoreId").notNull();
+        pebbleAppstoreIdEntry.addLongProperty("lastUpdateCheck").notNull();
+        pebbleAppstoreIdEntry.addBooleanProperty("updateAvailable").notNull();
+
+        Index indexUnique = new Index();
+        indexUnique.addProperty(uuidProperty);
+        indexUnique.makeUnique();
+        pebbleAppstoreIdEntry.addIndex(indexUnique);
+    }
+
     private static void addActivitySummary(Schema schema, Entity user, Entity device) {
         Entity summary = addEntity(schema, "BaseActivitySummary");
         summary.implementsInterface(ACTIVITY_SUMMARY);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AbstractAppManagerFragment.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AbstractAppManagerFragment.java
index e31aa99f1d..86e28ab7ba 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AbstractAppManagerFragment.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/AbstractAppManagerFragment.java
@@ -26,10 +26,13 @@ import android.content.BroadcastReceiver;
 import android.content.Context;
 import android.content.Intent;
 import android.content.IntentFilter;
+import android.content.SharedPreferences;
 import android.graphics.Bitmap;
 import android.graphics.BitmapFactory;
 import android.net.Uri;
 import android.os.Bundle;
+import android.os.Handler;
+import android.os.Looper;
 import android.view.LayoutInflater;
 import android.view.Menu;
 import android.view.MenuItem;
@@ -48,6 +51,7 @@ import com.google.android.material.dialog.MaterialAlertDialogBuilder;
 import com.google.android.material.floatingactionbutton.FloatingActionButton;
 
 import org.apache.commons.lang3.StringUtils;
+import org.json.JSONException;
 import org.json.JSONObject;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
@@ -61,16 +65,21 @@ import java.util.HashMap;
 import java.util.List;
 import java.util.Map;
 import java.util.UUID;
+import java.util.concurrent.ExecutorService;
+import java.util.concurrent.Executors;
 
 import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.activities.ExternalPebbleJSActivity;
 import nodomain.freeyourgadget.gadgetbridge.adapter.GBDeviceAppAdapter;
+import nodomain.freeyourgadget.gadgetbridge.database.DBHelper;
 import nodomain.freeyourgadget.gadgetbridge.devices.DeviceCoordinator;
 import nodomain.freeyourgadget.gadgetbridge.devices.pebble.PebbleCoordinator;
 import nodomain.freeyourgadget.gadgetbridge.devices.qhybrid.FossilFileReader;
 import nodomain.freeyourgadget.gadgetbridge.devices.qhybrid.FossilHRInstallHandler;
 import nodomain.freeyourgadget.gadgetbridge.devices.qhybrid.QHybridConstants;
+import nodomain.freeyourgadget.gadgetbridge.entities.PebbleAppstoreIdEntry;
+import nodomain.freeyourgadget.gadgetbridge.entities.PebbleAppstoreIdEntryDao;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDeviceApp;
 import nodomain.freeyourgadget.gadgetbridge.model.DeviceService;
@@ -80,8 +89,10 @@ import nodomain.freeyourgadget.gadgetbridge.util.FileUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 import nodomain.freeyourgadget.gadgetbridge.util.GridAutoFitLayoutManager;
 import nodomain.freeyourgadget.gadgetbridge.util.InternetHelperSingleton;
+import nodomain.freeyourgadget.gadgetbridge.util.InternetUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.PebbleUtils;
 import nodomain.freeyourgadget.gadgetbridge.util.Version;
+import nodomain.freeyourgadget.gadgetbridge.util.preferences.DevicePrefs;
 
 
 public abstract class AbstractAppManagerFragment extends Fragment {
@@ -134,6 +145,52 @@ public abstract class AbstractAppManagerFragment extends Fragment {
             AppManagerActivity.rewriteAppOrderFile(getSortFilename(), uuids);
         }
         appList.addAll(getCachedApps(uuids));
+
+        // Check for Pebble app updates outside the main thread
+        final ExecutorService executor = Executors.newSingleThreadExecutor();
+        executor.execute(() -> {
+            final boolean internetAvailable = GBApplication.hasInternetAccess();
+            final SharedPreferences devicePrefs = GBApplication.getDevicePrefs(mGBDevice).getPreferences();
+            final boolean pebbleSearchUpdates = devicePrefs.getBoolean("pebble_enable_finding_app_updates", false);
+            if (mGBDevice.getType() == DeviceType.PEBBLE && internetAvailable && pebbleSearchUpdates) {
+                for (GBDeviceApp app : appList) {
+                    PebbleAppstoreIdEntry appstoreIdEntry = DBHelper.getPebbleAppstoreIdByUUID(app.getUUID().toString());
+                    if (appstoreIdEntry != null) {
+                        if (appstoreIdEntry.getUpdateAvailable() || (System.currentTimeMillis() - 60 * 60 * 1000) < appstoreIdEntry.getLastUpdateCheck()) {
+                            // Skip online check if we already know an update is available or when the last check was
+                            // less than an hour ago
+                            continue;
+                        }
+                        LOG.debug("Searching update for Pebble app {} in appstore", app.getName());
+                        try {
+                            JSONObject appstoreEntry = InternetUtils.Companion.doJsonRequest(
+                                    Uri.parse("https://appstore-api.rebble.io/api/v1/apps/id/" + appstoreIdEntry.getAppstoreId()),
+                                    "GET",
+                                    Collections.emptyMap(),
+                                    null,
+                                    "application/json",
+                                    false
+                            );
+                            JSONObject appEntry = (JSONObject) appstoreEntry.getJSONArray("data").get(0);
+                            String latestVersion = appEntry.getJSONObject("latest_release").getString("version");
+                            if (latestVersion.equals(app.getVersion())) {
+                                LOG.info("No update found for Pebble app {} {} in appstore", app.getName(), app.getVersion());
+                                appstoreIdEntry.setUpdateAvailable(false);
+                            } else {
+                                LOG.info("Found update for Pebble app {} ({} -> {}) in appstore", app.getName(), app.getVersion(), latestVersion);
+                                app.setUpToDate(false);
+                                appstoreIdEntry.setUpdateAvailable(true);
+                            }
+                            appstoreIdEntry.setLastUpdateCheck(System.currentTimeMillis());
+                            DBHelper.store(appstoreIdEntry);
+                        } catch (JSONException | NullPointerException e) {
+                            LOG.warn("JSON error while searching for Pebble app update", e);
+                        }
+                    }
+                }
+                new Handler(Looper.getMainLooper()).post(() -> mGBDeviceAppAdapter.notifyDataSetChanged());
+            }
+        });
     }
 
     private void refreshListFromDevice(Intent intent) {
@@ -325,6 +382,12 @@ public abstract class AbstractAppManagerFragment extends Fragment {
                                 LOG.warn("Couldn't read app version", e);
                             }
                         }
+                        if (mGBDevice.getType() == DeviceType.PEBBLE) {
+                            PebbleAppstoreIdEntry appstoreIdEntry = DBHelper.getPebbleAppstoreIdByUUID(app.getUUID().toString());
+                            if (appstoreIdEntry != null && appstoreIdEntry.getUpdateAvailable()) {
+                                app.setUpToDate(false);
+                            }
+                        }
                         cachedAppList.add(app);
                     } catch (Exception e) {
                         LOG.info("could not read json file for " + baseName);
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/RebbleAppStoreActivity.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/RebbleAppStoreActivity.kt
index 8255198394..3374561c70 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/RebbleAppStoreActivity.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/activities/appmanager/RebbleAppStoreActivity.kt
@@ -28,7 +28,9 @@ import android.widget.Toast
 import androidx.core.net.toUri
 import nodomain.freeyourgadget.gadgetbridge.R
 import nodomain.freeyourgadget.gadgetbridge.activities.AbstractGBActivity
+import nodomain.freeyourgadget.gadgetbridge.database.DBHelper
 import nodomain.freeyourgadget.gadgetbridge.devices.InstallHandler
+import nodomain.freeyourgadget.gadgetbridge.entities.PebbleAppstoreIdEntry
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice
 import nodomain.freeyourgadget.gadgetbridge.model.DeviceService
 import nodomain.freeyourgadget.gadgetbridge.util.GB
@@ -39,6 +41,7 @@ import org.json.JSONObject
 import org.slf4j.Logger
 import org.slf4j.LoggerFactory
 import java.io.File
+import java.util.UUID
 
 class RebbleAppStoreActivity : AbstractGBActivity()  {
     val LOG: Logger = LoggerFactory.getLogger(RebbleAppStoreActivity::class.java)
@@ -95,6 +98,8 @@ class RebbleAppStoreActivity : AbstractGBActivity()  {
         if (response != null) {
             val dataArray = response.getJSONArray("data")
             val firstAppObject = dataArray.getJSONObject(0)
+            val appUUID = firstAppObject.getString("uuid")
+            DBHelper.store(PebbleAppstoreIdEntry(appUUID, storeId, System.currentTimeMillis(), false));
             val latestRelease = firstAppObject.getJSONObject("latest_release")
             val pbwFile = latestRelease.getString("pbw_file")
             downloadInstallWatchapp(pbwFile.toUri())
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/database/DBHelper.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/database/DBHelper.java
index 072b12f8c0..9e127e02ae 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/database/DBHelper.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/database/DBHelper.java
@@ -41,6 +41,7 @@ import java.util.Date;
 import java.util.List;
 import java.util.Locale;
 import java.util.Objects;
+import java.util.UUID;
 
 import de.greenrobot.dao.Property;
 import de.greenrobot.dao.query.Query;
@@ -60,6 +61,8 @@ import nodomain.freeyourgadget.gadgetbridge.entities.Device;
 import nodomain.freeyourgadget.gadgetbridge.entities.DeviceAttributes;
 import nodomain.freeyourgadget.gadgetbridge.entities.DeviceAttributesDao;
 import nodomain.freeyourgadget.gadgetbridge.entities.DeviceDao;
+import nodomain.freeyourgadget.gadgetbridge.entities.PebbleAppstoreIdEntry;
+import nodomain.freeyourgadget.gadgetbridge.entities.PebbleAppstoreIdEntryDao;
 import nodomain.freeyourgadget.gadgetbridge.entities.Reminder;
 import nodomain.freeyourgadget.gadgetbridge.entities.ReminderDao;
 import nodomain.freeyourgadget.gadgetbridge.entities.Tag;
@@ -723,6 +726,20 @@ public class DBHelper {
         return Collections.emptyList();
     }
 
+    public static PebbleAppstoreIdEntry getPebbleAppstoreIdByUUID(@NonNull String appUUID) {
+        try (DBHandler db = GBApplication.acquireDB()) {
+            final DaoSession daoSession = db.getDaoSession();
+            final PebbleAppstoreIdEntryDao entryDao = daoSession.getPebbleAppstoreIdEntryDao();
+            final QueryBuilder<PebbleAppstoreIdEntry> qb = entryDao.queryBuilder();
+            qb.where(PebbleAppstoreIdEntryDao.Properties.Uuid.eq(appUUID));
+            return qb.build().unique();
+        } catch (final Exception e) {
+            LOG.error("Error reading appstoreId from db", e);
+        }
+
+        return null;
+    }
+
     public static void store(final Reminder reminder) {
         try (DBHandler db = GBApplication.acquireDB()) {
             final DaoSession daoSession = db.getDaoSession();
@@ -750,6 +767,15 @@ public class DBHelper {
         }
     }
 
+    public static void store(final PebbleAppstoreIdEntry entry) {
+        try (DBHandler db = GBApplication.acquireDB()) {
+            final DaoSession daoSession = db.getDaoSession();
+            daoSession.insertOrReplace(entry);
+        } catch (final Exception e) {
+            LOG.error("Error acquiring database", e);
+        }
+    }
+
     public static void delete(final Reminder reminder) {
         try (DBHandler db = GBApplication.acquireDB()) {
             final DaoSession daoSession = db.getDaoSession();
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/pebble/PebbleSettingsCustomizer.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/pebble/PebbleSettingsCustomizer.java
index b55735e9c0..4fab0e5a52 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/pebble/PebbleSettingsCustomizer.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/pebble/PebbleSettingsCustomizer.java
@@ -1,52 +1,25 @@
 package nodomain.freeyourgadget.gadgetbridge.devices.pebble;
 
-import android.content.ClipData;
-import android.content.ClipboardManager;
-import android.content.Context;
-import android.content.Intent;
-import android.net.Uri;
 import android.os.Parcel;
-import android.text.Editable;
-import android.text.InputFilter;
 import android.text.InputType;
-import android.text.TextWatcher;
-import android.widget.Toast;
 
-import androidx.activity.result.ActivityResultLauncher;
-import androidx.activity.result.contract.ActivityResultContracts;
 import androidx.annotation.NonNull;
-import androidx.documentfile.provider.DocumentFile;
 import androidx.preference.EditTextPreference;
 import androidx.preference.Preference;
-import androidx.preference.PreferenceCategory;
-
-import com.google.android.material.dialog.MaterialAlertDialogBuilder;
 
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
 import java.text.SimpleDateFormat;
 import java.util.Collections;
-import java.util.Date;
-import java.util.List;
 import java.util.Locale;
 import java.util.Set;
-import java.util.concurrent.atomic.AtomicInteger;
 
-import nodomain.freeyourgadget.gadgetbridge.R;
-import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsPreferenceConst;
-import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSettingsUtils;
+import nodomain.freeyourgadget.gadgetbridge.GBApplication;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSpecificSettingsCustomizer;
 import nodomain.freeyourgadget.gadgetbridge.activities.devicesettings.DeviceSpecificSettingsHandler;
-import nodomain.freeyourgadget.gadgetbridge.devices.garmin.GarminPreferences;
-import nodomain.freeyourgadget.gadgetbridge.devices.garmin.GarminRealtimeSettingsActivity;
-import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
-import nodomain.freeyourgadget.gadgetbridge.service.devices.garmin.agps.GarminAgpsStatus;
-import nodomain.freeyourgadget.gadgetbridge.util.GB;
 import nodomain.freeyourgadget.gadgetbridge.util.Prefs;
 
-import static nodomain.freeyourgadget.gadgetbridge.util.GB.toast;
-
 public class PebbleSettingsCustomizer implements DeviceSpecificSettingsCustomizer {
     public static final Creator<PebbleSettingsCustomizer> CREATOR = new Creator<PebbleSettingsCustomizer>() {
         @Override
@@ -69,13 +42,17 @@ public class PebbleSettingsCustomizer implements DeviceSpecificSettingsCustomize
     @Override
     public void customizeSettings(final DeviceSpecificSettingsHandler handler, final Prefs prefs, final String rootKey) {
         final EditTextPreference pref = handler.findPreference("pebble_mtu_limit");
-        if (pref == null) {
-            return;
+        if (pref != null) {
+            pref.setOnBindEditTextListener(p -> {
+                p.setInputType(InputType.TYPE_CLASS_NUMBER);
+                p.setSelection(p.getText().length());
+            });
+        }
+
+        final Preference appUpdatePref = handler.findPreference("pebble_enable_finding_app_updates");
+        if (appUpdatePref != null && !GBApplication.hasInternetAccess()) {
+            appUpdatePref.setEnabled(false);
         }
-        pref.setOnBindEditTextListener(p -> {
-            p.setInputType(InputType.TYPE_CLASS_NUMBER);
-            p.setSelection(p.getText().length());
-        });
     }
 
     @Override
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index 0d0dfa4b3e..133d39ed44 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -4498,4 +4498,6 @@
     <string name="dangerous_actions">Dangerous actions</string>
     <string name="debug_other_actions">Other actions</string>
     <string name="prefs_title_battery_allow_bypass_mode">Allow battery bypass</string>
+    <string name="pref_title_pebble_search_app_updates">Search for app updates</string>
+    <string name="pref_summary_pebble_search_app_updates">Automatically search for watch app and watchface updates when opening the app manager</string>
 </resources>
diff --git a/app/src/main/res/xml/devicesettings_pebble_generic.xml b/app/src/main/res/xml/devicesettings_pebble_generic.xml
index d6ef66ed88..575630f062 100644
--- a/app/src/main/res/xml/devicesettings_pebble_generic.xml
+++ b/app/src/main/res/xml/devicesettings_pebble_generic.xml
@@ -6,7 +6,14 @@
         android:defaultValue="false"
         android:key="pebble_enable_background_javascript"
         android:layout="@layout/preference_checkbox"
-        android:summary="@string/pref_summary_pebble_enable_bgjs"
         android:title="@string/pref_title_pebble_enable_bgjs"
+        android:summary="@string/pref_summary_pebble_enable_bgjs"
+        app:iconSpaceReserved="false" />
+    <SwitchPreferenceCompat
+        android:defaultValue="false"
+        android:key="pebble_enable_finding_app_updates"
+        android:layout="@layout/preference_checkbox"
+        android:title="@string/pref_title_pebble_search_app_updates"
+        android:summary="@string/pref_summary_pebble_search_app_updates"
         app:iconSpaceReserved="false" />
 </androidx.preference.PreferenceScreen>
```
-----------------------------------
