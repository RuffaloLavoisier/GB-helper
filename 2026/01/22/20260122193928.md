# Commit: 5cb242564396b17f2743a9cf0608fe3114698976
## Message: SBM67: Extract blood pressure profile
## Changed files:
app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/GenericBloodPressureSampleProvider.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/bloodpressure/BloodPressureMeasurement.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/bloodpressure/BloodPressureProfile.kt

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/SBM67BloodPressureSampleProvider.java

GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/SBM67Coordinator.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/sbm_67/SBM67DeviceSupport.java

app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/kotlin/ByteBufferExtensions.kt

app/src/main/res/values/strings.xml

app/src/test/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinatorTest.java

## Diff:
```
diff --git a/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java b/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java
index 2ad101148a..f9331fb9b2 100644
--- a/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java
+++ b/GBDaoGenerator/src/nodomain/freeyourgadget/gadgetbridge/daogen/GBDaoGenerator.java
@@ -139,7 +139,7 @@ public class GBDaoGenerator {
         addPineTimeActivitySample(schema, user, device);
         addPolarH10ActivitySample(schema, user, device);
         addWithingsSteelHRActivitySample(schema, user, device);
-        addSBM67BloodPressureSample(schema, user, device);
+        addGenericBloodPressureSample(schema, user, device);
         addHybridHRActivitySample(schema, user, device);
         addHybridHRSpo2Sample(schema, user, device);
         addVivomoveHrActivitySample(schema, user, device);
@@ -2245,16 +2245,14 @@ public class GBDaoGenerator {
         return sample;
     }
 
-    private static Entity addSBM67BloodPressureSample(Schema schema, Entity user, Entity device) {
-        Entity bloodPressureSample = addEntity(schema, "SBM67BloodPressureSample");
+    private static Entity addGenericBloodPressureSample(Schema schema, Entity user, Entity device) {
+        Entity bloodPressureSample = addEntity(schema, "GenericBloodPressureSample");
         addCommonTimeSampleProperties("AbstractBloodPressureSample", bloodPressureSample, user, device);
         addBloodPressureProperies(bloodPressureSample);
-        bloodPressureSample.addIntProperty("userIndex"); //device can store measurements for up to 4 users
+        bloodPressureSample.addIntProperty("userIndex");
         bloodPressureSample.addIntProperty("meanArterialPressure");
-        bloodPressureSample.addIntProperty("pulse");
-        bloodPressureSample.addIntProperty("readingStatus");
-        bloodPressureSample.addBooleanProperty("heartRhythmDisorder");
-        bloodPressureSample.addBooleanProperty("restingIndicator");
+        bloodPressureSample.addIntProperty("pulseRate");
+        bloodPressureSample.addIntProperty("measurementStatus");
         return bloodPressureSample;
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/SBM67BloodPressureSampleProvider.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/GenericBloodPressureSampleProvider.java
similarity index 65%
rename from app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/SBM67BloodPressureSampleProvider.java
rename to app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/GenericBloodPressureSampleProvider.java
index f877dcee92..ccf9719552 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/SBM67BloodPressureSampleProvider.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/GenericBloodPressureSampleProvider.java
@@ -22,35 +22,35 @@ import de.greenrobot.dao.AbstractDao;
 import de.greenrobot.dao.Property;
 import nodomain.freeyourgadget.gadgetbridge.devices.AbstractTimeSampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession;
-import nodomain.freeyourgadget.gadgetbridge.entities.SBM67BloodPressureSample;
-import nodomain.freeyourgadget.gadgetbridge.entities.SBM67BloodPressureSampleDao;
+import nodomain.freeyourgadget.gadgetbridge.entities.GenericBloodPressureSample;
+import nodomain.freeyourgadget.gadgetbridge.entities.GenericBloodPressureSampleDao;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 
-public class SBM67BloodPressureSampleProvider extends AbstractTimeSampleProvider<SBM67BloodPressureSample> {
-    public SBM67BloodPressureSampleProvider(final GBDevice device, final DaoSession session) {
+public class GenericBloodPressureSampleProvider extends AbstractTimeSampleProvider<GenericBloodPressureSample> {
+    public GenericBloodPressureSampleProvider(final GBDevice device, final DaoSession session) {
         super(device, session);
     }
 
     @NonNull
     @Override
-    public AbstractDao<SBM67BloodPressureSample, ?> getSampleDao() {
-        return getSession().getSBM67BloodPressureSampleDao();
+    public AbstractDao<GenericBloodPressureSample, ?> getSampleDao() {
+        return getSession().getGenericBloodPressureSampleDao();
     }
 
     @NonNull
     @Override
     protected Property getTimestampSampleProperty() {
-        return SBM67BloodPressureSampleDao.Properties.Timestamp;
+        return GenericBloodPressureSampleDao.Properties.Timestamp;
     }
 
     @NonNull
     @Override
     protected Property getDeviceIdentifierSampleProperty() {
-        return SBM67BloodPressureSampleDao.Properties.DeviceId;
+        return GenericBloodPressureSampleDao.Properties.DeviceId;
     }
 
     @Override
-    public SBM67BloodPressureSample createSample() {
-        return new SBM67BloodPressureSample();
+    public GenericBloodPressureSample createSample() {
+        return new GenericBloodPressureSample();
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/SBM67Coordinator.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/SBM67Coordinator.java
index 03328282cc..44a4cbf38c 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/SBM67Coordinator.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/devices/sbm_67/SBM67Coordinator.java
@@ -32,7 +32,7 @@ public class SBM67Coordinator extends AbstractBLEDeviceCoordinator {
     @Nullable
     @Override
     protected Pattern getSupportedDeviceName() {
-        return Pattern.compile("^(SBM67|BPM Smart)$", Pattern.CASE_INSENSITIVE);
+        return Pattern.compile("^(SBM67|BPM Smart)$");
     }
 
     @Override
@@ -58,7 +58,12 @@ public class SBM67Coordinator extends AbstractBLEDeviceCoordinator {
 
     @Override
     public int getBondingStyle() {
-        return BONDING_STYLE_NONE;
+        return BONDING_STYLE_BOND;
+    }
+
+    @Override
+    public int getBatteryCount(GBDevice device) {
+        return 0; // it does not report battery %
     }
 
     @Override
@@ -67,7 +72,7 @@ public class SBM67Coordinator extends AbstractBLEDeviceCoordinator {
     }
 
     @Override
-    public SBM67BloodPressureSampleProvider getBloodPressureSampleProvider(GBDevice device, DaoSession session) {
-        return new SBM67BloodPressureSampleProvider(device, session);
+    public GenericBloodPressureSampleProvider getBloodPressureSampleProvider(final GBDevice device, final DaoSession session) {
+        return new GenericBloodPressureSampleProvider(device, session);
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/bloodpressure/BloodPressureMeasurement.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/bloodpressure/BloodPressureMeasurement.kt
new file mode 100644
index 0000000000..a4632d9881
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/bloodpressure/BloodPressureMeasurement.kt
@@ -0,0 +1,15 @@
+package nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.bloodpressure
+
+import android.os.Parcelable
+import kotlinx.parcelize.Parcelize
+
+@Parcelize
+data class BloodPressureMeasurement(
+    val timestamp: Long,
+    val systolicMmHg: Int,
+    val diastolicMmHg: Int,
+    val meanArterialPressure: Int,
+    val pulseRate: Int?,
+    val userId: Int?,
+    val measurementStatus: Int?,
+): Parcelable
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/bloodpressure/BloodPressureProfile.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/bloodpressure/BloodPressureProfile.kt
new file mode 100644
index 0000000000..6d49a2f1a6
--- /dev/null
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/btle/profiles/bloodpressure/BloodPressureProfile.kt
@@ -0,0 +1,123 @@
+package nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.bloodpressure
+
+import android.bluetooth.BluetoothGatt
+import android.bluetooth.BluetoothGattCharacteristic
+import android.content.Intent
+import nodomain.freeyourgadget.gadgetbridge.service.btle.AbstractBTLESingleDeviceSupport
+import nodomain.freeyourgadget.gadgetbridge.service.btle.GattCharacteristic
+import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder
+import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.AbstractBleProfile
+import nodomain.freeyourgadget.gadgetbridge.util.kotlin.getSFloat
+import org.slf4j.LoggerFactory
+import java.nio.ByteBuffer
+import java.nio.ByteOrder
+import java.util.GregorianCalendar
+import kotlin.math.roundToInt
+
+class BloodPressureProfile<T : AbstractBTLESingleDeviceSupport>(val support: T) : AbstractBleProfile<T>(support) {
+    override fun enableNotify(builder: TransactionBuilder, enable: Boolean) {
+        builder.notify(GattCharacteristic.UUID_CHARACTERISTIC_BLOOD_PRESSURE_MEASUREMENT, enable)
+    }
+
+    override fun onCharacteristicChanged(
+        gatt: BluetoothGatt,
+        characteristic: BluetoothGattCharacteristic,
+        value: ByteArray
+    ): Boolean {
+        if (GattCharacteristic.UUID_CHARACTERISTIC_BLOOD_PRESSURE_MEASUREMENT != characteristic.uuid) {
+            return false
+        }
+
+        val buf = ByteBuffer.wrap(value).order(ByteOrder.LITTLE_ENDIAN)
+
+        val flags = buf.get().toInt()
+        val systolicRaw: Float = buf.getSFloat()
+        val diastolicRaw: Float = buf.getSFloat()
+        val meanArterialPressureRaw: Float = buf.getSFloat()
+
+        val systolic: Int
+        val diastolic: Int
+        val meanArterialPressure: Int
+
+        if ((flags and FLAG_UNIT) != 0) {
+            systolic = (systolicRaw * 7.50061683).roundToInt()
+            diastolic = (diastolicRaw * 7.50061683).roundToInt()
+            meanArterialPressure = (meanArterialPressureRaw * 7.50061683).roundToInt()
+        } else {
+            systolic = systolicRaw.roundToInt()
+            diastolic = diastolicRaw.roundToInt()
+            meanArterialPressure = meanArterialPressureRaw.roundToInt()
+        }
+
+        val timestamp: Long
+        if ((flags and FLAG_TIMESTAMP) != 0) {
+            val year = buf.getShort()
+            val month = buf.get()
+            val day = buf.get()
+
+            val hour = buf.get()
+            val minute = buf.get()
+            val second = buf.get()
+
+            val c = GregorianCalendar.getInstance()
+            c.set(year.toInt(), month - 1, day.toInt(), hour.toInt(), minute.toInt(), second.toInt())
+
+            timestamp = c.getTime().time
+        } else {
+            timestamp = System.currentTimeMillis()
+        }
+
+        val pulseRate = if ((flags and FLAG_PULSE_RATE) != 0) {
+            buf.getSFloat().roundToInt()
+        } else {
+            null
+        }
+
+        val userId = if ((flags and FLAG_USER_ID) != 0) {
+            buf.get().toInt() and 0xff
+        } else {
+            null
+        }
+
+        val measurementStatus = if ((flags and FLAG_MEASUREMENT_STATUS) != 0) {
+            buf.get().toInt() and 0xff
+        } else {
+            null
+        }
+
+        val measurement = BloodPressureMeasurement(
+            timestamp,
+            systolic,
+            diastolic,
+            meanArterialPressure,
+            pulseRate,
+            userId,
+            measurementStatus,
+        )
+
+        LOG.debug("Got blood pressure measurement: {}", measurement)
+
+        notify(createIntent(measurement))
+
+        return true
+    }
+
+    private fun createIntent(measurement: BloodPressureMeasurement): Intent {
+        val intent = Intent(ACTION_BLOOD_PRESSURE)
+        intent.putExtra(EXTRA_BLOOD_PRESSURE, measurement)
+        return intent
+    }
+
+    companion object {
+        private val LOG = LoggerFactory.getLogger(BloodPressureProfile::class.java)
+
+        const val ACTION_BLOOD_PRESSURE = "nodomain.freeyourgadget.gadgetbridge.ble.profile.ACTION_BLOOD_PRESSURE"
+        const val EXTRA_BLOOD_PRESSURE = "blood_pressure_measurement"
+
+        const val FLAG_UNIT = 0x01
+        const val FLAG_TIMESTAMP = 0x02
+        const val FLAG_PULSE_RATE = 0x04
+        const val FLAG_USER_ID = 0x08
+        const val FLAG_MEASUREMENT_STATUS = 0x10
+    }
+}
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/sbm_67/SBM67DeviceSupport.java b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/sbm_67/SBM67DeviceSupport.java
index 6dfd9d117d..e813940892 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/sbm_67/SBM67DeviceSupport.java
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/service/devices/sbm_67/SBM67DeviceSupport.java
@@ -24,207 +24,192 @@ import android.content.Intent;
 import android.content.IntentFilter;
 import android.widget.Toast;
 
+import androidx.annotation.CallSuper;
 import androidx.localbroadcastmanager.content.LocalBroadcastManager;
 
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
-import java.nio.ByteBuffer;
-import java.nio.ByteOrder;
 import java.util.ArrayList;
-import java.util.Calendar;
-import java.util.GregorianCalendar;
 import java.util.List;
+import java.util.stream.Collectors;
 
 import nodomain.freeyourgadget.gadgetbridge.GBApplication;
+import nodomain.freeyourgadget.gadgetbridge.R;
 import nodomain.freeyourgadget.gadgetbridge.database.DBHandler;
-import nodomain.freeyourgadget.gadgetbridge.database.DBHelper;
 import nodomain.freeyourgadget.gadgetbridge.deviceevents.GBDeviceEventVersionInfo;
-import nodomain.freeyourgadget.gadgetbridge.devices.sbm_67.SBM67BloodPressureSampleProvider;
-import nodomain.freeyourgadget.gadgetbridge.devices.sbm_67.SBM67Coordinator;
+import nodomain.freeyourgadget.gadgetbridge.devices.sbm_67.GenericBloodPressureSampleProvider;
 import nodomain.freeyourgadget.gadgetbridge.entities.DaoSession;
-import nodomain.freeyourgadget.gadgetbridge.entities.Device;
-import nodomain.freeyourgadget.gadgetbridge.entities.SBM67BloodPressureSample;
-import nodomain.freeyourgadget.gadgetbridge.entities.User;
+import nodomain.freeyourgadget.gadgetbridge.entities.GenericBloodPressureSample;
 import nodomain.freeyourgadget.gadgetbridge.impl.GBDevice;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.AbstractBTLESingleDeviceSupport;
-import nodomain.freeyourgadget.gadgetbridge.service.btle.GattCharacteristic;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.GattService;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.TransactionBuilder;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.actions.SetDeviceStateAction;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.IntentListener;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.bloodpressure.BloodPressureMeasurement;
+import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.bloodpressure.BloodPressureProfile;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.deviceinfo.DeviceInfo;
 import nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.deviceinfo.DeviceInfoProfile;
-import nodomain.freeyourgadget.gadgetbridge.util.DeviceHelper;
 import nodomain.freeyourgadget.gadgetbridge.util.GB;
 
-public class SBM67DeviceSupport extends AbstractBTLESingleDeviceSupport {
+public class SBM67DeviceSupport extends AbstractBTLESingleDeviceSupport implements IntentListener {
     private static final Logger LOG = LoggerFactory.getLogger(nodomain.freeyourgadget.gadgetbridge.service.devices.sbm_67.SBM67DeviceSupport.class);
 
     private final DeviceInfoProfile<SBM67DeviceSupport> deviceInfoProfile;
-    private final GBDeviceEventVersionInfo versionCmd = new GBDeviceEventVersionInfo();
+    private final BloodPressureProfile<SBM67DeviceSupport> bloodPressureProfile;
+    private final BroadcastReceiver commandReceiver;
 
-    private List<SBM67BloodPressureSample> samples;
+    private final List<BloodPressureMeasurement> measurements = new ArrayList<>();
 
     public SBM67DeviceSupport() {
         super(LOG);
+
         addSupportedService(GattService.UUID_SERVICE_BLOOD_PRESSURE);
         addSupportedService(GattService.UUID_SERVICE_DEVICE_INFORMATION);
 
-        samples = new ArrayList<>();
-
         deviceInfoProfile = new DeviceInfoProfile<>(this);
-        IntentListener mListener = intent -> {
-            String s = intent.getAction();
-            if (DeviceInfoProfile.ACTION_DEVICE_INFO.equals(s)) {
-                DeviceInfo deviceInfo = intent.getParcelableExtra(DeviceInfoProfile.EXTRA_DEVICE_INFO);
-                if (deviceInfo != null) {
-                    handleDeviceInfo(deviceInfo);
-                }
-            }
-        };
-        deviceInfoProfile.addListener(mListener);
+        deviceInfoProfile.addListener(this);
         addSupportedProfile(deviceInfoProfile);
 
-        IntentFilter commandFilter = new IntentFilter();
-        commandFilter.addAction(GBDevice.ACTION_DEVICE_CHANGED);
-        BroadcastReceiver commandReceiver = new BroadcastReceiver() {
+        bloodPressureProfile = new BloodPressureProfile<>(this);
+        bloodPressureProfile.addListener(this);
+        addSupportedProfile(bloodPressureProfile);
+
+        commandReceiver = new BroadcastReceiver() {
             @Override
             public void onReceive(Context context, Intent intent) {
                 if (GBDevice.ACTION_DEVICE_CHANGED.equals(intent.getAction())) {
-                    GBDevice.DeviceUpdateSubject subject = (GBDevice.DeviceUpdateSubject) intent.getSerializableExtra(GBDevice.EXTRA_UPDATE_SUBJECT);
+                    final GBDevice.DeviceUpdateSubject subject = (GBDevice.DeviceUpdateSubject) intent.getSerializableExtra(GBDevice.EXTRA_UPDATE_SUBJECT);
 
                     if (GBDevice.DeviceUpdateSubject.CONNECTION_STATE.equals(subject) &&
                             GBDevice.State.NOT_CONNECTED.equals(gbDevice.getState()) &&
-                            !samples.isEmpty()) {
+                            !measurements.isEmpty()) {
                         // This particular device disconnects automatically once the transfer is finished, hence this method of persisting the samples works, but it's far from ideal
-                        persistSamples();
-                        samples.clear();
+                        persistMeasurements();
+                        measurements.clear();
                     }
                 }
             }
         };
+
+        final IntentFilter commandFilter = new IntentFilter();
+        commandFilter.addAction(GBDevice.ACTION_DEVICE_CHANGED);
         LocalBroadcastManager.getInstance(GBApplication.getContext()).registerReceiver(commandReceiver, commandFilter);
     }
 
-    /**
-     * Subclasses should populate the given builder to initialize the device (if necessary).
-     *
-     * @param builder
-     * @return the same builder as passed as the argument
-     */
+    @Override
+    public boolean useAutoConnect() {
+        return false;
+    }
+
     @Override
     protected TransactionBuilder initializeDevice(TransactionBuilder builder) {
-
-        samples = new ArrayList<>();
-
-        deviceInfoProfile.requestDeviceInfo(builder);
-
-        builder.setCallback(this);
+        measurements.clear();
 
         // mark the device as initializing
         builder.add(new SetDeviceStateAction(getDevice(), GBDevice.State.INITIALIZING, getContext()));
 
-        builder.notify(getCharacteristic(GattCharacteristic.UUID_CHARACTERISTIC_BLOOD_PRESSURE_MEASUREMENT), true);
+        // request device info
+        deviceInfoProfile.requestDeviceInfo(builder);
+
+        // enable blood pressure notifications
+        bloodPressureProfile.enableNotify(builder, true);
 
         // mark the device as initialized
         builder.add(new SetDeviceStateAction(getDevice(), GBDevice.State.INITIALIZED, getContext()));
+
         return builder;
     }
 
-    private void handleDeviceInfo(nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.deviceinfo.DeviceInfo info) {
+    @CallSuper
+    @Override
+    public void dispose() {
+        synchronized (ConnectionMonitor) {
+            try {
+                LocalBroadcastManager.getInstance(GBApplication.getContext()).unregisterReceiver(commandReceiver);
+            } catch (final Exception e) {
+                LOG.error("Failed to unregister receiver", e);
+            }
+
+            super.dispose();
+        }
+    }
+
+    @Override
+    public boolean onCharacteristicChanged(final BluetoothGatt gatt,
+                                           final BluetoothGattCharacteristic characteristic,
+                                           final byte[] value) {
+        if (super.onCharacteristicChanged(gatt, characteristic, value)) {
+            return true;
+        }
+
+        LOG.warn("Unhandled characteristic changed: {} {}", characteristic.getUuid(), GB.hexdump(value));
+
+        return false;
+    }
+
+    protected void persistMeasurements() {
+        if (measurements.isEmpty()) {
+            LOG.debug("No measurements to persist");
+            return;
+        }
+
+        LOG.debug("Will persist {} blood pressure measurements", measurements.size());
+
+        final List<GenericBloodPressureSample> samples = measurements.stream().map(measurement -> {
+            final GenericBloodPressureSample sample = new GenericBloodPressureSample();
+            sample.setTimestamp(measurement.getTimestamp());
+            sample.setBpSystolic(measurement.getSystolicMmHg());
+            sample.setBpDiastolic(measurement.getDiastolicMmHg());
+            sample.setMeanArterialPressure(measurement.getMeanArterialPressure());
+            sample.setPulseRate(measurement.getPulseRate());
+            sample.setUserIndex(measurement.getUserId());
+            sample.setMeasurementStatus(measurement.getMeasurementStatus());
+            return sample;
+        }).collect(Collectors.toList());
+
+        try (DBHandler handler = GBApplication.acquireDB()) {
+            final DaoSession session = handler.getDaoSession();
+            final GenericBloodPressureSampleProvider sampleProvider = new GenericBloodPressureSampleProvider(getDevice(), session);
+            sampleProvider.persistForDevice(getContext(), getDevice(), samples);
+        } catch (final Exception e) {
+            GB.toast(getContext(), "Error saving blood pressure samples", Toast.LENGTH_LONG, GB.ERROR, e);
+        }
+
+        GB.signalActivityDataFinish(getDevice());
+    }
+
+    @Override
+    public void notify(final Intent intent) {
+        if (DeviceInfoProfile.ACTION_DEVICE_INFO.equals(intent.getAction())) {
+            final DeviceInfo deviceInfo = intent.getParcelableExtra(DeviceInfoProfile.EXTRA_DEVICE_INFO);
+            if (deviceInfo != null) {
+                handleDeviceInfo(deviceInfo);
+            }
+        }
+        if (BloodPressureProfile.ACTION_BLOOD_PRESSURE.equals(intent.getAction())) {
+            final BloodPressureMeasurement measurement = intent.getParcelableExtra(BloodPressureProfile.EXTRA_BLOOD_PRESSURE);
+            if (measurement != null) {
+                // If we're not marked as busy yet, do it now
+                if (!getDevice().isBusy()) {
+                    getDevice().setBusyTask(R.string.busy_task_fetch_blood_pressure_data, getContext());
+                    getDevice().sendDeviceUpdateIntent(getContext());
+                }
+
+                handleBloodPressureMeasurement(measurement);
+            }
+        }
+    }
+
+    private void handleDeviceInfo(final nodomain.freeyourgadget.gadgetbridge.service.btle.profiles.deviceinfo.DeviceInfo info) {
+        final GBDeviceEventVersionInfo versionCmd = new GBDeviceEventVersionInfo();
         versionCmd.hwVersion = info.getHardwareRevision();
         versionCmd.fwVersion = info.getFirmwareRevision();
         handleGBDeviceEvent(versionCmd);
     }
 
-    @Override
-    public boolean onCharacteristicChanged(BluetoothGatt gatt, BluetoothGattCharacteristic characteristic, byte[] value) {
-
-        if (GattCharacteristic.UUID_CHARACTERISTIC_BLOOD_PRESSURE_MEASUREMENT.equals(characteristic.getUuid())) {
-            ByteBuffer incoming = ByteBuffer.wrap(value);
-            incoming.order(ByteOrder.LITTLE_ENDIAN);
-
-            final SBM67BloodPressureSample bloodPressureSample = new SBM67BloodPressureSample();
-
-            byte unk = incoming.get();
-            short syst = incoming.getShort();//
-            short dia = incoming.getShort();//
-            if ((unk & 1) != 0) {
-                bloodPressureSample.setBpSystolic((int) ((int) syst * 7.50061683d));
-                bloodPressureSample.setBpDiastolic((int) ((int) dia * 7.50061683d));
-            } else {
-                bloodPressureSample.setBpSystolic((int) syst);
-                bloodPressureSample.setBpDiastolic((int) dia);
-            }
-            short map = incoming.getShort(); //mean arterial pressure
-            bloodPressureSample.setMeanArterialPressure((int) map);
-
-            if ((unk & 2) != 0) {
-                short year = incoming.getShort();
-                byte month = incoming.get();
-                byte day = incoming.get();
-
-                byte hour = incoming.get();
-                byte minute = incoming.get();
-                byte second = incoming.get();
-
-                Calendar c = GregorianCalendar.getInstance();
-                c.set(year, month - 1, day, hour, minute, second);
-
-                bloodPressureSample.setTimestamp(c.getTime().getTime());
-            }
-            byte pulse = incoming.get();//
-            bloodPressureSample.setPulse((int) pulse & 0xff);
-            incoming.get();//skip
-            byte user = incoming.get();//
-            bloodPressureSample.setUserIndex((int) user);
-
-            byte status = incoming.get();//
-            bloodPressureSample.setReadingStatus((int) status);
-            bloodPressureSample.setHeartRhythmDisorder((status & 4) != 0);
-            bloodPressureSample.setRestingIndicator((status & 64) != 0);
-
-            samples.add(bloodPressureSample);
-            return true;
-        }
-
-        return super.onCharacteristicChanged(gatt, characteristic, value);
-    }
-
-
-    protected void persistSamples() {
-
-        try (DBHandler handler = GBApplication.acquireDB()) {
-            final DaoSession session = handler.getDaoSession();
-
-            final Device device = DBHelper.getDevice(getDevice(), session);
-            final User user = DBHelper.getUser(session);
-
-            final SBM67Coordinator coordinator = (SBM67Coordinator) getDevice().getDeviceCoordinator();
-            final SBM67BloodPressureSampleProvider sampleProvider = coordinator.getBloodPressureSampleProvider(getDevice(), session);
-
-            for (final SBM67BloodPressureSample sample : samples) {
-                sample.setDevice(device);
-                sample.setUser(user);
-            }
-
-            LOG.debug("Will persist {} blood pressure samples", samples.size());
-            sampleProvider.addSamples(samples);
-        } catch (final Exception e) {
-            GB.toast(getContext(), "Error saving blood pressure samples", Toast.LENGTH_LONG, GB.ERROR, e);
-            return;
-        }
-
-        return;
-    }
-
-    /**
-     * Returns true if a connection attempt shall be made automatically whenever
-     * needed (e.g. when a notification shall be sent to the device while not connected.
-     */
-    @Override
-    public boolean useAutoConnect() {
-        return false;
+    private void handleBloodPressureMeasurement(final BloodPressureMeasurement measurement) {
+        measurements.add(measurement);
     }
 }
diff --git a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/kotlin/ByteBufferExtensions.kt b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/kotlin/ByteBufferExtensions.kt
index 32b14cacff..ab83ade6a4 100644
--- a/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/kotlin/ByteBufferExtensions.kt
+++ b/app/src/main/java/nodomain/freeyourgadget/gadgetbridge/util/kotlin/ByteBufferExtensions.kt
@@ -2,7 +2,24 @@ package nodomain.freeyourgadget.gadgetbridge.util.kotlin
 
 import nodomain.freeyourgadget.gadgetbridge.util.StringUtils
 import java.nio.ByteBuffer
+import kotlin.math.pow
 
 fun ByteBuffer.stringUntilNullTerminator(): String? {
     return StringUtils.untilNullTerminator(this)
 }
+
+fun ByteBuffer.getSFloat(): Float {
+    val raw = getShort().toInt() and 0xFFFF
+
+    var mantissa = raw and 0x0FFF
+    if (mantissa >= 0x0800) {
+        mantissa -= 0x1000
+    }
+
+    var exponent = (raw shr 12) and 0x0F
+    if (exponent >= 0x08) {
+        exponent -= 0x10
+    }
+
+    return (mantissa * 10.0.pow(exponent.toDouble())).toFloat()
+}
diff --git a/app/src/main/res/values/strings.xml b/app/src/main/res/values/strings.xml
index 22f19f190d..7a69d7de98 100644
--- a/app/src/main/res/values/strings.xml
+++ b/app/src/main/res/values/strings.xml
@@ -759,6 +759,7 @@
     <string name="initializing">Initializing</string>
     <string name="busy_task_fetch_activity_data">Fetching activity data</string>
     <string name="busy_task_fetch_glucose_data">Fetching glucose data</string>
+    <string name="busy_task_fetch_blood_pressure_data">Fetching blood pressure data</string>
     <string name="busy_task_fetch_sports_summaries">Fetching sports summaries</string>
     <string name="busy_task_fetch_sports_details">Fetching sports details</string>
     <string name="busy_task_fetch_sports_details_interrupted">Fetching sports details was interrupted</string>
diff --git a/app/src/test/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinatorTest.java b/app/src/test/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinatorTest.java
index 153c55567d..c566e92adc 100644
--- a/app/src/test/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinatorTest.java
+++ b/app/src/test/java/nodomain/freeyourgadget/gadgetbridge/devices/AbstractDeviceCoordinatorTest.java
@@ -75,6 +75,8 @@ public class AbstractDeviceCoordinatorTest extends TestBase {
             put("fenix 6X Sapphire", DeviceType.GARMIN_FENIX_6X_SAPPHIRE); // #5496
             put("fenix 6S Pro Solar", DeviceType.GARMIN_FENIX_6S_PRO_SOLAR); // #5568
             put("R50Pro", DeviceType.R50PRO);
+            put("SBM67", DeviceType.SBM_67);
+            put("BPM Smart", DeviceType.SBM_67);
             put("R11_0500", DeviceType.YAWELL_R11); // #4711
             put("Edge 130", DeviceType.GARMIN_EDGE_130); // matrix
             put("Edge 840", DeviceType.GARMIN_EDGE_840); // matrix
```
-----------------------------------
